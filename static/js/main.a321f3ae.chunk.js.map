{"version":3,"sources":["store/stories/index.ts","components/tooltip/tooltip.tsx","components/control/icon-button.tsx","store/prefs/index.ts","store/story-formats/index.ts","components/container/button-bar/button-bar.tsx","components/container/button-bar/button-bar-separator.tsx","components/container/card/card-content.tsx","dialogs/index.ts","store/undoable-stories/index.ts","components/container/dialog-card/dialog-card.tsx","components/container/dialog-card/dialog-editor.tsx","util/geometry.ts","store/stories/defaults.ts","components/control/checkbox-button.tsx","util/is-electron.ts","electron/shared/index.ts","store/persistence/persistable-changes.ts","components/error/error-message.tsx","components/error/global-error-boundary.tsx","components/error/safari-warning-card.tsx","components/control/text-select.tsx","util/story-format/editor-extensions.ts","util/story-format/namespace.ts","util/app-info.ts","util/publish.ts","util/tag.ts","components/control/card-button.tsx","components/control/menu-button.tsx","components/control/prompt-button.tsx","util/parse-links.ts","store/prefs/defaults.ts","components/image/icon/empty.tsx","components/image/icon/loading.tsx","components/image/icon/twine.tsx","codemirror/prefix-trigger.ts","components/control/code-area/code-area.tsx","util/i18n.ts","store/persistence/electron-ipc/prefs/load.ts","store/persistence/electron-ipc/save-json.ts","store/persistence/electron-ipc/prefs/save-middleware.ts","store/persistence/electron-ipc/stories/load.ts","store/persistence/electron-ipc/stories/save-middleware.ts","store/persistence/electron-ipc/stories/save-story.ts","store/persistence/electron-ipc/story-formats/load.ts","store/persistence/electron-ipc/story-formats/save-middleware.ts","store/persistence/local-storage/prefs/load.ts","store/persistence/local-storage/prefs/save-middleware.ts","store/persistence/local-storage/prefs/save.ts","store/persistence/local-storage/stories/save-middleware.ts","store/persistence/local-storage/stories/load.ts","store/persistence/local-storage/comma-list.ts","store/persistence/local-storage/stories/save.ts","store/persistence/local-storage/story-formats/load.ts","store/persistence/local-storage/story-formats/save.ts","store/persistence/local-storage/story-formats/save-middleware.ts","store/persistence/use-persistence.ts","store/persistence/electron-ipc/use-electron-ipc-persistence.ts","store/persistence/local-storage/use-local-storage-persistence.ts","components/tag/add-tag-button.tsx","components/tag/tag-button.tsx","components/control/icon-link.tsx","components/codemirror/indent-buttons.tsx","components/codemirror/undo-redo-buttons.tsx","components/control/text-input.tsx","components/container/card/card.tsx","store/stories/getters.ts","util/story-format/fetch-properties.ts","store/story-formats/defaults.ts","util/unused-name.ts","store/use-store-error-reporter.ts","util/codemirror-options.ts","util/color.ts","util/regexp.ts","dialogs/context/dialogs.tsx","components/tag/tag-stripe.tsx","dialogs/context/reducer.ts","dialogs/context/dialogs-context.tsx","util/import.ts","components/container/button-card.tsx","components/passage/rename-passage-button.tsx","store/prefs/use-computed-theme.ts","components/tag/tag-editor.tsx","components/meter/meter.tsx","store/format-loader.tsx","store/prefs/action-creators.ts","store/prefs/getters.ts","electron/shared/story-filename.ts","store/story-formats/action-creators.ts","store/story-formats/getters.ts","dialogs/app-donation.tsx","dialogs/passage-tags.tsx","dialogs/story-javascript.tsx","dialogs/story-search.tsx","dialogs/story-stylesheet.tsx","dialogs/story-tags.tsx","store/stories/action-creators/create-newly-linked-passages.ts","store/stories/action-creators/create-story.ts","store/stories/action-creators/create-untitled-passage.ts","store/stories/action-creators/delete-passage.ts","store/stories/action-creators/delete-story.ts","store/stories/action-creators/duplicate-story.ts","store/stories/action-creators/delete-orphaned-passages.ts","util/passage-is-empty.ts","store/stories/action-creators/update-passage.ts","store/stories/action-creators/find-replace.ts","store/stories/action-creators/highlight-passages.ts","store/stories/action-creators/import-stories.ts","store/stories/action-creators/move-passages.ts","store/stories/action-creators/rename-passage-tag.ts","store/stories/action-creators/rename-story-tag.ts","store/stories/action-creators/select-passage.ts","store/stories/action-creators/select-story.ts","store/stories/action-creators/tag-color.ts","store/stories/action-creators/tag-passage.ts","store/stories/action-creators/update-story.ts","store/stories/reducer/create-passage.ts","store/stories/reducer/delete-passage.ts","store/stories/reducer/repair/repair-passage.ts","store/stories/reducer/repair/repair-story.ts","store/stories/reducer/update-passage.ts","store/stories/reducer/index.ts","store/stories/reducer/create-passages.ts","store/stories/reducer/create-story.ts","store/stories/reducer/delete-passages.ts","store/stories/reducer/delete-story.ts","store/stories/reducer/init.ts","store/stories/reducer/repair/repair-state.ts","store/stories/reducer/update-passages.ts","store/stories/reducer/update-story.ts","store/stories/stories-context.tsx","dialogs/passage-edit/passage-text.tsx","store/use-codemirror-passage-hints.ts","store/use-format-codemirror-mode.ts","dialogs/passage-edit/passage-toolbar.tsx","dialogs/passage-edit/story-format-toolbar.tsx","store/use-format-codemirror-toolbar.ts","dialogs/passage-edit/tag-toolbar.tsx","dialogs/passage-edit/passage-edit.tsx","components/control/file-input.tsx","dialogs/story-import/file-chooser.tsx","dialogs/story-import/story-chooser.tsx","dialogs/story-import/story-import.tsx","store/undoable-stories/reverse-action.ts","store/undoable-stories/reverse-thunk.ts","store/undoable-stories/reducer.ts","store/undoable-stories/undoable-stories-context.tsx","components/story-format/story-format-select.tsx","dialogs/story-details/story-stats.tsx","dialogs/story-details/story-details.tsx","components/control/font-select.tsx","util/locales.ts","dialogs/app-prefs.tsx","store/prefs/prefs-context.tsx","store/prefs/reducer.ts","store/story-formats/story-formats-context.tsx","store/story-formats/reducer.ts","dialogs/about-twine/about-twine.tsx","components/loading-curtain/loading-curtain.tsx","store/locale-switcher.tsx","components/click-away-listener/click-away-listener.tsx","components/container/card-group.tsx","components/document-title/document-title.tsx","components/container/main-content.tsx","components/badge/badge.tsx","components/container/card/selectable-card.tsx","components/story-format/story-format-card/story-format-card-details.tsx","components/story-format/story-format-card/story-format-card.tsx","components/route-toolbar/back-button.tsx","components/route-toolbar/route-toolbar.tsx","store/use-publishing.ts","store/use-story-launch.ts","util/save-html.ts","route-actions/build-actions.tsx","route-actions/app-actions.tsx","routes/story-format-list/toolbar/formats/add-story-format-button.tsx","routes/story-format-list/toolbar/formats/default-story-format-button.tsx","routes/story-format-list/toolbar/formats/proofing-story-format-button.tsx","routes/story-format-list/toolbar/formats/remove-story-format-button.tsx","routes/story-format-list/toolbar/formats/story-format-extensions-button.tsx","routes/story-format-list/toolbar/formats/format-actions.tsx","routes/story-format-list/toolbar/view-actions.tsx","routes/story-format-list/toolbar/story-format-list-toolbar.tsx","routes/story-format-list/story-format-list-route.tsx","routes/story-edit/toolbar/passage/create-passage-button.tsx","routes/story-edit/toolbar/passage/delete-passages-button.tsx","routes/story-edit/toolbar/passage/edit-passages-buttons.tsx","routes/story-edit/toolbar/passage/select-all-passages-button.tsx","routes/story-edit/toolbar/passage/start-at-passage-button.tsx","routes/story-edit/toolbar/passage/test-passage-button.tsx","routes/story-edit/toolbar/passage/passage-actions.tsx","components/story/rename-story-button.tsx","routes/story-edit/toolbar/story/details-button.tsx","routes/story-edit/toolbar/story/find-replace-button.tsx","routes/story-edit/toolbar/story/javascript-button.tsx","routes/story-edit/toolbar/story/passage-tags-button.tsx","routes/story-edit/toolbar/story/stylesheet-button.tsx","routes/story-edit/toolbar/story/story-actions.tsx","routes/story-edit/toolbar/undo-redo-buttons.tsx","routes/story-edit/toolbar/story-edit-toolbar.tsx","routes/story-edit/zoom-buttons.tsx","routes/story-edit/use-zoom-transition.ts","components/marquee-selection/marquee-selection.tsx","components/passage/passage-connections/broken-connection.tsx","util/svg.ts","components/passage/passage-connections/passage-connection.tsx","components/passage/passage-connections/self-connection.tsx","components/passage/passage-connections/passage-connection-group.tsx","components/passage/passage-connections/link-markers.tsx","components/passage/passage-connections/start-connection.tsx","store/use-format-reference-parser.ts","components/passage/passage-connections/passage-connections.tsx","components/passage/passage-card.tsx","components/passage/passage-card-group.tsx","components/passage/passage-map/passage-map.tsx","routes/story-edit/marqueeable-passage-map.tsx","routes/story-edit/story-edit-route.tsx","routes/story-edit/use-zoom-shortcuts.ts","components/storage-quota/storage-quota.tsx","routes/story-list/toolbar/library/archive-button.tsx","routes/story-list/toolbar/library/import-story-button.tsx","routes/story-list/toolbar/library/story-tags-button.tsx","routes/story-list/toolbar/library/library-actions.tsx","routes/story-list/toolbar/story/create-story-button.tsx","components/control/confirm-button.tsx","routes/story-list/toolbar/story/delete-story-button.tsx","routes/story-list/toolbar/story/duplicate-story-button.tsx","routes/story-list/toolbar/story/edit-story-button.tsx","routes/story-list/toolbar/story/tag-story-button.tsx","routes/story-list/toolbar/story/story-actions.tsx","routes/story-list/toolbar/view/sort-by-button.tsx","routes/story-list/toolbar/view/tag-filter-button.tsx","routes/story-list/toolbar/view/view-actions.tsx","routes/story-list/toolbar/story-list-toolbar.tsx","util/hue-string.ts","components/story/story-preview.tsx","components/story/story-card.tsx","routes/story-list/story-cards.tsx","routes/story-list/story-list-route.tsx","store/prefs/use-donation-check.ts","util/replace-dom.ts","routes/story-play/story-play-route.tsx","routes/story-proof/story-proof-route.tsx","routes/story-test/story-test-route.tsx","components/welcome/welcome-card.tsx","routes/welcome/content.tsx","routes/welcome/welcome-route.tsx","routes/index.tsx","store/state-loader.tsx","store/theme-setter.tsx","app.tsx","index.tsx"],"names":["Tooltip","props","anchor","label","position","React","tooltipEl","setTooltipEl","arrowEl","setArrowEl","visible","setVisible","appearTimeout","setAppearTimeout","usePopper","modifiers","name","options","element","placement","strategy","styles","attributes","handleOnEnter","window","setTimeout","handleOnLeave","clearTimeout","addEventListener","removeEventListener","CSSTransition","classNames","in","mountOnEnter","timeout","unmountOnExit","className","ref","role","style","popper","arrow","IconButton","disabled","icon","iconOnly","iconPosition","onClick","preventDefault","selectable","selected","tooltipPosition","variant","button","setButton","undefined","e","ButtonBar","orientation","children","ButtonBarSeparator","CardContent","DialogCard","collapsed","fixedSize","headerLabel","maximizable","maximized","onChangeCollapsed","onChangeMaximized","onClose","useErrorBoundary","didCatch","ErrorBoundary","error","t","useTranslation","console","calcdClassName","onKeyDown","event","key","floating","DialogEditor","lineAngle","p1","p2","Math","atan2","top","left","PI","lineDistance","hypot","rectCenter","rect","width","height","rectFromPoints","rectsIntersect","r1","r2","rectIntersectionWithLine","segmentStart","segmentEnd","result","NaN","segseg","boundingRect","rects","length","Error","right","bottom","i","rectRight","rectBottom","passageDefaults","highlighted","i18n","tags","text","storyDefaults","ifid","lastUpdate","Date","passages","script","snapToGrid","startPassage","storyFormat","storyFormatVersion","stylesheet","tagColors","zoom","CheckboxButton","checkedIcon","onChange","uncheckedIcon","value","otherProps","calculatedIcon","isElectronRenderer","navigator","userAgent","indexOf","trivialPassageProps","trivialStoryProps","trivialStoryFormatProps","isPersistablePassageChange","Object","keys","some","includes","isPersistableStoryChange","isPersistableStoryFormatChange","ErrorMessage","GlobalErrorBoundary","href","rel","target","stack","SafariWarningCard","browser","UAParser","getBrowser","version","parseInt","replace","Number","isFinite","safariNavigator","standalone","canAddToHomeScreen","TextSelect","map","option","formatEditorExtensions","format","twineVersion","loadState","properties","editorExtensions","twine","extensions","filter","semverSpec","satisfies","warn","info","namespaceForFormat","toLowerCase","getAppInfo","process","archiveFilename","timestamp","toLocaleString","publishArchive","stories","appInfo","reduce","output","story","publishStory","startOptional","publishPassage","passage","localId","escape","toString","join","startLocalId","formatOptions","startId","find","p","id","passageData","forEach","index","tagData","tag","publishStoryWithFormat","formatSource","isValidTagName","test","CardButton","ariaLabel","onChangeOpen","focusSelector","open","other","buttonEl","setButtonEl","cardEl","setCardEl","focusTrapOptions","clickOutsideDeactivates","onDeactivate","MenuButton","items","menuEl","setMenuEl","setOpen","closer","document","item","separator","checked","PromptButton","cancelIcon","cancelLabel","onSubmit","prompt","submitIcon","submitLabel","submitVariant","validate","mounted","validation","setValidation","a","current","valid","updateValidation","message","buttonType","internalLinks","link","nonEmptyLinks","removeSetters","noSetter","getField","removeEnclosingBrackets","substr","fields","split","extractLink","tagContent","parseLinks","internalOnly","uniq","match","extractLinkTags","defaults","appTheme","codeEditorFontFamily","codeEditorFontScale","dialogWidth","disabledStoryFormatEditorExtensions","donateShown","editorCursorBlinks","firstRunTime","getTime","lastUpdateSeen","lastUpdateCheckTime","locale","userLanguage","language","browserLanguage","systemLanguage","passageEditorFontFamily","passageEditorFontScale","proofingFormat","storyFormatListFilter","storyListSort","storyListTagFilter","storyTagColors","welcomeSeen","IconEmpty","viewBox","stroke","strokeWidth","fill","strokeLinecap","strokeLinejoin","IconLoading","IconTwine","xmlns","xmlnsXlink","offset","stopColor","stopOpacity","xlinkHref","x1","y1","x2","y2","gradientUnits","gradientTransform","d","transform","attachments","prefixTriggerOption","cm","prefixes","callback","checkTrigger","state","completionActive","curWord","findWordAt","getDoc","getCursor","ch","prevWordRange","prevWord","getRange","head","push","on","off","editor","inited","CodeMirror","defineOption","CodeArea","fontFamily","fontScale","fontSize","classnames","labelHidden","i18next","createInstance","use","HttpBackend","initReactI18next","init","debug","backend","loadPath","fallbackLng","interpolation","escapeValue","load","twineElectron","prefKeys","ipcRenderer","invoke","prefs","saveJson","filename","data","send","saveMiddleware","action","type","Array","isArray","file","importStories","htmlSource","mtime","lastState","saveStory","formats","formatWithNameAndVersion","source","fetchStoryFormatProperties","url","storyWithName","storyWithId","storyId","oldStory","newStory","once","passageUpdates","passageId","storyFormats","uuid","userAdded","serialized","localStorage","getItem","serializedPref","JSON","parse","previouslySerialized","removeItem","ids","setItem","stringify","save","serializedStories","serializedStory","serializedPassages","serializedPassage","trim","values","addUnique","list","RegExp","contains","remove","substring","doUpdateTransaction","updater","transaction","passageIds","storyIds","savePassage","deletePassageById","passageWithName","deleteStory","passageWithId","serializedFormat","loadError","usePersistence","electronIpcPersistence","localStoragePersistence","AddTagButton","assignedTags","existingTags","onAdd","creatingTag","setCreatingTag","newColor","setNewColor","newName","setNewName","validationMessage","canAdd","tagName","colors","color","TagButton","checkable","onChangeColor","onRemove","IconLink","IndentButtons","execCommand","command","focus","UndoRedoButtons","watch","canRedo","setCanRedo","canUndo","setCanUndo","history","historySize","redo","undo","TextInput","onInput","placeholder","Card","passageName","passageConnections","connectionParser","parser","passageMap","Map","draggable","broken","Set","connections","self","fixed","targetName","add","targetPassage","get","has","set","passagesMatchingSearch","search","flags","matcher","includePassageNames","matchCase","useRegexes","createRegExp","storyPassageTags","from","sort","storyStats","links","brokenLinks","characters","count","words","storyTags","s","requestQueue","Promise","resolve","jsonpRequester","jsonp","reject","then","resolveQueue","err","builtins","unusedName","existing","suffix","useStoreErrorReporter","useSuspense","ready","reportError","messageKey","alert","codeMirrorOptionsFromPrefs","extraKeys","Insert","cursorBlinkRate","escapeRegExp","escapeRegExpReplace","DialogTransition","Dialogs","useScrollbarSize","usePrefsContext","useDialogsContext","dispatch","dialogs","hasUnmaximized","dialog","containerStyle","paddingLeft","marginBottom","marginRight","maximizedStyle","component","managementProps","TagStripe","title","displayName","reducer","exists","editedState","stateDialog","isEqual","DialogsContext","DialogsContextProvider","useThunkReducer","Provider","selectors","float","stringValue","parseFloat","query","el","selector","querySelectorAll","parseDimensions","raw","bits","html","lastUpdateOverride","nodes","createElement","innerHTML","storyEl","importedStory","startPassagePid","getAttribute","startPassageId","textContent","passageEl","size","domToObject","ButtonCard","DisabledRenamePassageButton","EnabledRenamePassageButton","onRename","RenamePassageButton","useComputedTheme","matchMedia","mediaQuery","matches","systemTheme","setSystemTheme","listener","TagEditor","allTags","onChangeName","Meter","domId","percent","FormatLoader","block","seenFormats","setSeenFormats","useStoryFormatsContext","newFormats","newFormat","oldFormat","loadAllFormatProperties","loadingFormat","f","loadPercent","setPref","formatEditorExtensionsDisabled","storyFileName","createFromProperties","deleteFormat","deselectAllFormats","getFormats","deselectFormat","loadFormatThunk","hydrate","hydrateResult","Function","call","toLoad","allSettled","loadFormatProperties","selectFormat","exclusive","getState","filteredFormats","semverLt","formatImageUrl","image","isAbsoluteUrl","formatWithId","newestFormatNamed","gt","sortFormats","b","AppDonationDialog","PassageTagsDialog","useUndoableStoriesContext","setTagColor","handleChangeColor","renamePassageTag","handleChangeTagName","StoryJavaScriptDialog","cmEditor","setCmEditor","useStoriesContext","editorDidMount","onBeforeChange","updateStory","autofocus","lineWrapping","mode","ignoreTab","Tab","StorySearchDialog","setFlags","setReplace","setFind","debouncedDispatch","debounce","toggleFlag","highlightPassagesMatchingSearch","replaceInStory","StoryStylesheetDialog","StoryTagsDialog","storiesDispatch","prefsDispatch","renameStoryTag","createNewlyLinkedPassages","newText","oldText","oldLinks","toCreate","l","passageDefs","passageGap","newPassagesWidth","needsMoving","createStory","createUntitledPassage","centerX","centerY","defs","bounds","max","round","deletePassages","duplicateStory","deleteOrphanedPassages","newLinks","orphan","orphanPassage","passageIsEmpty","updatePassage","oldName","dontUpdateOthers","updatedStory","oldNameEscaped","newNameEscaped","simpleLinkRegexp","compoundLinkRegexp","reverseLinkRegexp","relinkedPassage","replaceText","searchFor","replaceWith","replacer","replaceInPassage","matchIds","oldHighlighted","newHighlighted","toImport","existingStories","importStory","otherStory","existingStory","movePassages","xChange","yChange","deselectPassage","selectAllPassages","selectPassage","selectPassagesInRect","ignoreIds","r","deselectStory","deselectAllStories","selectStory","addPassageTag","removePassageTag","createPassage","passageProps","storyExists","created","newState","newPassage","deletePassage","foundStory","deleted","logRepair","propName","repairedValue","detail","repairStory","allStories","allFormats","defaultFormat","storyDefs","repairs","newId","newIfid","entries","defKey","repairFormat","anyPassageRepaired","repairedPassages","repairedPassage","parentStory","pos","posKey","dim","dimKey","otherPassage","repairPassage","updated","createPassages","storyProps","toUpperCase","repairState","updatePassages","StoriesContext","StoriesContextProvider","storiesPersistence","persistedReducer","PassageText","onEditorChange","storyFormatExtensionsDisabled","changePending","setChangePending","localText","setLocalText","autocompletePassageNames","showHint","completeSingle","character","hint","doc","replaceRange","close","wordRange","word","comps","to","useCodeMirrorPassageHints","formatName","formatVersion","modeName","setModeName","extensionsDisabled","codeMirror","defineMode","useFormatCodeMirrorMode","debouncedOnChange","handleMount","refresh","handleChange","prefixTrigger","PassageToolbar","isStart","handleSetSize","StoryFormatToolbar","onExecCommand","containerRef","toolbarFactory","loaded","setLoaded","toolbarFunc","setToolbarFunc","namespace","commands","commandName","namespacedCommand","toolbar","environment","subitem","useFormatCodeMirrorToolbar","toolbarItems","setToolbarItems","tryToSetToolbar","getComputedStyle","foregroundColor","src","alt","TagToolbar","handleChangeTagColor","InnerPassageEditDialog","storyFormatExtensionsEnabled","setStoryFormatExtensionsEnabled","editorCrashed","setEditorCrashed","resetError","reset","handlePassageTextChange","selections","listSelections","setSelections","PassageEditDialog","FileInput","onError","changeEvent","files","reader","FileReader","loadEvent","readAsText","FileChooser","accept","StoryChooser","onImport","selectedStories","setSelectedStories","willReplaceExisting","StoryImportDialog","setFile","setStories","reverseAction","prop","passageResult","reverseThunk","thunk","actions","actionOrThunk","newChange","description","storiesState","newChanges","changes","slice","currentChange","min","change","UndoableStoriesContext","UndoableStoriesContextProvider","dispatchAndRecordStoryAction","redoLabel","undoLabel","StoryFormatSelect","selectedFormat","loadingFormats","loadingCount","dateFormatter","Intl","DateTimeFormat","dateStyle","timeStyle","StoryDetailsDialogStats","stats","date","StoryDetailsDialog","families","scales","FontSelect","familyLabel","onChangeFamily","onChangeScale","scaleLabel","customScaleVisible","setCustomScaleVisible","customFamilyVisible","setCustomFamilyVisible","customFamily","setCustomFamily","customScale","setCustomScale","scale","locales","code","closestAppLocale","roughCode","roughMatch","AppPrefsDialog","PrefsContext","PrefsContextProvider","prefKey","defaultBuiltins","StoryFormatsContext","StoryFormatsContextProvider","builtinFormats","keep","builtinFormat","AboutTwineDialog","dangerouslySetInnerHTML","__html","credits","c","localizations","LoadingCurtain","LocaleSwitcher","changeLanguage","ClickAwayListener","ignoreSelector","onClickAway","closest","CardGroup","gridTemplateColumns","columnWidth","columns","maxWidth","DocumentTitle","querySelector","Helmet","MainContent","grabbable","padded","dragScrollStart","dragMouseStart","container","moveListener","scrollLeft","clientX","scrollTop","clientY","upListener","releasePointerCapture","pointerId","cursor","downListener","setPointerCapture","ignoreContext","Badge","SelectableCard","onDoubleClick","onSelect","ctrlKey","shiftKey","tabIndex","StoryFormatCardDetails","errorMessage","author","license","StoryFormatCard","editorExtensionsDisabled","proofing","BackButton","useHistory","location","pathname","goBack","RouteToolbar","helpUrl","pinnedControls","tabs","selectedTabClassName","tabName","tabContent","usePublishing","storyFormatsDispatch","proofStory","formatProperties","publishOptions","publishStoryData","useStoryLaunch","playStory","testStory","saveHtml","Blob","saveAs","BuildActions","playError","setPlayError","proofError","setProofError","publishError","setPublishError","testError","setTestError","resetErrors","AppActions","isValidUrl","URL","AddStoryFormatButton","newFormatUrl","setNewFormatUrl","storyFormatName","DefaultStoryFormatButton","ProofingStoryFormatButton","RemoveStoryFormatButton","isDefault","isProofing","StoryFormatExtensionsButton","FormatActions","selectedFormats","ViewActions","setFilter","StoryFormatListToolbar","StoryFormatListRoute","formatsDispatch","visibleFormats","TransitionGroup","disabledFormat","handleSelect","CreatePassageButton","getCenter","handleClick","DeletePassagesButton","useHotkeys","EditPassagesButton","SelectAllPassagesButton","StartAtPassageButton","TestPassageButton","PassageActions","selectedPassages","soloSelectedPassage","handleRename","DisabledRenameStoryButton","EnabledRenameStoryButton","RenameStoryButton","DetailsButton","FindReplaceButton","JavaScriptButton","PassageTagsButton","StylesheetButton","StoryActions","StoryEditToolbar","ZoomButtons","handleZoomChange","useZoomTransition","scrollTarget","setCurrent","transition","step","requestAnimationFrame","lastTimestamp","elapsed","setter","start","time","quadOut","transitionStep","newLeft","scrollNormalizedCenter","scrollCenter","newTop","clientWidth","clientHeight","MarqueeSelection","ignoreEventsOnSelector","onSelectRect","onTemporarySelectRect","additive","setAdditive","dragging","setDragging","setStart","currentContainerRect","currentContainer","relativePointerPos","pointerType","getBoundingClientRect","lineOffset","sqrt","BrokenConnection","markerEnd","arc","end","radius","largeArc","sweep","rotation","PassageConnection","path","offsetStart","offsetEnd","startPoint","endPoint","distance","SelfConnection","PassageConnectionGroup","connection","LinkMarkers","refX","refY","markerWidth","markerHeight","orient","cx","cy","StartConnection","markerStart","emptyFunc","emptySet","noOffset","PassageConnections","referenceParser","setEditorExtensions","references","parsePassageText","useFormatReferenceParser","draggableLinks","fixedLinks","draggableReferences","fixedReferences","PassageCard","onDeselect","onDrag","onDragStart","onDragStop","onEdit","empty","excerpt","deviceType","handleMouseDown","handleEdit","nodeRef","onMouseDown","onStart","onStop","PassageCardGroup","sortedPassages","dragReducer","dragX","x","dragY","y","startX","startY","PassageMap","visibleZoom","compactCards","setCompactCards","passageBounds","setProperty","handleDragStart","body","classList","handleDrag","handleDragStop","MarqueeablePassageMap","temporaryRect","setTemporaryRect","temporaryAdditive","setTemporaryAdditive","innerPassages","handleTemporarySelectRect","handleSelectRect","InnerStoryEditRoute","setInited","dialogsDispatch","mainContent","useParams","undoableStoriesDispatch","keydown","keyup","useZoomShortcuts","handleDeselectPassage","handleDragPassages","abs","handleEditPassage","handleSelectPassage","logicalRect","center","StoryEditRoute","StorageQuota","lastWatch","setLastWatch","working","setWorking","percentFree","setPercentFree","hide","storage","estimate","quota","usage","toFixed","run","ArchiveButton","ImportStoryButton","StoryTagsButton","LibraryActions","CreateStoryButton","ConfirmButton","confirmIcon","confirmLabel","confirmVariant","onConfirm","DeleteStoryButton","storyName","setStoryName","DuplicateStoryButton","EditStoryButton","TagStoryButton","tagColor","selectedStory","SortByButton","TagFilterButton","StoryListToolbar","hueString","charCodeAt","StoryPreview","hues","minX","POSITIVE_INFINITY","minY","maxX","NEGATIVE_INFINITY","maxY","svg","circle","bgRadius","StoryCard","onChangeTagColor","onRemoveTag","StoryCards","onSelectStory","handleRemoveTag","InnerStoryListRoute","shouldShowDonationPrompt","now","useDonationCheck","visibleStories","filteredStories","sortBy","StoryListRoute","replaceDom","SVG","Store","StoryFormat","amdDefine","app","jQuery","write","StoryPlayRoute","StoryProofRoute","StoryTestRoute","WelcomeCard","nextLabel","onNext","onSkip","showSkip","content","WelcomeRoute","containerEl","shown","setShown","allCards","visibleCards","lastCard","scroll","documentElement","offsetTop","duration","finish","showNext","card","Routes","exact","render","StateLoader","initing","setIniting","prefsRepaired","setPrefsRepaired","formatsRepaired","setFormatsRepaired","storiesRepaired","setStoriesRepaired","prefsState","formatsState","safeFormat","ThemeSetter","computedTheme","dataset","App","fallback","ReactDOM","getElementById"],"mappings":"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","file":"static/js/main.a321f3ae.chunk.js","sourcesContent":["export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './stories-context';\nexport * from './stories.types';\nexport * from './zoom';\n","import * as React from 'react';\nimport {CSSTransition} from 'react-transition-group';\nimport {usePopper} from 'react-popper';\nimport {Placement} from '@popperjs/core';\nimport './tooltip.css';\n\nexport interface TooltipProps {\n\tanchor: HTMLElement | null;\n\tlabel: string;\n\tposition?: Placement;\n}\n\n// This component is intentionally limited in functionality. It should *only* be\n// used to duplicate content that is only perceivable by screen readers or other\n// assistive technology, e.g. through an `aria-label` attribute. The one use\n// case right now in the app are icon-only buttons.\n//\n// Content in these components is *not* accessible to screen readers and should\n// not be. That content should be placed in an `aria-label` attribute instead.\n\nexport const Tooltip: React.FC<TooltipProps> = props => {\n\tconst {anchor, label, position = 'top'} = props;\n\tconst [tooltipEl, setTooltipEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [arrowEl, setArrowEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [visible, setVisible] = React.useState(false);\n\tconst [appearTimeout, setAppearTimeout] = React.useState<number>();\n\tconst {styles, attributes} = usePopper(anchor, tooltipEl, {\n\t\tmodifiers: [{name: 'arrow', options: {element: arrowEl}}, {name: 'flip'}],\n\t\tplacement: position,\n\t\tstrategy: 'fixed'\n\t});\n\n\tReact.useEffect(() => {\n\t\tconst handleOnEnter = () =>\n\t\t\tsetAppearTimeout(window.setTimeout(() => setVisible(true), 500));\n\t\tconst handleOnLeave = () => {\n\t\t\tif (appearTimeout) {\n\t\t\t\twindow.clearTimeout(appearTimeout);\n\t\t\t}\n\n\t\t\tsetVisible(false);\n\t\t};\n\n\t\tif (anchor) {\n\t\t\tanchor.addEventListener('pointerenter', handleOnEnter);\n\t\t\tanchor.addEventListener('pointerleave', handleOnLeave);\n\t\t\treturn () => {\n\t\t\t\tanchor.removeEventListener('pointerenter', handleOnEnter);\n\t\t\t\tanchor.removeEventListener('pointerleave', handleOnLeave);\n\t\t\t};\n\t\t}\n\t}, [anchor, appearTimeout]);\n\n\treturn (\n\t\t<CSSTransition\n\t\t\tclassNames=\"fade-in-out\"\n\t\t\tin={visible}\n\t\t\tmountOnEnter\n\t\t\ttimeout={200}\n\t\t\tunmountOnExit\n\t\t>\n\t\t\t<div\n\t\t\t\taria-hidden\n\t\t\t\tclassName=\"tooltip\"\n\t\t\t\tref={setTooltipEl}\n\t\t\t\trole=\"tooltip\"\n\t\t\t\tstyle={styles.popper}\n\t\t\t\t{...attributes.popper}\n\t\t\t>\n\t\t\t\t<div className=\"tooltip-arrow\" ref={setArrowEl} style={styles.arrow} />\n\t\t\t\t<div className=\"tooltip-label\">{label}</div>\n\t\t\t</div>\n\t\t</CSSTransition>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\nimport {Tooltip, TooltipProps} from '../tooltip';\n\nexport interface IconButtonProps {\n\tbuttonType?: 'button' | 'submit';\n\tdisabled?: boolean;\n\ticon: React.ReactNode;\n\ticonOnly?: boolean;\n\ticonPosition?: 'start' | 'end';\n\tlabel: string;\n\tonClick?: (e: React.MouseEvent) => void;\n\tpreventDefault?: boolean;\n\tselectable?: boolean;\n\tselected?: boolean;\n\ttooltipPosition?: TooltipProps['position'];\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n}\n\nexport const IconButton = React.forwardRef<HTMLButtonElement, IconButtonProps>(\n\t(props, ref) => {\n\t\tconst {\n\t\t\tdisabled,\n\t\t\ticon,\n\t\t\ticonOnly,\n\t\t\ticonPosition = 'start',\n\t\t\tonClick,\n\t\t\tpreventDefault,\n\t\t\tselectable = false,\n\t\t\tselected = false,\n\t\t\ttooltipPosition,\n\t\t\tvariant = 'secondary'\n\t\t} = props;\n\t\tconst className = classNames(\n\t\t\t'icon-button',\n\t\t\t`icon-position-${iconPosition}`,\n\t\t\t{selected: selected},\n\t\t\t`variant-${variant}`,\n\t\t\t{'icon-only': iconOnly}\n\t\t);\n\t\tconst [button, setButton] = React.useState<HTMLButtonElement | null>(null);\n\t\tReact.useImperativeHandle(ref, () => button as HTMLButtonElement);\n\t\tconst handleOnClick = (e: React.MouseEvent) => {\n\t\t\tonClick && onClick(e);\n\n\t\t\tif (preventDefault) {\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t};\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<button\n\t\t\t\t\taria-label={iconOnly ? props.label : undefined}\n\t\t\t\t\taria-pressed={selectable ? selected : undefined}\n\t\t\t\t\tdisabled={disabled}\n\t\t\t\t\tclassName={className}\n\t\t\t\t\tonClick={handleOnClick}\n\t\t\t\t\tref={setButton}\n\t\t\t\t>\n\t\t\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t\t\t{!iconOnly && props.label}\n\t\t\t\t</button>\n\t\t\t\t{iconOnly && (\n\t\t\t\t\t<Tooltip\n\t\t\t\t\t\tanchor={button}\n\t\t\t\t\t\tlabel={props.label}\n\t\t\t\t\t\tposition={tooltipPosition}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n);\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './prefs-context';\nexport * from './prefs.types';\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './story-formats-context';\nexport * from './story-formats.types';\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './button-bar.css';\n\nexport interface ButtonBarProps {\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const ButtonBar: React.FC<ButtonBarProps> = props => (\n\t<div\n\t\tclassName={classNames(\n\t\t\t'button-bar',\n\t\t\t`orientation-${props.orientation ?? 'horizontal'}`\n\t\t)}\n\t>\n\t\t{props.children}\n\t</div>\n);\n","import * as React from 'react';\nimport './button-bar-separator.css';\n\nexport const ButtonBarSeparator: React.FC = () => (\n\t<div className=\"button-bar-separator\" />\n);\n","import * as React from 'react';\nimport './card-content.css';\n\nexport const CardContent: React.FC = ({children}) => (\n\t<div className=\"card-content\">{children}</div>\n);\n","export * from './about-twine';\nexport * from './app-donation';\nexport * from './app-prefs';\nexport * from './context';\nexport * from './context/dialogs';\nexport * from './dialogs.types';\nexport * from './passage-edit';\nexport * from './passage-tags';\nexport * from './story-import';\nexport * from './story-javascript';\nexport * from './story-details';\nexport * from './story-search';\nexport * from './story-stylesheet';\nexport * from './story-tags';\n","export * from './undoable-stories-context';\nexport * from './undoable-stories.types';\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {\n\tIconArrowsDiagonal,\n\tIconArrowsDiagonalMinimize,\n\tIconChevronDown,\n\tIconChevronUp,\n\tIconX\n} from '@tabler/icons';\nimport {Card} from '../card';\nimport {IconButton} from '../../control/icon-button';\nimport './dialog-card.css';\nimport useErrorBoundary from 'use-error-boundary';\nimport {ErrorMessage} from '../../error';\n\nexport interface DialogCardProps {\n\tclassName?: string;\n\tcollapsed: boolean;\n\tfixedSize?: boolean;\n\theaderLabel: string;\n\tmaximizable?: boolean;\n\tmaximized?: boolean;\n\tonChangeCollapsed: (value: boolean) => void;\n\tonChangeMaximized: (value: boolean) => void;\n\tonClose: () => void;\n}\n\nexport const DialogCard: React.FC<DialogCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\tclassName,\n\t\tcollapsed,\n\t\tfixedSize,\n\t\theaderLabel,\n\t\tmaximizable,\n\t\tmaximized,\n\t\tonChangeCollapsed,\n\t\tonChangeMaximized,\n\t\tonClose\n\t} = props;\n\tconst {didCatch, ErrorBoundary, error} = useErrorBoundary();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\t}, [error]);\n\n\tconst calcdClassName = classNames('dialog-card', className, {\n\t\tcollapsed,\n\t\t'fixed-size': fixedSize,\n\t\tmaximized\n\t});\n\n\tfunction handleKeyDown(event: React.KeyboardEvent) {\n\t\tif (event.key === 'Escape') {\n\t\t\tonClose();\n\t\t}\n\t}\n\n\treturn (\n\t\t<div\n\t\t\taria-label={headerLabel}\n\t\t\trole=\"dialog\"\n\t\t\tclassName={calcdClassName}\n\t\t\tonKeyDown={handleKeyDown}\n\t\t>\n\t\t\t<Card floating>\n\t\t\t\t<h2>\n\t\t\t\t\t<div className=\"dialog-card-header\">\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={collapsed ? <IconChevronUp /> : <IconChevronDown />}\n\t\t\t\t\t\t\tlabel={headerLabel}\n\t\t\t\t\t\t\tonClick={() => onChangeCollapsed(!collapsed)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"dialog-card-header-controls\">\n\t\t\t\t\t\t{maximizable && (\n\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\ticon={\n\t\t\t\t\t\t\t\t\tmaximized ? (\n\t\t\t\t\t\t\t\t\t\t<IconArrowsDiagonalMinimize />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<IconArrowsDiagonal />\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\t\t\tlabel={\n\t\t\t\t\t\t\t\t\tmaximized ? t('common.unmaximize') : t('common.maximize')\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tonClick={() => onChangeMaximized(!maximized)}\n\t\t\t\t\t\t\t\ttooltipPosition=\"bottom\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\ttooltipPosition=\"bottom\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</h2>\n\t\t\t\t{didCatch ? (\n\t\t\t\t\t<ErrorMessage>\n\t\t\t\t\t\t{t('components.dialogCard.contentsCrashed')}\n\t\t\t\t\t</ErrorMessage>\n\t\t\t\t) : (\n\t\t\t\t\t<ErrorBoundary>{!collapsed && children}</ErrorBoundary>\n\t\t\t\t)}\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport './dialog-editor.css';\n\nexport const DialogEditor: React.FC = props => (\n\t<div className=\"dialog-editor\">{props.children}</div>\n);\n","import segseg, {SegSegVector} from 'segseg';\n\nexport interface Point {\n\ttop: number;\n\tleft: number;\n}\n\nexport interface Rect extends Point {\n\theight: number;\n\twidth: number;\n}\n\n/**\n * Returns the angle between two points in degrees.\n * @see https://gist.github.com/conorbuck/2606166\n */\nexport function lineAngle(p1: Point, p2: Point) {\n\treturn (Math.atan2(p2.top - p1.top, p2.left - p1.left) * 180) / Math.PI;\n}\n\n/**\n * Returns the length of the line segment between two points.\n */\nexport function lineDistance(p1: Point, p2: Point) {\n\treturn Math.hypot(p1.left - p2.left, p1.top - p2.top);\n}\n\n/**\n * Returns the center of a rectangle.\n */\nexport function rectCenter(rect: Rect): Point {\n\treturn {left: rect.left + rect.width / 2, top: rect.top + rect.height / 2};\n}\n\n/**\n * Creates a rectangle from two points, regardless of their relative position.\n */\n\nexport function rectFromPoints(p1: Point, p2: Point): Rect {\n\tconst rect: Rect = {height: 0, left: 0, top: 0, width: 0};\n\n\tif (p1.left < p2.left) {\n\t\trect.left = p1.left;\n\t\trect.width = p2.left - p1.left;\n\t} else {\n\t\trect.left = p2.left;\n\t\trect.width = p1.left - p2.left;\n\t}\n\n\tif (p1.top < p2.top) {\n\t\trect.top = p1.top;\n\t\trect.height = p2.top - p1.top;\n\t} else {\n\t\trect.top = p2.top;\n\t\trect.height = p1.top - p2.top;\n\t}\n\n\treturn rect;\n}\n\n/**\n * Returns whether two rectangles intersect.\n * @see http://stackoverflow.com/questions/2752349/fast-rectangle-to-rectangle-intersection\n */\nexport function rectsIntersect(r1: Rect, r2: Rect) {\n\treturn !(\n\t\tr2.left > r1.left + r1.width ||\n\t\tr2.left + r2.width < r1.left ||\n\t\tr2.top > r1.top + r1.height ||\n\t\tr2.top + r2.height < r1.top\n\t);\n}\n\n/**\n * Returns the intersection point between a rectangle and a line segment. If\n * none exists, this returns null.\n */\nexport function rectIntersectionWithLine(\n\trect: Rect,\n\tsegmentStart: Point,\n\tsegmentEnd: Point\n): Point | null {\n\tlet result: SegSegVector = [NaN, NaN];\n\n\t// Left side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Right side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Top side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Bottom side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\treturn null;\n}\n\n/**\n * Returns a rectangle enclosing a set of rectangles.\n */\nexport function boundingRect(rects: Rect[]) {\n\tif (rects.length === 0) {\n\t\tthrow new Error(\"Can't calculate bounding rect for 0 rects\");\n\t}\n\n\tlet left = rects[0].left;\n\tlet right = rects[0].left + rects[0].width;\n\tlet top = rects[0].top;\n\tlet bottom = rects[0].top + rects[0].height;\n\n\tfor (let i = 1; i < rects.length; i++) {\n\t\tconst rectRight = rects[i].left + rects[i].width;\n\t\tconst rectBottom = rects[i].top + rects[i].height;\n\n\t\tif (rects[i].left < left) {\n\t\t\tleft = rects[i].left;\n\t\t}\n\n\t\tif (rects[i].top < top) {\n\t\t\ttop = rects[i].top;\n\t\t}\n\n\t\tif (rectRight > right) {\n\t\t\tright = rectRight;\n\t\t}\n\n\t\tif (rectBottom > bottom) {\n\t\t\tbottom = rectBottom;\n\t\t}\n\t}\n\n\treturn {left, top, height: bottom - top, width: right - left};\n}\n","import {i18n} from '../../util/i18n';\nimport {Passage, Story} from './stories.types';\n\nexport const passageDefaults = (): Omit<Passage, 'id' | 'story'> => ({\n\theight: 100,\n\thighlighted: false,\n\tleft: 0,\n\tname: i18n.t('store.passageDefaults.name'),\n\tselected: false,\n\ttags: [],\n\ttext: '',\n\ttop: 0,\n\twidth: 100\n});\n\nexport const storyDefaults = (): Omit<Story, 'id'> => ({\n\tifid: '',\n\tlastUpdate: new Date(),\n\tpassages: [],\n\tname: i18n.t('store.storyDefaults.name'),\n\tscript: '',\n\tselected: false,\n\tsnapToGrid: true,\n\tstartPassage: '',\n\tstoryFormat: '',\n\tstoryFormatVersion: '',\n\tstylesheet: '',\n\ttags: [],\n\ttagColors: {},\n\tzoom: 1\n});\n","import * as React from 'react';\nimport {IconSquare, IconSquareCheck} from '@tabler/icons';\nimport {IconButton, IconButtonProps} from './icon-button';\n\nexport interface CheckboxButtonProps\n\textends Omit<IconButtonProps, 'icon' | 'onClick'> {\n\tcheckedIcon?: React.ReactNode;\n\ticon?: React.ReactNode;\n\tonChange: (value: boolean) => void;\n\tuncheckedIcon?: React.ReactNode;\n\tvalue: boolean;\n}\n\nexport const CheckboxButton: React.FC<CheckboxButtonProps> = props => {\n\tconst {\n\t\tcheckedIcon,\n\t\ticon,\n\t\tonChange,\n\t\tuncheckedIcon,\n\t\tvalue,\n\t\t...otherProps\n\t} = props;\n\tconst calculatedIcon = value\n\t\t? checkedIcon ?? <IconSquareCheck />\n\t\t: uncheckedIcon ?? <IconSquare />;\n\n\treturn (\n\t\t<span\n\t\t\taria-disabled={otherProps.disabled}\n\t\t\tclassName=\"checkbox-button\"\n\t\t\trole=\"checkbox\"\n\t\t\taria-checked={value}\n\t\t>\n\t\t\t<IconButton\n\t\t\t\ticon={icon ?? calculatedIcon}\n\t\t\t\tonClick={() => onChange(!value)}\n\t\t\t\t{...otherProps}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","/**\n * Is this code currently in an Electron renderer process? Returns false if\n * either this is running in the Electron main process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-337858978\n */\nexport const isElectronRenderer = () =>\n\twindow.navigator.userAgent.indexOf('Electron') !== -1;\n\n/**\n * Is this code currently running in an Electron main process? Returns false if\n * either this is running in an Electron renderer process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-611231970\n */\n\nexport const isElectronMain = () => process.versions.hasOwnProperty('electron');\n","export * from './electron-shared.types';\nexport * from './story-filename';\n","import {Passage, Story} from '../stories';\nimport {StoryFormat} from '../story-formats';\n\nconst trivialPassageProps: (keyof Passage)[] = ['highlighted', 'selected'];\nconst trivialStoryProps: (keyof Story)[] = ['lastUpdate', 'selected'];\n\n// Loosely typing this because of the different load states possible in the type.\nconst trivialStoryFormatProps: string[] = [\n\t'loadError',\n\t'loadState',\n\t'properties',\n\t'selected'\n];\n\n/**\n * Is a passage change persistable? e.g. is it nontrivial?\n */\nexport function isPersistablePassageChange(props: Partial<Passage>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialPassageProps.includes(key as keyof Passage)\n\t);\n}\n\n/**\n * Is a story change persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryChange(props: Partial<Story>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryProps.includes(key as keyof Story)\n\t);\n}\n\n/**\n * Is a story format persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryFormatChange(props: Partial<StoryFormat>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryFormatProps.includes(key as keyof StoryFormat)\n\t);\n}","import {IconAlertOctagon} from '@tabler/icons';\nimport * as React from 'react';\nimport './error-message.css';\n\nexport const ErrorMessage: React.FC = ({children}) => (\n\t<div className=\"error-message\">\n\t\t<IconAlertOctagon />\n\t\t<div className=\"message\">{children}</div>\n\t</div>\n);\n","import * as React from 'react';\nimport useErrorBoundary from 'use-error-boundary';\nimport {ErrorMessage} from './error-message';\nimport './global-error-boundary.css';\n\nexport const GlobalErrorBoundary: React.FC = ({children}) => {\n\tconst {ErrorBoundary, didCatch, error} = useErrorBoundary();\n\n\t// Non-localized because our localization might be broken.\n\n\treturn didCatch ? (\n\t\t<div className=\"global-error-boundary\">\n\t\t\t<div>\n\t\t\t\t<ErrorMessage>\n\t\t\t\t\t<p>Something went wrong and Twine can't continue.</p>\n\t\t\t\t\t<p>Please try restarting Twine or reloading the page.</p>\n\t\t\t\t\t<p>\n\t\t\t\t\t\tIf you see this message repeatedly, please{' '}\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref=\"https://twinery.org/2bugs\"\n\t\t\t\t\t\t\trel=\"noreferrer\"\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\treport a bug\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t.\n\t\t\t\t\t</p>\n\t\t\t\t</ErrorMessage>\n\t\t\t\t<p>Details:</p>\n\t\t\t\t<pre>{error.stack}</pre>\n\t\t\t</div>\n\t\t</div>\n\t) : (\n\t\t<ErrorBoundary>{children}</ErrorBoundary>\n\t);\n};","import {IconInfoCircle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport UAParser from 'ua-parser-js';\nimport {ButtonBar} from '../container/button-bar';\nimport {Card} from '../container/card';\nimport {IconLink} from '../control/icon-link';\nimport {ErrorMessage} from '../error';\nimport './safari-warning-card.css';\n\nexport interface SafariNavigator extends Navigator {\n\tstandalone?: boolean;\n}\n\nexport const SafariWarningCard: React.FC = props => {\n\tconst {t} = useTranslation();\n\tconst browser = new UAParser().getBrowser();\n\n\tif (browser.name !== 'Safari') {\n\t\treturn null;\n\t}\n\n\tif (browser.version) {\n\t\tconst version = parseInt(browser.version.replace(/\\..*/, ''));\n\n\t\tif (Number.isFinite(version) && version < 13) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tconst safariNavigator = window.navigator as SafariNavigator;\n\n\tif (safariNavigator.standalone) {\n\t\t// We are in \"standalone\" or full-screen mode. This is supposed to have\n\t\t// its own localStorage which is not subject to the seven-day limit.\n\t\t// https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html\n\t\treturn null;\n\t}\n\n\tconst canAddToHomeScreen = safariNavigator.standalone !== undefined;\n\n\treturn (\n\t\t<div className=\"safari-warning-card\">\n\t\t\t<Card>\n\t\t\t\t<ErrorMessage>\n\t\t\t\t\t<p>{t('components.safariWarningCard.message')}</p>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<p>{t('components.safariWarningCard.addToHomeScreen')}</p>\n\t\t\t\t\t)}\n\t\t\t\t\t<p>{t('components.safariWarningCard.archiveAndUseAnotherBrowser')}</p>\n\t\t\t\t</ErrorMessage>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/2ioslocalstorage\"\n\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\tlabel={t('components.safariWarningCard.learnMore')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<IconLink\n\t\t\t\t\t\t\thref=\"https://twinery.org/2ioshomescreen\"\n\t\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\t\tlabel={t('components.safariWarningCard.howToAddToHomeScreen')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './text-select.css';\n\nexport interface SelectOption {\n\tdisabled?: boolean;\n\tlabel: string;\n\tvalue: string;\n}\n\nexport interface TextSelectProps {\n\tchildren: React.ReactNode;\n\tonChange?: React.ChangeEventHandler<HTMLSelectElement>;\n\toptions: SelectOption[];\n\torientation?: 'horizontal' | 'vertical';\n\tvalue: string;\n}\n\nexport const TextSelect: React.FC<TextSelectProps> = props => {\n\tconst {children, onChange, options, orientation, value} = props;\n\tconst className = classNames(\n\t\t'text-select',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"text-select-label\">{children}</span>\n\t\t\t\t<span className=\"text-select-control\">\n\t\t\t\t\t<select onChange={onChange} value={value}>\n\t\t\t\t\t\t{options.map(option => (\n\t\t\t\t\t\t\t<option\n\t\t\t\t\t\t\t\tdisabled={option.disabled}\n\t\t\t\t\t\t\t\tkey={option.value}\n\t\t\t\t\t\t\t\tvalue={option.value}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{option.label}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</select>\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import {StoryFormat} from '../../store/story-formats';\nimport {satisfies} from 'semver';\n\n/**\n * Returns editor extensions in a format that fit the Twine version specified.\n * If none are available, then this returns undefined.\n */\nexport function formatEditorExtensions(\n\tformat: StoryFormat,\n\ttwineVersion: string\n) {\n\tif (format.loadState !== 'loaded') {\n\t\treturn;\n\t}\n\n\tif (!format.properties.editorExtensions?.twine) {\n\t\treturn;\n\t}\n\n\tconst extensions = Object.keys(\n\t\tformat.properties.editorExtensions.twine\n\t).filter(semverSpec => satisfies(twineVersion, semverSpec));\n\n\tif (extensions.length === 0) {\n\t\tconsole.info(\n\t\t\t`${format.name} ${format.version} has editor extensions, but none that ${twineVersion} satisfies`\n\t\t);\n\t\treturn;\n\t}\n\n\tif (extensions.length > 1) {\n\t\tconsole.warn(\n\t\t\t`More than one set of editor extensions for ${format.name} ${format.version} is satisfied by ${twineVersion}. Using the first.`\n\t\t);\n\t}\n\n\treturn format.properties.editorExtensions.twine[extensions[0]];\n}\n","import {StoryFormat} from '../../store/story-formats';\n\n/**\n * Returns a namespace prefix for a story format that is compatible with\n * CodeMirror names (modes and commands).\n */\nexport function namespaceForFormat(format: StoryFormat) {\n\treturn format.name.toLowerCase().replace(/\\s/g, '-') + '-' + format.version;\n}\n","export interface AppInfo {\n\tname: string;\n\tversion: string;\n}\n\n/**\n * Retrieves information about the Twine app itself based on buildtime\n * environment\n */\nexport function getAppInfo(): AppInfo {\n\treturn {\n\t\tname: process.env.REACT_APP_NAME as string,\n\t\tversion: process.env.REACT_APP_VERSION as string\n\t};\n}\n","import escape from 'lodash/escape';\nimport {Passage, Story} from '../store/stories';\nimport {AppInfo} from './app-info';\nimport {i18n} from './i18n';\n\nexport interface PublishOptions {\n\t/**\n\t * Options that will be passed as-is to the format in the `options` attribute\n\t * of the published `<tw-storydata>` tag.\n\t */\n\tformatOptions?: string;\n\n\t/**\n\t * ID of the passage to start the story at. This overrides what is set at the\n\t * story level.\n\t */\n\tstartId?: string;\n\n\t/**\n\t * If true, publishing will proceed even if the story has no starting passage\n\t * set and one wasn't set manually.\n\t */\n\tstartOptional?: boolean;\n}\n\n/**\n * Returns a filename for an archive file.\n */\nexport function archiveFilename() {\n\tconst timestamp = new Date().toLocaleString().replace(/[/:\\\\]/g, '.');\n\n\treturn i18n.t('store.archiveFilename', {timestamp});\n}\n\n/**\n * Publishes an archive of stories, e.g. all stories in one file with no story\n * format binding.\n */\nexport function publishArchive(stories: Story[], appInfo: AppInfo) {\n\treturn stories.reduce((output, story) => {\n\t\t// Force publishing even if there is no start point set.\n\n\t\treturn (\n\t\t\toutput + publishStory(story, appInfo, {startOptional: true}) + '\\n\\n'\n\t\t);\n\t}, '');\n}\n\n/**\n * Publishes a passage to an HTML fragment. This takes a id argument because\n * passages are numbered sequentially in published stories, not with a UUID.\n */\nexport function publishPassage(passage: Passage, localId: number) {\n\treturn (\n\t\t`<tw-passagedata pid=\"${escape(localId.toString())}\" ` +\n\t\t`name=\"${escape(passage.name)}\" ` +\n\t\t`tags=\"${escape(passage.tags.join(' '))}\" ` +\n\t\t`position=\"${passage.left},${passage.top}\" ` +\n\t\t`size=\"${passage.width},${passage.height}\">` +\n\t\t`${escape(passage.text)}</tw-passagedata>`\n\t);\n}\n\n/**\n * Does a \"naked\" publish of a story -- creating an HTML representation of it,\n * but without any story format binding.\n */\nexport function publishStory(\n\tstory: Story,\n\tappInfo: AppInfo,\n\t{formatOptions, startId, startOptional}: PublishOptions = {}\n) {\n\tstartId = startId ?? story.startPassage;\n\n\t// Verify that the start passage exists.\n\n\tif (!startOptional) {\n\t\tif (!startId) {\n\t\t\tthrow new Error(\n\t\t\t\t'There is no starting point set for this story and none was set manually.'\n\t\t\t);\n\t\t}\n\n\t\tif (!story.passages.find(p => p.id === startId)) {\n\t\t\tthrow new Error(\n\t\t\t\t'The passage set as starting point for this story does not exist.'\n\t\t\t);\n\t\t}\n\t}\n\n\t// The id of the start passage as it is published (*not* a UUID).\n\n\tlet startLocalId;\n\tlet passageData = '';\n\n\tstory.passages.forEach((p, index) => {\n\t\tpassageData += publishPassage(p, index + 1);\n\n\t\tif (p.id === startId) {\n\t\t\tstartLocalId = index + 1;\n\t\t}\n\t});\n\n\tconst tagData = Object.keys(story.tagColors).reduce(\n\t\t(result, tag) =>\n\t\t\tresult +\n\t\t\t`<tw-tag name=\"${escape(tag)}\" color=\"${escape(\n\t\t\t\tstory.tagColors[tag]\n\t\t\t)}\"></tw-tag>`,\n\t\t''\n\t);\n\n\treturn (\n\t\t`<tw-storydata name=\"${escape(story.name)}\" ` +\n\t\t`startnode=\"${startLocalId || ''}\" ` +\n\t\t`creator=\"${escape(appInfo.name)}\" ` +\n\t\t`creator-version=\"${escape(appInfo.version)}\" ` +\n\t\t`format=\"${escape(story.storyFormat)}\" ` +\n\t\t`format-version=\"${escape(story.storyFormatVersion)}\" ` +\n\t\t`ifid=\"${escape(story.ifid)}\" ` +\n\t\t`options=\"${escape(formatOptions)}\" ` +\n\t\t`tags=\"${escape(story.tags.join(' '))}\" ` +\n\t\t`zoom=\"${escape(story.zoom.toString())}\" hidden>` +\n\t\t`<style role=\"stylesheet\" id=\"twine-user-stylesheet\" ` +\n\t\t`type=\"text/twine-css\">` +\n\t\tstory.stylesheet +\n\t\t`</style>` +\n\t\t`<script role=\"script\" id=\"twine-user-script\" ` +\n\t\t`type=\"text/twine-javascript\">` +\n\t\tstory.script +\n\t\t`</script>` +\n\t\ttagData +\n\t\tpassageData +\n\t\t`</tw-storydata>`\n\t);\n}\n\n/**\n * Publishes a story and binds it to the source of a story format.\n */\nexport function publishStoryWithFormat(\n\tstory: Story,\n\tformatSource: string,\n\tappInfo: AppInfo,\n\t{formatOptions, startId}: PublishOptions = {}\n) {\n\tif (!formatSource) {\n\t\tthrow new Error('Story format source cannot be empty.');\n\t}\n\n\tlet output = formatSource;\n\n\t// We use function replacements to protect the data from accidental\n\t// interactions with the special string replacement patterns.\n\n\toutput = output.replace(/{{STORY_NAME}}/g, () => escape(story.name));\n\toutput = output.replace(/{{STORY_DATA}}/g, () =>\n\t\tpublishStory(story, appInfo, {formatOptions, startId})\n\t);\n\n\treturn output;\n}\n","export function isValidTagName(value: string) {\n\treturn value.length > 0 && !/\\s/.test(value);\n}\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {Card} from '../container/card';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './card-button.css';\nimport FocusTrap from 'focus-trap-react';\n\nexport interface CardButtonProps extends IconButtonProps {\n\t/**\n\t * ARIA label for the card that opens.\n\t */\n\tariaLabel: string;\n\t/**\n\t * CSS selector for the element inside the card that should be focused when it\n\t * is opened. Otherwise, the first text input or button in source order will\n\t * be focused.\n\t */\n\tfocusSelector?: string;\n\t/**\n\t * Callback for when the open status of the card should change.\n\t */\n\tonChangeOpen: (value: boolean) => void;\n\t/**\n\t * Is the card currently open?\n\t */\n\topen?: boolean;\n}\n\nexport const CardButton: React.FC<CardButtonProps> = props => {\n\tconst {ariaLabel, children, focusSelector, onChangeOpen, open, ...other} =\n\t\tprops;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [cardEl, setCardEl] = React.useState<HTMLDivElement | null>(null);\n\tconst {styles, attributes} = usePopper(buttonEl, cardEl, {strategy: 'fixed'});\n\n\treturn (\n\t\t<span className=\"card-button\">\n\t\t\t<IconButton\n\t\t\t\tonClick={() => onChangeOpen(!open)}\n\t\t\t\t{...other}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<FocusTrap\n\t\t\t\t\tfocusTrapOptions={{\n\t\t\t\t\t\tclickOutsideDeactivates: true,\n\t\t\t\t\t\tonDeactivate: () => onChangeOpen(false)\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\taria-label={ariaLabel}\n\t\t\t\t\t\tclassName=\"card-button-card\"\n\t\t\t\t\t\tref={setCardEl}\n\t\t\t\t\t\trole=\"dialog\"\n\t\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t\t{...attributes.popper}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Card floating>{children}</Card>\n\t\t\t\t\t</div>\n\t\t\t\t</FocusTrap>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {ButtonBar, ButtonBarSeparator} from '../container/button-bar';\nimport {ButtonCard} from '../container/button-card';\nimport {IconEmpty} from '../image/icon';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './menu-button.css';\nimport {CheckboxButton} from './checkbox-button';\nimport {IconCheck} from '@tabler/icons';\n\nexport interface UncheckableLabeledMenuItem {\n\tdisabled?: boolean;\n\tlabel: string;\n\tonClick: () => void;\n\tseparator?: undefined;\n\tvariant?: IconButtonProps['variant'];\n}\n\nexport interface CheckableLabeledMenuItem extends UncheckableLabeledMenuItem {\n\tcheckable: true;\n\tchecked: boolean;\n}\n\nexport type LabeledMenuItem =\n\t| UncheckableLabeledMenuItem\n\t| CheckableLabeledMenuItem;\n\nexport interface MenuSeparator {\n\tseparator: true;\n}\n\nexport interface MenuButtonProps extends Omit<IconButtonProps, 'onClick'> {\n\titems: (LabeledMenuItem | MenuSeparator)[];\n}\n\nexport const MenuButton: React.FC<MenuButtonProps> = props => {\n\tconst {items, ...other} = props;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [menuEl, setMenuEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [open, setOpen] = React.useState(false);\n\tconst {styles, attributes} = usePopper(buttonEl, menuEl, {strategy: 'fixed'});\n\n\tReact.useEffect(() => {\n\t\tconst closer = () => setOpen(false);\n\n\t\tif (open) {\n\t\t\tdocument.addEventListener('click', closer);\n\t\t}\n\n\t\treturn () => document.removeEventListener('click', closer);\n\t}, [menuEl, open, setOpen]);\n\n\treturn (\n\t\t<span className=\"menu-button\">\n\t\t\t<IconButton\n\t\t\t\t{...other}\n\t\t\t\tonClick={() => setOpen(open => !open)}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"menu-button-menu\"\n\t\t\t\t\tref={setMenuEl}\n\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t{...attributes.popper}\n\t\t\t\t>\n\t\t\t\t\t<ButtonCard floating>\n\t\t\t\t\t\t<ButtonBar orientation=\"vertical\">\n\t\t\t\t\t\t\t{items.map((item, index) => {\n\t\t\t\t\t\t\t\tif (item.separator) {\n\t\t\t\t\t\t\t\t\treturn <ButtonBarSeparator key={index} />;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn 'checkable' in item ? (\n\t\t\t\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\t\t\t\tcheckedIcon={<IconCheck />}\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonChange={item.onClick}\n\t\t\t\t\t\t\t\t\t\tuncheckedIcon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tvalue={item.checked}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\ticon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonClick={item.onClick}\n\t\t\t\t\t\t\t\t\t\tvariant={item.variant}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</ButtonBar>\n\t\t\t\t\t</ButtonCard>\n\t\t\t\t</div>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCheck, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport {TextInput} from './text-input';\n\nexport interface PromptValidationResponse {\n\tmessage?: string;\n\tvalid: boolean;\n}\n\nexport type PromptButtonValidator = (\n\tvalue: string\n) => PromptValidationResponse | Promise<PromptValidationResponse>;\n\nexport interface PromptButtonProps\n\textends Omit<CardButtonProps, 'ariaLabel' | 'onChangeOpen' | 'open'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tonChange: React.ChangeEventHandler<HTMLInputElement>;\n\tonSubmit: (value: string) => void;\n\tprompt: string;\n\tsubmitIcon?: React.ReactNode;\n\tsubmitLabel?: string;\n\tsubmitVariant?: IconButtonProps['variant'];\n\tvalidate?: PromptButtonValidator;\n\tvalue: string;\n}\n\nexport const PromptButton: React.FC<PromptButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tonChange,\n\t\tonSubmit,\n\t\tprompt,\n\t\tsubmitIcon,\n\t\tsubmitLabel,\n\t\tsubmitVariant,\n\t\tvalidate,\n\t\tvalue,\n\t\t...other\n\t} = props;\n\tconst mounted = React.useRef(true);\n\tconst [open, setOpen] = React.useState(false);\n\tconst [validation, setValidation] =\n\t\tReact.useState<PromptValidationResponse>();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tasync function updateValidation() {\n\t\t\tif (validate) {\n\t\t\t\tconst validation = await validate(value);\n\n\t\t\t\tif (mounted.current) {\n\t\t\t\t\tsetValidation(validation);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (mounted.current) {\n\t\t\t\t\tsetValidation({valid: true});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tupdateValidation();\n\t}, [validate, value]);\n\n\tReact.useEffect(() => {\n\t\treturn () => {\n\t\t\tmounted.current = false;\n\t\t};\n\t}, []);\n\n\tfunction handleCancel(event: React.MouseEvent) {\n\t\tevent.preventDefault();\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleSubmit(event: React.FormEvent) {\n\t\tevent.preventDefault();\n\n\t\t// It's possible to submit with the Enter key and bypass us disabling the\n\t\t// submit button, so we need to catch that here.\n\n\t\tif (validation?.valid) {\n\t\t\tonSubmit(value);\n\t\t\tsetOpen(false);\n\t\t}\n\t}\n\n\treturn (\n\t\t<span className=\"prompt-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={prompt}\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t\t{...other}\n\t\t\t>\n\t\t\t\t<form onSubmit={handleSubmit}>\n\t\t\t\t\t<CardContent>\n\t\t\t\t\t\t<TextInput onChange={onChange} orientation=\"vertical\" value={value}>\n\t\t\t\t\t\t\t{prompt}\n\t\t\t\t\t\t</TextInput>\n\t\t\t\t\t\t{validation?.message && <p>{validation.message}</p>}\n\t\t\t\t\t</CardContent>\n\t\t\t\t\t<ButtonBar>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\tbuttonType=\"submit\"\n\t\t\t\t\t\t\tdisabled={!validation?.valid}\n\t\t\t\t\t\t\ticon={submitIcon ?? <IconCheck />}\n\t\t\t\t\t\t\tlabel={submitLabel ?? t('common.ok')}\n\t\t\t\t\t\t\tvariant={submitVariant ?? 'primary'}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\tbuttonType=\"button\"\n\t\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\t\tonClick={handleCancel}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ButtonBar>\n\t\t\t\t</form>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","/*\nParses passage text for links. Optionally, it returns internal links only --\ne.g. those pointing to other passages in a story, not to an external web site.\n*/\n\nimport uniq from 'lodash/uniq';\n\n// The top level regular expression to catch links -- i.e. [[link]].\nconst extractLinkTags = (text: string) => text.match(/\\[\\[.*?\\]\\]/g) || [];\n\n// Links _not_ starting with a protocol, e.g. abcd://.\nconst internalLinks = (link: string) => !/^\\w+:\\/\\/\\/?\\w/i.test(link);\n\n// Links with some text in them.\nconst nonEmptyLinks = (link: string) => link !== '';\n\n// Setter is the second [] block if exists.\nconst removeSetters = (link: string) => {\n\tconst noSetter = getField(link, '][', 0);\n\n\treturn noSetter ?? link;\n};\n\nconst removeEnclosingBrackets = (link: string) =>\n\tlink.substr(2, link.length - 4);\n\n/**\n * Split the link by the separator and return the field in the given index.\n * Negative indices start from the end of the array.\n */\nconst getField = (link: string, separator: string, index: number) => {\n\tconst fields = link.split(separator);\n\n\tif (fields.length === 1) {\n\t\t/* Separator not present. */\n\t\treturn undefined;\n\t}\n\n\treturn index < 0 ? fields[fields.length + index] : fields[index];\n};\n\n// Arrow links:\n// [[display text->link]] format\n// [[link<-display text]] format\n// Interpret the rightmost '->' and the leftmost '<-' as the divider.\n\nconst extractLink = (tagContent: string) => {\n\treturn (\n\t\tgetField(tagContent, '->', -1) ||\n\t\tgetField(tagContent, '<-', 0) ||\n\t\t//  TiddlyWiki links:\n\t\t//  [[display text|link]] format\n\n\t\tgetField(tagContent, '|', -1) ||\n\t\t// [[link]] format\n\t\ttagContent\n\t);\n};\n\n/**\n * Returns a list of unique links in passage source code.\n */\nexport function parseLinks(text: string, internalOnly?: boolean) {\n\t// Link matching regexps ignore setter components, should they exist.\n\n\tlet result = uniq(\n\t\textractLinkTags(text)\n\t\t\t.map(removeEnclosingBrackets)\n\t\t\t.map(removeSetters)\n\t\t\t.map(extractLink)\n\t\t\t.filter(nonEmptyLinks)\n\t);\n\n\tif (internalOnly) {\n\t\tresult = result.filter(internalLinks);\n\t}\n\n\treturn result;\n}\n","import {PrefsState} from './prefs.types';\n\nexport const defaults = (): PrefsState => ({\n\tappTheme: 'system',\n\tcodeEditorFontFamily: 'var(--font-monospaced)',\n\tcodeEditorFontScale: 1,\n\tdialogWidth: 600,\n\tdisabledStoryFormatEditorExtensions: [],\n\tdonateShown: false,\n\teditorCursorBlinks: true,\n\tfirstRunTime: new Date().getTime(),\n\tlastUpdateSeen: '',\n\tlastUpdateCheckTime: new Date().getTime(),\n\tlocale:\n\t\t(window.navigator as any).userLanguage ||\n\t\twindow.navigator.language ||\n\t\t(window.navigator as any).browserLanguage ||\n\t\t(window.navigator as any).systemLanguage ||\n\t\t'en-us',\n\tpassageEditorFontFamily: 'var(--font-system)',\n\tpassageEditorFontScale: 1,\n\tproofingFormat: {\n\t\tname: 'Paperthin',\n\t\tversion: '1.0.0'\n\t},\n\tstoryFormat: {\n\t\tname: 'GrowYourOwn',\n\t\tversion: '1.0.0'\n\t},\n\tstoryFormatListFilter: 'current',\n\tstoryListSort: 'name',\n\tstoryListTagFilter: [],\n\tstoryTagColors: {},\n\twelcomeSeen: false\n});\n","import * as React from 'react';\n\nexport const IconEmpty: React.FC = () => (\n\t<svg\n\t\tviewBox=\"0 0 24 24\"\n\t\twidth=\"24\"\n\t\theight=\"24\"\n\t\tstroke=\"currentColor\"\n\t\tstrokeWidth=\"2\"\n\t\tfill=\"none\"\n\t\tstrokeLinecap=\"round\"\n\t\tstrokeLinejoin=\"round\"\n\t></svg>\n);\n","import * as React from 'react';\nimport {IconCircle} from '@tabler/icons';\nimport './loading.css';\n\nexport const IconLoading: React.FC = () => {\n\treturn (\n\t\t<span className=\"icon-loading\">\n\t\t\t<IconCircle />\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\n\nexport const IconTwine: React.FC = () => (\n\t<svg\n\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\txmlnsXlink=\"http://www.w3.org/1999/xlink\"\n\t\tviewBox=\"0 0 1200 1200\"\n\t\twidth=\"1200\"\n\t\theight=\"1200\"\n\t>\n\t\t<defs>\n\t\t\t<linearGradient id=\"b\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#127aee\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#117aef\" stopOpacity=\".251\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient id=\"a\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#10f05e\" stopOpacity=\".251\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#10f05e\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#a\"\n\t\t\t\tid=\"d\"\n\t\t\t\tx1=\"52\"\n\t\t\t\ty1=\"604.362\"\n\t\t\t\tx2=\"972\"\n\t\t\t\ty2=\"604.362\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t/>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#b\"\n\t\t\t\tid=\"c\"\n\t\t\t\tx1=\"256\"\n\t\t\t\ty1=\"0\"\n\t\t\t\tx2=\"231.987\"\n\t\t\t\ty2=\"725.548\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t\tgradientTransform=\"translate(0 28.362)\"\n\t\t\t/>\n\t\t</defs>\n\t\t<path\n\t\t\tfill=\"url(#c)\"\n\t\t\td=\"M64 28.362h384v1024H64z\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t\t<path\n\t\t\td=\"M64 860.362c0-704 896-704 896-704v384s-512 0-512 320v192H64z\"\n\t\t\tfill=\"url(#d)\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t</svg>\n);\n","// This automatically triggers a function when typing a word that is prefixed by\n// certain text. We use this to automatically pop open the autocomplete when the\n// user is probably typing a passage name.\n\nimport CodeMirror from 'codemirror';\nimport {Editor} from 'codemirror';\n\nlet attachments: Editor[] = [];\n\nexport interface CMPrefixTriggerOptions {\n\t/**\n\t * Called when the user types a prefix in.\n\t */\n\tcallback?: (editor: Editor) => void;\n\t/**\n\t * An array of strings that will trigger the callback, case-sensitive.\n\t */\n\tprefixes?: string[];\n}\n\nexport function prefixTriggerOption(\n\tcm: Editor,\n\toptions: CMPrefixTriggerOptions\n) {\n\tconst {prefixes, callback} = options;\n\n\tfunction checkTrigger(cm: Editor) {\n\t\tif (cm.state.completionActive || !prefixes || !callback) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Back up two words from the cursor.\n\n\t\tconst curWord = cm.findWordAt(cm.getDoc().getCursor());\n\n\t\tcurWord.anchor.ch--;\n\n\t\tconst prevWordRange = cm.findWordAt(curWord.anchor);\n\t\tconst prevWord = cm.getRange(prevWordRange.anchor, prevWordRange.head);\n\n\t\t// Do we have a match? Only trigger this once.\n\n\t\tfor (const prefix of prefixes) {\n\t\t\tif (prevWord === prefix) {\n\t\t\t\tcallback(cm);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (callback && prefixes && !attachments.includes(cm)) {\n\t\tattachments.push(cm);\n\t\tcm.on('inputRead', checkTrigger);\n\t} else if (attachments.includes(cm)) {\n\t\tcm.off('inputRead', checkTrigger);\n\t\tattachments = attachments.filter(editor => editor !== cm);\n\t}\n}\n\nlet inited = false;\n\nexport function initPrefixTriggerGlobally() {\n\tif (!inited) {\n\t\tCodeMirror.defineOption('prefixTrigger', [], prefixTriggerOption);\n\t\tinited = true;\n\t}\n}\n","import * as React from 'react';\nimport {\n\tControlled as CodeMirror,\n\tIControlledCodeMirror\n} from 'react-codemirror2';\nimport 'codemirror/addon/display/placeholder';\nimport 'codemirror/addon/hint/show-hint';\nimport 'codemirror/addon/hint/show-hint.css';\nimport 'codemirror/lib/codemirror.css';\nimport 'codemirror/mode/css/css';\nimport 'codemirror/mode/javascript/javascript';\nimport './code-area.css';\nimport './codemirror-theme.css';\nimport classnames from 'classnames';\nimport {initPrefixTriggerGlobally} from '../../../codemirror/prefix-trigger';\n\n// Not ideal by far to do this init here, outside of a component, but we have to\n// set up CodeMirror before the first render. Otherwise, CodeMirror doesn't pick\n// up on options properly.\n\ninitPrefixTriggerGlobally();\n\nexport interface CodeAreaProps extends IControlledCodeMirror {\n\tfontFamily?: string;\n\tfontScale?: number;\n\tlabel: string;\n\tlabelHidden?: boolean;\n\tvalue: string;\n}\n\nexport const CodeArea: React.FC<CodeAreaProps> = props => {\n\tconst {fontFamily, fontScale, label, ...otherProps} = props;\n\tconst style: React.CSSProperties = {};\n\n\tif (fontFamily) {\n\t\tstyle.fontFamily = fontFamily.includes(' ')\n\t\t\t? `\"${fontFamily}\"`\n\t\t\t: fontFamily;\n\t}\n\n\tif (fontScale) {\n\t\tstyle.fontSize = `${fontScale * 100}%`;\n\t}\n\n\treturn (\n\t\t<div className=\"code-area\" style={style}>\n\t\t\t<label>\n\t\t\t\t<span\n\t\t\t\t\tclassName={classnames('label', {\n\t\t\t\t\t\t'screen-reader-only': props.labelHidden\n\t\t\t\t\t})}\n\t\t\t\t>\n\t\t\t\t\t{label}\n\t\t\t\t</span>\n\t\t\t\t<CodeMirror {...otherProps} />\n\t\t\t</label>\n\t\t</div>\n\t);\n};\n","import i18next from 'i18next';\nimport HttpBackend from 'i18next-http-backend';\nimport {initReactI18next} from 'react-i18next';\n\nexport const i18n = i18next.createInstance();\n\ni18n\n\t.use(HttpBackend)\n\t.use(initReactI18next)\n\t.init({\n\t\tdebug: process.env.NODE_ENV === 'development',\n\t\tbackend: {\n\t\t\tloadPath: `${process.env.PUBLIC_URL}/locales/{{lng}}.json`\n\t\t},\n\t\tfallbackLng: 'en-us',\n\t\tinterpolation: {\n\t\t\tescapeValue: false\n\t\t},\n\t\tload: 'currentOnly'\n\t});\n","import {PrefsState} from '../../../prefs';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {defaults} from '../../../prefs/defaults';\n\nexport async function load(): Promise<Partial<PrefsState>> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst result: Partial<PrefsState> = {};\n\tconst prefKeys = Object.keys(defaults());\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst prefs = await twineElectron?.ipcRenderer.invoke('load-prefs');\n\n\tif (prefs && typeof prefs === 'object') {\n\t\tfor (const key in prefs) {\n\t\t\tif (prefKeys.includes(key)) {\n\t\t\t\t(result as any)[key] = prefs[key];\n\t\t\t}\n\t\t}\n\t}\n\n\treturn result;\n}\n","import {TwineElectronWindow} from '../../../electron/shared';\n\nexport function saveJson(filename: string, data: any) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttwineElectron.ipcRenderer.send('save-json', filename, data);\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsaveJson('prefs.json', state);\n\t}\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories/stories.types';\nimport {importStories} from '../../../../util/import';\n\nexport async function load(): Promise<Story[]> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst stories = await twineElectron?.ipcRenderer.invoke('load-stories');\n\n\tif (stories && Array.isArray(stories)) {\n\t\treturn stories.reduce((result, file) => {\n\t\t\tconst story = importStories(file.htmlSource, file.mtime);\n\n\t\t\tif (story[0]) {\n\t\t\t\treturn [...result, story[0]];\n\t\t\t}\n\n\t\t\tconsole.warn('Could not hydrate story: ', file.htmlSource);\n\t\t\treturn result;\n\t\t}, [] as Story[]);\n\t} else {\n\t\tconsole.warn('No stories to hydrate in Electron bridge');\n\t}\n\n\treturn [];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {StoryFormatsState} from '../../../story-formats';\nimport {\n\tisPersistablePassageChange,\n\tisPersistableStoryChange\n} from '../../persistable-changes';\nimport {saveStory} from './save-story';\n\n// When a story is deleted, we need to be able to look up information about it\n// from the last state.\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to disk. This should be called *after*\n * the main reducer runs.\n *\n * This has an extra argument: functions to archive and publish a story. This is\n * because the Electron app saves stories in published format.\n */\nexport function saveMiddleware(\n\tstate: StoriesState,\n\taction: StoriesAction,\n\tformats: StoryFormatsState\n) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tsaveStory(storyWithName(state, action.props.name), formats);\n\t\t\tbreak;\n\n\t\tcase 'deleteStory': {\n\t\t\t// We have to look up the story in our saved last state to know what file\n\t\t\t// to delete.\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'delete-story',\n\t\t\t\tstoryWithId(lastState, action.storyId)\n\t\t\t);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory':\n\t\t\tif (isPersistableStoryChange(action.props)) {\n\t\t\t\tif (action.props.name) {\n\t\t\t\t\t// The story has been renamed, and we need to process it\n\t\t\t\t\t// specially. We rename the story file, then save it to catch\n\t\t\t\t\t// any other changes.\n\n\t\t\t\t\tconst oldStory = storyWithId(lastState, action.storyId);\n\t\t\t\t\tconst newStory = storyWithId(state, action.storyId);\n\n\t\t\t\t\t// It's crucial that we only respond to this event once. Otherwise,\n\t\t\t\t\t// multiple renames in one session will cause mayhem.\n\n\t\t\t\t\ttwineElectron.ipcRenderer.once('story-renamed', () =>\n\t\t\t\t\t\tsaveStory(newStory, formats)\n\t\t\t\t\t);\n\t\t\t\t\ttwineElectron.ipcRenderer.send('rename-story', oldStory, newStory);\n\t\t\t\t} else {\n\t\t\t\t\t// An ordinary update.\n\n\t\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'createPassage':\n\t\tcase 'createPassages':\n\t\tcase 'deletePassage':\n\t\tcase 'deletePassages':\n\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\tbreak;\n\n\t\tcase 'updatePassage':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (\n\t\t\t\tObject.keys(action.passageUpdates).some(passageId =>\n\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no Electron persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = [...state];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories';\nimport {publishStory, publishStoryWithFormat} from '../../../../util/publish';\nimport {\n\tformatWithNameAndVersion,\n\tStoryFormatsState\n} from '../../../story-formats';\nimport {getAppInfo} from '../../../../util/app-info';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format/fetch-properties';\n\n/**\n * Sends an IPC message to save a story to disk, ideally in published form.\n */\nexport async function saveStory(story: Story, formats: StoryFormatsState) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttry {\n\t\tconst format = formatWithNameAndVersion(\n\t\t\tformats,\n\t\t\tstory.storyFormat,\n\t\t\tstory.storyFormatVersion\n\t\t);\n\n\t\tif (format.loadState === 'loaded') {\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, format.properties.source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t} else {\n\t\t\tconst {source} = await fetchStoryFormatProperties(format.url);\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t`Could not save full story (${error.message}). Trying to save story data only.`\n\t\t);\n\t\ttwineElectron.ipcRenderer.send(\n\t\t\t'save-story-html',\n\t\t\tstory,\n\t\t\tpublishStory(story, getAppInfo(), {startOptional: true})\n\t\t);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport async function load(): Promise<StoryFormatsState> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst storyFormats = await twineElectron?.ipcRenderer.invoke(\n\t\t'load-story-formats'\n\t);\n\n\tif (!storyFormats || !Array.isArray(storyFormats)) {\n\t\treturn [];\n\t}\n\n\treturn storyFormats.map(data => ({\n\t\tid: uuid(),\n\t\tloadState: 'unloaded',\n\t\tname: data.name,\n\t\tselected: false,\n\t\tversion: data.version,\n\t\turl: data.url,\n\t\tuserAdded: data.userAdded\n\t}));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tconst shouldSave =\n\t\taction.type === 'create' ||\n\t\taction.type === 'delete' ||\n\t\taction.type === 'repair' ||\n\t\t(action.type === 'update' && isPersistableStoryFormatChange(action.props));\n\n\tif (shouldSave) {\n\t\tsaveJson(\n\t\t\t'story-formats.json',\n\t\t\tstate.map(format => ({\n\t\t\t\tid: format.id,\n\t\t\t\tname: format.name,\n\t\t\t\tselected: undefined,\n\t\t\t\tversion: format.version,\n\t\t\t\turl: format.url,\n\t\t\t\tuserAdded: format.userAdded\n\t\t\t}))\n\t\t);\n\t}\n}\n","import {PrefsState} from '../../../prefs';\n\nexport async function load(): Promise<Partial<PrefsState>> {\n\tconst serialized = window.localStorage.getItem('twine-prefs');\n\tconst result: Partial<PrefsState> = {};\n\n\tif (!serialized) {\n\t\treturn {};\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedPref = window.localStorage.getItem(`twine-prefs-${id}`);\n\n\t\t\tif (!serializedPref) {\n\t\t\t\tconsole.warn(`No preference stored at twine-prefs-${id}`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst item = JSON.parse(serializedPref);\n\n\t\t\t(result as any)[item.name] = item.value;\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Preference ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-prefs-${id}`),\n\t\t\t\te\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {save} from './save';\n\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsave(state);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {PrefsState} from '../../../prefs';\n\nexport function save(state: PrefsState) {\n\t// Delete existing prefs in local storage, since we aren't bothering to\n\t// preserve IDs.\n\n\tconst previouslySerialized = window.localStorage.getItem('twine-prefs');\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-prefs-${id}`);\n\t\t});\n\t}\n\n\t/* Save new ones. */\n\n\tlet ids: string[] = [];\n\n\tfor (const name in state) {\n\t\tconst id = uuid();\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-prefs-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tvalue: state[name as keyof PrefsState]\n\t\t\t})\n\t\t);\n\t}\n\n\twindow.localStorage.setItem('twine-prefs', ids.join(','));\n}\n","import {\n\tpassageWithId,\n\tpassageWithName,\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {isPersistablePassageChange} from '../../persistable-changes';\nimport {\n\tdeletePassageById,\n\tdeleteStory,\n\tdoUpdateTransaction,\n\tsavePassage,\n\tsaveStory\n} from './save';\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: StoriesState, action: StoriesAction) {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createPassage': {\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst passage = passageWithName(state, story.id, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tsavePassage(transaction, passage);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createPassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (!props.name) {\n\t\t\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t\t\t}\n\n\t\t\t\t\tsavePassage(\n\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\tpassageWithName(state, story.id, props.name)\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Story was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithName(state, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase 'deletePassage': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// We can't dig up the passage in question right now, because\n\t\t\t// previousStories is only a shallow copy, and it's gone there at\n\t\t\t// this point in time.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tdeletePassageById(transaction, action.passageId);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deletePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// See above comment about passages.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.passageIds.forEach(passageId =>\n\t\t\t\t\tdeletePassageById(transaction, passageId)\n\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deleteStory': {\n\t\t\t// The story will be gone from state by the time we're called, so we\n\t\t\t// need a cached copy.\n\n\t\t\tconst story = storyWithId(lastState, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t// We have to delete all passages, then the story itself.\n\n\t\t\t\tstory.passages.forEach(passage =>\n\t\t\t\t\tdeletePassageById(transaction, passage.id)\n\t\t\t\t);\n\n\t\t\t\tdeleteStory(transaction, story);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updatePassage':\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\n\t\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t\tsaveStory(transaction, story);\n\t\t\t\t\tsavePassage(transaction, passage);\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tObject.keys(action.passageUpdates)\n\t\t\t\t\t.filter(passageId =>\n\t\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t\t)\n\t\t\t\t\t.forEach(passageId =>\n\t\t\t\t\t\tsavePassage(\n\t\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no local storage persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = state;\n}\n","import {passageDefaults, storyDefaults} from '../../../stories/defaults';\nimport {Passage, Story} from '../../../stories/stories.types';\n\n/**\n * Parses initial state from local storage.\n */\nexport async function load(): Promise<Story[]> {\n\tconst stories: Record<string, Story> = {};\n\tconst serializedStories = window.localStorage.getItem('twine-stories');\n\n\tif (!serializedStories) {\n\t\treturn [];\n\t}\n\n\t// First, deserialize stories. We index them by ID so that we can quickly add\n\t// passages to them as they are deserialized.\n\n\tserializedStories.split(',').forEach(id => {\n\t\tconst serializedStory = window.localStorage.getItem(`twine-stories-${id}`);\n\n\t\tif (!serializedStory) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story list contained ID ${id}, but twine-stories-${id} does not exist, skipping`\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst story: Story = JSON.parse(serializedStory);\n\n\t\t\tif (!story.id) {\n\t\t\t\tconsole.warn('Story in local storage had no ID, skipping', story);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tstories[story.id] = {\n\t\t\t\t...storyDefaults(),\n\t\t\t\t...story,\n\n\t\t\t\t// Coerce lastUpdate to a date.\n\t\t\t\tlastUpdate: story.lastUpdate\n\t\t\t\t\t? new Date(Date.parse(story.lastUpdate as unknown as string))\n\t\t\t\t\t: new Date(),\n\n\t\t\t\t// Force the passages property to be an empty array -- we'll populate it\n\t\t\t\t// when we load passages below.\n\t\t\t\tpassages: []\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Could not parse story as JSON, skipping: ${serializedStory}`\n\t\t\t);\n\t\t}\n\t});\n\n\t// Then create passages, adding them to their parent story.\n\n\tconst serializedPassages = window.localStorage.getItem('twine-passages');\n\n\tif (serializedPassages) {\n\t\tserializedPassages.split(',').forEach(id => {\n\t\t\tconst serializedPassage = window.localStorage.getItem(\n\t\t\t\t`twine-passages-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedPassage) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Passage list contained ID ${id}, but twine-passages-${id} does not exist, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst passage: Passage = JSON.parse(serializedPassage);\n\n\t\t\t\tif (!passage || !passage.story) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} did not have parent story ID, skipping`,\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!stories[passage.story]) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} is orphaned (looking for story ID ${passage.story}), skipping`\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstories[passage.story].passages.push({\n\t\t\t\t\t...passageDefaults,\n\t\t\t\t\t...passage,\n\n\t\t\t\t\t// Remove empty tags.\n\t\t\t\t\ttags: passage.tags ? passage.tags.filter(t => t.trim() !== '') : []\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Could not parse passage as JSON, skipping: ${serializedPassage}`\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\t}\n\n\t// Flatten the stories object.\n\treturn Object.values(stories);\n}\n","// Lightweight functions for dealing with comma-delimited strings (e.g. that don't\n// deal with all the intracacies of dealing with the actual CSV format, e.g.\n// quotation marks).\n\n/**\n * Returns whether a list contains a value.\n */\nexport function contains(list: string, value: string) {\n\treturn new RegExp('\\\\b' + value + '\\\\b').test(list);\n}\n\n/**\n * Adds a value to a list if it's not already present.\n */\nexport function addUnique(list: string, value: string) {\n\tif (list === '') {\n\t\treturn value;\n\t}\n\n\tif (contains(list, value)) {\n\t\treturn list;\n\t}\n\n\treturn list + ',' + value;\n}\n\n/**\n * Removes a value from a list.\n */\nexport function remove(list: string, value: string) {\n\tlist = list.replace(new RegExp(',?' + value), '');\n\n\t// We end up with a leading comma if we just removed the first value.\n\n\tif (list[0] === ',') {\n\t\treturn list.substring(1);\n\t}\n\n\treturn list;\n}\n","// Functions for moving stories into local storage. This module in particular\n// needs to remain well-optimized, as it has a direct effect on load time. As a\n// result, saving requires that you start and end a transaction manually. This\n// minimizes the number of writes to local storage.\n\nimport {Passage, Story} from '../../../stories/stories.types';\nimport {addUnique, remove} from '../comma-list';\n\nexport interface StorageTransaction {\n\tpassageIds: string;\n\tstoryIds: string;\n}\n\nexport type StorageUpdater = (transaction: StorageTransaction) => void;\n\n/**\n * A wrapper for a series of save/delete operations. This takes a function as\n * argument that will receive an object keeping track of the transaction. This\n * function should then make save and delete calls as necessary, passing the\n * provided transaction object as their first argument.\n */\nexport function doUpdateTransaction(updater: StorageUpdater) {\n\tconst transaction = {\n\t\tpassageIds: window.localStorage.getItem('twine-passages') ?? '',\n\t\tstoryIds: window.localStorage.getItem('twine-stories') ?? ''\n\t};\n\n\tupdater(transaction);\n\n\twindow.localStorage.setItem('twine-stories', transaction.storyIds);\n\twindow.localStorage.setItem('twine-passages', transaction.passageIds);\n}\n\n/**\n * Saves a story to local storage. This does *not* affect any child passages.\n **/\nexport function saveStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = addUnique(transaction.storyIds, story.id);\n\n\t// We have to remove the passages property before serializing the story,\n\t// as those are serialized under separate keys.\n\n\twindow.localStorage.setItem(\n\t\t`twine-stories-${story.id}`,\n\t\tJSON.stringify({...story, passages: undefined})\n\t);\n}\n\n/**\n * Deletes a story from local storage. This does *not* affect any child\n * passages. You *must* delete child passages manually.\n */\nexport function deleteStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = remove(transaction.storyIds, story.id);\n\twindow.localStorage.removeItem(`twine-stories-${story.id}`);\n}\n\n/**\n * Saves a passage to local storage.\n */\nexport function savePassage(transaction: StorageTransaction, passage: Passage) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\ttransaction.passageIds = addUnique(transaction.passageIds, passage.id);\n\twindow.localStorage.setItem(\n\t\t`twine-passages-${passage.id}`,\n\t\tJSON.stringify(passage)\n\t);\n}\n\n/**\n * Deletes a passage from local storage.\n */\nexport function deletePassage(\n\ttransaction: StorageTransaction,\n\tpassage: Passage\n) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\tdeletePassageById(transaction, passage.id);\n}\n\n/**\n * Deletes a passage from local storage by ID only.\n */\nexport function deletePassageById(\n\ttransaction: StorageTransaction,\n\tpassageId: string\n) {\n\ttransaction.passageIds = remove(transaction.passageIds, passageId);\n\twindow.localStorage.removeItem(`twine-passages-${passageId}`);\n}\n","import {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport async function load(): Promise<StoryFormatsState> {\n\tconst result: StoryFormatsState = [];\n\tconst serialized = window.localStorage.getItem('twine-storyformats');\n\n\tif (!serialized) {\n\t\treturn [];\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedFormat = window.localStorage.getItem(\n\t\t\t\t`twine-storyformats-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedFormat) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`No story format stored at twine-storyformats-${id}, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresult.push({...JSON.parse(serializedFormat), loadState: 'unloaded'});\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story format ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-storyformats-${id}`)\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import uuid from 'tiny-uuid';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport function save(state: StoryFormatsState) {\n\t// Delete existing formats in local storage, since we aren't bothering to\n\t// preserve ids.\n\n\tconst previouslySerialized = window.localStorage.getItem(\n\t\t'twine-storyformats'\n\t);\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-storyformats-${id}`);\n\t\t});\n\t}\n\n\t// Save new ones.\n\n\tlet ids: string[] = [];\n\n\tstate.forEach(format => {\n\t\tconst id = uuid();\n\n\t\t// We have to remove the `properties` property if it exists, as that is\n\t\t// dynamically added when loading.\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-storyformats-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\t...format,\n\t\t\t\tloadError: undefined,\n\t\t\t\tloadState: undefined,\n\t\t\t\tproperties: undefined,\n\t\t\t\tselected: undefined\n\t\t\t})\n\t\t);\n\t});\n\n\twindow.localStorage.setItem('twine-storyformats', ids.join(','));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {save} from './save';\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tswitch (action.type) {\n\t\tcase 'create':\n\t\tcase 'delete':\n\t\tcase 'repair':\n\t\t\tsave(state);\n\t\t\tbreak;\n\n\t\tcase 'update':\n\t\t\t// Is this a significant update?\n\t\t\tif (isPersistableStoryFormatChange(action.props)) {\n\t\t\t\tsave(state);\n\t\t\t}\n\t\t\tbreak;\n\t}\n}\n","import * as React from 'react';\nimport {useElectronIpcPersistence} from './electron-ipc/use-electron-ipc-persistence';\nimport {useLocalStoragePersistence} from './local-storage/use-local-storage-persistence';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {StoryFormatsAction, StoryFormatsState} from '../story-formats';\nimport {PrefsAction, PrefsState} from '../prefs';\n\nexport interface PersistenceHooks {\n\tprefs: {\n\t\tload: () => Promise<Partial<PrefsState>>;\n\t\tsaveMiddleware: (state: PrefsState, action: PrefsAction) => void;\n\t};\n\tstories: {\n\t\tload: () => Promise<StoriesState>;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoriesState,\n\t\t\taction: StoriesAction,\n\t\t\tformats: StoryFormatsState\n\t\t) => void;\n\t};\n\tstoryFormats: {\n\t\tload: () => Promise<StoryFormatsState>;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoryFormatsState,\n\t\t\taction: StoryFormatsAction\n\t\t) => void;\n\t};\n}\n\nexport function usePersistence(): PersistenceHooks {\n\tconst electronIpcPersistence = useElectronIpcPersistence();\n\tconst localStoragePersistence = useLocalStoragePersistence();\n\n\treturn React.useMemo(\n\t\t() =>\n\t\t\tisElectronRenderer() ? electronIpcPersistence : localStoragePersistence,\n\t\t[electronIpcPersistence, localStoragePersistence]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useElectronIpcPersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useLocalStoragePersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {colors, Color} from '../../util/color';\nimport {IconPlus, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton} from '../control/card-button';\nimport {IconButton} from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport {TextSelect} from '../control/text-select';\nimport {isValidTagName} from '../../util/tag';\nimport './add-tag-button.css';\n\nexport interface AddTagButtonProps {\n\t/**\n\t * Tags that have been assigned to this object.\n\t */\n\tassignedTags: string[];\n\t/**\n\t * Is the button disabled?\n\t */\n\tdisabled?: boolean;\n\t/**\n\t * Other tags that have been assigned to this type of object.\n\t */\n\texistingTags: string[];\n\t/**\n\t * Icon for the button.\n\t */\n\ticon?: React.ReactNode;\n\t/**\n\t * Label for the button.\n\t */\n\tlabel?: string;\n\t/**\n\t * Called when the user chooses to add a tag. If they are adding a\n\t * pre-existing tag, it will only send a name.\n\t */\n\tonAdd: (name: string, color?: Color) => void;\n}\n\nexport const AddTagButton: React.FC<AddTagButtonProps> = props => {\n\tconst {assignedTags, disabled, existingTags, icon, label, onAdd} = props;\n\tconst [creatingTag, setCreatingTag] = React.useState(true);\n\tconst [newColor, setNewColor] = React.useState<Color>('none');\n\tconst [newName, setNewName] = React.useState('');\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tlet validationMessage: string | undefined = undefined;\n\tlet canAdd = isValidTagName(newName);\n\n\tif (!canAdd && newName !== '') {\n\t\tvalidationMessage = t('components.addTagButton.invalidName');\n\t}\n\n\tif (canAdd && creatingTag) {\n\t\tcanAdd = !existingTags.includes(newName);\n\n\t\tif (!canAdd) {\n\t\t\tvalidationMessage = t('components.addTagButton.alreadyAdded');\n\t\t}\n\t}\n\n\tfunction handleAdd() {\n\t\tif (creatingTag) {\n\t\t\tonAdd(newName, newColor);\n\t\t} else {\n\t\t\tonAdd(newName);\n\t\t}\n\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleSelectChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst tagName = event.target.value;\n\n\t\tsetNewName(tagName);\n\t\tsetCreatingTag(tagName === '');\n\t}\n\n\treturn (\n\t\t<span className=\"add-tag-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={t('components.addTagButton.addLabel')}\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon={icon ?? <IconPlus />}\n\t\t\t\tlabel={label ?? t('common.tag')}\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<TextSelect\n\t\t\t\t\t\tonChange={handleSelectChange}\n\t\t\t\t\t\toptions={[\n\t\t\t\t\t\t\t{label: t('components.addTagButton.newTag'), value: ''},\n\t\t\t\t\t\t\t...existingTags.map(tag => ({\n\t\t\t\t\t\t\t\tdisabled: assignedTags.includes(tag),\n\t\t\t\t\t\t\t\tlabel: tag,\n\t\t\t\t\t\t\t\tvalue: tag\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t]}\n\t\t\t\t\t\tvalue={creatingTag ? '' : newName}\n\t\t\t\t\t>\n\t\t\t\t\t\t{t('components.addTagButton.addLabel')}\n\t\t\t\t\t</TextSelect>\n\t\t\t\t\t{creatingTag && (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<TextInput\n\t\t\t\t\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\t\t\t\t\tvalue={newName}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagNameLabel')}\n\t\t\t\t\t\t\t</TextInput>\n\t\t\t\t\t\t\t<TextSelect\n\t\t\t\t\t\t\t\tonChange={e => setNewColor(e.target.value)}\n\t\t\t\t\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\t\t\t\tvalue: color\n\t\t\t\t\t\t\t\t}))}\n\t\t\t\t\t\t\t\tvalue={newColor}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagColorLabel')}\n\t\t\t\t\t\t\t</TextSelect>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)}\n\t\t\t\t\t{creatingTag && !!validationMessage && <p>{validationMessage}</p>}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={!canAdd}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('common.add')}\n\t\t\t\t\t\tonClick={handleAdd}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {IconChevronDown} from '@tabler/icons';\nimport {MenuButton} from '../control/menu-button';\nimport {colors, Color} from '../../util/color';\nimport './tag-button.css';\n\nexport interface TagButtonProps {\n\tcolor?: Color;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonRemove: () => void;\n}\n\nexport const TagButton: React.FC<TagButtonProps> = props => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<span className={classNames('tag-button', `color-${props.color}`)}>\n\t\t\t<MenuButton\n\t\t\t\ticon={<IconChevronDown />}\n\t\t\t\ticonPosition=\"end\"\n\t\t\t\titems={[\n\t\t\t\t\t...colors.map(color => ({\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: color === 'none' ? !props.color : color === props.color,\n\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\tonClick: () => props.onChangeColor(color)\n\t\t\t\t\t})),\n\t\t\t\t\t{\n\t\t\t\t\t\tseparator: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.remove'),\n\t\t\t\t\t\tonClick: props.onRemove\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tlabel={props.name}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\n\nexport interface IconLinkProps {\n\thref: string;\n\ticon: React.ReactNode;\n\tlabel: string;\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n\ttarget?: string;\n}\n\nexport const IconLink: React.FC<IconLinkProps> = props => {\n\tconst {href, icon, label, target, variant} = props;\n\tconst className = classNames('icon-link', `variant-${variant}`);\n\n\treturn (\n\t\t<a href={href} className={className} target={target ?? '_blank'}>\n\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t{label}\n\t\t</a>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconIndentDecrease, IconIndentIncrease} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface IndentButtonsProps {\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n}\n\nexport const IndentButtons: React.FC<IndentButtonsProps> = props => {\n\tconst {editor} = props;\n\tconst {t} = useTranslation();\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentIncrease />}\n\t\t\t\tlabel={t('components.indentButtons.indent')}\n\t\t\t\tonClick={() => execCommand('indentMore')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentDecrease />}\n\t\t\t\tlabel={t('components.indentButtons.unindent')}\n\t\t\t\tonClick={() => execCommand('indentLess')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface UndoRedoButtonsProps {\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n\t/**\n\t * A change in this prop triggers a render (probably, put the editor value\n\t * here). This is necessary because the editor instance itself is mutable, so\n\t * we need some way of knowing when to re-check whether undo/redo is availble.\n\t */\n\twatch: string;\n}\n\nexport const UndoRedoButtons: React.FC<UndoRedoButtonsProps> = props => {\n\tconst {editor, watch} = props;\n\tconst {t} = useTranslation();\n\tconst [canRedo, setCanRedo] = React.useState(false);\n\tconst [canUndo, setCanUndo] = React.useState(false);\n\n\tReact.useEffect(() => {\n\t\tif (editor) {\n\t\t\tconst history = editor.historySize();\n\n\t\t\tsetCanRedo(history.redo > 0);\n\t\t\tsetCanUndo(history.undo > 0);\n\t\t} else {\n\t\t\tsetCanRedo(false);\n\t\t\tsetCanUndo(false);\n\t\t}\n\t}, [editor, watch]);\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!canUndo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={t('common.undo')}\n\t\t\t\tonClick={() => execCommand('undo')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!canRedo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={t('common.redo')}\n\t\t\t\tonClick={() => execCommand('redo')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './text-input.css';\n\nexport interface TextInputProps {\n\tonChange?: (event: React.ChangeEvent<HTMLInputElement>) => void;\n\tonInput?: (event: React.FormEvent<HTMLInputElement>) => void;\n\torientation?: 'horizontal' | 'vertical';\n\tplaceholder?: string;\n\ttype?: 'search' | 'text';\n\tvalue: string;\n}\n\nexport const TextInput: React.FC<TextInputProps> = props => {\n\tconst className = classNames(\n\t\t'text-input',\n\t\t`orientation-${props.orientation}`,\n\t\t`type-${props.type}`\n\t);\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"text-input-label\">{props.children}</span>\n\t\t\t\t<input\n\t\t\t\t\tonChange={props.onChange}\n\t\t\t\t\tonInput={props.onInput}\n\t\t\t\t\tplaceholder={props.placeholder}\n\t\t\t\t\ttype={props.type ?? 'text'}\n\t\t\t\t\tvalue={props.value}\n\t\t\t\t/>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './card.css';\n\nexport interface CardProps {\n\tfloating?: boolean;\n\thighlighted?: boolean;\n}\n\nexport const Card: React.FC<CardProps> = props => {\n\tconst {children, floating, highlighted} = props;\n\n\tconst className = classNames('card', {\n\t\tfloating,\n\t\thighlighted\n\t});\n\n\treturn <div className={className}>{children}</div>;\n};\n","import uniq from 'lodash/uniq';\nimport {Passage, StorySearchFlags, Story} from './stories.types';\nimport {createRegExp} from '../../util/regexp';\nimport {parseLinks} from '../../util/parse-links';\n\nexport function passageWithId(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageId: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.id === passageId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with ID \"${passageId}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\nexport function passageWithName(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageName: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.name === passageName);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with name \"${passageName}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\n/**\n * Returns connections between passages in a structure optimized for rendering.\n * Connections are divided between draggable and fixed, depending on whether\n * either of their passages are selected (and could be dragged by the user).\n */\nexport function passageConnections(\n\tpassages: Passage[],\n\tconnectionParser?: (text: string) => string[]\n) {\n\tconst parser = connectionParser ?? ((text: string) => parseLinks(text, true));\n\tconst passageMap = new Map(passages.map(p => [p.name, p]));\n\tconst result = {\n\t\tdraggable: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t},\n\t\tfixed: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t}\n\t};\n\n\tpassages.forEach(passage =>\n\t\tparser(passage.text).forEach(targetName => {\n\t\t\tif (targetName === passage.name) {\n\t\t\t\t(passage.selected ? result.draggable : result.fixed).self.add(passage);\n\t\t\t} else {\n\t\t\t\tconst targetPassage = passageMap.get(targetName);\n\n\t\t\t\tif (targetPassage) {\n\t\t\t\t\tconst target =\n\t\t\t\t\t\tpassage.selected || targetPassage.selected\n\t\t\t\t\t\t\t? result.draggable\n\t\t\t\t\t\t\t: result.fixed;\n\n\t\t\t\t\tif (target.connections.has(passage)) {\n\t\t\t\t\t\ttarget.connections.get(passage)!.add(targetPassage);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttarget.connections.set(passage, new Set([targetPassage]));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t(passage.selected ? result.draggable : result.fixed).broken.add(\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t);\n\n\treturn result;\n}\n\n/**\n * Returns all passages matching a search criteria. Use\n * `highlightPassageMatches()` to highlight exactly what matched.\n */\nexport function passagesMatchingSearch(\n\tpassages: Passage[],\n\tsearch: string,\n\tflags: StorySearchFlags\n): Passage[] {\n\tif (search === '') {\n\t\treturn [];\n\t}\n\n\tconst {includePassageNames, matchCase, useRegexes} = flags;\n\tlet matcher: RegExp;\n\n\ttry {\n\t\tmatcher = createRegExp(search, {matchCase, useRegexes});\n\t} catch (error) {\n\t\t// The regexp was malformed. Take no action.\n\t\treturn [];\n\t}\n\n\treturn passages.reduce((result, passage) => {\n\t\tif (\n\t\t\tmatcher.test(passage.text) ||\n\t\t\t(includePassageNames && matcher.test(passage.name))\n\t\t) {\n\t\t\treturn [...result, passage];\n\t\t}\n\n\t\treturn result;\n\t}, [] as Passage[]);\n}\n\nexport function storyPassageTags(story: Story) {\n\treturn Array.from(\n\t\tstory.passages.reduce((result, passage) => {\n\t\t\tpassage.tags && passage.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyStats(story: Story) {\n\tconst links = story.passages.reduce<string[]>(\n\t\t(links, passage) => [\n\t\t\t...links,\n\t\t\t...parseLinks(passage.text).filter(link => links.indexOf(link) === -1)\n\t\t],\n\t\t[]\n\t);\n\n\tconst brokenLinks = uniq(links).filter(\n\t\tlink => !story.passages.some(passage => passage.name === link)\n\t);\n\n\treturn {\n\t\tbrokenLinks,\n\t\tlinks,\n\t\tcharacters: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.length,\n\t\t\t0\n\t\t),\n\t\tpassages: story.passages.length,\n\t\twords: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.split(/\\s+/).length,\n\t\t\t0\n\t\t)\n\t};\n}\n\nexport function storyTags(stories: Story[]) {\n\treturn Array.from(\n\t\tstories.reduce((result, story) => {\n\t\t\tstory.tags && story.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyWithId(stories: Story[], storyId: string) {\n\tconst result = stories.find(s => s.id === storyId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with ID \"${storyId}\".`);\n}\n\nexport function storyWithName(stories: Story[], name: string) {\n\tconst result = stories.find(s => s.name === name);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with name \"${name}\".`);\n}\n","// Manages requesting a story format via URL. There are two aspects that add\n// complexity:\n//\n// - The difference between web and Electron contexts. In a web context, the app is\n//   able to make JSON requests freely. In Electron contexts, however, it is\n//   restricted to HTTP/HTTPS only. To allow users to add story formats via\n//   file:/// URL, the main process will make JSONP requests on behalf of a web\n//   process.\n//\n//   This is only needed for requests outside the app bundle (e.g. loading a locale\n//   or an external story format).\n//\n// - Throttling requests. Because all story formats load via the same global\n//   callback, we can only load one at a time safely--otherwise they will compete\n//   for the same callback.\n\nimport jsonp from 'jsonp';\nimport {TwineElectronWindow} from '../../electron/shared';\nimport {StoryFormatProperties} from '../../store/story-formats';\nimport {isElectronRenderer} from '../is-electron';\n\nlet requestQueue = Promise.resolve();\n\n/**\n * Fetches a story format's properties via JSONP. If multiple requests are made\n * at once, they will be queued by this function.\n */\nexport async function fetchStoryFormatProperties(\n\turl: string,\n\ttimeout = 2000\n): Promise<StoryFormatProperties> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst jsonpRequester =\n\t\tisElectronRenderer() && twineElectron?.jsonp ? twineElectron.jsonp : jsonp;\n\n\treturn new Promise(\n\t\t(resolve, reject) =>\n\t\t\t(requestQueue = requestQueue.then(\n\t\t\t\t() =>\n\t\t\t\t\tnew Promise(resolveQueue => {\n\t\t\t\t\t\tjsonpRequester(url, {timeout, name: 'storyFormat'}, (err, data) => {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresolve(data);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolveQueue();\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t))\n\t);\n}\n","export const builtins = () => [\n\t{\n\t\tname: 'GrowYourOwn',\n\t\turl: 'story-formats/growyourown-1.0.0/format.js',\n\t\tversion: '1.0.0'\n\t},\n\t{\n\t\tname: 'Chapbook',\n\t\turl: 'story-formats/chapbook-1.2.2/format.js',\n\t\tversion: '1.2.2'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-1.2.4/format.js',\n\t\tversion: '1.2.4'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-2.1.0/format.js',\n\t\tversion: '2.1.0'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-3.3.3/format.js',\n\t\tversion: '3.3.3'\n\t},\n\t{\n\t\tname: 'Paperthin',\n\t\turl: 'story-formats/paperthin-1.0.0/format.js',\n\t\tversion: '1.0.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-1.4.0/format.js',\n\t\tversion: '1.4.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-2.0.2/format.js',\n\t\tversion: '2.0.2',\n\t\tuserAdded: false\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-1.0.35/format.js',\n\t\tversion: '1.0.35'\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-2.36.1/format.js',\n\t\tversion: '2.36.1'\n\t}\n];\n","/**\n * Returns an unique name among an array of existing, making it unique if need\n * be by adding a number at the end.\n */\nexport function unusedName(name: string, existing: string[]): string {\n\tif (existing.includes(name)) {\n\t\tlet suffix = 1;\n\n\t\twhile (existing.includes(`${name} ${suffix}`)) {\n\t\t\tsuffix++;\n\t\t}\n\n\t\treturn `${name} ${suffix}`;\n\t}\n\n\treturn name;\n}\n","import {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../util/is-electron';\n\nexport function useStoreErrorReporter() {\n\t// We can't use suspense here because we're too high in the component tree--we\n\t// need to report errors as soon as possible, and if prefs fail, we might not\n\t// have i18n initialized.\n\n\tconst {t, ready} = useTranslation('', {useSuspense: false});\n\n\treturn {\n\t\treportError(error: Error, messageKey: string) {\n\t\t\tconsole.error('Twine store error', error);\n\n\t\t\tif (ready) {\n\t\t\t\twindow.alert(\n\t\t\t\t\tt(messageKey, {error: error.message}) +\n\t\t\t\t\t\t' ' +\n\t\t\t\t\t\tt(\n\t\t\t\t\t\t\t`store.errors.${\n\t\t\t\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t\t\t\t}Remediation`\n\t\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\twindow.alert(\n\t\t\t\t\t`An error occurred while saving (${error.message}). Reloading or restarting the application may help.`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t};\n}\n","import {EditorConfiguration} from 'codemirror';\nimport {PrefsState} from '../store/prefs';\n\n/**\n * Returns baseline CodeMirror options based on user preferences.\n */\nexport function codeMirrorOptionsFromPrefs(\n\tprefs: PrefsState\n): EditorConfiguration {\n\t// Disable overstrike mode.\n\n\tlet result: EditorConfiguration = {\n\t\textraKeys: {\n\t\t\tInsert() {}\n\t\t}\n\t};\n\n\tif (!prefs.editorCursorBlinks) {\n\t\tresult.cursorBlinkRate = 0;\n\t}\n\n\treturn result;\n}\n","// See https://stackoverflow.com/a/64174790\n\nexport const colors = [\n\t'none',\n\t'red',\n\t'orange',\n\t'yellow',\n\t'green',\n\t'blue',\n\t'purple'\n];\n\nexport type Color = typeof colors[number];\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {StorySearchFlags} from '../store/stories/stories.types';\n\n/**\n * Creates RegExps using UI-visible settings.\n */\nexport function createRegExp(\n\tsearch: string,\n\tflags: Omit<StorySearchFlags, 'includePassages'>\n) {\n\treturn new RegExp(\n\t\tflags.useRegexes ? search : escapeRegExp(search),\n\t\tflags.matchCase ? 'g' : 'gi'\n\t);\n}\n\n/**\n * Escapes replacement strings if the user didn't intend them to be regexps.\n * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace#Specifying_a_string_as_a_parameter\n */\nexport function escapeRegExpReplace(source: string) {\n\t// This implementation is a little tricky in that it needs to escape the $s\n\t// itself in the replacement.\n\n\treturn source.replace(/\\$/g, '$$$$');\n}\n","import * as React from 'react';\nimport {useScrollbarSize} from 'react-scrollbar-size';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {useDialogsContext} from '.';\nimport {usePrefsContext} from '../../store/prefs';\nimport './dialogs.css';\n\nconst DialogTransition: React.FC = props => (\n\t<CSSTransition classNames=\"pop\" timeout={200} {...props}>\n\t\t{props.children}\n\t</CSSTransition>\n);\n\nexport const Dialogs: React.FC = () => {\n\tconst {height, width} = useScrollbarSize();\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch, dialogs} = useDialogsContext();\n\n\tconst hasUnmaximized = dialogs.some(dialog => !dialog.maximized);\n\tconst containerStyle: React.CSSProperties = {\n\t\tpaddingLeft: `calc(100% - (${prefs.dialogWidth}px + 2 * (var(--grid-size))))`,\n\t\tmarginBottom: height,\n\t\tmarginRight: width\n\t};\n\tconst maximizedStyle: React.CSSProperties = {\n\t\tmarginRight: hasUnmaximized\n\t\t\t? `calc(${prefs.dialogWidth}px + var(--grid-size))`\n\t\t\t: 0\n\t};\n\n\treturn (\n\t\t<div className=\"dialogs\" style={containerStyle}>\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{dialogs.map((dialog, index) => {\n\t\t\t\t\tconst managementProps = {\n\t\t\t\t\t\tcollapsed: dialog.collapsed,\n\t\t\t\t\t\tmaximized: dialog.maximized,\n\t\t\t\t\t\tonChangeCollapsed: (collapsed: boolean) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogCollapsed', collapsed, index}),\n\t\t\t\t\t\tonChangeMaximized: (maximized: boolean) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogMaximized', maximized, index}),\n\t\t\t\t\t\tonClose: () => dispatch({type: 'removeDialog', index})\n\t\t\t\t\t};\n\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<DialogTransition key={index}>\n\t\t\t\t\t\t\t{dialog.maximized ? (\n\t\t\t\t\t\t\t\t<div className=\"maximized\" style={maximizedStyle}>\n\t\t\t\t\t\t\t\t\t<dialog.component {...dialog.props} {...managementProps} />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<dialog.component {...dialog.props} {...managementProps} />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</DialogTransition>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</TransitionGroup>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {TagColors} from '../../store/stories';\nimport './tag-stripe.css';\n\nexport interface TagStripeProps {\n\ttagColors: TagColors;\n\ttags: string[];\n}\n\nexport const TagStripe: React.FC<TagStripeProps> = React.memo(props => {\n\treturn (\n\t\t<div className=\"tag-stripe\">\n\t\t\t{props.tags.map(tag => (\n\t\t\t\t<span\n\t\t\t\t\tclassName={`color-${props.tagColors[tag]}`}\n\t\t\t\t\tkey={tag}\n\t\t\t\t\ttitle={tag}\n\t\t\t\t/>\n\t\t\t))}\n\t\t</div>\n\t);\n});\n\nTagStripe.displayName = 'TagStripe';\n","import * as React from 'react';\nimport isEqual from 'lodash/isEqual';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport const reducer: React.Reducer<DialogsState, DialogsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'addDialog':\n\t\t\t// If the dialog has been previously added, expand it. Otherwise, add it\n\t\t\t// to the end.\n\n\t\t\tlet exists = false;\n\t\t\tconst editedState = state.map(stateDialog => {\n\t\t\t\tif (\n\t\t\t\t\tisEqual(stateDialog, {\n\t\t\t\t\t\t// Ignore collapsed and maximized properties for comparison.\n\t\t\t\t\t\tcollapsed: stateDialog.collapsed,\n\t\t\t\t\t\tcomponent: action.component,\n\t\t\t\t\t\tmaximized: stateDialog.maximized,\n\t\t\t\t\t\tprops: action.props\n\t\t\t\t\t})\n\t\t\t\t) {\n\t\t\t\t\texists = true;\n\t\t\t\t\treturn {...stateDialog, collapsed: false};\n\t\t\t\t}\n\n\t\t\t\treturn stateDialog;\n\t\t\t});\n\n\t\t\tif (exists) {\n\t\t\t\treturn editedState;\n\t\t\t}\n\n\t\t\treturn [\n\t\t\t\t...state,\n\t\t\t\t{\n\t\t\t\t\tcollapsed: false,\n\t\t\t\t\tcomponent: action.component,\n\t\t\t\t\tmaximized: false,\n\t\t\t\t\tprops: action.props\n\t\t\t\t}\n\t\t\t];\n\n\t\tcase 'removeDialog':\n\t\t\treturn state.filter((dialog, index) => index !== action.index);\n\n\t\tcase 'setDialogCollapsed':\n\t\t\treturn state.map((dialog, index) =>\n\t\t\t\tindex === action.index\n\t\t\t\t\t? {...dialog, collapsed: action.collapsed}\n\t\t\t\t\t: dialog\n\t\t\t);\n\n\t\tcase 'setDialogMaximized':\n\t\t\treturn state.map((dialog, index) => ({\n\t\t\t\t...dialog,\n\t\t\t\tmaximized: index === action.index ? action.maximized : false\n\t\t\t}));\n\t}\n};\n","import * as React from 'react';\nimport useThunkReducer, {Thunk} from 'react-hook-thunk-reducer';\nimport {reducer} from './reducer';\nimport {Dialogs} from './dialogs';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport interface DialogsContextProps {\n\tdispatch: React.Dispatch<DialogsAction | Thunk<DialogsState, DialogsAction>>;\n\tdialogs: DialogsState;\n}\n\nexport const DialogsContext = React.createContext<DialogsContextProps>({\n\tdispatch: () => {},\n\tdialogs: []\n});\n\nDialogsContext.displayName = 'Dialogs';\n\nexport const useDialogsContext = () => React.useContext(DialogsContext);\n\nexport const DialogsContextProvider: React.FC = props => {\n\tconst [dialogs, dispatch] = useThunkReducer(reducer, []);\n\n\treturn (\n\t\t<DialogsContext.Provider value={{dispatch, dialogs}}>\n\t\t\t{props.children}\n\t\t\t<Dialogs />\n\t\t</DialogsContext.Provider>\n\t);\n};\n","// Handles importing HTML source code into story objects ready to be saved to\n// the store. This works on both published story files and archives.\n//\n// It's important that this code be as efficient as possible, as it directly\n// affects startup time in the Twine desktop app. This module moves data from\n// the filesystem into local storage, and the app can't begin until it's done.\n\nimport defaults from 'lodash/defaults';\nimport uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults, Passage, Story} from '../store/stories';\n\n/**\n * An imported story, which may contain incomplete or malformed data.\n */\nexport interface ImportedStory extends Omit<Partial<Story>, 'passages'> {\n\tpassages: Partial<Passage>[];\n}\n\n/**\n * HTML selectors used to find data in HTML format.\n */\nconst selectors = {\n\tpassage: 'tw-passage',\n\tstory: 'tw-story',\n\tscript: '[role=script]',\n\tstylesheet: '[role=stylesheet]',\n\tstoryData: 'tw-storydata',\n\ttagColors: 'tw-tag',\n\tpassageData: 'tw-passagedata'\n};\n\n/**\n * Convenience function to convert a string value to an float.\n */\nfunction float(stringValue: string) {\n\treturn parseFloat(stringValue);\n}\n\n/**\n * Convenience function to query an element by a selector.\n */\nfunction query(el: Element, selector: string) {\n\treturn Array.from(el.querySelectorAll(selector));\n}\n\n/**\n * Convenience function to parse a string like \"100,50\".\n */\nfunction parseDimensions(raw: any): [string, string] | undefined {\n\tif (typeof raw !== 'string') {\n\t\treturn undefined;\n\t}\n\n\tconst bits = raw.split(',');\n\n\tif (bits.length === 2) {\n\t\treturn [bits[0], bits[1]];\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Converts a DOM <tw-storydata> element to a story object matching the format\n * in the store. This *may* be missing data, or data it returns may be\n * malformed. This function does its best to reflect the contents of the\n * element.\n */\nfunction domToObject(storyEl: Element): ImportedStory {\n\tconst startPassagePid = storyEl.getAttribute('startnode');\n\tlet startPassageId: string | undefined = undefined;\n\tconst story: ImportedStory = {\n\t\tifid: storyEl.getAttribute('ifid') ?? uuid(),\n\t\tid: uuid(),\n\t\tlastUpdate: undefined,\n\t\tname: storyEl.getAttribute('name') ?? undefined,\n\t\tstoryFormat: storyEl.getAttribute('format') ?? undefined,\n\t\tstoryFormatVersion: storyEl.getAttribute('format-version') ?? undefined,\n\t\tscript: query(storyEl, selectors.script)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\tstylesheet: query(storyEl, selectors.stylesheet)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\ttags: storyEl.getAttribute('tags')\n\t\t\t? storyEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t: [],\n\t\tzoom: parseFloat(storyEl.getAttribute('zoom') ?? '1'),\n\t\ttagColors: query(storyEl, selectors.tagColors).reduce((result, el) => {\n\t\t\tconst tagName = el.getAttribute('name');\n\n\t\t\tif (typeof tagName !== 'string') {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn {...result, [tagName]: el.getAttribute('color')};\n\t\t}, {}),\n\t\tpassages: query(storyEl, selectors.passageData).map(passageEl => {\n\t\t\tconst id = uuid();\n\t\t\tconst position = parseDimensions(passageEl.getAttribute('position'));\n\t\t\tconst size = parseDimensions(passageEl.getAttribute('size'));\n\n\t\t\tif (passageEl.getAttribute('pid') === startPassagePid) {\n\t\t\t\tstartPassageId = id;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid,\n\t\t\t\tleft: position ? float(position[0]) : undefined,\n\t\t\t\ttop: position ? float(position[1]) : undefined,\n\t\t\t\twidth: size ? float(size[0]) : undefined,\n\t\t\t\theight: size ? float(size[1]) : undefined,\n\t\t\t\ttags: passageEl.getAttribute('tags')\n\t\t\t\t\t? passageEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t\t\t: [],\n\t\t\t\tname: passageEl.getAttribute('name') ?? undefined,\n\t\t\t\ttext: passageEl.textContent ?? undefined\n\t\t\t};\n\t\t})\n\t};\n\n\tstory.startPassage = startPassageId;\n\treturn story;\n}\n\n/**\n * Imports stories from HTML. If there are any missing attributes in the HTML,\n * defaults will be applied.\n */\nexport function importStories(\n\thtml: string,\n\tlastUpdateOverride?: Date\n): Story[] {\n\tconst nodes = document.createElement('div');\n\n\tnodes.innerHTML = html;\n\n\treturn query(nodes, selectors.storyData).map(storyEl => {\n\t\tconst importedStory = domToObject(storyEl);\n\n\t\t// Merge in defaults. We can't use object spreads here because undefined\n\t\t// values would override defaults.\n\n\t\tconst story: Story = defaults(importedStory, {id: uuid()}, storyDefaults());\n\n\t\t// Override the last update as requested.\n\n\t\tif (lastUpdateOverride) {\n\t\t\tstory.lastUpdate = lastUpdateOverride;\n\t\t}\n\n\t\t// Merge in passage defaults. We don't need to set ID here--domToObject did\n\t\t// this for us.\n\n\t\tstory.passages = story.passages.map(passage =>\n\t\t\tdefaults(passage, passageDefaults(), {story: story.id})\n\t\t);\n\n\t\treturn story;\n\t});\n}\n","import * as React from 'react';\nimport {Card, CardProps} from './card/card';\nimport './button-card.css';\n\nexport const ButtonCard: React.FC<CardProps> = props => (\n\t<div className=\"button-card\">\n\t\t<Card {...props} />\n\t</div>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {Passage, Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\nconst DisabledRenamePassageButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\nexport interface EnabledRenamePassageButtonProps {\n\tonRename: (value: string) => void;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const EnabledRenamePassageButton: React.FC<EnabledRenamePassageButtonProps> = props => {\n\tconst {onRename, passage, story} = props;\n\tconst [newName, setNewName] = React.useState(passage.name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (story.passages.some(p => p.id !== passage.id && p.name === name)) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: passage.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenamePassageButtonProps\n\textends Omit<EnabledRenamePassageButtonProps, 'passage'> {\n\tpassage?: Passage;\n}\n\nexport const RenamePassageButton: React.FC<RenamePassageButtonProps> = props => {\n\tif (props.passage) {\n\t\treturn (\n\t\t\t<EnabledRenamePassageButton\n\t\t\t\t{...(props as EnabledRenamePassageButtonProps)}\n\t\t\t/>\n\t\t);\n\t}\n\n\treturn <DisabledRenamePassageButton />;\n};","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\nexport function useComputedTheme() {\n\t// See https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia\n\n\tconst {prefs} = usePrefsContext();\n\tconst [mediaQuery] = React.useState(\n\t\twindow.matchMedia('(prefers-color-scheme: dark)')\n\t);\n\tconst [systemTheme, setSystemTheme] = React.useState<'dark' | 'light'>(\n\t\tmediaQuery.matches ? 'dark' : 'light'\n\t);\n\n\tReact.useEffect(() => {\n\t\tconst listener = (event: MediaQueryListEvent) =>\n\t\t\tsetSystemTheme(event.matches ? 'dark' : 'light');\n\n\t\tmediaQuery.addEventListener('change', listener);\n\t\treturn () => mediaQuery.removeEventListener('change', listener);\n\t}, [mediaQuery]);\n\n\treturn prefs.appTheme === 'system' ? systemTheme : prefs.appTheme;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport classNames from 'classnames';\nimport {IconWriting} from '@tabler/icons';\nimport {colors, Color} from '../../util/color';\nimport {PromptButton, PromptValidationResponse} from '../control/prompt-button';\nimport {TextSelect} from '../control/text-select';\nimport './tag-editor.css';\n\nexport interface TagEditorProps {\n\tallTags: string[];\n\tcolor?: Color;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonChangeName: (name: string) => void;\n}\n\nexport const TagEditor: React.FC<TagEditorProps> = props => {\n\tconst {allTags, color, name, onChangeColor, onChangeName} = props;\n\tconst [newName, setNewName] = React.useState(name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(value: string): PromptValidationResponse {\n\t\tif (value !== name && allTags.includes(value)) {\n\t\t\treturn {message: t('components.tagEditor.alreadyExists'), valid: false};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<div className=\"tag-editor\">\n\t\t\t<span className={classNames('tag-name', `color-${props.color}`)}>\n\t\t\t\t{props.name}\n\t\t\t</span>\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconWriting />}\n\t\t\t\tlabel={t('common.rename')}\n\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\tonSubmit={() => onChangeName(newName)}\n\t\t\t\tprompt={t('common.renamePrompt', {name})}\n\t\t\t\tvalue={newName}\n\t\t\t\tvalidate={validate}\n\t\t\t/>\n\t\t\t<TextSelect\n\t\t\t\tonChange={e => onChangeColor(e.target.value)}\n\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\tvalue: color\n\t\t\t\t}))}\n\t\t\t\tvalue={color ?? ''}\n\t\t\t>\n\t\t\t\t{t('common.color')}\n\t\t\t</TextSelect>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport './meter.css';\n\nexport interface MeterProps {\n\tdomId: string;\n\tpercent: number;\n}\n\nexport const Meter: React.FC<MeterProps> = ({children, domId, percent}) => {\n\treturn (\n\t\t<div\n\t\t\tclassName=\"meter\"\n\t\t\tid={domId}\n\t\t\trole=\"meter\"\n\t\t\taria-labelledby={`${domId}-label`}\n\t\t\taria-valuemin={0}\n\t\t\taria-valuemax={100}\n\t\t\taria-valuenow={percent * 100}\n\t\t>\n\t\t\t<div className=\"meter-bar\">\n\t\t\t\t<span className=\"filled\" style={{width: percent * 100 + '%'}}></span>\n\t\t\t</div>\n\t\t\t<div className=\"meter-label\" id={`${domId}-label`}>\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","// Initiates story format loading, optionally showing a progress meter while it works.\n\nimport * as React from 'react';\nimport {Meter} from '../components/meter';\nimport {\n\tloadAllFormatProperties,\n\tuseStoryFormatsContext,\n\tStoryFormat\n} from './story-formats';\n\nexport interface FormatLoaderProps {\n\tblock?: boolean;\n}\n\nexport const FormatLoader: React.FC<FormatLoaderProps> = ({\n\tblock,\n\tchildren\n}) => {\n\tconst [seenFormats, setSeenFormats] = React.useState<StoryFormat[]>([]);\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\n\t// We can't directly use formats in an effect because it will change as\n\t// loading takes place. Instead, we need to maintain a list of formats to load\n\t// that only ever changes if new formats appear in state.\n\n\tReact.useEffect(() => {\n\t\tconst newFormats = formats.filter(\n\t\t\tnewFormat =>\n\t\t\t\t!seenFormats.find(\n\t\t\t\t\toldFormat =>\n\t\t\t\t\t\toldFormat.name === newFormat.name &&\n\t\t\t\t\t\toldFormat.version === newFormat.version\n\t\t\t\t)\n\t\t);\n\n\t\tif (newFormats.length > 0) {\n\t\t\tdispatch(loadAllFormatProperties(newFormats));\n\t\t\tsetSeenFormats([...seenFormats, ...newFormats]);\n\t\t}\n\t}, [dispatch, formats, seenFormats]);\n\n\tconst loadingFormat = formats.find(f => f.loadState === 'loading');\n\tconst loadPercent =\n\t\tformats.filter(f => f.loadState === 'loaded').length / formats.length;\n\n\tif (block && loadPercent < 1) {\n\t\treturn (\n\t\t\t<Meter domId=\"story-format-loader\" percent={loadPercent}>\n\t\t\t\t{loadingFormat && (\n\t\t\t\t\t<>\n\t\t\t\t\t\tLoading {loadingFormat.name} {loadingFormat.version}\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</Meter>\n\t\t);\n\t}\n\n\treturn <>{children}</>;\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {Color} from '../../util/color';\n\nexport function setPref(\n\tname: keyof PrefsState,\n\tvalue:\n\t\t| boolean\n\t\t| number\n\t\t| string\n\t\t| {name: string; version: string}\n\t\t| {name: string; version: string}[]\n\t\t| Record<string, Color>\n): PrefsAction {\n\treturn {type: 'update', name, value};\n}\n","import {PrefsState} from './prefs.types';\n\n/**\n * Returns whether the user has disabled editor extensions for a story format.\n */\nexport function formatEditorExtensionsDisabled(\n\tprefs: PrefsState,\n\tname: string,\n\tversion: string\n) {\n\treturn prefs.disabledStoryFormatEditorExtensions.some(\n\t\tf => f.name === name && f.version === version\n\t);\n}\n","import {Story} from '../../store/stories/stories.types';\n\n/**\n * Returns a filename for a story object that's guaranteed to be safe across all\n * platforms. For this, we use POSIX's definition\n * (http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap03.html#tag_03_276)\n * with the addition of spaces, for legibility.\n */\nexport function storyFileName(story: Story) {\n\treturn story.name.replace(/[^\\w. -]/g, '_') + '.html';\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoryFormatsState} from '.';\nimport {fetchStoryFormatProperties} from '../../util/story-format/fetch-properties';\nimport {\n\tStoryFormat,\n\tStoryFormatProperties,\n\tStoryFormatsAction,\n\tStoryFormatsDispatch\n} from './story-formats.types';\n\n/**\n * Creates a new story format based on properties (probably loaded externally).\n */\nexport function createFromProperties(\n\turl: string,\n\tproperties: StoryFormatProperties\n): StoryFormatsAction {\n\tif (!properties.name || !properties.version) {\n\t\tthrow new Error('Missing required properties for a new story format');\n\t}\n\n\treturn {\n\t\ttype: 'create',\n\t\tprops: {\n\t\t\turl,\n\t\t\tname: properties.name,\n\t\t\tselected: false,\n\t\t\tuserAdded: true,\n\t\t\tversion: properties.version\n\t\t}\n\t};\n}\n\n/**\n * Deletes a story format.\n */\nexport function deleteFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'delete', id: format.id};\n}\n\n/**\n * Deselects all formats.\n */\nexport function deselectAllFormats(): Thunk<StoryFormat[], StoryFormatsAction> {\n\treturn (dispatch, getFormats) => {\n\t\tfor (const format of getFormats()) {\n\t\t\tif (format.selected) {\n\t\t\t\tdispatch({type: 'update', id: format.id, props: {selected: false}});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single format.\n */\nexport function deselectFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'update', id: format.id, props: {selected: false}};\n}\n\nasync function loadFormatThunk(\n\tformat: StoryFormat,\n\tdispatch: StoryFormatsDispatch\n) {\n\tdispatch({\n\t\ttype: 'update',\n\t\tid: format.id,\n\t\tprops: {loadState: 'loading'}\n\t});\n\n\ttry {\n\t\tlet properties = await fetchStoryFormatProperties(format.url);\n\n\t\t// If the format contains a `hydrate` property, try running it and merge in\n\t\t// properties that function creates by modifiying what's bound to its\n\t\t// `this`. This allows creation of properties that can't be serialized to\n\t\t// JSON on the format. The hydrate function cannot override properties\n\t\t// already present in the format properties, e.g. to change its source.\n\n\t\tif (properties.hydrate) {\n\t\t\ttry {\n\t\t\t\tconst hydrateResult: Partial<StoryFormatProperties> = {};\n\n\t\t\t\t// eslint-disable-next-line no-new-func\n\t\t\t\tconst hydrateFunc = new Function(properties.hydrate);\n\n\t\t\t\thydrateFunc.call(hydrateResult);\n\t\t\t\tproperties = {...hydrateResult, ...properties};\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Format ${format.id} has a hydrate property but it threw an error when called`,\n\t\t\t\t\te\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {properties, loadState: 'loaded'}\n\t\t});\n\n\t\treturn properties;\n\t} catch (loadError) {\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {loadError: (loadError as unknown) as Error, loadState: 'error'}\n\t\t});\n\t}\n}\n\n/**\n * Loads all format properties. If loading previously failed, this will try\n * again.\n */\nexport function loadAllFormatProperties(\n\tformats: StoryFormat[]\n): Thunk<StoryFormat[], StoryFormatsAction> {\n\tconst toLoad = formats.filter(\n\t\tf => f.loadState !== 'loaded' && f.loadState !== 'loading'\n\t);\n\n\tif (!toLoad) {\n\t\treturn () => {};\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) => {\n\t\tawait Promise.allSettled(\n\t\t\ttoLoad.map(format => loadFormatThunk(format, dispatch))\n\t\t);\n\t};\n}\n\n/**\n * Loads a format's properties. If loading previously failed, this function will\n * try again. This returns a thunk which in turns returns a promise resolving to\n * the format properties, which can be useful if you need them immediately.\n */\nexport function loadFormatProperties(format: StoryFormat) {\n\tif (format.loadState === 'loaded') {\n\t\treturn () => format.properties;\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) =>\n\t\tawait loadFormatThunk(format, dispatch);\n}\n\n/**\n * Selects a single format.\n */\nexport function selectFormat(\n\tformat: StoryFormat,\n\texclusive?: boolean\n): Thunk<StoryFormatsState, StoryFormatsAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!format.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'update',\n\t\t\t\tid: format.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== format.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\tid: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}","import isAbsoluteUrl from 'is-absolute-url';\nimport semverLt from 'semver/functions/lt';\nimport {StoryFormat} from './story-formats.types';\nimport {PrefsState} from '../prefs';\nimport {gt} from 'semver';\n\nexport function filteredFormats(\n\tformats: StoryFormat[],\n\tfilter: PrefsState['storyFormatListFilter']\n): StoryFormat[] {\n\tswitch (filter) {\n\t\tcase 'all':\n\t\t\treturn formats;\n\n\t\tcase 'current':\n\t\t\treturn Object.values(\n\t\t\t\tformats.reduce<Record<string, StoryFormat>>((result, format) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!result[format.name] ||\n\t\t\t\t\t\tsemverLt(result[format.name].version, format.version)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn {...result, [format.name]: format};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t}, {})\n\t\t\t);\n\n\t\tcase 'user':\n\t\t\treturn formats.filter(format => format.userAdded);\n\t}\n}\n\nexport function formatImageUrl(format: StoryFormat) {\n\tif (format.loadState !== 'loaded' || !format.properties.image) {\n\t\tthrow new Error('Format has no image property');\n\t}\n\n\tif (isAbsoluteUrl(format.properties.image)) {\n\t\treturn format.properties.image;\n\t}\n\n\treturn format.url.replace(/\\/[^/]*?$/, '/') + format.properties.image;\n}\n\nexport function formatWithId(formats: StoryFormat[], id: string) {\n\tconst result = formats.find(f => f.id === id);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story format with ID \"${id}\".`);\n}\n\nexport function formatWithNameAndVersion(\n\tformats: StoryFormat[],\n\tname: string,\n\tversion: string\n) {\n\tconst result = formats.find(f => f.name === name && f.version === version);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no story format with name \"${name}\" and version \"${version}\".`\n\t);\n}\n\nexport function newestFormatNamed(formats: StoryFormat[], name: string) {\n\treturn formats.reduce<StoryFormat | undefined>((result, format) => {\n\t\tif (format.name !== name) {\n\t\t\treturn result;\n\t\t}\n\n\t\tif (!result || gt(format.version, result.version)) {\n\t\t\treturn format;\n\t\t}\n\n\t\treturn result;\n\t}, undefined);\n}\n\nexport function sortFormats(formats: StoryFormat[]) {\n\treturn formats.sort((a, b) => {\n\t\t// First sort by name ascending...\n\n\t\tif (a.name < b.name) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (a.name > b.name) {\n\t\t\treturn 1;\n\t\t}\n\n\t\t// ... then by version, in descending order.\n\n\t\tif (a.version === b.version) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (semverLt(b.version, a.version)) {\n\t\t\treturn -1;\n\t\t}\n\n\t\treturn 1;\n\t});\n}\n","import {IconHeart, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {IconButton} from '../components/control/icon-button';\nimport {IconLink} from '../components/control/icon-link';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {DialogComponentProps} from './dialogs.types';\n\nexport const AppDonationDialog: React.FC<DialogComponentProps> = props => {\n\tconst {dispatch} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => dispatch(setPref('donateShown', true)), [dispatch]);\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-donation-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appDonation.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<div className=\"text\">\n\t\t\t\t\t<p>{t('dialogs.appDonation.supportMessage')}</p>\n\t\t\t\t\t<p>{t('dialogs.appDonation.onlyOnce')}</p>\n\t\t\t\t</div>\n\t\t\t</CardContent>\n\t\t\t<ButtonBar>\n\t\t\t\t<IconLink\n\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.donate')}\n\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.noThanks')}\n\t\t\t\t\tonClick={props.onClose}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {\n\tsetTagColor,\n\tstoryWithId,\n\trenamePassageTag,\n\tstoryPassageTags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport interface PassageTagsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const PassageTagsDialog: React.FC<PassageTagsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tconst story = storyWithId(stories, storyId);\n\tconst tags = storyPassageTags(story);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tdispatch(\n\t\t\tsetTagColor(story, tagName, color),\n\t\t\tt('undoChange.changeTagColor')\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tdispatch(\n\t\t\trenamePassageTag(story, tagName, newName),\n\t\t\tt('undoChange.renameTag')\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"passage-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.passageTags.title')}\n\t\t\t{...other}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.passageTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-javascript.css';\n\nexport interface StoryJavaScriptDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryJavaScriptDialog: React.FC<StoryJavaScriptDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {script: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-javascript-dialog\"\n\t\t\theaderLabel={t('dialogs.storyJavaScript.title')}\n\t\t\tmaximizable\n\t\t>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyJavaScript.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tlineWrapping: true,\n\t\t\t\t\t\tmode: 'javascript',\n\t\t\t\t\t\tplaceholder: t('dialogs.storyJavaScript.explanation')\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.script}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import {debounce} from 'lodash';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconReplace} from '@tabler/icons';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {CodeArea} from '../components/control/code-area';\nimport {IconButton} from '../components/control/icon-button';\nimport {\n\thighlightPassagesMatchingSearch,\n\tpassagesMatchingSearch,\n\treplaceInStory,\n\tstoryWithId,\n\tStorySearchFlags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-search.css';\n\n// See https://github.com/codemirror/CodeMirror/issues/5444\n\nconst ignoreTab: any = {\n\tTab: false,\n\t'Shift-Tab': false\n};\n\nexport interface StorySearchDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StorySearchDialog: React.FC<StorySearchDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [flags, setFlags] = React.useState<StorySearchFlags>({\n\t\tincludePassageNames: true,\n\t\tmatchCase: false,\n\t\tuseRegexes: false\n\t});\n\tconst [replace, setReplace] = React.useState('');\n\tconst [find, setFind] = React.useState('');\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst debouncedDispatch = React.useMemo(\n\t\t() => debounce(dispatch, 250),\n\t\t[dispatch]\n\t);\n\tconst {t} = useTranslation();\n\n\tconst story = storyWithId(stories, storyId);\n\tconst matches = passagesMatchingSearch(story.passages, find, flags);\n\n\tReact.useEffect(() => {\n\t\tdebouncedDispatch(highlightPassagesMatchingSearch(story, find, flags));\n\n\t\treturn () =>\n\t\t\tdebouncedDispatch(highlightPassagesMatchingSearch(story, '', {}));\n\t}, [debouncedDispatch, find, flags, story]);\n\n\tfunction handleReplaceWithChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetReplace(text);\n\t}\n\n\tfunction handleSearchForChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetFind(text);\n\t}\n\n\tfunction handleReplace() {\n\t\tdispatch(\n\t\t\treplaceInStory(story, find, replace, flags),\n\t\t\t'undoChange.replaceAllText'\n\t\t);\n\t}\n\n\tfunction toggleFlag(name: keyof StorySearchFlags) {\n\t\tsetFlags(flags => ({...flags, [name]: !flags[name]}));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-search-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storySearch.title')}\n\t\t>\n\t\t\t<div className=\"search-fields\">\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.find')}\n\t\t\t\t\tonBeforeChange={handleSearchForChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\textraKeys: ignoreTab,\n\t\t\t\t\t\tmode: 'text'\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={find}\n\t\t\t\t/>\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceWith')}\n\t\t\t\t\tonBeforeChange={handleReplaceWithChange}\n\t\t\t\t\toptions={{extraKeys: ignoreTab, mode: 'text'}}\n\t\t\t\t\tvalue={replace}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-flags\">\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.includePassageNames')}\n\t\t\t\t\tonChange={() => toggleFlag('includePassageNames')}\n\t\t\t\t\tvalue={flags.includePassageNames ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.matchCase')}\n\t\t\t\t\tonChange={() => toggleFlag('matchCase')}\n\t\t\t\t\tvalue={flags.matchCase ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.useRegexes')}\n\t\t\t\t\tonChange={() => toggleFlag('useRegexes')}\n\t\t\t\t\tvalue={flags.useRegexes ?? false}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-results\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={matches.length === 0}\n\t\t\t\t\ticon={<IconReplace />}\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceAll')}\n\t\t\t\t\tonClick={handleReplace}\n\t\t\t\t\tvariant=\"danger\"\n\t\t\t\t/>\n\t\t\t\t<span>\n\t\t\t\t\t{find &&\n\t\t\t\t\t\t(matches.length > 0\n\t\t\t\t\t\t\t? t('dialogs.storySearch.matchCount', {count: matches.length})\n\t\t\t\t\t\t\t: t('dialogs.storySearch.noMatches'))}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-stylesheet.css';\n\nexport interface StoryStylesheetDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryStylesheetDialog: React.FC<StoryStylesheetDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {stylesheet: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-stylesheet-dialog\"\n\t\t\theaderLabel={t('dialogs.storyStylesheet.title')}\n\t\t\tmaximizable\n\t\t>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyStylesheet.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tlineWrapping: true,\n\t\t\t\t\t\tmode: 'css',\n\t\t\t\t\t\tplaceholder: t('dialogs.storyStylesheet.explanation')\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.stylesheet}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {renameStoryTag, storyTags} from '../store/stories';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport type StoryTagsDialogProps = DialogComponentProps;\n\nexport const StoryTagsDialog: React.FC<StoryTagsDialogProps> = props => {\n\tconst {dispatch: storiesDispatch, stories} = useUndoableStoriesContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst tags = storyTags(stories);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {...prefs.storyTagColors, [tagName]: color})\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tstoriesDispatch(renameStoryTag(stories, tagName, newName));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"story-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyTags.title')}\n\t\t\t{...props}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={prefs.storyTagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.storyTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreatePassagesAction,\n\tPassage,\n\tStoriesState,\n\tStory\n} from '../stories.types';\nimport {passageDefaults} from '../defaults';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {parseLinks} from '../../../util/parse-links';\n\n/**\n * Creates newly linked passages from a passage. You shouldn't need to call this\n * directly--it will be invoked automatically by updatePassage() if you change\n * the passage text.\n */\nexport function createNewlyLinkedPassages(\n\tstory: Story,\n\tpassage: Passage,\n\tnewText: string,\n\toldText: string\n): Thunk<StoriesState, CreatePassagesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn dispatch => {\n\t\tconst oldLinks = parseLinks(oldText);\n\t\tconst toCreate = parseLinks(newText).filter(\n\t\t\tl => !oldLinks.includes(l) && !story.passages.some(p => p.name === l)\n\t\t);\n\n\t\tif (toCreate.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst passageDefs = passageDefaults();\n\t\tconst passageGap = 25;\n\n\t\tlet top = passage.top + passage.height + passageGap;\n\t\tconst newPassagesWidth =\n\t\t\ttoCreate.length * passageDefs.width + (toCreate.length - 1) * passageGap;\n\n\t\t// Horizontally center the passages.\n\n\t\tlet left = passage.left + (passage.width - newPassagesWidth) / 2;\n\n\t\t// Move them to avoid overlaps.\n\n\t\tconst needsMoving = () =>\n\t\t\tstory.passages.some(passage =>\n\t\t\t\trectsIntersect(passage, {\n\t\t\t\t\tleft,\n\t\t\t\t\ttop,\n\t\t\t\t\theight: passageDefs.height,\n\t\t\t\t\twidth: newPassagesWidth\n\t\t\t\t})\n\t\t\t);\n\n\t\twhile (needsMoving()) {\n\t\t\t// Try rightward.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Try leftward.\n\n\t\t\tleft -= 2 * (passageDefs.width + passageGap);\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Move downward and try again.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\t\t\ttop += passageDefs.height + passageGap;\n\t\t}\n\n\t\t// Actually create them.\n\n\t\tdispatch({\n\t\t\ttype: 'createPassages',\n\t\t\tstoryId: story.id,\n\t\t\tprops: toCreate.map(name => {\n\t\t\t\tconst result = {left, name, top};\n\n\t\t\t\tleft += passageDefs.width + passageGap;\n\t\t\t\treturn result;\n\t\t\t})\n\t\t});\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport uuid from 'tiny-uuid';\nimport {PrefsState} from '../../prefs';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\n\n/**\n * Creates a new story with the default story format.\n */\nexport function createStory(\n\tstories: Story[],\n\tprefs: PrefsState,\n\tprops: Partial<Omit<Story, 'id'>> & Pick<Story, 'name'>\n): Thunk<StoriesState, StoriesAction> {\n\tconst id = uuid();\n\n\tif (props.name.trim() === '') {\n\t\tthrow new Error('Story name cannot be empty');\n\t}\n\n\tif (\n\t\tstories.some(story => story.name.toLowerCase() === props.name.toLowerCase())\n\t) {\n\t\tthrow new Error(`There is already a story named \"${props.name}\"`);\n\t}\n\n\treturn dispatch => {\n\t\tdispatch({\n\t\t\ttype: 'createStory',\n\t\t\tprops: {\n\t\t\t\tid,\n\t\t\t\tstoryFormat: prefs.storyFormat.name,\n\t\t\t\tstoryFormatVersion: prefs.storyFormat.version,\n\t\t\t\t...props\n\t\t\t}\n\t\t});\n\n\t\treturn id;\n\t};\n}\n","import {passageDefaults} from '../defaults';\nimport {CreatePassageAction, Story} from '../stories.types';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a new, untitled passage centered at a point in the story. This\n * automatically increments a number at the end of the passage name to ensure\n * it's unique.\n */\nexport function createUntitledPassage(\n\tstory: Story,\n\tcenterX: number,\n\tcenterY: number\n): CreatePassageAction {\n\tif (!Number.isFinite(centerX) || !Number.isFinite(centerY)) {\n\t\tthrow new Error('Center must be a finite coordinate pair');\n\t}\n\n\tconst defs = passageDefaults();\n\tconst passageName = unusedName(\n\t\tdefs.name,\n\t\tstory.passages.map(passage => passage.name)\n\t);\n\n\t// Center it at the position requested, but move it outward until no overlaps are found.\n\n\tconst passageGap = 25;\n\tconst bounds = {\n\t\theight: defs.height,\n\t\tleft: Math.max(centerX - defs.width / 2, 0),\n\t\ttop: Math.max(centerY - defs.height / 2, 0),\n\t\twidth: defs.width\n\t};\n\n\tif (story.snapToGrid) {\n\t\tbounds.left = Math.round(bounds.left / passageGap) * passageGap;\n\t\tbounds.top = Math.round(bounds.top / passageGap) * passageGap;\n\t}\n\n\tconst needsMoving = () =>\n\t\tstory.passages.some(passage => rectsIntersect(passage, bounds));\n\n\twhile (needsMoving()) {\n\t\t// Try rightward.\n\n\t\tbounds.left += bounds.width + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try downward.\n\n\t\tbounds.left -= bounds.width + passageGap;\n\t\tbounds.top += bounds.height + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try leftward.\n\n\t\tif (bounds.left >= bounds.width + passageGap) {\n\t\t\tbounds.left -= bounds.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tbounds.left += bounds.width + passageGap;\n\t\t}\n\n\t\t// Move downward permanently and repeat.\n\n\t\tbounds.top += bounds.height + passageGap;\n\t}\n\n\treturn {\n\t\ttype: 'createPassage',\n\t\tstoryId: story.id,\n\t\tprops: {\n\t\t\t...bounds,\n\t\t\tstory: story.id,\n\t\t\tname: passageName\n\t\t}\n\t};\n}\n","import {\n\tPassage,\n\tStory,\n\tDeletePassageAction,\n\tDeletePassagesAction\n} from '../stories.types';\n\n/**\n * Deletes a passage.\n */\nexport function deletePassage(\n\tstory: Story,\n\tpassage: Passage\n): DeletePassageAction {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn {type: 'deletePassage', storyId: story.id, passageId: passage.id};\n}\n\n/**\n * Deletes multiple passages.\n */\nexport function deletePassages(\n\tstory: Story,\n\tpassages: Passage[]\n): DeletePassagesAction {\n\treturn {\n\t\ttype: 'deletePassages',\n\t\tstoryId: story.id,\n\t\tpassageIds: passages.map(passage => passage.id)\n\t};\n}\n","import {StoriesAction, Story} from '../stories.types';\n\nexport function deleteStory(story: Story): StoriesAction {\n\treturn {type: 'deleteStory', storyId: story.id};\n}\n","import uuid from 'tiny-uuid';\nimport {CreateStoryAction, Story} from '../stories.types';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a duplicate of an existing story.\n */\nexport function duplicateStory(\n\tstory: Story,\n\tstories: Story[]\n): CreateStoryAction {\n\treturn {\n\t\ttype: 'createStory',\n\t\tprops: {\n\t\t\t...story,\n\t\t\tid: uuid(),\n\t\t\tifid: uuid(),\n\t\t\tname: unusedName(\n\t\t\t\tstory.name,\n\t\t\t\tstories.map(story => story.name)\n\t\t\t)\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {parseLinks} from '../../../util/parse-links';\nimport {passageIsEmpty} from '../../../util/passage-is-empty';\nimport {\n\tDeletePassagesAction,\n\tPassage,\n\tStoriesState,\n\tStory\n} from '../stories.types';\n\n/**\n * Deletes empty, orphaned passages from a story after passage text changes. An orphan\n * must meet all these criteria:\n *\n * - It is considered empty (see util/passage-is-empty.ts)\n * - It is not the story start\n * - It was linked previously from the passage, but is not anymore\n * - It is only linked to from the passage whose text is changing\n *\n * The intent is to delete passages that were automatically created in the past,\n * but the user has removed the link through editing without ever editing the\n * passage.\n */\nexport function deleteOrphanedPassages(\n\tstory: Story,\n\tpassage: Passage,\n\tnewText: string,\n\toldText: string\n): Thunk<StoriesState, DeletePassagesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn dispatch => {\n\t\tconst oldLinks = parseLinks(oldText);\n\t\tconst newLinks = parseLinks(newText);\n\t\tconst orphans = oldLinks.filter(link => !newLinks.includes(link));\n\n\t\tconst passageIds = orphans.reduce<string[]>((result, orphan) => {\n\t\t\tconst orphanPassage = story.passages.find(p => p.name === orphan);\n\n\t\t\t// These tests are fast because they look at the passage object only.\n\n\t\t\tif (\n\t\t\t\t!orphanPassage ||\n\t\t\t\t!passageIsEmpty(orphanPassage) ||\n\t\t\t\tstory.startPassage === orphanPassage.id\n\t\t\t) {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\t// This is O(n) potentially.\n\n\t\t\tif (\n\t\t\t\tstory.passages.some(\n\t\t\t\t\tp => p.id !== passage.id && parseLinks(p.text).includes(orphan)\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn [...result, orphanPassage.id];\n\t\t}, []);\n\n\t\tif (passageIds.length > 0) {\n\t\t\tdispatch({type: 'deletePassages', passageIds, storyId: story.id});\n\t\t}\n\t};\n}\n","import {Passage} from '../store/stories';\n\n/**\n * Returns whether a passage is considered empty, e.g. whether the user has put\n * any content into it.\n */\nexport function passageIsEmpty(passage: Passage) {\n\treturn (\n\t\tpassage.text === '' &&\n\t\tpassage.tags.length === 0 &&\n\t\tpassage.width === 100 &&\n\t\tpassage.height === 100\n\t);\n}\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {storyWithId} from '../getters';\nimport {Passage, StoriesAction, StoriesState, Story} from '../stories.types';\nimport {createNewlyLinkedPassages} from './create-newly-linked-passages';\nimport {deleteOrphanedPassages} from './delete-orphaned-passages';\n\nexport interface UpdatePassageOptions {\n\tdontUpdateOthers?: boolean;\n}\n\n/**\n * General update of a passage.\n */\nexport function updatePassage(\n\tstory: Story,\n\tpassage: Passage,\n\tprops: Partial<Passage>,\n\toptions: UpdatePassageOptions = {}\n): Thunk<StoriesState, StoriesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (\n\t\t'name' in props &&\n\t\tstory.passages\n\t\t\t.filter(p => p.name === props.name)\n\t\t\t.some(p => p.id !== passage.id)\n\t) {\n\t\tthrow new Error(`There is already a passage named \"${props.name}\".`);\n\t}\n\n\treturn (dispatch, getState) => {\n\t\t// Do the passage update itself.\n\n\t\tconst oldName = passage.name;\n\t\tconst oldText = passage.text;\n\n\t\tdispatch({\n\t\t\tprops,\n\t\t\ttype: 'updatePassage',\n\t\t\tpassageId: passage.id,\n\t\t\tstoryId: story.id\n\t\t});\n\n\t\t// Side effects from changes.\n\n\t\tif (!options.dontUpdateOthers && props.text) {\n\t\t\tdispatch(deleteOrphanedPassages(story, passage, props.text, oldText));\n\n\t\t\t// We need to get an up-to-date version of the story so placement of new\n\t\t\t// passages is correct.\n\t\t\t//\n\t\t\t// still causes passage bounces sometimes :( this is because the placement\n\t\t\t// algorithm works differently based on the number of passages it sees.\n\t\t\t// will anyone care?? could there be a 'suggested positions'? how would we\n\t\t\t// communicate back and forth?\n\n\t\t\tconst updatedStory = storyWithId(getState(), story.id);\n\n\t\t\tdispatch(\n\t\t\t\tcreateNewlyLinkedPassages(updatedStory, passage, props.text, oldText)\n\t\t\t);\n\t\t}\n\n\t\tif (props.name) {\n\t\t\tconst oldNameEscaped = escapeRegExp(oldName);\n\n\t\t\t// We only need to escape $ stuff in the new name, because it will be the\n\t\t\t// second argument to replace(). This is a little mindbending, but the\n\t\t\t// purpose of this is to replace $ with $$.\n\n\t\t\tconst newNameEscaped = props.name.replace(/\\$/g, '$$$$');\n\n\t\t\tconst simpleLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst compoundLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[(.*?)(\\\\||->)' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst reverseLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(<-.*?)(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\n\t\t\tstory.passages.forEach(relinkedPassage => {\n\t\t\t\tif (\n\t\t\t\t\tsimpleLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\tcompoundLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\treverseLinkRegexp.test(relinkedPassage.text)\n\t\t\t\t) {\n\t\t\t\t\tlet newText = relinkedPassage.text;\n\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tsimpleLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tcompoundLinkRegexp,\n\t\t\t\t\t\t'[[$1$2' + newNameEscaped + '$3]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\treverseLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1$2]]'\n\t\t\t\t\t);\n\n\t\t\t\t\tupdatePassage(\n\t\t\t\t\t\tstory,\n\t\t\t\t\t\trelinkedPassage,\n\t\t\t\t\t\t{text: newText},\n\t\t\t\t\t\toptions\n\t\t\t\t\t)(dispatch, getState);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {createRegExp, escapeRegExpReplace} from '../../../util/regexp';\nimport {updatePassage} from './update-passage';\nimport {\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags\n} from '../stories.types';\n\n/**\n * Core logic for replacing text using flags.\n */\nfunction replaceText(source: string, searchFor: string, replaceWith: string, flags: StorySearchFlags) {\n\tconst {matchCase, useRegexes} = flags;\n\tconst matcher = createRegExp(searchFor, {matchCase, useRegexes});\n\tconst replacer = useRegexes\n\t? replaceWith\n\t: escapeRegExpReplace(replaceWith);\n\n\treturn source.replace(matcher, replacer);\n}\n\nexport function replaceInPassage(\n\tstory: Story,\n\tpassage: Passage,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) => {\n\t\tif (searchFor === '') {\n\t\t\tthrow new Error(\"Can't replace an empty string\");\n\t\t}\n\n\t\tif (passage.story !== story.id) {\n\t\t\tthrow new Error('Passage does not belong to story');\n\t\t}\n\n\t\tconst {includePassageNames} = flags;\n\t\tconst props: Partial<Passage> = {};\n\n\t\tconst newText = replaceText(passage.text, searchFor, replaceWith, flags);\n\n\t\tif (newText !== passage.text) {\n\t\t\tprops.text = newText;\n\t\t}\n\n\t\tif (includePassageNames) {\n\t\t\tconst newName = replaceText(passage.name, searchFor, replaceWith, flags);\n\n\t\t\tif (newName !== passage.name) {\n\t\t\t\tprops.name = newName;\n\t\t\t}\n\t\t}\n\n\t\tif (Object.keys(props).length > 0) {\n\t\t\tupdatePassage(story, passage, props)(dispatch, getState);\n\t\t}\n\t};\n}\n\nexport function replaceInStory(\n\tstory: Story,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) => {\n\t\tif (searchFor === '') {\n\t\t\tthrow new Error(\"Can't replace an empty string\");\n\t\t}\n\n\t\tif (flags.includePassageNames) {\n\t\t\t// Do replaces in passage names first, so that if a replace will change\n\t\t\t// both a link and a passage name, the updatePassage action will see that\n\t\t\t// the passage exists when the link is changed, and not create a new\n\t\t\t// passage that will conflict with the existing one.\n\t\t\t\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\tconst name = replaceText(passage.name, searchFor, replaceWith, flags);\n\n\t\t\t\tif (name !== passage.name) {\n\t\t\t\t\tupdatePassage(story, passage, {name})(dispatch, getState);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\tconst text = replaceText(passage.text, searchFor, replaceWith, flags);\n\n\t\t\t\tif (text !== passage.text) {\n\t\t\t\t\tupdatePassage(story, passage, {text})(dispatch, getState);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// We're only updating passage text, so we can do it the easy way.\n\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\treplaceInPassage(\n\t\t\t\t\tstory,\n\t\t\t\t\tpassage,\n\t\t\t\t\tsearchFor,\n\t\t\t\t\treplaceWith,\n\t\t\t\t\tflags\n\t\t\t\t)(dispatch, getState);\n\t\t\t}\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags,\n\tUpdatePassagesAction\n} from '../stories.types';\nimport {passagesMatchingSearch} from '../getters';\n\nexport function highlightPassagesMatchingSearch(\n\tstory: Story,\n\tsearch: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tlet passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (search === '') {\n\t\t\t// Remove all highlights.\n\t\t\tpassageUpdates = story.passages.reduce((result, passage) => {\n\t\t\t\tif (passage.highlighted) {\n\t\t\t\t\treturn {...result, [passage.id]: {highlighted: false}};\n\t\t\t\t}\n\n\t\t\t\treturn result;\n\t\t\t}, {});\n\t\t} else {\n\t\t\tconst matchIds = passagesMatchingSearch(\n\t\t\t\tstory.passages,\n\t\t\t\tsearch,\n\t\t\t\tflags\n\t\t\t).map(passage => passage.id);\n\n\t\t\tstory.passages.forEach(passage => {\n\t\t\t\tconst oldHighlighted = passage.highlighted;\n\t\t\t\tconst newHighlighted = matchIds.includes(passage.id);\n\n\t\t\t\tif (newHighlighted !== oldHighlighted) {\n\t\t\t\t\tpassageUpdates[passage.id] = {highlighted: newHighlighted};\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreateStoryAction,\n\tStoriesState,\n\tStory,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * Imports stories, overwriting any stories with the same name.\n */\nexport function importStories(\n\ttoImport: Story[],\n\texistingStories: Story[]\n): Thunk<StoriesState, CreateStoryAction | UpdateStoryAction> {\n\ttoImport.forEach(importStory => {\n\t\tif (\n\t\t\ttoImport.some(\n\t\t\t\totherStory =>\n\t\t\t\t\totherStory !== importStory &&\n\t\t\t\t\tstoryFileName(otherStory) === storyFileName(importStory)\n\t\t\t)\n\t\t) {\n\t\t\tthrow new Error(\n\t\t\t\t`Stories to import cannot have the same name: \"${importStory.name}\"`\n\t\t\t);\n\t\t}\n\t});\n\n\treturn dispatch => {\n\t\ttoImport.forEach(importStory => {\n\t\t\t// Remove the temp ID that was assigned to the new story.\n\n\t\t\tconst props: Partial<Story> = {...importStory};\n\n\t\t\tdelete props.id;\n\n\t\t\tconst existingStory = existingStories.find(\n\t\t\t\ts => storyFileName(s) === storyFileName(importStory)\n\t\t\t);\n\n\t\t\t// Do an update so that if something goes awry, we won't have deleted the\n\t\t\t// story. We need to update passage props so that their parent story ID is\n\t\t\t// set properly.\n\n\t\t\tif (existingStory) {\n\t\t\t\tif (props.passages) {\n\t\t\t\t\tprops.passages = props.passages.map(passage => ({\n\t\t\t\t\t\t...passage,\n\t\t\t\t\t\tstory: existingStory.id\n\t\t\t\t\t}));\n\t\t\t\t}\n\n\t\t\t\tdispatch({props, type: 'updateStory', storyId: existingStory.id});\n\t\t\t} else {\n\t\t\t\tdispatch({props, type: 'createStory'});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Passage, Story, UpdatePassagesAction} from '../stories.types';\n\n/**\n * Moves passages by an offset, e.g. after dragging.\n */\nexport function movePassages(\n\tstory: Story,\n\tpassageIds: string[],\n\txChange: number,\n\tyChange: number\n): UpdatePassagesAction {\n\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\tif (!Number.isFinite(xChange) || !Number.isFinite(yChange)) {\n\t\tthrow new Error('Offset must be a finite number.');\n\t}\n\n\tpassageIds.forEach(passageId => {\n\t\tconst passage = story.passages.find(p => p.id === passageId);\n\n\t\tif (!passage) {\n\t\t\tthrow new Error(\n\t\t\t\t`There is no passage in this story with ID \"${passageId}\".`\n\t\t\t);\n\t\t}\n\n\t\tlet left = Math.max(passage.left + xChange, 0);\n\t\tlet top = Math.max(passage.top + yChange, 0);\n\n\t\tif (story.snapToGrid) {\n\t\t\tleft = Math.round(left / 25) * 25;\n\t\t\ttop = Math.round(top / 25) * 25;\n\t\t}\n\n\t\tpassageUpdates[passage.id] = {left, top};\n\t});\n\n\treturn {type: 'updatePassages', passageUpdates, storyId: story.id};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassagesAction,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renamePassageTag(\n\tstory: Story,\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, UpdatePassagesAction | UpdateStoryAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Change tags in passages.\n\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.tags.includes(oldName)) {\n\t\t\t\tpassageUpdates[passage.id] = {\n\t\t\t\t\ttags: passage.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\n\t\t\t// Move the tag color to the new one.\n\n\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\tdelete tagColors[oldName];\n\t\t\ttagColors[newName] = story.tagColors[oldName];\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renameStoryTag(\n\tstories: Story[],\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, StoriesAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\tstories.forEach(story => {\n\t\t\tif (story.tags.includes(oldName)) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\ttags: story.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Rect, rectsIntersect} from '../../../util/geometry';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassageAction,\n\tUpdatePassagesAction\n} from '../stories.types';\n\n/**\n * Deselects all passages.\n */\nexport function deselectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: false};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single passage.\n */\nexport function deselectPassage(\n\tstory: Story,\n\tpassage: Passage\n): Thunk<StoriesState, UpdatePassageAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tif (passage.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tpassageId: passage.id,\n\t\t\t\tprops: {selected: false},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects all passages.\n */\nexport function selectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (!passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects a single passage.\n */\nexport function selectPassage(\n\tstory: Story,\n\tpassage: Passage,\n\texclusive: boolean\n): Thunk<StoriesState, UpdatePassagesAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (!passage.selected) {\n\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tstory.passages.forEach(p => {\n\t\t\t\tif (p.id !== passage.id && p.selected) {\n\t\t\t\t\tpassageUpdates[p.id] = {selected: false};\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n\nexport function selectPassagesInRect(\n\tstory: Story,\n\trect: Rect,\n\tignoreIds: string[] = []\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (ignoreIds.find(r => r === passage.id)) {\n\t\t\t\t// We are ignoring this passage, e.g. this is an additive selection and it\n\t\t\t\t// was already selected.\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selected = rectsIntersect(rect, passage);\n\n\t\t\tif (passage.selected !== selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\n/**\n * Deselects a single story.\n */\nexport function deselectStory(\n\tstory: Story\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: false}\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects all stories.\n */\nexport function deselectAllStories(): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tfor (const story of getState()) {\n\t\t\tif (story.selected) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {selected: false}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Selects a single story.\n */\nexport function selectStory(\n\tstory: Story,\n\texclusive: boolean\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== story.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\t\tstoryId: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Color} from '../../../util/color';\nimport {isValidTagName} from '../../../util/tag';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\nexport function setTagColor(\n\tstory: Story,\n\tname: string,\n\tcolor: Color\n): Thunk<StoriesState, UpdateStoryAction> {\n\tif (!isValidTagName(name)) {\n\t\tthrow new Error(`\"${name}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Special handling: if the color is set to none, just delete it.\n\n\t\tif (color === 'none') {\n\t\t\tif (name in story.tagColors) {\n\t\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\t\tdelete tagColors[name];\n\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tprops: {tagColors},\n\t\t\t\t\tstoryId: story.id\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors: {...story.tagColors, [name]: color}},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Passage, Story, UpdatePassageAction} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\n/**\n * Adds a tag to a passage.\n */\nexport function addPassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage already has the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: [...passage.tags, tagName]}\n\t};\n}\n\n/**\n * Removes a tag from a passage.\n */\nexport function removePassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (!passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage does not have the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: passage.tags.filter(t => t !== tagName)}\n\t};\n}\n","import {Story, UpdateStoryAction} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * General update of a story.\n */\nexport function updateStory(\n\tstories: Story[],\n\tstory: Story,\n\tprops: Partial<Story>\n): UpdateStoryAction {\n\tif (\n\t\tprops.name &&\n\t\tstories\n\t\t\t.filter(s => storyFileName(s) === storyFileName({...s, ...props}))\n\t\t\t.some(s => s.id !== story.id)\n\t) {\n\t\tthrow new Error(`There is already a story named \"${props.name}\".`);\n\t}\n\n\treturn {\n\t\tprops,\n\t\tstoryId: story.id,\n\t\ttype: 'updateStory'\n\t};\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../defaults';\nimport {Passage, Story, StoriesState} from '../stories.types';\n\nexport function createPassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>\n) {\n\tlet storyExists = false;\n\tlet created = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (story.passages.some(passage => passage.id === passageProps.id)) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with ID \"${passageProps.id}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(passage => passage.name === passageProps.name)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newPassage: Passage = {\n\t\t\t...passageDefaults(),\n\t\t\tid: uuid(),\n\t\t\t...passageProps,\n\t\t\tstory: story.id\n\t\t};\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tlastUpdate: new Date(),\n\t\t\tpassages: [...story.passages, newPassage]\n\t\t};\n\n\t\tif (newStory.passages.length === 1) {\n\t\t\tnewStory.startPassage = newPassage.id;\n\t\t}\n\n\t\tcreated = true;\n\t\treturn newStory;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!created) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deletePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string\n) {\n\tlet foundStory = false;\n\tlet deleted = false;\n\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tfoundStory = true;\n\n\t\tconst newStory = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.filter(passage => {\n\t\t\t\tif (passage.id === passageId) {\n\t\t\t\t\tdeleted = true;\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t})\n\t\t};\n\n\t\tif (deleted) {\n\t\t\tnewStory.lastUpdate = new Date();\n\t\t\treturn newStory;\n\t\t}\n\n\t\treturn story;\n\t});\n\n\tif (!foundStory) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../../defaults';\nimport {Passage, Story} from '../../stories.types';\n\nfunction logRepair(\n\tpassage: Passage,\n\tpropName: keyof Passage,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing passage (name: \"${passage.name}\", id: ${passage.id}): ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${passage[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairPassage(passage: Passage, parentStory: Story): Passage {\n\tconst passageDefs = passageDefaults();\n\tconst repairs: Partial<Passage> = {};\n\n\t// Give the passage an ID if it has none.\n\n\tif (typeof passage.id !== 'string' || passage.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(passage, 'id', newId, 'was undefined or empty string');\n\t\trepairs.id = uuid();\n\t}\n\n\t// Apply default properties to the passage.\n\n\tObject.entries(passageDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof passageDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(passage[defKey])) ||\n\t\t\ttypeof value !== typeof passage[defKey]\n\t\t) {\n\t\t\tlogRepair(passage, defKey, passageDefs[defKey]);\n\t\t\t(repairs[defKey] as Passage[typeof defKey]) = passageDefs[defKey];\n\t\t}\n\t});\n\n\t// Make passage coordinates 0 or greater.\n\n\t['left', 'top'].forEach(pos => {\n\t\tconst posKey = pos as keyof Passage;\n\n\t\tif (passage[posKey] < 0) {\n\t\t\tlogRepair(passage, posKey, 0, 'was negative');\n\t\t\t(repairs[posKey] as Passage[typeof posKey]) = 0;\n\t\t}\n\t});\n\n\t// Make passage dimensions 5 or greater.\n\n\t['height', 'width'].forEach(dim => {\n\t\tconst dimKey = dim as keyof Passage;\n\n\t\tif (passage[dimKey] < 5) {\n\t\t\tlogRepair(passage, dimKey, 0, 'was less than 5');\n\t\t\t(repairs[dimKey] as Passage[typeof dimKey]) = 5;\n\t\t}\n\t});\n\n\t// Repair story property if it doesn't point to the parent story.\n\n\tif (passage.story !== parentStory.id) {\n\t\tlogRepair(passage, 'story', parentStory.id, \"didn't match parent story\");\n\t\trepairs.story = parentStory.id;\n\t}\n\n\t// Repair ID conflicts with any other passage in the story.\n\n\tif (\n\t\tparentStory.passages.some(otherPassage => {\n\t\t\tif (otherPassage === passage) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherPassage.id === passage.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(\n\t\t\tpassage,\n\t\t\t'id',\n\t\t\tnewId,\n\t\t\t'conflicted with another passage in the story'\n\t\t);\n\t\trepairs.id = newId;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...passage, ...repairs};\n\t}\n\n\treturn passage;\n}\n","import {satisfies} from 'semver';\nimport uuid from 'tiny-uuid';\nimport {Story} from '../../stories.types';\nimport {storyDefaults} from '../../defaults';\nimport {StoryFormat} from '../../../story-formats';\nimport {repairPassage} from './repair-passage';\n\nfunction logRepair(\n\tstory: Story,\n\tpropName: keyof Story,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing story (name: \"${story.name}\", id: ${story.id}) by ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${story[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairStory(\n\tstory: Story,\n\tallStories: Story[],\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): Story {\n\tconst storyDefs = storyDefaults();\n\tconst repairs: Partial<Story> = {};\n\n\t// Give the story an ID if it has none.\n\n\tif (typeof story.id !== 'string' || story.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, 'was bad type or empty string');\n\t\trepairs.id = newId;\n\t}\n\n\t// Give the story an IFID if it has none.\n\n\tif (typeof story.ifid !== 'string' || story.id === '') {\n\t\tconst newIfid = uuid();\n\n\t\tlogRepair(story, 'ifid', newIfid, 'was bad type or empty string');\n\t\trepairs.ifid = newIfid;\n\t}\n\n\t// Apply default properties to the story.\n\n\tObject.entries(storyDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof storyDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(story[defKey])) ||\n\t\t\ttypeof value !== typeof story[defKey]\n\t\t) {\n\t\t\tlogRepair(story, defKey, storyDefs[defKey]);\n\t\t\t(repairs[defKey] as Story[typeof defKey]) = storyDefs[defKey];\n\t\t}\n\t});\n\n\tif (\n\t\ttypeof story.storyFormat !== 'string' ||\n\t\tstory.storyFormat === '' ||\n\t\ttypeof story.storyFormatVersion !== 'string' ||\n\t\tstory.storyFormatVersion === ''\n\t) {\n\t\t// Assign the story the default story format if it has none.\n\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormat',\n\t\t\tdefaultFormat.name,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormatVersion',\n\t\t\tdefaultFormat.version,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\trepairs.storyFormat = defaultFormat.name;\n\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t} else if (\n\t\t!allFormats.some(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tformat.version === story.storyFormatVersion\n\t\t)\n\t) {\n\t\t// If the story has a nonexistent story format, try to match it to one that\n\t\t// does, using semver as a guide.\n\n\t\tconst repairFormat = allFormats.find(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tsatisfies(format.version, '^' + story.storyFormatVersion)\n\t\t);\n\n\t\tif (repairFormat) {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\trepairFormat.name,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\trepairFormat.version,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = repairFormat.name;\n\t\t\trepairs.storyFormatVersion = repairFormat.version;\n\t\t} else {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\tdefaultFormat.name,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\tdefaultFormat.version,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = defaultFormat.name;\n\t\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t\t}\n\t}\n\n\t// Repair ID conflicts with other stories.\n\n\tif (\n\t\tallStories.some(otherStory => {\n\t\t\tif (otherStory === story) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherStory.id === story.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, \"conflicted with another story's ID\");\n\t\trepairs.id = newId;\n\t}\n\n\t// Repair all passages. All story ID changes must be before this to prevent\n\t// mismatches. We merge in repairs temporarily here so that passages see the\n\t// most correct ID.\n\n\tlet anyPassageRepaired = false;\n\tconst repairedPassages = story.passages.map(passage => {\n\t\tconst repairedPassage = repairPassage(passage, {...story, ...repairs});\n\n\t\tif (repairedPassage !== passage) {\n\t\t\tanyPassageRepaired = true;\n\t\t\treturn repairedPassage;\n\t\t}\n\n\t\treturn passage;\n\t});\n\n\tif (anyPassageRepaired) {\n\t\trepairs.passages = repairedPassages;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...story, ...repairs};\n\t}\n\n\treturn story;\n}\n","import {Passage, Story, StoriesState} from '../stories.types';\nimport {isPersistablePassageChange} from '../../persistence/persistable-changes';\n\nexport function updatePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string,\n\tpassageProps: Omit<Partial<Passage>, 'id' | 'story'>\n) {\n\tlet storyExists = false;\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(\n\t\t\t\tpassage =>\n\t\t\t\t\tpassage.name === passageProps.name && passage.id !== passageId\n\t\t\t)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.map(passage => {\n\t\t\t\tif (passage.id !== passageId) {\n\t\t\t\t\treturn passage;\n\t\t\t\t}\n\n\t\t\t\tupdated = true;\n\t\t\t\treturn {...passage, ...passageProps};\n\t\t\t})\n\t\t};\n\n\t\tif (updated) {\n\t\t\tif (isPersistablePassageChange(passageProps)) {\n\t\t\t\tnewStory.lastUpdate = new Date();\n\t\t\t}\n\n\t\t\treturn newStory;\n\t\t}\n\n\t\tconsole.warn(\n\t\t\t`Asked to update a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn story;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!updated) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {createPassage} from './create-passage';\nimport {createPassages} from './create-passages';\nimport {createStory} from './create-story';\nimport {deletePassage} from './delete-passage';\nimport {deletePassages} from './delete-passages';\nimport {deleteStory} from './delete-story';\nimport {initState} from './init';\nimport {repairState} from './repair';\nimport {updatePassage} from './update-passage';\nimport {updatePassages} from './update-passages';\nimport {updateStory} from './update-story';\nimport {StoriesAction, StoriesState} from '../stories.types';\n\nexport const reducer: React.Reducer<StoriesState, StoriesAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\treturn createPassage(state, action.storyId, action.props);\n\n\t\tcase 'createPassages':\n\t\t\treturn createPassages(state, action.storyId, action.props);\n\n\t\tcase 'createStory':\n\t\t\treturn createStory(state, action.props);\n\n\t\tcase 'deletePassage':\n\t\t\treturn deletePassage(state, action.storyId, action.passageId);\n\n\t\tcase 'deletePassages':\n\t\t\treturn deletePassages(state, action.storyId, action.passageIds);\n\n\t\tcase 'deleteStory':\n\t\t\treturn deleteStory(state, action.storyId);\n\n\t\tcase 'init':\n\t\t\treturn initState(state, action.state);\n\n\t\tcase 'repair':\n\t\t\treturn repairState(state, action.allFormats, action.defaultFormat);\n\n\t\tcase 'updatePassage':\n\t\t\treturn updatePassage(\n\t\t\t\tstate,\n\t\t\t\taction.storyId,\n\t\t\t\taction.passageId,\n\t\t\t\taction.props\n\t\t\t);\n\n\t\tcase 'updatePassages':\n\t\t\treturn updatePassages(state, action.storyId, action.passageUpdates);\n\n\t\tcase 'updateStory':\n\t\t\treturn updateStory(state, action.storyId, action.props);\n\n\t\tdefault:\n\t\t\tconsole.warn(`${(action as any).type} not implemented yet`);\n\t}\n\n\treturn state;\n};\n","import {Passage, StoriesState} from '../stories.types';\nimport {createPassage} from './create-passage';\n\nexport function createPassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>[]\n) {\n\treturn passageProps.reduce(\n\t\t(state, props) => createPassage(state, storyId, props),\n\t\tstate\n\t);\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults} from '../defaults';\nimport {Story, StoriesState} from '../stories.types';\n\nexport function createStory(state: StoriesState, storyProps: Partial<Story>) {\n\tif ('id' in storyProps && state.some(story => story.id === storyProps.id)) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with ID \"${storyProps.id}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet story: Story = {\n\t\tid: uuid(),\n\t\t...storyDefaults(),\n\t\tifid: uuid().toUpperCase(),\n\t\tlastUpdate: new Date(),\n\t\tpassages: [],\n\t\ttags: [],\n\t\ttagColors: {},\n\t\t...storyProps\n\t};\n\n\t// If we are prepopulating the story with passages, make sure they have the\n\t// correct ID linkage, and at least make sure basic properties are set.\n\n\tstory.passages = story.passages.map(passage => ({\n\t\t...passageDefaults,\n\t\t...passage,\n\t\tstory: story.id\n\t}));\n\n\treturn [...state, story];\n}\n","import {StoriesState} from '../stories.types';\nimport {deletePassage} from './delete-passage';\n\nexport function deletePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageIds: string[]\n) {\n\treturn passageIds.reduce(\n\t\t(state, passageId) => deletePassage(state, storyId, passageId),\n\t\tstate\n\t);\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deleteStory(state: StoriesState, storyId: string) {\n\tlet deleted = false;\n\tconst newState = state.filter(story => {\n\t\tif (story.id === storyId) {\n\t\t\tdeleted = true;\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t});\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {Story, StoriesState} from '../stories.types';\n\nexport function initState(state: StoriesState, init: Story[]) {\n\treturn [...init];\n}\n","import {repairStory} from './repair-story';\nimport {StoryFormat} from '../../../story-formats';\nimport {StoriesState} from '../../stories.types';\n\nexport function repairState(\n\tstate: StoriesState,\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): StoriesState {\n\treturn state.map(story =>\n\t\trepairStory(story, state, allFormats, defaultFormat)\n\t);\n}\n","import {Passage, StoriesState} from '../stories.types';\nimport {updatePassage} from './update-passage';\n\nexport function updatePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageUpdates: Record<string, Partial<Passage>>\n) {\n\treturn Object.keys(passageUpdates).reduce(\n\t\t(state, passageId) =>\n\t\t\tupdatePassage(state, storyId, passageId, passageUpdates[passageId]),\n\t\tstate\n\t);\n}\n","import {Story, StoriesState} from '../stories.types';\nimport {isPersistableStoryChange} from '../../persistence/persistable-changes';\n\nexport function updateStory(\n\tstate: StoriesState,\n\tstoryId: string,\n\tstoryProps: Partial<Omit<Story, 'id'>>\n) {\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name && story.id !== storyId)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is another story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tupdated = true;\n\n\t\tconst updatedStory = {...story, ...storyProps};\n\n\t\tif (isPersistableStoryChange(storyProps)) {\n\t\t\tupdatedStory.lastUpdate = new Date();\n\t\t}\n\n\t\treturn updatedStory;\n\t});\n\n\tif (!updated) {\n\t\tconsole.warn(\n\t\t\t`Asked to update a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {reducer} from './reducer';\nimport {\n\tStoriesContextProps,\n\tStoriesAction,\n\tStoriesState\n} from './stories.types';\nimport {useStoryFormatsContext} from '../story-formats';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\n\nexport const StoriesContext = React.createContext<StoriesContextProps>({\n\tdispatch: () => {},\n\tstories: []\n});\n\nStoriesContext.displayName = 'Stories';\n\nexport const useStoriesContext = () => React.useContext(StoriesContext);\n\nexport const StoriesContextProvider: React.FC = props => {\n\tconst {stories: storiesPersistence} = usePersistence();\n\tconst {formats} = useStoryFormatsContext();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoriesState,\n\t\tStoriesAction\n\t> = React.useMemo(\n\t\t() => (state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoriesPersistence.saveMiddleware(newState, action, formats);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStories');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[formats, reportError, storiesPersistence]\n\t);\n\tconst [stories, dispatch] = useThunkReducer(persistedReducer, []);\n\n\treturn (\n\t\t<StoriesContext.Provider value={{dispatch, stories}}>\n\t\t\t{props.children}\n\t\t</StoriesContext.Provider>\n\t);\n};\n","import {debounce} from 'lodash';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogEditor} from '../../components/container/dialog-card';\nimport {CodeArea} from '../../components/control/code-area';\nimport {usePrefsContext} from '../../store/prefs';\nimport {Passage, Story} from '../../store/stories';\nimport {StoryFormat} from '../../store/story-formats';\nimport {useCodeMirrorPassageHints} from '../../store/use-codemirror-passage-hints';\nimport {useFormatCodeMirrorMode} from '../../store/use-format-codemirror-mode';\nimport {codeMirrorOptionsFromPrefs} from '../../util/codemirror-options';\n\nexport interface PassageTextProps {\n\tonChange: (value: string) => void;\n\tonEditorChange: (value: CodeMirror.Editor) => void;\n\tpassage: Passage;\n\tstory: Story;\n\tstoryFormat: StoryFormat;\n\tstoryFormatExtensionsDisabled?: boolean;\n}\n\nexport const PassageText: React.FC<PassageTextProps> = props => {\n\tconst {\n\t\tonChange,\n\t\tonEditorChange,\n\t\tpassage,\n\t\tstory,\n\t\tstoryFormat,\n\t\tstoryFormatExtensionsDisabled\n\t} = props;\n\tconst [changePending, setChangePending] = React.useState(false);\n\tconst [localText, setLocalText] = React.useState(passage.text);\n\tconst {prefs} = usePrefsContext();\n\tconst autocompletePassageNames = useCodeMirrorPassageHints(story);\n\tconst mode =\n\t\tuseFormatCodeMirrorMode(storyFormat.name, storyFormat.version) ?? 'text';\n\tconst {t} = useTranslation();\n\n\t// Effects to handle debouncing updates upward. The idea here is that the\n\t// component maintains a local state so that the CodeMirror instance always is\n\t// up-to-date with what the user has typed, but the global context may not be.\n\t// This is because updating global context causes re-rendering in the story\n\t// map, which can be time-intensive.\n\n\tReact.useEffect(() => {\n\t\t// A change to passage text has occurred externally, e.g. through a find and\n\t\t// replace. We ignore this if a change is pending so that users don't see\n\t\t// things they've typed in disappear or be replaced.\n\n\t\tif (!changePending && localText !== passage.text) {\n\t\t\tsetLocalText(passage.text);\n\t\t}\n\t}, [changePending, localText, passage.text]);\n\n\t// The code below handles user changes in the text field. 1 second is a\n\t// guesstimate.\n\n\tconst debouncedOnChange = React.useMemo(\n\t\t() =>\n\t\t\tdebounce((value: string) => {\n\t\t\t\tonChange(value);\n\t\t\t\tsetChangePending(false);\n\t\t\t}, 1000),\n\t\t[onChange]\n\t);\n\n\tconst handleMount = React.useCallback(\n\t\t(editor: CodeMirror.Editor) => {\n\t\t\tonEditorChange(editor);\n\n\t\t\t// The potential combination of loading a mode and the dialog entrance\n\t\t\t// animation seems to mess up CodeMirror's cursor rendering. The delay below\n\t\t\t// is intended to run after the animation completes.\n\n\t\t\twindow.setTimeout(() => {\n\t\t\t\teditor.focus();\n\t\t\t\teditor.refresh();\n\t\t\t}, 400);\n\t\t},\n\t\t[onEditorChange]\n\t);\n\n\tconst handleChange = React.useCallback(\n\t\t(\n\t\t\teditor: CodeMirror.Editor,\n\t\t\tdata: CodeMirror.EditorChange,\n\t\t\ttext: string\n\t\t) => {\n\t\t\tonEditorChange(editor);\n\t\t\tsetChangePending(true);\n\t\t\tdebouncedOnChange(text);\n\t\t\tsetLocalText(text);\n\t\t},\n\t\t[debouncedOnChange, onEditorChange]\n\t);\n\n\tconst options = React.useMemo(\n\t\t() => ({\n\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\tmode: storyFormatExtensionsDisabled ? 'text' : mode,\n\t\t\tlineWrapping: true,\n\t\t\tplaceholder: t('dialogs.passageEdit.passageTextPlaceholder'),\n\t\t\tprefixTrigger: {\n\t\t\t\tcallback: autocompletePassageNames,\n\t\t\t\tprefixes: ['[[', '->']\n\t\t\t}\n\t\t}),\n\t\t[autocompletePassageNames, mode, prefs, storyFormatExtensionsDisabled, t]\n\t);\n\n\treturn (\n\t\t<DialogEditor>\n\t\t\t<CodeArea\n\t\t\t\teditorDidMount={handleMount}\n\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\tlabel={t('dialogs.passageEdit.passageTextEditorLabel')}\n\t\t\t\tlabelHidden\n\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\tonChange={onEditorChange}\n\t\t\t\toptions={options}\n\t\t\t\tvalue={localText}\n\t\t\t/>\n\t\t</DialogEditor>\n\t);\n};\n","import CodeMirror, {Editor, Handle} from 'codemirror';\nimport * as React from 'react';\nimport {Story} from './stories';\n\ntype HintExtraKeyHandler = (editor: Editor, hint: Handle) => void;\n\nexport function useCodeMirrorPassageHints(story: Story) {\n\treturn React.useCallback(\n\t\t(editor: Editor) => {\n\t\t\teditor.showHint({\n\t\t\t\tcompleteSingle: false,\n\t\t\t\textraKeys:\n\t\t\t\t\t// Any of the characters below are an indication the user is finished\n\t\t\t\t\t// typing a passage name in a link and the hint should close. We need\n\t\t\t\t\t// to 'type' this character for the user since our handler consumes\n\t\t\t\t\t// the event.\n\t\t\t\t\t[']', '-', '|'].reduce<Record<string, HintExtraKeyHandler>>(\n\t\t\t\t\t\t(result, character) => {\n\t\t\t\t\t\t\tresult[character] = (editor, hint) => {\n\t\t\t\t\t\t\t\tconst doc = editor.getDoc();\n\n\t\t\t\t\t\t\t\tdoc.replaceRange(character, doc.getCursor());\n\t\t\t\t\t\t\t\thint.close();\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{}\n\t\t\t\t\t),\n\t\t\t\thint() {\n\t\t\t\t\tconst wordRange = editor.findWordAt(editor.getCursor());\n\t\t\t\t\tconst word = editor\n\t\t\t\t\t\t.getRange(wordRange.anchor, wordRange.head)\n\t\t\t\t\t\t.toLowerCase();\n\n\t\t\t\t\tconst comps = {\n\t\t\t\t\t\tlist: story.passages.reduce<string[]>((result, passage) => {\n\t\t\t\t\t\t\tif (passage.name.toLowerCase().includes(word)) {\n\t\t\t\t\t\t\t\treturn [...result, passage.name];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}, []),\n\t\t\t\t\t\tfrom: wordRange.anchor,\n\t\t\t\t\t\tto: wordRange.head\n\t\t\t\t\t};\n\n\t\t\t\t\tCodeMirror.on(comps, 'pick', () => {\n\t\t\t\t\t\tconst doc = editor.getDoc();\n\n\t\t\t\t\t\tdoc.replaceRange(']] ', doc.getCursor());\n\t\t\t\t\t});\n\n\t\t\t\t\treturn comps;\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t[story.passages]\n\t);\n}\n","import {version as twineVersion} from '../../package.json';\nimport CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\n/**\n * Sets up a CodeMirror mode for a format, if the format has defined one via\n * properties.codeMirror.mode. Once one is fully set up, this returns the name\n * of that mode. If the mode is being set up or the format hasn't defined one,\n * this returns undefined.\n */\nexport function useFormatCodeMirrorMode(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst [modeName, setModeName] = React.useState<string>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.mode) {\n\t\t\t\tCodeMirror.defineMode(\n\t\t\t\t\tnamespaceForFormat(format),\n\t\t\t\t\teditorExtensions.codeMirror.mode\n\t\t\t\t);\n\t\t\t\tsetModeName(namespaceForFormat(format));\n\t\t\t}\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\treturn modeName;\n}\n","import {IconResize} from '@tabler/icons';\nimport {Editor} from 'codemirror';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {UndoRedoButtons} from '../../components/codemirror';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {MenuButton} from '../../components/control/menu-button';\nimport {RenamePassageButton} from '../../components/passage/rename-passage-button';\nimport {AddTagButton} from '../../components/tag';\nimport {\n\taddPassageTag,\n\tPassage,\n\tsetTagColor,\n\tStory,\n\tstoryPassageTags,\n\tupdatePassage,\n\tupdateStory\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\nexport interface PassageToolbarProps {\n\teditor?: Editor;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const PassageToolbar: React.FC<PassageToolbarProps> = props => {\n\tconst {editor, passage, story} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\tconst isStart = story.startPassage === passage.id;\n\n\tfunction handleAddTag(name: string, color?: Color) {\n\t\t// Kind of tricky. We make adding the tag to the passage undoable, but not\n\t\t// any color change associated with this. This is because we only set a\n\t\t// color here when creating an entirely new tag. If the user is adding an\n\t\t// existing tag, then we would only receive the name here, since it's\n\t\t// currently impossible to add an existing tag and change its color\n\t\t// simultaneously.\n\t\t//\n\t\t// If this changes, then this should change too.\n\n\t\tdispatch(addPassageTag(story, passage, name), t('undoChange.addTag'));\n\n\t\tif (color) {\n\t\t\tdispatch(setTagColor(story, name, color));\n\t\t}\n\t}\n\n\tfunction handleRename(name: string) {\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(updatePassage(story, passage, {name}, {dontUpdateOthers: true}));\n\t}\n\n\tfunction handleSetAsStart() {\n\t\tdispatch(updateStory(stories, story, {startPassage: passage.id}));\n\t}\n\n\tfunction handleSetSize({height, width}: {height: number; width: number}) {\n\t\tdispatch(updatePassage(story, passage, {height, width}));\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<UndoRedoButtons editor={editor} watch={passage.text} />\n\t\t\t<AddTagButton\n\t\t\t\tassignedTags={passage.tags}\n\t\t\t\texistingTags={storyPassageTags(story)}\n\t\t\t\tonAdd={handleAddTag}\n\t\t\t/>\n\t\t\t<MenuButton\n\t\t\t\ticon={<IconResize />}\n\t\t\t\titems={[\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 100,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeSmall'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 100})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 200,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeLarge'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 200})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 100,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeTall'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 100})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 200,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeWide'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 200})\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tlabel={t('dialogs.passageEdit.size')}\n\t\t\t/>\n\t\t\t<RenamePassageButton\n\t\t\t\tonRename={handleRename}\n\t\t\t\tpassage={passage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={isStart}\n\t\t\t\tlabel={t('dialogs.passageEdit.setAsStart')}\n\t\t\t\tonChange={handleSetAsStart}\n\t\t\t\tvalue={isStart}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport CodeMirror from 'codemirror';\nimport {usePrefsContext} from '../../store/prefs';\nimport {StoryFormat, StoryFormatToolbarItem} from '../../store/story-formats';\nimport {useComputedTheme} from '../../store/prefs/use-computed-theme';\nimport {useFormatCodeMirrorToolbar} from '../../store/use-format-codemirror-toolbar';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {IconButton} from '../../components/control/icon-button';\nimport {MenuButton} from '../../components/control/menu-button';\nimport './story-format-toolbar.css';\n\nexport interface StoryFormatToolbarProps {\n\teditor?: CodeMirror.Editor;\n\tonExecCommand: (name: string) => void;\n\tstoryFormat: StoryFormat;\n}\n\nexport const StoryFormatToolbar: React.FC<StoryFormatToolbarProps> = props => {\n\tconst {editor, onExecCommand, storyFormat} = props;\n\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\tconst appTheme = useComputedTheme();\n\tconst {prefs} = usePrefsContext();\n\tconst toolbarFactory = useFormatCodeMirrorToolbar(\n\t\tstoryFormat.name,\n\t\tstoryFormat.version\n\t);\n\tconst [toolbarItems, setToolbarItems] = React.useState<\n\t\tStoryFormatToolbarItem[]\n\t>([]);\n\n\tconst tryToSetToolbar = React.useCallback(() => {\n\t\tif (toolbarFactory && containerRef.current && editor) {\n\t\t\ttry {\n\t\t\t\tconst style = window.getComputedStyle(containerRef.current);\n\n\t\t\t\tsetToolbarItems(\n\t\t\t\t\ttoolbarFactory(editor, {\n\t\t\t\t\t\tappTheme,\n\t\t\t\t\t\tforegroundColor: style.color,\n\t\t\t\t\t\tlocale: prefs.locale\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Toolbar function for ${storyFormat.name} ${storyFormat.version} threw an error, skipping update`,\n\t\t\t\t\terror\n\t\t\t\t);\n\t\t\t}\n\t\t} else {\n\t\t\tsetToolbarItems([]);\n\t\t}\n\t}, [\n\t\tappTheme,\n\t\teditor,\n\t\tprefs.locale,\n\t\tstoryFormat.name,\n\t\tstoryFormat.version,\n\t\ttoolbarFactory\n\t]);\n\n\tReact.useEffect(() => {\n\t\tif (editor) {\n\t\t\t// Run the toolbar factory initially.\n\n\t\t\ttryToSetToolbar();\n\n\t\t\t// React to both content changes and the selection and cursor moving,\n\t\t\t// since the toolbar factory might want to do different things based on\n\t\t\t// the cursor position or selection.\n\n\t\t\teditor.on('cursorActivity', tryToSetToolbar);\n\t\t\treturn () => editor.off('cursorActivity', tryToSetToolbar);\n\t\t}\n\t}, [editor, tryToSetToolbar]);\n\n\tfunction execCommand(name: string) {\n\t\t// Run the command, then update the toolbar after the current execution\n\t\t// context finishes.\n\n\t\tonExecCommand(name);\n\t\tPromise.resolve().then(tryToSetToolbar);\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-toolbar\" ref={containerRef}>\n\t\t\t<ButtonBar>\n\t\t\t\t{toolbarItems.map((item, index) => {\n\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\ticonOnly={item.iconOnly}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\tonClick={() => execCommand(item.command)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\tcase 'menu': {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<MenuButton\n\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\ticonOnly={item.iconOnly}\n\t\t\t\t\t\t\t\t\titems={item.items\n\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t.map(subitem => {\n\t\t\t\t\t\t\t\t\t\t\tif (subitem.type === 'button') {\n\t\t\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: 'button',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabled: subitem.disabled,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: subitem.label,\n\t\t\t\t\t\t\t\t\t\t\t\t\tonClick: () => execCommand(subitem.command)\n\t\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\treturn {separator: true};\n\t\t\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t})}\n\t\t\t</ButtonBar>\n\t\t</div>\n\t);\n};\n","import CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tStoryFormatToolbarFactory,\n\tStoryFormatToolbarFactoryEnvironment,\n\tStoryFormatToolbarItem,\n\tuseStoryFormatsContext\n} from './story-formats';\n\n/**\n * Manages working with a CodeMirror toolbar for a story format, which consists\n * of:\n *\n * - (optionally, but usually) a set of CodeMirror commands\n * - A function that returns an array of objects describing the toolbar, which\n *   uses those commands for functionality\n *\n * This loads the story format if it hasn't already been loaded, and installs\n * CodeMirror commands it provides. It returns the toolbar factory function if\n * everything succeeds. Otherwise, it will return undefined.\n */\nexport function useFormatCodeMirrorToolbar(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [loaded, setLoaded] = React.useState<Record<string, boolean>>({});\n\tconst [\n\t\ttoolbarFunc,\n\t\tsetToolbarFunc\n\t] = React.useState<StoryFormatToolbarFactory>();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (\n\t\t\tformat.loadState === 'loaded' &&\n\t\t\t!loaded[namespaceForFormat(format)]\n\t\t) {\n\t\t\tconst namespace = namespaceForFormat(format);\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.commands) {\n\t\t\t\tfor (const commandName in editorExtensions.codeMirror.commands) {\n\t\t\t\t\tconst namespacedCommand = namespace + commandName;\n\n\t\t\t\t\tif (namespacedCommand in CodeMirror.commands) {\n\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t`CodeMirror already has a \"${namespacedCommand}\" command defined, skipping`\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Using any here because the type is defined with factory\n\t\t\t\t\t\t// commands only.\n\n\t\t\t\t\t\t(CodeMirror.commands as any)[\n\t\t\t\t\t\t\tnamespacedCommand\n\t\t\t\t\t\t] = editorExtensions.codeMirror!.commands![commandName];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\tsetToolbarFunc(\n\t\t\t\t\t() => (\n\t\t\t\t\t\teditor: CodeMirror.Editor,\n\t\t\t\t\t\tenvironment: StoryFormatToolbarFactoryEnvironment\n\t\t\t\t\t) => {\n\t\t\t\t\t\t// If somehow we lost our format's toolbar function, exit early.\n\n\t\t\t\t\t\tif (!editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst items = editorExtensions.codeMirror.toolbar(\n\t\t\t\t\t\t\teditor,\n\t\t\t\t\t\t\tenvironment\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// If we didn't get an array from the function, coerce it to an\n\t\t\t\t\t\t// empty one.\n\n\t\t\t\t\t\tif (!Array.isArray(items)) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Namespace command properties and filter out any types that aren't\n\t\t\t\t\t\t// buttons or menus.\n\n\t\t\t\t\t\treturn items.reduce((result, item) => {\n\t\t\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t{...item, command: namespace + item.command}\n\t\t\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\t\tcase 'menu':\n\t\t\t\t\t\t\t\t\tif (Array.isArray(item.items)) {\n\t\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t...item,\n\t\t\t\t\t\t\t\t\t\t\t\titems: item.items\n\t\t\t\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.map(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsubitem.type === 'separator'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? subitem\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t...subitem,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcommand: namespace + subitem.command\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}, [] as StoryFormatToolbarItem[]);\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tsetLoaded(loaded => ({...loaded, [namespaceForFormat(format)]: true}));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format, loaded]);\n\n\treturn toolbarFunc;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {TagButton} from '../../components/tag';\nimport {\n\tPassage,\n\tremovePassageTag,\n\tStory,\n\tupdateStory\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\nexport interface TagToolbarProps {\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const TagToolbar: React.FC<TagToolbarProps> = props => {\n\tconst {passage, story} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleChangeTagColor(name: string, color: Color) {\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttagColors: {...story.tagColors, [name]: color}\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(name: string) {\n\t\tdispatch(removePassageTag(story, passage, name), t('undoChange.removeTag'));\n\t}\n\n\tif (passage.tags.length === 0) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<div className=\"tags\">\n\t\t\t<ButtonBar>\n\t\t\t\t{passage.tags.map(tag => (\n\t\t\t\t\t<TagButton\n\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\tonChangeColor={color => handleChangeTagColor(tag, color)}\n\t\t\t\t\t\tonRemove={() => handleRemoveTag(tag)}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</ButtonBar>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport useErrorBoundary from 'use-error-boundary';\nimport {\n\tDialogCard,\n\tDialogCardProps\n} from '../../components/container/dialog-card';\nimport {ErrorMessage} from '../../components/error';\nimport {passageWithId, storyWithId, updatePassage} from '../../store/stories';\nimport {\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport './passage-edit.css';\nimport {PassageText} from './passage-text';\nimport {PassageToolbar} from './passage-toolbar';\nimport {StoryFormatToolbar} from './story-format-toolbar';\nimport {TagToolbar} from './tag-toolbar';\n\nexport interface PassageEditDialogProps\n\textends Omit<DialogCardProps, 'headerLabel'> {\n\tpassageId: string;\n\tstoryId: string;\n}\n\nexport const InnerPassageEditDialog: React.FC<\n\tPassageEditDialogProps\n> = props => {\n\tconst {passageId, storyId, ...other} = props;\n\tconst [storyFormatExtensionsEnabled, setStoryFormatExtensionsEnabled] =\n\t\tReact.useState(true);\n\tconst [editorCrashed, setEditorCrashed] = React.useState(false);\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {ErrorBoundary, error, reset: resetError} = useErrorBoundary();\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst passage = passageWithId(stories, storyId, passageId);\n\tconst story = storyWithId(stories, storyId);\n\tconst storyFormat = formatWithNameAndVersion(\n\t\tformats,\n\t\tstory.storyFormat,\n\t\tstory.storyFormatVersion\n\t);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (error) {\n\t\t\tif (storyFormatExtensionsEnabled) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t'Passage editor crashed, trying without format extensions',\n\t\t\t\t\terror\n\t\t\t\t);\n\t\t\t\tsetStoryFormatExtensionsEnabled(false);\n\t\t\t} else {\n\t\t\t\tsetEditorCrashed(true);\n\t\t\t}\n\n\t\t\tresetError();\n\t\t}\n\t}, [error, resetError, storyFormatExtensionsEnabled]);\n\n\tconst handlePassageTextChange = React.useCallback(\n\t\t(text: string) => {\n\t\t\tdispatch(updatePassage(story, passage, {text}));\n\t\t},\n\t\t[dispatch, passage, story]\n\t);\n\n\tfunction handleExecCommand(name: string) {\n\t\t// A format toolbar command probably will affect the editor content. It\n\t\t// appears that react-codemirror2 can't maintain the selection properly in\n\t\t// all cases when this happens (particularly when using\n\t\t// `replaceSelection('something', 'around')`), so we take a snapshot\n\t\t// immediately after the command runs, let react-codemirror2 work, then\n\t\t// reapply the selection ASAP.\n\n\t\tif (!cmEditor) {\n\t\t\tthrow new Error('No editor set');\n\t\t}\n\n\t\tcmEditor.execCommand(name);\n\n\t\tconst selections = cmEditor.listSelections();\n\n\t\tPromise.resolve().then(() => cmEditor.setSelections(selections));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"passage-edit-dialog\"\n\t\t\theaderLabel={passage.name}\n\t\t\tmaximizable\n\t\t>\n\t\t\t{editorCrashed ? (\n\t\t\t\t<ErrorMessage>{t('dialogs.passageEdit.editorCrashed')}</ErrorMessage>\n\t\t\t) : (\n\t\t\t\t<>\n\t\t\t\t\t<PassageToolbar editor={cmEditor} passage={passage} story={story} />\n\t\t\t\t\t{storyFormatExtensionsEnabled && (\n\t\t\t\t\t\t<StoryFormatToolbar\n\t\t\t\t\t\t\teditor={cmEditor}\n\t\t\t\t\t\t\tonExecCommand={handleExecCommand}\n\t\t\t\t\t\t\tstoryFormat={storyFormat}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t\t<TagToolbar passage={passage} story={story} />\n\t\t\t\t\t<ErrorBoundary>\n\t\t\t\t\t\t<PassageText\n\t\t\t\t\t\t\tonChange={handlePassageTextChange}\n\t\t\t\t\t\t\tonEditorChange={setCmEditor}\n\t\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t\t\tstory={story}\n\t\t\t\t\t\t\tstoryFormat={storyFormat}\n\t\t\t\t\t\t\tstoryFormatExtensionsDisabled={!storyFormatExtensionsEnabled}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ErrorBoundary>\n\t\t\t\t</>\n\t\t\t)}\n\t\t</DialogCard>\n\t);\n};\n\nexport const PassageEditDialog: React.FC<PassageEditDialogProps> = props => {\n\t// Check for the existence of the passage. If it doesn't (e.g. it was deleted\n\t// after the dialog was opened), render nothing and call onClose.\n\n\tconst {stories} = useUndoableStoriesContext();\n\n\ttry {\n\t\tpassageWithId(stories, props.storyId, props.passageId);\n\t} catch (err) {\n\t\tprops.onClose();\n\t\treturn null;\n\t}\n\n\treturn <InnerPassageEditDialog {...props} />;\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './file-input.css';\n\n// See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file\n\nexport interface FileInputProps {\n\taccept?: string;\n\tchildren: React.ReactNode;\n\tonChange: (file: File, data: string) => void;\n\tonError?: (error: Error) => void;\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const FileInput: React.FC<FileInputProps> = props => {\n\tconst {children, onChange, onError, orientation, ...otherProps} = props;\n\tconst className = classNames(\n\t\t'file-input',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\tfunction handleChange(changeEvent: React.ChangeEvent<HTMLInputElement>) {\n\t\tif (!changeEvent.target.files) {\n\t\t\tthrow new Error('Change event occurred but no files present');\n\t\t}\n\n\t\tconst file = changeEvent.target.files[0];\n\t\tconst reader = new FileReader();\n\n\t\treader.addEventListener('loadend', loadEvent => {\n\t\t\tif (reader.error) {\n\t\t\t\tconsole.warn(reader.error);\n\n\t\t\t\tif (onError) {\n\t\t\t\t\tonError(reader.error);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tonChange(file, reader.result as string);\n\t\t\t}\n\t\t});\n\n\t\treader.readAsText(file);\n\t}\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"file-input-label\">{children}</span>\n\t\t\t\t<span className=\"file-input-control\">\n\t\t\t\t\t<input {...otherProps} onChange={handleChange} type=\"file\" />\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {FileInput} from '../../components/control/file-input';\nimport {Story} from '../../store/stories';\nimport {importStories} from '../../util/import';\n\nexport interface FileChooserProps {\n\tonChange: (file: File, stories: Story[]) => void;\n}\n\nexport const FileChooser: React.FC<FileChooserProps> = props => {\n\tconst {onChange} = props;\n\tconst {t} = useTranslation();\n\n\tfunction handleChange(file: File, data: string) {\n\t\tonChange(file, importStories(data));\n\t}\n\n\treturn (\n\t\t<div className=\"file-chooser\">\n\t\t\t<p>\n\t\t\t\t<FileInput\n\t\t\t\t\taccept=\".html\"\n\t\t\t\t\tonChange={handleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyImport.filePrompt')}\n\t\t\t\t</FileInput>\n\t\t\t</p>\n\t\t</div>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {IconButton} from '../../components/control/icon-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport './story-chooser.css';\n\nexport interface StoryChooserProps {\n\texistingStories: Story[];\n\tonImport: (stories: Story[]) => void;\n\tstories: Story[];\n}\n\nexport const StoryChooser: React.FC<StoryChooserProps> = props => {\n\tconst {existingStories, onImport, stories} = props;\n\tconst [selectedStories, setSelectedStories] = React.useState<Story[]>([]);\n\tconst {t} = useTranslation();\n\n\tfunction willReplaceExisting(story: Story) {\n\t\treturn existingStories.some(\n\t\t\tother => storyFileName(other) === storyFileName(story)\n\t\t);\n\t}\n\n\tfunction handleChange(story: Story, selected: boolean) {\n\t\tif (selected) {\n\t\t\tsetSelectedStories(current => [...current, story]);\n\t\t} else {\n\t\t\tsetSelectedStories(current =>\n\t\t\t\tcurrent.filter(other => other.id !== story.id)\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"story-chooser\">\n\t\t\t<p>{t('dialogs.storyImport.storiesPrompt')}</p>\n\t\t\t<ul>\n\t\t\t\t{stories.map(story => (\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\tkey={story.id}\n\t\t\t\t\t\t\tlabel={story.name}\n\t\t\t\t\t\t\tonChange={selected => handleChange(story, selected)}\n\t\t\t\t\t\t\tvalue={selectedStories.includes(story)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{selectedStories.includes(story) && willReplaceExisting(story) && (\n\t\t\t\t\t\t\t<span className=\"replace-warning\">\n\t\t\t\t\t\t\t\t{t('dialogs.storyImport.willReplaceExisting')}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</li>\n\t\t\t\t))}\n\t\t\t</ul>\n\t\t\t<div className=\"actions\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={selectedStories.length === 0}\n\t\t\t\t\ticon={<IconFileImport />}\n\t\t\t\t\tlabel={t('dialogs.storyImport.importSelected')}\n\t\t\t\t\tonClick={() => onImport(selectedStories)}\n\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../../components/container/card';\nimport {\n\tDialogCard,\n\tDialogCardProps\n} from '../../components/container/dialog-card';\nimport {importStories, Story, useStoriesContext} from '../../store/stories';\nimport {FileChooser} from './file-chooser';\nimport {StoryChooser} from './story-chooser';\nimport './story-import.css';\n\nexport type StoryImportDialogProps = DialogCardProps;\n\nexport const StoryImportDialog: React.FC<StoryImportDialogProps> = props => {\n\tconst {onClose} = props;\n\tconst {t} = useTranslation();\n\tconst {dispatch, stories: existingStories} = useStoriesContext();\n\tconst [file, setFile] = React.useState<File>();\n\tconst [stories, setStories] = React.useState<Story[]>([]);\n\n\tfunction handleFileChange(file: File, stories: Story[]) {\n\t\tsetFile(file);\n\t\tsetStories(stories);\n\t}\n\n\tfunction handleImport(stories: Story[]) {\n\t\tdispatch(importStories(stories, existingStories));\n\t\tonClose();\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"story-import-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyImport.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<FileChooser onChange={handleFileChange} />\n\t\t\t\t{file && stories.length > 0 && (\n\t\t\t\t\t<StoryChooser\n\t\t\t\t\t\texistingStories={existingStories}\n\t\t\t\t\t\tonImport={handleImport}\n\t\t\t\t\t\tstories={stories}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t\t{file && stories.length === 0 && (\n\t\t\t\t\t<p>{t('dialogs.storyImport.noStoriesInFile')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tpassageWithId,\n\tpassageWithName,\n\tstoryWithId,\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory\n} from '../stories';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns an action or thunk to reverse a single action.\n */\nexport function reverseAction(\n\taction: StoriesAction,\n\tstate: StoriesState\n): StoriesActionOrThunk {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\tif (action.props.id) {\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\tpassageId: action.props.id,\n\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t};\n\t\t\t} else if (action.props.name) {\n\t\t\t\t// This is dependant on the fact that we will only undo this action\n\t\t\t\t// immediately--otherwise this could create havoc if the passage has\n\t\t\t\t// been renamed in the meantime.\n\t\t\t\t//\n\t\t\t\t// This also assumes that the create action will succeed--e.g. there are\n\t\t\t\t// no conflicts.\n\t\t\t\tconst reverseThunk: Thunk<StoriesState, StoriesAction> = (\n\t\t\t\t\tdispatch,\n\t\t\t\t\tgetState\n\t\t\t\t) => {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\tpassageId: passageWithName(\n\t\t\t\t\t\t\tgetState(),\n\t\t\t\t\t\t\taction.storyId,\n\t\t\t\t\t\t\taction.props.name!\n\t\t\t\t\t\t).id,\n\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\treturn reverseThunk;\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassage action without either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t// TODO: crashes on a replace all that affects a passage name, unclear why\n\n\t\tcase 'createPassages':\n\t\t\tif (action.props.some(prop => !prop.id && !prop.name)) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassages action where a prop set doesn't have either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn (dispatch, getState) => {\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (props.id) {\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: props.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (props.name) {\n\t\t\t\t\t\t// This is dependent on the fact that we will only undo this action\n\t\t\t\t\t\t// immediately--see comment about the createPassage action.\n\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: passageWithName(getState(), action.storyId, props.name)\n\t\t\t\t\t\t\t\t.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\n\t\tcase 'deletePassage':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassage',\n\t\t\t\tprops: passageWithId(state, action.storyId, action.passageId),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'deletePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassages',\n\t\t\t\tprops: action.passageIds.map(passageId =>\n\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updatePassage': {\n\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t}),\n\t\t\t\t{} as Passage\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tprops,\n\t\t\t\tpassageId: action.passageId,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\n\t\tcase 'updatePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tpassageUpdates: Object.keys(action.passageUpdates).reduce(\n\t\t\t\t\t(result, passageId) => {\n\t\t\t\t\t\tconst passage = passageWithId(state, action.storyId, passageId);\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t[passageId]: Object.keys(action.passageUpdates[passageId]).reduce(\n\t\t\t\t\t\t\t\t(passageResult, propName) => ({\n\t\t\t\t\t\t\t\t\t...passageResult,\n\t\t\t\t\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t{} as Passage\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t};\n\t\t\t\t\t},\n\t\t\t\t\t{} as Record<string, Partial<Passage>>\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: story[propName as keyof Story]\n\t\t\t\t}),\n\t\t\t\t{} as Story\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\t}\n\n\tthrow new Error(`Don't know how to reverse action type \"${action.type}\"`);\n}\n","import * as React from 'react';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {reverseAction} from './reverse-action';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns a thunk to reverse a thunk's actions. **This only works with thunks\n * that dispatch all actions synchronously.**\n */\nexport function reverseThunk(\n\tthunk: Thunk<StoriesState, StoriesAction>,\n\tstate: StoriesState\n): Thunk<StoriesState, StoriesAction> {\n\tconst actions: StoriesActionOrThunk[] = [];\n\tconst dispatch: React.Dispatch<StoriesActionOrThunk> = (\n\t\tactionOrThunk: StoriesActionOrThunk\n\t) => {\n\t\tif (typeof actionOrThunk === 'function') {\n\t\t\tactions.push(reverseThunk(actionOrThunk, state));\n\t\t} else {\n\t\t\tactions.push(reverseAction(actionOrThunk, state));\n\t\t}\n\t};\n\n\tthunk(dispatch, () => state);\n\treturn dispatch => actions.forEach(dispatch);\n}\n","// This reducer manages tracking undo states only. It does not actually perform\n// the undo/redos itself--that is instead done by\n// <UndoableStoriesContextProvider>, which orchestrates things between this\n// reducer and the main stories reducer.\n\nimport * as React from 'react';\nimport {reverseAction} from './reverse-action';\nimport {reverseThunk} from './reverse-thunk';\nimport {\n\tStoryChange,\n\tUndoableStoriesAction,\n\tUndoableStoriesState\n} from './undoable-stories.types';\n\nexport const reducer: React.Reducer<\n\tUndoableStoriesState,\n\tUndoableStoriesAction\n> = (state, action) => {\n\tswitch (action.type) {\n\t\tcase 'addChange':\n\t\t\tconst newChange: StoryChange = {\n\t\t\t\tdescription: action.description,\n\t\t\t\tredo: action.action,\n\t\t\t\tundo:\n\t\t\t\t\ttypeof action.action === 'function'\n\t\t\t\t\t\t? reverseThunk(action.action, action.storiesState)\n\t\t\t\t\t\t: reverseAction(action.action, action.storiesState)\n\t\t\t};\n\n\t\t\t// Slice off any changes after the current one.\n\n\t\t\tconst newChanges = [\n\t\t\t\t...state.changes.slice(0, state.currentChange + 1),\n\t\t\t\tnewChange\n\t\t\t];\n\n\t\t\treturn {\n\t\t\t\tchanges: newChanges,\n\t\t\t\tcurrentChange: newChanges.length - 1\n\t\t\t};\n\n\t\tcase 'updateCurrent':\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tcurrentChange: Math.min(\n\t\t\t\t\tMath.max(state.currentChange + action.change, -1),\n\t\t\t\t\tstate.changes.length - 1\n\t\t\t\t)\n\t\t\t};\n\t}\n};\n","// This context wraps access to a StoriesContext so that changes made can be\n// undone. To properly use this, a change should be dispatched via either a\n// single action object or a thunk. This context assumes that each dispatch call\n// should be treated as a discrete change. If this context is being used, all\n// changes should go through this context--the StoriesContext shouldn't be\n// accessed directly.\n\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {\n\tStoriesActionOrThunk,\n\tUndoableStoriesContextProps\n} from './undoable-stories.types';\nimport {reducer} from './reducer';\nimport {useStoriesContext} from '../stories';\n\nexport const UndoableStoriesContext = React.createContext<UndoableStoriesContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tstories: []\n\t}\n);\n\nUndoableStoriesContext.displayName = 'UndoableStories';\n\nexport const useUndoableStoriesContext = () =>\n\tReact.useContext(UndoableStoriesContext);\n\nexport const UndoableStoriesContextProvider: React.FC = props => {\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst [state, dispatch] = React.useReducer(reducer, {\n\t\tchanges: [],\n\t\tcurrentChange: -1\n\t});\n\tconst dispatchAndRecordStoryAction = React.useCallback(\n\t\t(action: StoriesActionOrThunk, description?: string) => {\n\t\t\tif (description) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addChange',\n\t\t\t\t\taction,\n\t\t\t\t\tdescription: description,\n\t\t\t\t\tstoriesState: stories\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn storiesDispatch(action);\n\t\t},\n\t\t[stories, storiesDispatch]\n\t);\n\tconst {t} = useTranslation();\n\n\tlet redo: (() => void) | undefined = undefined;\n\tlet redoLabel: string | undefined = undefined;\n\tlet undo: (() => void) | undefined = undefined;\n\tlet undoLabel: string | undefined = undefined;\n\n\tif (state.changes.length > 0) {\n\t\tif (state.currentChange >= 0) {\n\t\t\tundo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange].undo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: -1});\n\t\t\t};\n\t\t\tundoLabel = t('common.undoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange].description)\n\t\t\t});\n\t\t}\n\n\t\tif (state.currentChange < state.changes.length - 1) {\n\t\t\tredo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange + 1].redo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: 1});\n\t\t\t};\n\t\t\tredoLabel = t('common.redoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange + 1].description)\n\t\t\t});\n\t\t}\n\t}\n\n\treturn (\n\t\t<UndoableStoriesContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch: dispatchAndRecordStoryAction,\n\t\t\t\tredo,\n\t\t\t\tredoLabel,\n\t\t\t\tstories,\n\t\t\t\tundo,\n\t\t\t\tundoLabel\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</UndoableStoriesContext.Provider>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat, sortFormats} from '../../store/story-formats';\nimport {TextSelect, TextSelectProps} from '../control/text-select';\n\nexport interface StoryFormatSelectProps\n\textends Omit<TextSelectProps, 'options' | 'value'> {\n\tformats: StoryFormat[];\n\tselectedFormat: StoryFormat;\n}\n\nexport const StoryFormatSelect: React.FC<StoryFormatSelectProps> = props => {\n\tconst {formats, selectedFormat, ...other} = props;\n\tconst {t} = useTranslation();\n\tconst loadingFormats = formats.filter(\n\t\tformat => format.loadState === 'loading'\n\t);\n\tconst visibleFormats = sortFormats(\n\t\tformats.filter(\n\t\t\tformat => format.loadState === 'loaded' || format.id === selectedFormat.id\n\t\t)\n\t);\n\tconst options = visibleFormats.map(format => ({\n\t\tdisabled: false,\n\t\tlabel: `${format.name} ${format.version}`,\n\t\tvalue: format.id\n\t}));\n\n\tif (loadingFormats.length !== 0) {\n\t\toptions.push({\n\t\t\tdisabled: true,\n\t\t\tlabel: t('components.storyFormatSelect.loadingCount', {\n\t\t\t\tloadingCount: loadingFormats.length\n\t\t\t}),\n\t\t\tvalue: ''\n\t\t});\n\t}\n\n\treturn <TextSelect {...other} options={options} value={selectedFormat.id} />;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {storyStats, Story} from '../../store/stories';\nimport './story-stats.css';\n\nconst dateFormatter = new Intl.DateTimeFormat([], {\n\tdateStyle: 'full',\n\ttimeStyle: 'long'\n});\n\nexport interface StoryDetailsDialogStatsProps {\n\tstory: Story;\n}\n\nexport const StoryDetailsDialogStats: React.FC<StoryDetailsDialogStatsProps> = props => {\n\tconst {story} = props;\n\tconst stats = storyStats(story);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-stats\">\n\t\t\t<table className=\"counts\">\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.characters}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.characters')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.words}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.words')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.passages}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.passages')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.links.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.links')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.brokenLinks.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.brokenLinks')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<div className=\"update-and-ifid\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.lastUpdate', {\n\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.ifid', {ifid: story.ifid})}&nbsp;\n\t\t\t\t\t<a href=\"https://ifdb.org/help-ifid\" target=\"_blank\" rel=\"noreferrer\">\n\t\t\t\t\t\t{t('dialogs.storyDetails.stats.ifidExplanation')}\n\t\t\t\t\t</a>\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {CardContent} from '../../components/container/card';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {StoryFormatSelect} from '../../components/story-format/story-format-select';\nimport {storyWithId, updateStory, useStoriesContext} from '../../store/stories';\nimport {\n\tformatWithId,\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {FormatLoader} from '../../store/format-loader';\nimport {DialogComponentProps} from '../dialogs.types';\nimport {StoryDetailsDialogStats} from './story-stats';\n\nexport interface StoryDetailsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryDetailsDialog: React.FC<StoryDetailsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tfunction handleFormatChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst newFormat = formatWithId(formats, event.target.value);\n\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\tstoryFormat: newFormat.name,\n\t\t\t\tstoryFormatVersion: newFormat.version\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-details-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={story.name}\n\t\t>\n\t\t\t<div className=\"story-format\">\n\t\t\t\t<FormatLoader block={false} />\n\t\t\t\t<StoryFormatSelect\n\t\t\t\t\tformats={formats}\n\t\t\t\t\tonChange={handleFormatChange}\n\t\t\t\t\tselectedFormat={formatWithNameAndVersion(\n\t\t\t\t\t\tformats,\n\t\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t{t('common.storyFormat')}\n\t\t\t\t</StoryFormatSelect>\n\t\t\t\t<a\n\t\t\t\t\thref=\"https://twinery.org/2storyformats\"\n\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\trel=\"noreferrer\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyDetails.storyFormatExplanation')}\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t\t<ButtonBar>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storyDetails.snapToGrid')}\n\t\t\t\t\tonChange={value =>\n\t\t\t\t\t\tdispatch(updateStory(stories, story, {snapToGrid: value}))\n\t\t\t\t\t}\n\t\t\t\t\tvalue={story.snapToGrid}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t\t<CardContent>\n\t\t\t\t{!other.collapsed && <StoryDetailsDialogStats story={story} />}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {TextInput} from './text-input';\nimport {TextSelect} from './text-select';\nimport './font-select.css';\n\nconst families = ['var(--font-monospaced)', 'var(--font-system)'];\nconst scales = [0.8, 0.9, 1, 1.25, 1.5, 2];\n\nexport interface FontSelectProps {\n\tfamilyLabel: string;\n\tfontFamily: string;\n\tfontScale: number;\n\tonChangeFamily: (value: string) => void;\n\tonChangeScale: (value: number) => void;\n\tscaleLabel: string;\n}\n\nexport const FontSelect: React.FC<FontSelectProps> = props => {\n\tconst {\n\t\tfamilyLabel,\n\t\tfontFamily,\n\t\tfontScale,\n\t\tonChangeFamily,\n\t\tonChangeScale,\n\t\tscaleLabel\n\t} = props;\n\tconst [customScaleVisible, setCustomScaleVisible] = React.useState(\n\t\t!scales.includes(fontScale)\n\t);\n\tconst [customFamilyVisible, setCustomFamilyVisible] = React.useState(\n\t\t!families.includes(fontFamily)\n\t);\n\tconst [customFamily, setCustomFamily] = React.useState(fontFamily);\n\tconst [customScale, setCustomScale] = React.useState(\n\t\t(fontScale * 100).toString()\n\t);\n\tconst {t} = useTranslation();\n\n\tfunction handleFamilyChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomFamilyVisible(true);\n\t\t\tif (families.includes(customFamily)) {\n\t\t\t\tsetCustomFamily('');\n\t\t\t}\n\t\t} else {\n\t\t\tsetCustomFamilyVisible(false);\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleScaleChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomScaleVisible(true);\n\t\t} else {\n\t\t\tsetCustomScaleVisible(false);\n\t\t\tonChangeScale(parseFloat(event.target.value));\n\t\t}\n\t}\n\n\tfunction handleCustomFamilyChange(\n\t\tevent: React.ChangeEvent<HTMLInputElement>\n\t) {\n\t\tsetCustomFamily(event.target.value);\n\n\t\tif (event.target.value.trim() !== '') {\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleCustomScaleChange(event: React.ChangeEvent<HTMLInputElement>) {\n\t\tsetCustomScale(event.target.value);\n\n\t\tconst value = parseInt(event.target.value);\n\n\t\tif (Number.isFinite(value)) {\n\t\t\tonChangeScale(value / 100);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"font-select\">\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleFamilyChange}\n\t\t\t\toptions={[\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.system'),\n\t\t\t\t\t\tvalue: 'var(--font-system)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.monospaced'),\n\t\t\t\t\t\tvalue: 'var(--font-monospaced)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.custom'),\n\t\t\t\t\t\tvalue: 'custom'\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tvalue={customFamilyVisible ? 'custom' : fontFamily}\n\t\t\t>\n\t\t\t\t{familyLabel}\n\t\t\t</TextSelect>\n\t\t\t{customFamilyVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomFamilyChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customFamily}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customFamilyDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleScaleChange}\n\t\t\t\toptions={[\n\t\t\t\t\t...scales.map(scale => ({\n\t\t\t\t\t\tlabel: t('components.fontSelect.percentage', {\n\t\t\t\t\t\t\tpercent: scale * 100\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tvalue: scale.toString()\n\t\t\t\t\t})),\n\t\t\t\t\t{label: t('common.custom'), value: 'custom'}\n\t\t\t\t]}\n\t\t\t\tvalue={customScaleVisible ? 'custom' : fontScale.toString()}\n\t\t\t>\n\t\t\t\t{scaleLabel}\n\t\t\t</TextSelect>\n\t\t\t{customScaleVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomScaleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customScale}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customScaleDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","/**\n * Locales supported in the app.\n * @see https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes\n */\nexport const locales = [\n\t{code: 'ca', name: 'Català'},\n\t{code: 'cs', name: 'Čeština'},\n\t{code: 'da', name: 'Dansk'},\n\t{code: 'de', name: 'Deutsch'},\n\t{code: 'en', name: 'English'},\n\t{code: 'es', name: 'Castellano'},\n\t{code: 'fi', name: 'Suomi'},\n\t{code: 'fr', name: 'Français'},\n\t{code: 'it', name: 'Italiano'},\n\t{code: 'ms', name: 'Bahasa Melayu'},\n\t{code: 'nb', name: 'Norsk bokmål'},\n\t{code: 'nl', name: 'Nederlands'},\n\t{code: 'pt-br', name: 'Português Brasileiro'},\n\t{code: 'pt-pt', name: 'Português'},\n\t{code: 'ru', name: 'русский'},\n\t{code: 'sv', name: 'Svenska'},\n\t{code: 'tr', name: 'Türkçe'},\n\t{code: 'zh-cn', name: '中文(简体)'}\n];\n\n/**\n * Finds the closest match for a locale in app-supported locales, for example\n * mapping `en-US` to `en`. If none are plausible, this returns `en` as a\n * default.\n */\nexport function closestAppLocale(code: string) {\n\t// Exact match? \n\n\tif (locales.some(locale => locale.code === code)) {\n\t\treturn code;\n\t}\n\n\tif (code.includes('-')) {\n\t\tconst roughCode = code.replace(/-.+/, '');\n\t\tconst roughMatch = locales.find(locale => locale.code === roughCode || locale.code.replace(/-.+/, '') === roughCode);\n\n\t\tif (roughMatch) {\n\t\t\treturn roughMatch.code;\n\t\t}\n\t}\n\n\treturn 'en';\n}","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard, DialogCardProps} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {FontSelect} from '../components/control/font-select';\nimport {TextSelect} from '../components/control/text-select';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {closestAppLocale, locales} from '../util/locales';\nimport './app-prefs.css';\n\nexport const AppPrefsDialog: React.FC<\n\tOmit<DialogCardProps, 'headerLabel'>\n> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-prefs-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appPrefs.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('locale', e.target.value))}\n\t\t\t\t\toptions={locales.map(locale => ({\n\t\t\t\t\t\tlabel: locale.name,\n\t\t\t\t\t\tvalue: locale.code\n\t\t\t\t\t}))}\n\t\t\t\t\tvalue={closestAppLocale(prefs.locale)}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.language')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('appTheme', e.target.value))}\n\t\t\t\t\toptions={[\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeSystem'), value: 'system'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeLight'), value: 'light'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeDark'), value: 'dark'}\n\t\t\t\t\t]}\n\t\t\t\t\tvalue={prefs.appTheme}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.theme')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e =>\n\t\t\t\t\t\tdispatch(setPref('dialogWidth', parseInt(e.target.value)))\n\t\t\t\t\t}\n\t\t\t\t\toptions={[\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.dialogWidths.default'), value: '600'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.dialogWidths.wider'), value: '700'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.dialogWidths.widest'), value: '800'}\n\t\t\t\t\t]}\n\t\t\t\t\tvalue={prefs.dialogWidth.toString()}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.dialogWidth')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.appPrefs.editorCursorBlinks')}\n\t\t\t\t\tonChange={value => dispatch(setPref('editorCursorBlinks', value))}\n\t\t\t\t\tvalue={prefs.editorCursorBlinks}\n\t\t\t\t/>\n\t\t\t\t<p className=\"font-explanation\">\n\t\t\t\t\t{t('dialogs.appPrefs.fontExplanation')}\n\t\t\t\t</p>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.passageEditorFont')}\n\t\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.passageEditorFontScale')}\n\t\t\t\t/>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.codeEditorFont')}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.codeEditorFontScale')}\n\t\t\t\t/>\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {defaults} from './defaults';\nimport {PrefsAction, PrefsContextProps, PrefsState} from './prefs.types';\nimport {reducer} from './reducer';\n\nexport const PrefsContext = React.createContext<PrefsContextProps>({\n\tdispatch: () => {},\n\tprefs: defaults()\n});\n\nPrefsContext.displayName = 'Prefs';\n\nexport const usePrefsContext = () => React.useContext(PrefsContext);\n\nexport const PrefsContextProvider: React.FC = props => {\n\tconst {prefs} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tPrefsState,\n\t\tPrefsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tprefs.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistPrefs');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[prefs, reportError]\n\t);\n\n\tconst [state, dispatch] = React.useReducer(persistedReducer, defaults());\n\n\treturn (\n\t\t<PrefsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tprefs: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</PrefsContext.Provider>\n\t);\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {defaults} from './defaults';\nimport {formatWithNameAndVersion, newestFormatNamed} from '../story-formats';\n\nexport const reducer: React.Reducer<PrefsState, PrefsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn {...state, ...action.state};\n\n\t\tcase 'repair':\n\t\t\tconst defs = defaults();\n\n\t\t\t// Type check values.\n\n\t\t\tlet changes: Partial<PrefsState> = Object.entries(defs).reduce(\n\t\t\t\t(result, [key, value]) => {\n\t\t\t\t\tconst prefKey = key as keyof PrefsState;\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t(typeof value === 'number' && !Number.isFinite(state[prefKey])) ||\n\t\t\t\t\t\ttypeof value !== typeof state[prefKey]\n\t\t\t\t\t) {\n\t\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t\t`Repairing preference \"${key}\" by setting it to ${value}, ` +\n\t\t\t\t\t\t\t\t`was ${state[prefKey]} (bad type)`\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn {...result, [prefKey]: value};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t},\n\t\t\t\t{}\n\t\t\t);\n\n\t\t\t// If the proofing or story format don't match an existing format, repair\n\t\t\t// them to the most recent version with the same name. If none exist with\n\t\t\t// that name, repair to the default.\n\n\t\t\tconst {proofingFormat, storyFormat} = state;\n\t\t\tconst {allFormats} = action;\n\n\t\t\ttry {\n\t\t\t\tformatWithNameAndVersion(\n\t\t\t\t\tallFormats,\n\t\t\t\t\tproofingFormat.name,\n\t\t\t\t\tproofingFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\tconst format = newestFormatNamed(allFormats, proofingFormat.name);\n\n\t\t\t\tif (format) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing proofing format preference (version doesn't exist) by setting to ${format.name} ${format.version}, was ${proofingFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.proofingFormat = {name: format.name, version: format.version};\n\t\t\t\t} else {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing proofing format preference (format doesn't exist at all) by setting to default ${defs.proofingFormat.name} ${defs.proofingFormat.version}, was ${proofingFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.proofingFormat = {\n\t\t\t\t\t\tname: defs.proofingFormat.name,\n\t\t\t\t\t\tversion: defs.proofingFormat.version\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tformatWithNameAndVersion(\n\t\t\t\t\tallFormats,\n\t\t\t\t\tstoryFormat.name,\n\t\t\t\t\tstoryFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\tconst format = newestFormatNamed(allFormats, storyFormat.name);\n\n\t\t\t\tif (format) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story format preference (version doesn't exist) by setting to ${format.name} ${format.version}, was ${storyFormat.name} ${storyFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.storyFormat = {name: format.name, version: format.version};\n\t\t\t\t} else {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story format preference (format doesn't exist at all) by setting to default ${defs.storyFormat.name} ${defs.storyFormat.version}, was ${storyFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.storyFormat = {\n\t\t\t\t\t\tname: defs.storyFormat.name,\n\t\t\t\t\t\tversion: defs.storyFormat.version\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {...state, ...changes};\n\n\t\tcase 'update': {\n\t\t\treturn {...state, [action.name]: action.value};\n\t\t}\n\t}\n};\n","import uuid from 'tiny-uuid';\nimport * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsContextProps,\n\tStoryFormatsState\n} from './story-formats.types';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {reducer} from './reducer';\n\nconst defaultBuiltins: StoryFormat[] = builtins().map(f => ({\n\t...f,\n\tid: uuid(),\n\tloadState: 'unloaded',\n\tselected: false,\n\tuserAdded: false\n}));\n\nexport const StoryFormatsContext = React.createContext<StoryFormatsContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tformats: []\n\t}\n);\n\nStoryFormatsContext.displayName = 'StoryFormats';\n\nexport const useStoryFormatsContext = () =>\n\tReact.useContext(StoryFormatsContext);\n\nexport const StoryFormatsContextProvider: React.FC = props => {\n\tconst {storyFormats} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoryFormatsState,\n\t\tStoryFormatsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoryFormats.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStoryFormats');\n\t\t\t}\n\t\t\treturn newState;\n\t\t},\n\t\t[reportError, storyFormats]\n\t);\n\n\tconst [state, dispatch] = useThunkReducer(persistedReducer, defaultBuiltins);\n\n\treturn (\n\t\t<StoryFormatsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tformats: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</StoryFormatsContext.Provider>\n\t);\n};\n","import uuid from 'tiny-uuid';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsState\n} from './story-formats.types';\n\nexport const reducer: React.Reducer<StoryFormatsState, StoryFormatsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn [...action.state];\n\n\t\tcase 'repair':\n\t\t\tconst builtinFormats = builtins();\n\n\t\t\t// Filter out any outdated builtins.\n\n\t\t\tconst result = state.filter(format => {\n\t\t\t\tconst keep =\n\t\t\t\t\tformat.userAdded ||\n\t\t\t\t\tbuiltinFormats.some(\n\t\t\t\t\t\tf => f.name === format.name && f.version === format.version\n\t\t\t\t\t);\n\n\t\t\t\tif (!keep) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by removing ${format.name} ${format.version} ` +\n\t\t\t\t\t\t\t`(outdated version of built-in format)`\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn keep;\n\t\t\t});\n\n\t\t\t// Add any builtins not present.\n\n\t\t\tbuiltinFormats.forEach(builtinFormat => {\n\t\t\t\tif (\n\t\t\t\t\t!result.some(\n\t\t\t\t\t\tf =>\n\t\t\t\t\t\t\tf.name === builtinFormat.name &&\n\t\t\t\t\t\t\tf.version === builtinFormat.version\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by adding built-in ${builtinFormat.name} ${builtinFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tresult.push({\n\t\t\t\t\t\t...builtinFormat,\n\t\t\t\t\t\tid: uuid(),\n\t\t\t\t\t\tloadState: 'unloaded',\n\t\t\t\t\t\tselected: false,\n\t\t\t\t\t\tuserAdded: false\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn result;\n\n\t\tcase 'create':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn [...state, {...action.props, id: uuid(), loadState: 'unloaded'}];\n\n\t\tcase 'delete':\n\t\t\treturn state.filter(f => f.id !== action.id);\n\n\t\tcase 'update':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.id !== action.id &&\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn state.map(format => {\n\t\t\t\tif (format.id !== action.id) {\n\t\t\t\t\treturn format;\n\t\t\t\t}\n\n\t\t\t\treturn {...format, ...action.props} as StoryFormat;\n\t\t\t});\n\t}\n\n\treturn state;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCode, IconHeart} from '@tabler/icons';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {IconLink} from '../../components/control/icon-link';\nimport {getAppInfo} from '../../util/app-info';\nimport {DialogComponentProps} from '../dialogs.types';\nimport credits from './credits.json';\nimport './about-twine.css';\n\nexport const AboutTwineDialog: React.FC<DialogComponentProps> = props => {\n\tconst {t} = useTranslation();\n\tconst info = getAppInfo();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"about-twine-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.aboutTwine.title', {\n\t\t\t\tversion: info.version\n\t\t\t})}\n\t\t>\n\t\t\t<div className=\"content\">\n\t\t\t\t<p>{t('dialogs.aboutTwine.twineDescription')}</p>\n\t\t\t\t<p\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('dialogs.aboutTwine.license')\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t\t<div className=\"credits\">\n\t\t\t\t\t<div className=\"code\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.codeHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.code.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"localizations\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.localizationHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.localizations.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.donateToTwine')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://github.com/klembot/twinejs\"\n\t\t\t\t\t\ticon={<IconCode />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.codeRepo')}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {IconLoading} from '../image/icon';\nimport './loading-curtain.css';\n\nexport const LoadingCurtain: React.FC = () => (\n\t<div className=\"loading-curtain\">\n\t\t<IconLoading />\n\t</div>\n);\n","// Listens to changes in the locale preference and changes i18n's language\n// accordingly.\n\nimport * as React from 'react';\nimport {usePrefsContext} from './prefs';\nimport {i18n} from '../util/i18n';\n\nexport const LocaleSwitcher: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\tReact.useEffect(() => {\n\t\ti18n.changeLanguage(prefs.locale);\n\t}, [prefs.locale]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport 'element-closest';\n\nexport interface ClickAwayListenerProps {\n\tignoreSelector?: string;\n\tonClickAway: () => void;\n}\n\nexport const ClickAwayListener: React.FC<ClickAwayListenerProps> = props => {\n\tconst {children, ignoreSelector, onClickAway} = props;\n\tconst handleClick: React.MouseEventHandler = event => {\n\t\tif (ignoreSelector) {\n\t\t\tif (!(event.target as HTMLElement)?.closest(ignoreSelector)) {\n\t\t\t\tonClickAway();\n\t\t\t}\n\t\t} else {\n\t\t\tonClickAway();\n\t\t}\n\t};\n\n\treturn <div onClick={handleClick}>{children}</div>;\n};\n","import * as React from 'react';\nimport './card-group.css';\n\nexport type CardGroupProps =\n\t| {columns: number; maxWidth?: string}\n\t| {columnWidth: number | string; maxWidth?: string};\n\nexport const CardGroup: React.FC<CardGroupProps> = props => {\n\tconst style: React.CSSProperties = {\n\t\tgridTemplateColumns:\n\t\t\t'columnWidth' in props\n\t\t\t\t? `repeat(auto-fit, ${\n\t\t\t\t\t\ttypeof props.columnWidth === 'number'\n\t\t\t\t\t\t\t? props.columnWidth + 'px'\n\t\t\t\t\t\t\t: props.columnWidth\n\t\t\t\t  })`\n\t\t\t\t: `repeat(${props.columns}, 1fr)`,\n\t\tmaxWidth: props.maxWidth ?? 'auto'\n\t};\n\n\treturn (\n\t\t<div className=\"card-group\" style={style}>\n\t\t\t{props.children}\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {isElectronRenderer} from '../../util/is-electron';\n\nexport interface DocumentTitleProps {\n\ttitle: string;\n}\n\n/**\n * Sets the document title. This works around a bug with Electron and may not be\n * needed in later versions.\n */\nexport const DocumentTitle: React.FC<DocumentTitleProps> = ({title}) => {\n\t// Using `history.goBack()` doesn't seem to cause Electron to update the\n\t// window title bar--possibly tied to using a <HashRouter>. If it does in a\n\t// future version, we can just use react-helmet directly.\n\n\tReact.useEffect(() => {\n\t\tif (isElectronRenderer()) {\n\t\t\tconst timeout = window.setTimeout(() => {\n\t\t\t\tdocument.querySelector('title')!.innerHTML = title;\n\t\t\t}, 0);\n\n\t\t\treturn () => window.clearTimeout(timeout);\n\t\t}\n\t}, [title]);\n\n\treturn (\n\t\t<Helmet>\n\t\t\t<title>{title}</title>\n\t\t</Helmet>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport {Point} from '../../util/geometry';\nimport {DocumentTitle} from '../document-title/document-title';\nimport './main-content.css';\n\nexport interface MainContentProps\n\textends React.ComponentPropsWithoutRef<'div'> {\n\tgrabbable?: boolean;\n\tpadded?: boolean;\n\ttitle?: string;\n}\n\nexport const MainContent = React.forwardRef<HTMLDivElement, MainContentProps>(\n\t(props, ref) => {\n\t\tconst {children, grabbable, title} = props;\n\t\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\t\tconst className = classNames('main-content', {\n\t\t\tpadded: props.padded ?? true\n\t\t});\n\n\t\tReact.useImperativeHandle(\n\t\t\tref,\n\t\t\t() => containerRef.current as HTMLDivElement\n\t\t);\n\n\t\tReact.useEffect(() => {\n\t\t\tif (containerRef.current) {\n\t\t\t\tcontainerRef.current.focus();\n\t\t\t}\n\t\t}, []);\n\n\t\tReact.useEffect(() => {\n\t\t\tconst container = containerRef.current;\n\t\t\tlet dragScrollStart: Point;\n\t\t\tlet dragMouseStart: Point;\n\n\t\t\tfunction moveListener(event: PointerEvent) {\n\t\t\t\tif (container) {\n\t\t\t\t\tcontainer.scrollLeft =\n\t\t\t\t\t\tdragScrollStart.left + (dragMouseStart.left - event.clientX);\n\t\t\t\t\tcontainer.scrollTop =\n\t\t\t\t\t\tdragScrollStart.top + (dragMouseStart.top - event.clientY);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction upListener(event: PointerEvent) {\n\t\t\t\tif (event.button !== 2 || !container) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcontainer.releasePointerCapture(event.pointerId);\n\t\t\t\tcontainer.removeEventListener('pointermove', moveListener);\n\t\t\t\tcontainer.style.cursor = '';\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tfunction downListener(event: PointerEvent) {\n\t\t\t\tif (event.button !== 2 || !container) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcontainer.setPointerCapture(event.pointerId);\n\t\t\t\tcontainer.addEventListener('pointermove', moveListener);\n\t\t\t\tcontainer.addEventListener('pointerup', upListener);\n\t\t\t\tcontainer.style.cursor = 'grabbing';\n\t\t\t\tdragScrollStart = {\n\t\t\t\t\tleft: container.scrollLeft,\n\t\t\t\t\ttop: container.scrollTop\n\t\t\t\t};\n\t\t\t\tdragMouseStart = {left: event.clientX, top: event.clientY};\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tfunction ignoreContext(event: Event) {\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tif (grabbable && container) {\n\t\t\t\tcontainer.addEventListener('pointerdown', downListener);\n\t\t\t\tcontainer.addEventListener('contextmenu', ignoreContext);\n\t\t\t\treturn () => {\n\t\t\t\t\tcontainer.removeEventListener('pointerdown', downListener);\n\t\t\t\t\tcontainer.removeEventListener('contextmenu', ignoreContext);\n\t\t\t\t};\n\t\t\t}\n\t\t}, [grabbable]);\n\n\t\treturn (\n\t\t\t<div className={className} ref={containerRef}>\n\t\t\t\t{title && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<DocumentTitle title={title} />\n\t\t\t\t\t\t<h1>{title}</h1>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t);\n\t}\n);\n","import * as React from 'react';\nimport './badge.css';\n\nexport interface BadgeProps {\n\tlabel: string;\n}\n\nexport const Badge: React.FC<BadgeProps> = ({label}) => (\n\t<span className=\"badge\">{label}</span>\n);\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport {Card, CardProps} from './card';\nimport './selectable-card.css';\n\nexport interface SelectableCardProps extends CardProps {\n\tlabel: string;\n\tonDoubleClick?: React.MouseEventHandler;\n\tonSelect: (value: boolean, exclusive: boolean) => void;\n\tselected?: boolean;\n}\n\nexport const SelectableCard: React.FC<SelectableCardProps> = props => {\n\tconst {label, onDoubleClick, onSelect, selected, ...other} = props;\n\tconst onClick = React.useCallback(\n\t\t(event: React.MouseEvent) => {\n\t\t\tif (event.ctrlKey || event.shiftKey) {\n\t\t\t\tonSelect(!selected, false);\n\t\t\t} else {\n\t\t\t\tonSelect(true, true);\n\t\t\t}\n\t\t},\n\t\t[onSelect, selected]\n\t);\n\tconst onKeyDown = React.useCallback(\n\t\t(event: React.KeyboardEvent) => {\n\t\t\tif (event.key === ' ' || event.key === 'Enter') {\n\t\t\t\tevent.preventDefault();\n\n\t\t\t\tif (event.ctrlKey || event.shiftKey) {\n\t\t\t\t\tonSelect(!selected, false);\n\t\t\t\t} else {\n\t\t\t\t\tonSelect(true, true);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[onSelect, selected]\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classNames('selectable-card', {selected})}\n\t\t\trole=\"button\"\n\t\t\taria-label={label}\n\t\t\taria-pressed={selected}\n\t\t\tonClick={onClick}\n\t\t\tonDoubleClick={onDoubleClick}\n\t\t\tonKeyDown={onKeyDown}\n\t\t\ttabIndex={0}\n\t\t>\n\t\t\t<Card {...other} />\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat} from '../../../store/story-formats';\n\nexport interface StoryFormatCardDetailsProps {\n\tformat: StoryFormat;\n}\n\nexport const StoryFormatCardDetails: React.FC<StoryFormatCardDetailsProps> = ({\n\tformat\n}) => {\n\tconst {t} = useTranslation();\n\n\tif (format.loadState === 'unloaded' || format.loadState === 'loading') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>{t('components.storyFormatCard.loadingFormat')}</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tif (format.loadState === 'error') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('components.storyFormatCard.loadError', {\n\t\t\t\t\t\terrorMessage: format.loadError.message\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card-details\">\n\t\t\t{format.properties.author && (\n\t\t\t\t<p\n\t\t\t\t\tclassName=\"story-format-card-author\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('components.storyFormatCard.author', {\n\t\t\t\t\t\t\tauthor: format.properties.author\n\t\t\t\t\t\t})\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.description && (\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"story-format-card-description\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: format.properties.description\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.license && (\n\t\t\t\t<p className=\"story-format-card-license\">\n\t\t\t\t\t{t('components.storyFormatCard.license', {\n\t\t\t\t\t\tlicense: format.properties.license\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","import {IconAlertTriangle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {formatImageUrl, StoryFormat} from '../../../store/story-formats';\nimport {Badge} from '../../badge/badge';\nimport {CardContent} from '../../container/card';\nimport {SelectableCard} from '../../container/card/selectable-card';\nimport {IconLoading} from '../../image/icon';\nimport {StoryFormatCardDetails} from './story-format-card-details';\nimport './story-format-card.css';\n\nexport interface StoryFormatCardProps {\n\tdefaultFormat: boolean;\n\teditorExtensionsDisabled: boolean;\n\tformat: StoryFormat;\n\tonSelect: () => void;\n\tproofingFormat: boolean;\n}\n\nexport const StoryFormatCard: React.FC<StoryFormatCardProps> = props => {\n\tconst {\n\t\tdefaultFormat,\n\t\teditorExtensionsDisabled,\n\t\tformat,\n\t\tonSelect,\n\t\tproofingFormat\n\t} = props;\n\tconst {t} = useTranslation();\n\n\tlet image = <></>;\n\n\tif (format.loadState === 'error') {\n\t\timage = <IconAlertTriangle />;\n\t} else if (\n\t\tformat.loadState === 'unloaded' ||\n\t\tformat.loadState === 'loading'\n\t) {\n\t\timage = <IconLoading />;\n\t} else if (format.loadState === 'loaded' && format.properties.image) {\n\t\timage = <img src={formatImageUrl(format)} alt=\"\" />;\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card\">\n\t\t\t<SelectableCard\n\t\t\t\tlabel={t('components.storyFormatCard.name', {\n\t\t\t\t\tname: format.name,\n\t\t\t\t\tversion: format.version\n\t\t\t\t})}\n\t\t\t\tonSelect={onSelect}\n\t\t\t\tselected={format.selected}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-format-image\">{image}</div>\n\t\t\t\t\t<div className=\"story-format-description\">\n\t\t\t\t\t\t<h2>\n\t\t\t\t\t\t\t{t('components.storyFormatCard.name', {\n\t\t\t\t\t\t\t\tname: format.name,\n\t\t\t\t\t\t\t\tversion: format.version\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<StoryFormatCardDetails format={format} />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"story-format-badges\">\n\t\t\t\t\t\t{!format.userAdded && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.builtIn')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{defaultFormat && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.defaultFormat')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{editorExtensionsDisabled && (\n\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\tlabel={t('components.storyFormatCard.editorExtensionsDisabled')}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{format.loadState === 'loaded' && format.properties.proofing && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.proofing')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{proofingFormat && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.proofingFormat')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</CardContent>\n\t\t\t</SelectableCard>\n\t\t</div>\n\t);\n};\n","import {IconArrowLeft} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../control/icon-button';\n\nexport const BackButton: React.FC = () => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\tif (['/', '/stories'].includes(history.location.pathname)) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconArrowLeft />}\n\t\t\tvariant=\"primary\"\n\t\t\tlabel={\n\t\t\t\thistory.length > 1\n\t\t\t\t\t? t('common.back')\n\t\t\t\t\t: t('routes.storyList.titleGeneric')\n\t\t\t}\n\t\t\tonClick={() =>\n\t\t\t\thistory.length > 1 ? history.goBack() : history.push('/')\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHelp} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Tab, TabList, TabPanel, Tabs} from 'react-tabs';\nimport {IconButton} from '../control/icon-button';\nimport {BackButton} from './back-button';\nimport './route-toolbar.css';\n\nexport interface RouteToolbarProps {\n\thelpUrl?: string;\n\tpinnedControls?: React.ReactNode;\n\ttabs: Record<string, React.ReactNode>;\n}\n\nexport const RouteToolbar: React.FC<RouteToolbarProps> = props => {\n\tconst {helpUrl = 'https://twinery.org/2guide', pinnedControls, tabs} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"route-toolbar\">\n\t\t\t<Tabs selectedTabClassName=\"selected\">\n\t\t\t\t<div className=\"route-toolbar-top\">\n\t\t\t\t\t<BackButton />\n\t\t\t\t\t<TabList className=\"route-toolbar-tablist\">\n\t\t\t\t\t\t{Object.keys(tabs).map(tabName => (\n\t\t\t\t\t\t\t<Tab className=\"route-toolbar-tab\" key={tabName}>\n\t\t\t\t\t\t\t\t{tabName}\n\t\t\t\t\t\t\t</Tab>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</TabList>\n\t\t\t\t\t<div className=\"route-toolbar-pinned-controls\">\n\t\t\t\t\t\t{pinnedControls}\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconHelp />}\n\t\t\t\t\t\t\tlabel={t('common.help')}\n\t\t\t\t\t\t\tonClick={() => window.open(helpUrl, '_blank')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div>\n\t\t\t\t\t{Object.entries(tabs).map(([tabName, tabContent]) => (\n\t\t\t\t\t\t<TabPanel key={tabName}>{tabContent}</TabPanel>\n\t\t\t\t\t))}\n\t\t\t\t</div>\n\t\t\t</Tabs>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {\n\tpublishArchive,\n\tpublishStory,\n\tpublishStoryWithFormat,\n\tPublishOptions\n} from '../util/publish';\nimport {usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {storyWithId, useStoriesContext} from './stories';\nimport {getAppInfo} from '../util/app-info';\n\nexport interface UsePublishingProps {\n\tproofStory: (storyId: string) => Promise<string>;\n\tpublishArchive: (storyIds?: string[]) => Promise<string>;\n\tpublishStory: (\n\t\tstoryId: string,\n\t\tpublishOptions?: PublishOptions\n\t) => Promise<string>;\n\tpublishStoryData: (storyId: string) => string;\n}\n\n/**\n * A React hook publish stories from context. You probably want to use\n * `useStoryLaunch` instead--this is for doing the actual binding of the story\n * and story format.\n */\nexport function usePublishing(): UsePublishingProps {\n\t// As little logic as possible should live here--instead it should be in\n\t// util/publish.ts.\n\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch: storyFormatsDispatch, formats} = useStoryFormatsContext();\n\tconst {stories} = useStoriesContext();\n\n\treturn {\n\t\tpublishArchive: React.useCallback(\n\t\t\tasync () => publishArchive(stories, getAppInfo()),\n\t\t\t[stories]\n\t\t),\n\t\tproofStory: React.useCallback(\n\t\t\tasync storyId => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\t\tprefs.proofingFormat.version\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo()\n\t\t\t\t);\n\t\t\t},\n\t\t\t[\n\t\t\t\tformats,\n\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\tprefs.proofingFormat.version,\n\t\t\t\tstories,\n\t\t\t\tstoryFormatsDispatch\n\t\t\t]\n\t\t),\n\t\tpublishStory: React.useCallback(\n\t\t\tasync (storyId, publishOptions) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo(),\n\t\t\t\t\tpublishOptions\n\t\t\t\t);\n\t\t\t},\n\t\t\t[formats, stories, storyFormatsDispatch]\n\t\t),\n\t\tpublishStoryData: React.useCallback(\n\t\t\t(storyId: string) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\n\t\t\t\treturn publishStory(story, getAppInfo(), {startOptional: true});\n\t\t\t},\n\t\t\t[stories]\n\t\t)\n\t};\n}\n","import {usePublishing} from './use-publishing';\nimport {isElectronRenderer} from '../util/is-electron';\nimport {TwineElectronWindow} from '../electron/shared';\n\nexport interface UseStoryLaunchProps {\n\tplayStory: (storyId: string) => Promise<void>;\n\tproofStory: (storyId: string) => Promise<void>;\n\ttestStory: (storyId: string, startPassageId?: string) => Promise<void>;\n}\n\n/**\n * Provides functions to launch a story that include the correct handling for\n * both web and Electron contexts.\n */\nexport function useStoryLaunch(): UseStoryLaunchProps {\n\tconst {proofStory, publishStory} = usePublishing();\n\n\tif (isElectronRenderer()) {\n\t\tconst {twineElectron} = window as TwineElectronWindow;\n\n\t\tif (!twineElectron) {\n\t\t\tthrow new Error('Electron bridge is not present on window.');\n\t\t}\n\n\t\treturn {\n\t\t\tplayStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\tproofStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait proofStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\t\tstartId: startPassageId\n\t\t\t\t\t}),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t}\n\n\treturn {\n\t\tplayStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/play`, '_blank');\n\t\t},\n\t\tproofStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/proof`, '_blank');\n\t\t},\n\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\twindow.open(\n\t\t\t\tstartPassageId\n\t\t\t\t\t? `#/stories/${storyId}/test/${startPassageId}`\n\t\t\t\t\t: `#/stories/${storyId}/test`,\n\t\t\t\t'_blank'\n\t\t\t);\n\t\t}\n\t};\n}\n","import {saveAs} from 'file-saver';\n\n/**\n * Saves text to a file. This works in either a browser or Electron context.\n */\nexport function saveHtml(source: string, filename: string) {\n\tconst data = new Blob([source], {type: 'text/html;charset=utf-8'});\n\n\tsaveAs(data, filename);\n}\n","import {\n\tIconEye,\n\tIconFileText,\n\tIconPlayerPlay,\n\tIconTool,\n\tIconX\n} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next/';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {CardContent} from '../components/container/card';\nimport {CardButton} from '../components/control/card-button';\nimport {IconButton} from '../components/control/icon-button';\nimport {storyFileName} from '../electron/shared';\nimport {Story} from '../store/stories';\nimport {usePublishing} from '../store/use-publishing';\nimport {useStoryLaunch} from '../store/use-story-launch';\nimport {saveHtml} from '../util/save-html';\n\nexport interface BuildActionsProps {\n\tstory?: Story;\n}\n\nexport const BuildActions: React.FC<BuildActionsProps> = ({story}) => {\n\tconst {publishStory} = usePublishing();\n\tconst [playError, setPlayError] = React.useState<Error>();\n\tconst [proofError, setProofError] = React.useState<Error>();\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [testError, setTestError] = React.useState<Error>();\n\tconst {playStory, proofStory, testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\tfunction resetErrors() {\n\t\tsetPlayError(undefined);\n\t\tsetProofError(undefined);\n\t\tsetPublishError(undefined);\n\t\tsetTestError(undefined);\n\t}\n\n\tasync function handlePlay() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tawait playStory(story.id);\n\t\t} catch (error) {\n\t\t\tsetPlayError(error as Error);\n\t\t}\n\t}\n\n\tasync function handleProof() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tawait proofStory(story.id);\n\t\t} catch (error) {\n\t\t\tsetProofError(error as Error);\n\t\t}\n\t}\n\n\tasync function handlePublishFile() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tsaveHtml(await publishStory(story.id), storyFileName(story));\n\t\t} catch (error) {\n\t\t\tsetPublishError(error as Error);\n\t\t}\n\t}\n\n\tasync function handleTest() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tawait testStory(story.id);\n\t\t} catch (error) {\n\t\t\tsetTestError(error as Error);\n\t\t}\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={testError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconTool />}\n\t\t\t\tlabel={t('routeActions.build.test')}\n\t\t\t\tonChangeOpen={() => setTestError(undefined)}\n\t\t\t\tonClick={handleTest}\n\t\t\t\topen={!!testError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{testError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setTestError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={playError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconPlayerPlay />}\n\t\t\t\tlabel={t('routeActions.build.play')}\n\t\t\t\tonChangeOpen={() => setPlayError(undefined)}\n\t\t\t\tonClick={handlePlay}\n\t\t\t\topen={!!playError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{playError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setPlayError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={proofError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconEye />}\n\t\t\t\tlabel={t('routeActions.build.proof')}\n\t\t\t\tonChangeOpen={() => setProofError(undefined)}\n\t\t\t\tonClick={handleProof}\n\t\t\t\topen={!!proofError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{proofError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setProofError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={publishError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconFileText />}\n\t\t\t\tlabel={t('routeActions.build.publishToFile')}\n\t\t\t\tonChangeOpen={() => setPublishError(undefined)}\n\t\t\t\tonClick={handlePublishFile}\n\t\t\t\topen={!!publishError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{publishError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setPublishError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t</ButtonBar>\n\t);\n};\n","import {IconAward, IconBug, IconFileCode, IconSettings} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {IconButton} from '../components/control/icon-button';\nimport {AboutTwineDialog, AppPrefsDialog, useDialogsContext} from '../dialogs';\n\nexport const AppActions: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconSettings />}\n\t\t\t\tlabel={t('routeActions.app.preferences')}\n\t\t\t\tonClick={() => dispatch({type: 'addDialog', component: AppPrefsDialog})}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={history.location.pathname === '/story-formats'}\n\t\t\t\ticon={<IconFileCode />}\n\t\t\t\tlabel={t('routeActions.app.storyFormats')}\n\t\t\t\tonClick={() => history.push('/story-formats')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconAward />}\n\t\t\t\tlabel={t('routeActions.app.aboutApp')}\n\t\t\t\tonClick={() =>\n\t\t\t\t\tdispatch({type: 'addDialog', component: AboutTwineDialog})\n\t\t\t\t}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconBug />}\n\t\t\t\tlabel={t('routeActions.app.reportBug')}\n\t\t\t\tonClick={() => window.open('https://twinery.org/2bugs', '_blank')}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {\n\tcreateFromProperties,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\nimport {\n\tPromptButton,\n\tPromptButtonValidator\n} from '../../../../components/control/prompt-button';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format';\nimport './add-story-format-button.css';\n\nfunction isValidUrl(value: string) {\n\ttry {\n\t\tnew URL(value);\n\t\treturn true;\n\t} catch (e) {}\n\n\treturn false;\n}\n\nexport const AddStoryFormatButton: React.FC = () => {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [newFormatUrl, setNewFormatUrl] = React.useState('');\n\tconst {t} = useTranslation();\n\n\tasync function handleSubmit() {\n\t\tdispatch(\n\t\t\tcreateFromProperties(\n\t\t\t\tnewFormatUrl,\n\t\t\t\tawait fetchStoryFormatProperties(newFormatUrl)\n\t\t\t)\n\t\t);\n\t}\n\n\tconst validate: PromptButtonValidator = async (value: string) => {\n\t\tif (newFormatUrl.trim() === '') {\n\t\t\treturn {valid: false};\n\t\t}\n\n\t\tif (!isValidUrl(newFormatUrl)) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.invalidUrl'\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\tconst properties = await fetchStoryFormatProperties(newFormatUrl);\n\n\t\t\tif (\n\t\t\t\tformats.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === properties.name &&\n\t\t\t\t\t\tformat.version === properties.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn {\n\t\t\t\t\tmessage: t(\n\t\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.alreadyAdded',\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t\t}\n\t\t\t\t\t),\n\t\t\t\t\tvalid: false\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.addPreview',\n\t\t\t\t\t{\n\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: true\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.fetchError',\n\t\t\t\t\t{\n\t\t\t\t\t\terrorMessage: error.message\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\t};\n\n\treturn (\n\t\t<span className=\"add-format-button\">\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconPlus />}\n\t\t\t\tlabel={t('common.add')}\n\t\t\t\tonChange={event => setNewFormatUrl(event.target.value)}\n\t\t\t\tonSubmit={handleSubmit}\n\t\t\t\tprompt={t('routes.storyFormatList.toolbar.addStoryFormatButton.prompt')}\n\t\t\t\tsubmitIcon={<IconPlus />}\n\t\t\t\tsubmitLabel={t('common.add')}\n\t\t\t\tsubmitVariant=\"create\"\n\t\t\t\tvalidate={validate}\n\t\t\t\tvalue={newFormatUrl}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import {IconStar} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface DefaultStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const DefaultStoryFormatButton: React.FC<DefaultStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\tformat.properties.proofing ||\n\t\t(prefs.storyFormat.name === format.name &&\n\t\t\tprefs.storyFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as default\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'storyFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconStar />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsDefaultFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEye} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface ProofingStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const ProofingStoryFormatButton: React.FC<ProofingStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\t!format.properties.proofing ||\n\t\t(prefs.proofingFormat.name === format.name &&\n\t\t\tprefs.proofingFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as proofing\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'proofingFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconEye />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsProofingFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tdeleteFormat,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\n\nexport interface RemoveStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const RemoveStoryFormatButton: React.FC<RemoveStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch} = useStoryFormatsContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst isDefault =\n\t\tformat?.name === prefs.storyFormat.name &&\n\t\tformat?.version === prefs.storyFormat.version;\n\tconst isProofing =\n\t\tformat?.name === prefs.proofingFormat.name &&\n\t\tformat?.version === prefs.proofingFormat.version;\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format || !format.userAdded || isDefault || isProofing}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.remove')}\n\t\t\tonClick={() => format && dispatch(deleteFormat(format))}\n\t\t/>\n\t);\n};\n","import {IconPuzzle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface StoryFormatExtensionsButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const StoryFormatExtensionsButton: React.FC<StoryFormatExtensionsButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst extensionsDisabled = prefs.disabledStoryFormatEditorExtensions.some(\n\t\tother => other.name === format?.name && other.version === format?.version\n\t);\n\n\tfunction handleClick() {\n\t\tif (!format) {\n\t\t\tthrow new Error('Format is not set');\n\t\t}\n\n\t\t// This logic is a little backwards--the user is setting whether to use the\n\t\t// extensions but our preferences track disabled ones.\n\n\t\tif (extensionsDisabled) {\n\t\t\tdispatch(\n\t\t\t\tsetPref(\n\t\t\t\t\t'disabledStoryFormatEditorExtensions',\n\t\t\t\t\tprefs.disabledStoryFormatEditorExtensions.filter(\n\t\t\t\t\t\tf => f.name !== format.name || f.version !== format.version\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t} else {\n\t\t\tdispatch(\n\t\t\t\tsetPref('disabledStoryFormatEditorExtensions', [\n\t\t\t\t\t...prefs.disabledStoryFormatEditorExtensions,\n\t\t\t\t\t{name: format.name, version: format.version}\n\t\t\t\t])\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format}\n\t\t\ticon={<IconPuzzle />}\n\t\t\tlabel={t(\n\t\t\t\t`routes.storyFormatList.toolbar.${\n\t\t\t\t\textensionsDisabled ? 'enable' : 'disable'\n\t\t\t\t}FormatExtensions`\n\t\t\t)}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {StoryFormat} from '../../../../store/story-formats';\nimport {AddStoryFormatButton} from './add-story-format-button';\nimport {DefaultStoryFormatButton} from './default-story-format-button';\nimport {ProofingStoryFormatButton} from './proofing-story-format-button';\nimport {RemoveStoryFormatButton} from './remove-story-format-button';\nimport {StoryFormatExtensionsButton} from './story-format-extensions-button';\n\nexport interface FormatActionsProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const FormatActions: React.FC<FormatActionsProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst format = selectedFormats.length === 1 ? selectedFormats[0] : undefined;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<AddStoryFormatButton />\n\t\t\t<RemoveStoryFormatButton format={format} />\n\t\t\t<StoryFormatExtensionsButton format={format} />\n\t\t\t<DefaultStoryFormatButton format={format} />\n\t\t\t<ProofingStoryFormatButton format={format} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../../components/control/checkbox-button';\nimport {setPref, usePrefsContext} from '../../../store/prefs';\n\nexport const ViewActions: React.FC = () => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction setFilter(name: string) {\n\t\tdispatch(setPref('storyFormatListFilter', name));\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'current'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.current')}\n\t\t\t\tonChange={() => setFilter('current')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'current'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'user'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.user')}\n\t\t\t\tonChange={() => setFilter('user')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'user'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'all'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.all')}\n\t\t\t\tonChange={() => setFilter('all')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'all'}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions} from '../../../route-actions';\nimport {StoryFormat} from '../../../store/story-formats';\nimport {FormatActions} from './formats/format-actions';\nimport {ViewActions} from './view-actions';\n\nexport interface StoryFormatListToolbarProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const StoryFormatListToolbar: React.FC<StoryFormatListToolbarProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\ttabs={{\n\t\t\t\t[t('common.storyFormat')]: (\n\t\t\t\t\t<FormatActions selectedFormats={selectedFormats} />\n\t\t\t\t),\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {ClickAwayListener} from '../../components/click-away-listener';\nimport {CardGroup} from '../../components/container/card-group';\nimport {MainContent} from '../../components/container/main-content';\nimport {StoryFormatCard} from '../../components/story-format/story-format-card/story-format-card';\nimport {DialogsContextProvider} from '../../dialogs';\nimport {FormatLoader} from '../../store/format-loader';\nimport {usePrefsContext} from '../../store/prefs';\nimport {\n\tdeselectAllFormats,\n\tdeselectFormat,\n\tfilteredFormats,\n\tselectFormat,\n\tsortFormats,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {StoryFormatListToolbar} from './toolbar';\n\nexport const StoryFormatListRoute: React.FC = () => {\n\tconst {dispatch: formatsDispatch, formats} = useStoryFormatsContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst selectedFormats = formats.filter(format => format.selected);\n\n\tconst visibleFormats = sortFormats(\n\t\tfilteredFormats(formats, prefs.storyFormatListFilter)\n\t);\n\n\t// Any formats no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const format of selectedFormats) {\n\t\t\tif (format.selected && !visibleFormats.includes(format)) {\n\t\t\t\tformatsDispatch(deselectFormat(format));\n\t\t\t}\n\t\t}\n\t}, [prefsDispatch, selectedFormats, visibleFormats, formatsDispatch]);\n\n\tfunction handleSelect(format: StoryFormat) {\n\t\tformatsDispatch(selectFormat(format, true));\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-list-route\">\n\t\t\t<DialogsContextProvider>\n\t\t\t\t<StoryFormatListToolbar selectedFormats={selectedFormats} />\n\t\t\t\t<ClickAwayListener\n\t\t\t\t\tignoreSelector=\".story-format-card\"\n\t\t\t\t\tonClickAway={() => formatsDispatch(deselectAllFormats())}\n\t\t\t\t>\n\t\t\t\t\t<MainContent\n\t\t\t\t\t\ttitle={t(\n\t\t\t\t\t\t\t`routes.storyFormatList.title.${prefs.storyFormatListFilter}`\n\t\t\t\t\t\t)}\n\t\t\t\t\t>\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t{t(\n\t\t\t\t\t\t\t\tvisibleFormats.length > 0\n\t\t\t\t\t\t\t\t\t? 'routes.storyFormatList.storyFormatExplanation'\n\t\t\t\t\t\t\t\t\t: 'routes.storyFormatList.noneVisible'\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<FormatLoader>\n\t\t\t\t\t\t\t<CardGroup columnWidth=\"450px\">\n\t\t\t\t\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t\t\t\t\t{visibleFormats.map(format => (\n\t\t\t\t\t\t\t\t\t\t<CSSTransition\n\t\t\t\t\t\t\t\t\t\t\tclassNames=\"pop\"\n\t\t\t\t\t\t\t\t\t\t\tkey={format.id}\n\t\t\t\t\t\t\t\t\t\t\ttimeout={200}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<StoryFormatCard\n\t\t\t\t\t\t\t\t\t\t\t\tdefaultFormat={\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === prefs.storyFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === prefs.storyFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\teditorExtensionsDisabled={prefs.disabledStoryFormatEditorExtensions.some(\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabledFormat =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === disabledFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === disabledFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\tformat={format}\n\t\t\t\t\t\t\t\t\t\t\t\tonSelect={() => handleSelect(format)}\n\t\t\t\t\t\t\t\t\t\t\t\tproofingFormat={\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === prefs.proofingFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === prefs.proofingFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t</TransitionGroup>\n\t\t\t\t\t\t\t</CardGroup>\n\t\t\t\t\t\t</FormatLoader>\n\t\t\t\t\t</MainContent>\n\t\t\t\t</ClickAwayListener>\n\t\t\t</DialogsContextProvider>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {createUntitledPassage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\nimport {Point} from '../../../../util/geometry';\n\nexport interface CreatePassageButtonProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const CreatePassageButton: React.FC<CreatePassageButtonProps> = props => {\n\tconst {getCenter, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst handleClick = React.useCallback(() => {\n\t\tconst {left, top} = getCenter();\n\n\t\tdispatch(createUntitledPassage(story, left, top), 'undoChange.newPassage');\n\t}, [dispatch, getCenter, story]);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport 'element-closest';\nimport * as React from 'react';\nimport {useHotkeys} from 'react-hotkeys-hook';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {deletePassages, Passage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\n\nexport interface DeletePassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const DeletePassagesButton: React.FC<\n\tDeletePassagesButtonProps\n> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\tconst disabled = React.useMemo(() => {\n\t\tif (passages.length === 0) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn passages.some(passage => story.startPassage === passage.id);\n\t}, [passages, story.startPassage]);\n\tconst handleClick = React.useCallback(() => {\n\t\tif (passages.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tdispatch(\n\t\t\tdeletePassages(story, passages),\n\t\t\tpassages.length > 1\n\t\t\t\t? 'undoChange.deletePassages'\n\t\t\t\t: 'undoChange.deletePassage'\n\t\t);\n\t}, [dispatch, passages, story]);\n\n\tuseHotkeys('Backspace,Delete', handleClick, [handleClick]);\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={\n\t\t\t\t!disabled && passages.length > 1\n\t\t\t\t\t? t('common.deleteCount', {count: passages.length})\n\t\t\t\t\t: t('common.delete')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {PassageEditDialog, useDialogsContext} from '../../../../dialogs';\nimport {Passage, Story} from '../../../../store/stories';\n\nexport interface EditPassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const EditPassagesButton: React.FC<EditPassagesButtonProps> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tdispatch(dispatch =>\n\t\t\tpassages.forEach(passage =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: PassageEditDialog,\n\t\t\t\t\tprops: {passageId: passage.id, storyId: story.id}\n\t\t\t\t})\n\t\t\t)\n\t\t);\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={passages.length === 0}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={\n\t\t\t\tpassages.length > 1\n\t\t\t\t\t? t('common.editCount', {count: passages.length})\n\t\t\t\t\t: t('common.edit')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconMarquee} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tselectAllPassages,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface SelectAllPassagesButtonProps {\n\tstory: Story;\n}\n\nexport const SelectAllPassagesButton: React.FC<SelectAllPassagesButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconMarquee />}\n\t\t\tlabel={t('common.selectAll')}\n\t\t\tonClick={() => dispatch(selectAllPassages(story))}\n\t\t/>\n\t);\n};\n","import {IconRocket} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tPassage,\n\tStory,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface StartAtPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const StartAtPassageButton: React.FC<StartAtPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!passage) {\n\t\t\tthrow new Error('No passage set');\n\t\t}\n\n\t\tdispatch(updateStory(stories, story, {startPassage: passage.id}));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage || passage.id === story.startPassage}\n\t\t\ticon={<IconRocket />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.startStoryHere')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTool} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Passage, Story} from '../../../../store/stories';\nimport {useStoryLaunch} from '../../../../store/use-story-launch';\n\nexport interface TestPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const TestPassageButton: React.FC<TestPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage}\n\t\t\ticon={<IconTool />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.testFromHere')}\n\t\t\tonClick={() => testStory(story.id, passage?.id)}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenamePassageButton} from '../../../../components/passage/rename-passage-button';\nimport {\n\tPassage,\n\tStory,\n\tupdatePassage,\n\tuseStoriesContext\n} from '../../../../store/stories';\nimport {Point} from '../../../../util/geometry';\nimport {CreatePassageButton} from './create-passage-button';\nimport {DeletePassagesButton} from './delete-passages-button';\nimport {EditPassagesButton} from './edit-passages-buttons';\nimport {SelectAllPassagesButton} from './select-all-passages-button';\nimport {StartAtPassageButton} from './start-at-passage-button';\nimport {TestPassageButton} from './test-passage-button';\n\nexport interface PassageActionsProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const PassageActions: React.FC<PassageActionsProps> = ({\n\tgetCenter,\n\tstory\n}) => {\n\tconst {dispatch} = useStoriesContext();\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\tconst soloSelectedPassage = React.useMemo(\n\t\t() => (selectedPassages.length === 1 ? selectedPassages[0] : undefined),\n\t\t[selectedPassages]\n\t);\n\n\tfunction handleRename(name: string, passage?: Passage) {\n\t\tif (!passage) {\n\t\t\tthrow new Error('Passage is unset');\n\t\t}\n\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(updatePassage(story, passage, {name}, {dontUpdateOthers: true}));\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreatePassageButton getCenter={getCenter} story={story} />\n\t\t\t<EditPassagesButton passages={selectedPassages} story={story} />\n\t\t\t<RenamePassageButton\n\t\t\t\tonRename={name => handleRename(name, soloSelectedPassage)}\n\t\t\t\tpassage={soloSelectedPassage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DeletePassagesButton passages={selectedPassages} story={story} />\n\t\t\t<TestPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<StartAtPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<SelectAllPassagesButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\n// This is here because it's used in two places--the story list and the story\n// info dialog.\n\nconst DisabledRenameStoryButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\ninterface EnabledRenameStoryButtonProps {\n\texistingStories: Story[];\n\tonRename: (value: string) => void;\n\tstory: Story;\n}\n\nconst EnabledRenameStoryButton: React.FC<EnabledRenameStoryButtonProps> = props => {\n\tconst {existingStories, onRename, story} = props;\n\tconst [newName, setNewName] = React.useState(story.name);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => setNewName(story.name), [story]);\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\texistingStories.some(\n\t\t\t\ts =>\n\t\t\t\t\ts.id !== story.id &&\n\t\t\t\t\tstoryFileName(s) === storyFileName({...story, name})\n\t\t\t)\n\t\t) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: story.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenameStoryButtonProps\n\textends Omit<EnabledRenameStoryButtonProps, 'story'> {\n\tstory?: Story;\n}\n\nexport const RenameStoryButton: React.FC<RenameStoryButtonProps> = props => {\n\tif (props.story) {\n\t\treturn (\n\t\t\t<EnabledRenameStoryButton {...(props as EnabledRenameStoryButtonProps)} />\n\t\t);\n\t}\n\n\treturn <DisabledRenameStoryButton />;\n};","import {IconInfoCircle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryDetailsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface DetailsButtonProps {\n\tstory: Story;\n}\n\nexport const DetailsButton: React.FC<DetailsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconInfoCircle />}\n\t\t\tlabel={t('common.details')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryDetailsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconSearch} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StorySearchDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface FindReplaceButtonProps {\n\tstory: Story;\n}\n\nexport const FindReplaceButton: React.FC<FindReplaceButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconSearch />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.findAndReplace')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StorySearchDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconBraces} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryJavaScriptDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface JavaScriptButtonProps {\n\tstory: Story;\n}\n\nexport const JavaScriptButton: React.FC<JavaScriptButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconBraces />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.javaScript')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryJavaScriptDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {PassageTagsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface PassageTagsButtonProps {\n\tstory: Story;\n}\n\nexport const PassageTagsButton: React.FC<PassageTagsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.passageTags')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: PassageTagsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryStylesheetDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface StylesheetButtonProps {\n\tstory: Story;\n}\n\nexport const StylesheetButton: React.FC<StylesheetButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconHash />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.stylesheet')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryStylesheetDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {DetailsButton} from './details-button';\nimport {FindReplaceButton} from './find-replace-button';\nimport {JavaScriptButton} from './javascript-button';\nimport {PassageTagsButton} from './passage-tags-button';\nimport {StylesheetButton} from './stylesheet-button';\n\nexport interface StoryActionsProps {\n\tstory: Story;\n}\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {story} = props;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<FindReplaceButton story={story} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name => dispatch(updateStory(stories, story, {name}))}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DetailsButton story={story} />\n\t\t\t<PassageTagsButton story={story} />\n\t\t\t<JavaScriptButton story={story} />\n\t\t\t<StylesheetButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {useUndoableStoriesContext} from '../../../store/undoable-stories';\nimport {IconButton} from '../../../components/control/icon-button';\n\nexport const UndoRedoButtons: React.FC = () => {\n\tconst {redo, redoLabel, undo, undoLabel} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!undo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={undoLabel ?? t('common.undo')}\n\t\t\t\tonClick={undo}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!redo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={redoLabel ?? t('common.redo')}\n\t\t\t\tonClick={redo}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions, BuildActions} from '../../../route-actions';\nimport {Story} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageActions} from './passage/passage-actions';\nimport {StoryActions} from './story/story-actions';\nimport {UndoRedoButtons} from './undo-redo-buttons';\n\nexport interface StoryEditToolbarProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const StoryEditToolbar: React.FC<StoryEditToolbarProps> = props => {\n\tconst {getCenter, story} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<UndoRedoButtons />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.passage')]: (\n\t\t\t\t\t<PassageActions getCenter={getCenter} story={story} />\n\t\t\t\t),\n\t\t\t\t[t('common.story')]: <StoryActions story={story} />,\n\t\t\t\t[t('common.build')]: <BuildActions story={story} />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconGridDots, IconLayoutGrid, IconSquare} from '@tabler/icons';\nimport {IconButton} from '../../components/control/icon-button';\nimport {updateStory, useStoriesContext, Story} from '../../store/stories';\nimport {ButtonCard} from '../../components/container/button-card';\nimport './zoom-buttons.css';\nimport {useScrollbarSize} from 'react-scrollbar-size';\n\nexport interface ZoomButtonsProps {\n\tstory: Story;\n}\n\nexport const ZoomButtons: React.FC<ZoomButtonsProps> = React.memo(({story}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst {height} = useScrollbarSize();\n\n\tconst handleZoomChange = React.useCallback(\n\t\t(zoom: number) => {\n\t\t\tdispatch(updateStory(stories, story, {zoom}));\n\t\t},\n\t\t[dispatch, stories, story]\n\t);\n\n\tconst style: React.CSSProperties = {\n\t\tmarginBottom: height\n\t};\n\n\treturn (\n\t\t<div className=\"zoom-buttons\" style={style}>\n\t\t\t<ButtonCard>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconSquare />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.passageNamesAndExcerpts')}\n\t\t\t\t\tonClick={() => handleZoomChange(1)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 1}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconLayoutGrid />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.passageNames')}\n\t\t\t\t\tonClick={() => handleZoomChange(0.6)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 0.6}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconGridDots />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.storyStructure')}\n\t\t\t\t\tonClick={() => handleZoomChange(0.3)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 0.3}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t</ButtonCard>\n\t\t</div>\n\t);\n});\n\nZoomButtons.displayName = 'ZoomButtons';","import * as React from 'react';\nimport {quadOut} from 'eases';\nimport {Point} from '../../util/geometry';\n\n/**\n * Information about a single zoom transition.\n */\ninterface ZoomTransition {\n\t/**\n\t * How much time has elapsed, in seconds.\n\t */\n\telapsed: number;\n\t/**\n\t * The last timestamp an update was done, in seconds.\n\t */\n\tlastTimestamp?: number;\n\t/**\n\t * The point the scrollTarget was centered on when the transition began,\n\t * normalized for zoom level. e.g. if it was centered on (100, 100) but the\n\t * story zoom was 0.5, this is (200, 200).\n\t */\n\tscrollNormalizedCenter: Point;\n\t/**\n\t * The current point the scrollTarget is centered on.\n\t */\n\tscrollCenter: {\n\t\theight: number;\n\t\twidth: number;\n\t};\n\t/**\n\t * The element whose scroll position is being maintained.\n\t */\n\tscrollTarget: HTMLElement;\n\t/**\n\t * How the zoom is changing during this transition.\n\t */\n\tzoom: {\n\t\tstart: number;\n\t\tchange: number;\n\t};\n}\n\n/**\n * Runs a single step of the zoom transition. This is outside the effect to\n * avoid dependencies.\n * @param setter Setter function for the zoom value\n * @param start Value of the zoom when the transition began\n * @param change Change in zoom value for the entire transition\n * @param time Elapsed time in seconds--assumes total time is 1 second\n * \n * @return transitioned value of zoom\n */\nfunction transitionStep(\n\tsetter: React.Dispatch<React.SetStateAction<number>>,\n\tstart: number,\n\tchange: number,\n\ttime: number\n) {\n\tlet value: number;\n\n\tif (time < 1) {\n\t\t// Step toward the change.\n\n\t\tvalue = start + change * quadOut(time);\n\t\tsetter(value);\n\t\treturn value;\n\t}\n\n\t// We're done.\n\n\tsetter(start + change);\n}\n\n/**\n * Manages transitioning zoom level of a story while maintaining the scroll\n * position's focus. This is meant to be called repeatedly with different\n * values, and returns the _visible_ zoom--what the user should see as zoom\n * value, which gradually changes over time.\n *\n * @param target Zoom value to transition towrds\n * @param scrollTarget DOM element whose scroll position should be manipulated\n * to match the returned value\n */\nexport function useZoomTransition(\n\ttarget: number,\n\tscrollTarget: HTMLElement | null\n) {\n\tconst [current, setCurrent] = React.useState(target);\n\tconst transition = React.useRef<ZoomTransition>();\n\n\t// This queues a single transition step using requestAnimationFrame. It's\n\t// crucial that this callback have no dependencies; otherwise things could get\n\t// confused in the middle of a transition.\n\n\tconst step = React.useCallback(() => {\n\t\tif (!transition.current) {\n\t\t\treturn;\n\t\t}\n\n\t\twindow.requestAnimationFrame(timestamp => {\n\t\t\tconst t = transition.current as ZoomTransition;\n\n\t\t\tif (t.lastTimestamp) {\n\t\t\t\t// Complete the transition in 0.5 seconds, not 1.\n\t\t\t\tt.elapsed += (timestamp - t.lastTimestamp) / 500;\n\t\t\t\tt.lastTimestamp = timestamp;\n\n\t\t\t\tconst value = transitionStep(\n\t\t\t\t\tsetCurrent,\n\t\t\t\t\tt.zoom.start,\n\t\t\t\t\tt.zoom.change,\n\t\t\t\t\tt.elapsed\n\t\t\t\t);\n\n\t\t\t\tif (value) {\n\t\t\t\t\t// Sync scroll position and request a new animation step.\n\n\t\t\t\t\tconst newLeft =\n\t\t\t\t\t\tt.scrollNormalizedCenter.left * value - t.scrollCenter.width;\n\t\t\t\t\tconst newTop =\n\t\t\t\t\t\tt.scrollNormalizedCenter.top * value - t.scrollCenter.height;\n\n\t\t\t\t\tif (newLeft >= 0 && newTop >= 0) {\n\t\t\t\t\t\tt.scrollTarget.scrollLeft = newLeft;\n\t\t\t\t\t\tt.scrollTarget.scrollTop = newTop;\n\t\t\t\t\t}\n\n\t\t\t\t\tstep();\n\t\t\t\t} else {\n\t\t\t\t\t// We've reached the end.\n\t\t\t\t\ttransition.current = undefined;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// This is the first time we've been called in a transition. Record the\n\t\t\t\t// timestamp and try again.\n\n\t\t\t\tt.lastTimestamp = timestamp;\n\t\t\t\tstep();\n\t\t\t}\n\t\t});\n\t}, []);\n\n\t// Start a new transition.\n\n\tReact.useEffect(() => {\n\t\tif (!transition.current && current !== target && scrollTarget) {\n\t\t\ttransition.current = {\n\t\t\t\tscrollTarget,\n\t\t\t\telapsed: 0,\n\t\t\t\tscrollNormalizedCenter: {\n\t\t\t\t\tleft:\n\t\t\t\t\t\t(scrollTarget.scrollLeft + scrollTarget.clientWidth / 2) / current,\n\t\t\t\t\ttop:\n\t\t\t\t\t\t(scrollTarget.scrollTop + scrollTarget.clientHeight / 2) / current\n\t\t\t\t},\n\t\t\t\tscrollCenter: {\n\t\t\t\t\theight: scrollTarget.clientHeight / 2,\n\t\t\t\t\twidth: scrollTarget.clientWidth / 2\n\t\t\t\t},\n\t\t\t\tzoom: {\n\t\t\t\t\tstart: current,\n\t\t\t\t\tchange: target - current\n\t\t\t\t}\n\t\t\t};\n\t\t\twindow.requestAnimationFrame(step);\n\t\t}\n\t}, [current, scrollTarget, step, target]);\n\n\treturn current;\n}\n","import * as React from 'react';\nimport 'element-closest';\nimport {rectFromPoints, Point, Rect} from '../../util/geometry';\nimport './marquee-selection.css';\n\nexport interface MarqueeSelectionProps {\n\t/**\n\t * Container DOM element to attach events to.\n\t */\n\tcontainer: React.RefObject<HTMLElement>;\n\t/**\n\t * Ignores click events on any element matching this selector. This is so that\n\t * drags beginning on a passage card can be ignored.\n\t */\n\tignoreEventsOnSelector?: string;\n\t/**\n\t * Callback for when selection is finalized by the user letting go of the\n\t * mouse button.\n\t */\n\tonSelectRect: (rect: Rect, additive: boolean) => void;\n\t/**\n\t * Callback for when the user is altering the selection by dragging the mouse.\n\t */\n\tonTemporarySelectRect: (rect: Rect, additive: boolean) => void;\n}\n\nexport const MarqueeSelection: React.FC<MarqueeSelectionProps> = props => {\n\tconst {\n\t\tcontainer,\n\t\tignoreEventsOnSelector,\n\t\tonSelectRect,\n\t\tonTemporarySelectRect\n\t} = props;\n\tconst [additive, setAdditive] = React.useState(false);\n\tconst [dragging, setDragging] = React.useState(false);\n\tconst [start, setStart] = React.useState<Point>();\n\tconst [current, setCurrent] = React.useState<Point>();\n\n\t// There are two effects here to prevent unnecesary cleanup of event\n\t// listeners. One listens to DOM events on the container, the other handles\n\t// calling onSelectRect.\n\n\tReact.useEffect(() => {\n\t\tconst currentContainer = container.current;\n\t\tlet currentContainerRect: DOMRect;\n\n\t\tfunction relativePointerPos(event: PointerEvent) {\n\t\t\treturn {\n\t\t\t\tleft:\n\t\t\t\t\tevent.clientX -\n\t\t\t\t\tcurrentContainerRect.left +\n\t\t\t\t\tcurrentContainer!.scrollLeft,\n\t\t\t\ttop:\n\t\t\t\t\tevent.clientY - currentContainerRect.top + currentContainer!.scrollTop\n\t\t\t};\n\t\t}\n\n\t\tfunction upListener(event: PointerEvent) {\n\t\t\tif (currentContainer) {\n\t\t\t\tcurrentContainer.releasePointerCapture(event.pointerId);\n\t\t\t\tcurrentContainer.removeEventListener('pointermove', moveListener);\n\t\t\t\tcurrentContainer.removeEventListener('pointerup', upListener);\n\t\t\t\tsetDragging(false);\n\t\t\t\t// See the second effect for how callbacks are invoked.\n\t\t\t}\n\t\t}\n\n\t\tfunction moveListener(event: PointerEvent) {\n\t\t\tsetCurrent(relativePointerPos(event));\n\t\t}\n\n\t\tfunction downListener(event: PointerEvent) {\n\t\t\tif (\n\t\t\t\tevent.pointerType === 'touch' ||\n\t\t\t\tevent.button !== 0 ||\n\t\t\t\t!currentContainer\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tignoreEventsOnSelector &&\n\t\t\t\t(event.target as HTMLElement).closest(ignoreEventsOnSelector)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcurrentContainerRect = currentContainer.getBoundingClientRect();\n\t\t\tcurrentContainer.setPointerCapture(event.pointerId);\n\t\t\tcurrentContainer.addEventListener('pointermove', moveListener);\n\t\t\tcurrentContainer.addEventListener('pointerup', upListener);\n\t\t\tsetAdditive(!!(event.shiftKey || event.ctrlKey));\n\t\t\tsetDragging(true);\n\t\t\tsetStart(relativePointerPos(event));\n\t\t\tsetCurrent(relativePointerPos(event));\n\t\t}\n\n\t\tif (currentContainer) {\n\t\t\tcurrentContainer.addEventListener('pointerdown', downListener);\n\t\t\treturn () =>\n\t\t\t\tcurrentContainer.removeEventListener('pointerdown', downListener);\n\t\t}\n\t}, [container, ignoreEventsOnSelector]);\n\n\tReact.useEffect(() => {\n\t\t// This effect will trigger constantly if the on* callbacks aren't memoized\n\t\t// outside the component.\n\n\t\tif (start && current) {\n\t\t\tif (dragging) {\n\t\t\t\tonTemporarySelectRect(rectFromPoints(start, current), additive);\n\t\t\t} else {\n\t\t\t\tonSelectRect(rectFromPoints(start, current), additive);\n\t\t\t\tsetStart(undefined);\n\t\t\t\tsetCurrent(undefined);\n\t\t\t}\n\t\t}\n\t}, [additive, current, dragging, onSelectRect, onTemporarySelectRect, start]);\n\n\tconst style = React.useMemo(() => {\n\t\tif (!start || !current) {\n\t\t\treturn {};\n\t\t}\n\n\t\tconst rect = rectFromPoints(start, current);\n\n\t\t// This relies on the static dimensions of the div being set at 100x100 in\n\t\t// CSS. The point of this is to allow the browser to resize the marquee\n\t\t// using GPU only (hopefully), which is more performant than setting bounds\n\t\t// directly.\n\n\t\treturn {\n\t\t\ttransform: `translate(${rect.left}px, ${rect.top}px) scale(${\n\t\t\t\trect.width / 100\n\t\t\t}, ${rect.height / 100})`\n\t\t};\n\t}, [current, start]);\n\n\tif (!start || !current) {\n\t\treturn null;\n\t}\n\n\treturn <div className=\"marquee-selection\" style={style} />;\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './broken-connection.css';\n\nexport interface BrokenConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\n// Making this equal in length to <StartConnector>.\nconst lineOffset = 25 * Math.sqrt(2);\n\nexport const BrokenConnection: React.FC<BrokenConnectionProps> = props => {\n\tconst {offset, passage} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\treturn (\n\t\t<line\n\t\t\tclassName=\"broken-connection\"\n\t\t\tx1={start.left + passage.width}\n\t\t\ty1={start.top + passage.height}\n\t\t\tx2={start.left + passage.width + lineOffset}\n\t\t\ty2={start.top + passage.height + lineOffset}\n\t\t\tstyle={{markerEnd: 'url(#link-broken)'}}\n\t\t/>\n\t);\n};\n","import {Point} from './geometry';\n\nexport interface ArcProps {\n\tend: Point;\n\tlargeArc?: boolean;\n\tradius: Point;\n\trotation?: number;\n\tstart: Point;\n\tsweep?: boolean;\n}\n\n/**\n * Returns an SVG path string between two points.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths#arcs\n */\nexport function arc({start, end, radius, largeArc, sweep, rotation}: ArcProps) {\n\treturn (\n\t\t'M' +\n\t\tstart.left +\n\t\t',' +\n\t\tstart.top +\n\t\t' A' +\n\t\tradius.left +\n\t\t',' +\n\t\tradius.top +\n\t\t' ' +\n\t\t(rotation ?? '0') +\n\t\t(largeArc ? ' 1' : ' 0') +\n\t\t(sweep ? ' 1 ' : ' 0 ') +\n\t\tend.left +\n\t\t',' +\n\t\tend.top\n\t);\n}\n","import * as React from 'react';\nimport {arc} from '../../../util/svg';\nimport {\n\tlineAngle,\n\tlineDistance,\n\trectCenter,\n\trectIntersectionWithLine,\n\tPoint\n} from '../../../util/geometry';\nimport {Passage} from '../../../store/stories';\nimport './passage-connection.css';\n\nexport interface PassageConnectionProps {\n\tend: Passage;\n\toffset: Point;\n\tstart: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const PassageConnection: React.FC<PassageConnectionProps> = props => {\n\tconst {end, offset, start, variant} = props;\n\tconst path = React.useMemo(() => {\n\t\t// If either passage is selected, offset it. We need to take care not to\n\t\t// overwrite the passage information.\n\n\t\tlet offsetStart = start;\n\t\tlet offsetEnd = end;\n\n\t\tif (start.selected) {\n\t\t\toffsetStart = {\n\t\t\t\t...start,\n\t\t\t\tleft: start.left + offset.left,\n\t\t\t\ttop: start.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\tif (end.selected) {\n\t\t\toffsetEnd = {\n\t\t\t\t...end,\n\t\t\t\tleft: end.left + offset.left,\n\t\t\t\ttop: end.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\t// Start at the center of both passages.\n\n\t\tlet startPoint: Point | null = rectCenter(offsetStart);\n\t\tlet endPoint: Point | null = rectCenter(offsetEnd);\n\n\t\t// Move both points to where they intersect with the edges of their passages.\n\n\t\tstartPoint = rectIntersectionWithLine(offsetStart, startPoint, endPoint);\n\n\t\tif (!startPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\tendPoint = rectIntersectionWithLine(offsetEnd, startPoint, endPoint);\n\n\t\tif (!endPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\t// Draw a flattened arc, to make it easier to distinguish between links\n\t\t// between passages with the same horizontal or vertical position (which\n\t\t// would otherwise be overlapping flat lines).\n\t\t//\n\t\t// The horizontal radius of our arc is proportional to the distance\n\t\t// the line will travel.\n\n\t\tconst distance = lineDistance(startPoint, endPoint);\n\n\t\t// Rotate the arc so that its underside will always face downward. We cheat\n\t\t// vertical lines so that their undersides face right--an aesthetic choice,\n\t\t// and so that bidirectional links line up.\n\n\t\tlet sweep = startPoint.left < endPoint.left;\n\n\t\tif (startPoint.left === endPoint.left && startPoint.top < endPoint.top) {\n\t\t\tsweep = true;\n\t\t}\n\n\t\tconst angle = lineAngle(startPoint, endPoint);\n\n\t\t// The Y radius is another aesthetic choice. The lower the ratio, the less\n\t\t// curved the lines become.\n\n\t\treturn arc({\n\t\t\tstart: startPoint,\n\t\t\tend: endPoint,\n\t\t\tradius: {left: distance, top: distance * 0.75},\n\t\t\trotation: angle,\n\t\t\tsweep\n\t\t});\n\t}, [end, offset.left, offset.top, start]);\n\n\treturn (\n\t\t<path\n\t\t\td={path}\n\t\t\tclassName={`passage-connection variant-${variant}`}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {arc} from '../../../util/svg';\nimport './self-connection.css';\n\nexport interface SelfConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const SelfConnection: React.FC<SelfConnectionProps> = props => {\n\tconst {offset, passage, variant} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\tconst radius = React.useMemo(\n\t\t() => 0.4 * Math.min(passage.width, passage.height),\n\t\t[passage.height, passage.width]\n\t);\n\n\tconst path = React.useMemo(\n\t\t() =>\n\t\t\tarc({\n\t\t\t\tstart: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top + passage.height / 2\n\t\t\t\t},\n\t\t\t\tend: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top\n\t\t\t\t},\n\t\t\t\tradius: {\n\t\t\t\t\tleft: radius,\n\t\t\t\t\ttop: radius\n\t\t\t\t},\n\t\t\t\tsweep: true,\n\t\t\t\tlargeArc: true\n\t\t\t}),\n\t\t[passage.height, radius, start.left, start.top]\n\t);\n\n\treturn (\n\t\t<path\n\t\t\tclassName={`self-connection variant-${variant}`}\n\t\t\td={path}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {BrokenConnection} from './broken-connection';\nimport {PassageConnection} from './passage-connection';\nimport {SelfConnection} from './self-connection';\nimport {Point} from '../../../util/geometry';\n\nexport interface PassageConnectionGroupProps {\n\tbroken: Set<Passage>;\n\tconnections: Map<Passage, Set<Passage>>;\n\toffset: Point;\n\tself: Set<Passage>;\n\tvariant?: 'link' | 'reference';\n}\n\nexport const PassageConnectionGroup: React.FC<PassageConnectionGroupProps> = React.memo(\n\tprops => {\n\t\tconst {broken, connections, offset, self, variant = 'link'} = props;\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t{Array.from(connections).map(connection =>\n\t\t\t\t\tArray.from(connection[1]).map(end => (\n\t\t\t\t\t\t<PassageConnection\n\t\t\t\t\t\t\tend={end}\n\t\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\t\tkey={connection[0].name + end.name}\n\t\t\t\t\t\t\tstart={connection[0]}\n\t\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t)}\n\t\t\t\t{Array.from(self).map(passage => (\n\t\t\t\t\t<SelfConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t\t{Array.from(broken).map(passage => (\n\t\t\t\t\t<BrokenConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</>\n\t\t);\n\t}\n);\n\nPassageConnectionGroup.displayName = 'PassageConnectionGroup';","import * as React from 'react';\nimport './link-markers.css';\n\n/**\n * Arrowheads used on connectors. Arrowheads must be applied by an inline style.\n * There seems to be disagreement on the proper way to implement this, but it\n * does not work in an external stylesheet in Firefox.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Element/marker\n */\nexport const LinkMarkers: React.FC = () => (\n\t<defs>\n\t\t<marker\n\t\t\tid=\"link-arrowhead\"\n\t\t\trefX=\"6\"\n\t\t\trefY=\"4\"\n\t\t\tmarkerWidth=\"8\"\n\t\t\tmarkerHeight=\"8\"\n\t\t\torient=\"auto\"\n\t\t>\n\t\t\t<path d=\"M 1,1 7,4 1,7 Z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-broken\"\n\t\t\trefX=\"7.5\"\n\t\t\trefY=\"7.5\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t>\n\t\t\t<circle cx=\"7.5\" cy=\"7.5\" r=\"7.5\" />\n\t\t\t<path d=\"M4.5 7.5h 6z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-start\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t\trefX=\"16\"\n\t\t\trefY=\"16\"\n\t\t\tviewBox=\"0 0 32 32\"\n\t\t>\n\t\t\t<circle cx=\"16\" cy=\"16\" r=\"16\" />\n\t\t\t<path d=\"M8 17a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3\" />\n\t\t\t<path d=\"M11 18a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3\" />\n\t\t\t<circle className=\"fill-white\" cx=\"19\" cy=\"13\" r=\"1\" />\n\t\t</marker>\n\t</defs>\n);\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './start-connection.css';\n\nexport interface StartConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\nexport const StartConnection: React.FC<StartConnectionProps> = React.memo(\n\tprops => {\n\t\tconst {offset, passage} = props;\n\t\tconst start: Point = {left: passage.left, top: passage.top};\n\n\t\tif (passage.selected) {\n\t\t\tstart.left += offset.left;\n\t\t\tstart.top += offset.top;\n\t\t}\n\n\t\treturn (\n\t\t\t<line\n\t\t\t\tclassName=\"start-connection\"\n\t\t\t\tx1={start.left - 50}\n\t\t\t\ty1={start.top + passage.height / 2}\n\t\t\t\tx2={start.left}\n\t\t\t\ty2={start.top + passage.height / 2}\n\t\t\t\tstyle={{markerStart: 'url(#link-start)'}}\n\t\t\t/>\n\t\t);\n\t}\n);\n\nStartConnection.displayName = 'StartConnection';","import * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions} from '../util/story-format';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\nconst emptyFunc = () => [];\n\nexport function useFormatReferenceParser(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst [editorExtensions, setEditorExtensions] = React.useState<\n\t\tReturnType<typeof formatEditorExtensions>\n\t>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tsetEditorExtensions(formatEditorExtensions(format, twineVersion));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\tif (extensionsDisabled) {\n\t\treturn emptyFunc;\n\t}\n\n\treturn editorExtensions?.references?.parsePassageText ?? emptyFunc;\n}\n","import * as React from 'react';\nimport {Passage, passageConnections} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageConnectionGroup} from './passage-connection-group';\nimport {LinkMarkers} from './link-markers';\nimport {StartConnection} from './start-connection';\nimport {useFormatReferenceParser} from '../../../store/use-format-reference-parser';\n\nexport interface PassageConnectionsProps {\n\tformatName: string;\n\tformatVersion: string;\n\toffset: Point;\n\tpassages: Passage[];\n\tstartPassageId: string;\n}\n\nconst emptySet = new Set<Passage>();\nconst noOffset: Point = {left: 0, top: 0};\n\nexport const PassageConnections: React.FC<PassageConnectionsProps> = props => {\n\tconst {formatName, formatVersion, offset, passages, startPassageId} = props;\n\tconst referenceParser = useFormatReferenceParser(formatName, formatVersion);\n\tconst {draggable: draggableLinks, fixed: fixedLinks} = React.useMemo(\n\t\t() => passageConnections(passages),\n\t\t[passages]\n\t);\n\tconst {\n\t\tdraggable: draggableReferences,\n\t\tfixed: fixedReferences\n\t} = React.useMemo(() => passageConnections(passages, referenceParser), [\n\t\tpassages,\n\t\treferenceParser\n\t]);\n\n\tconst startPassage = React.useMemo(\n\t\t() => passages.find(passage => passage.id === startPassageId),\n\t\t[passages, startPassageId]\n\t);\n\n\t// References only show existing connections.\n\n\treturn (\n\t\t<svg className=\"link-connectors\">\n\t\t\t<LinkMarkers />\n\t\t\t{startPassage && (\n\t\t\t\t<StartConnection offset={offset} passage={startPassage} />\n\t\t\t)}\n\t\t\t<PassageConnectionGroup {...draggableLinks} offset={offset} />\n\t\t\t<PassageConnectionGroup {...fixedLinks} offset={noOffset} />\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={draggableReferences.connections}\n\t\t\t\toffset={offset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={fixedReferences.connections}\n\t\t\t\toffset={noOffset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t</svg>\n\t);\n};\n","import classNames from 'classnames';\nimport {deviceType} from 'detect-it';\nimport * as React from 'react';\nimport {DraggableCore, DraggableCoreProps} from 'react-draggable';\nimport {useTranslation} from 'react-i18next';\nimport {Passage, TagColors} from '../../store/stories';\nimport {CardContent} from '../container/card';\nimport {SelectableCard} from '../container/card/selectable-card';\nimport {TagStripe} from '../tag/tag-stripe';\nimport './passage-card.css';\n\nexport interface PassageCardProps {\n\tonEdit: (passage: Passage) => void;\n\tonDeselect: (passage: Passage) => void;\n\tonDragStart?: DraggableCoreProps['onStart'];\n\tonDrag?: DraggableCoreProps['onDrag'];\n\tonDragStop?: DraggableCoreProps['onStop'];\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassage: Passage;\n\ttagColors: TagColors;\n}\n\n// Needs to fill a large-sized passage card.\nconst excerptLength = 400;\n\nexport const PassageCard: React.FC<PassageCardProps> = React.memo(props => {\n\tconst {\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonDragStart,\n\t\tonDragStop,\n\t\tonEdit,\n\t\tonSelect,\n\t\tpassage,\n\t\ttagColors\n\t} = props;\n\tconst {t} = useTranslation();\n\tconst className = React.useMemo(\n\t\t() =>\n\t\t\tclassNames('passage-card', {\n\t\t\t\tempty: passage.text === '' && passage.tags.length === 0,\n\t\t\t\tselected: passage.selected\n\t\t\t}),\n\t\t[passage.selected, passage.tags.length, passage.text]\n\t);\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst excerpt = React.useMemo(() => {\n\t\tif (passage.text.length > 0) {\n\t\t\treturn passage.text.substring(0, excerptLength);\n\t\t}\n\n\t\treturn (\n\t\t\t<span className=\"placeholder\">\n\t\t\t\t{t(\n\t\t\t\t\tdeviceType === 'touchOnly'\n\t\t\t\t\t\t? 'components.passageCard.placeholderTouch'\n\t\t\t\t\t\t: 'components.passageCard.placeholderClick'\n\t\t\t\t)}\n\t\t\t</span>\n\t\t);\n\t}, [passage.text, t]);\n\tconst style = React.useMemo(\n\t\t() => ({\n\t\t\theight: passage.height,\n\t\t\tleft: passage.left,\n\t\t\ttop: passage.top,\n\t\t\twidth: passage.width\n\t\t}),\n\t\t[passage.height, passage.left, passage.top, passage.width]\n\t);\n\tconst handleMouseDown = React.useCallback(\n\t\t(event: MouseEvent) => {\n\t\t\t// Shift- or control-clicking toggles our selected status, but doesn't\n\t\t\t// affect any other passage's selected status. If the shift or control key\n\t\t\t// was not held down and we were not already selected, we know the user\n\t\t\t// wants to select only this passage.\n\n\t\t\tif (event.shiftKey || event.ctrlKey) {\n\t\t\t\tif (passage.selected) {\n\t\t\t\t\tonDeselect(passage);\n\t\t\t\t} else {\n\t\t\t\t\tonSelect(passage, false);\n\t\t\t\t}\n\t\t\t} else if (!passage.selected) {\n\t\t\t\tonSelect(passage, true);\n\t\t\t}\n\t\t},\n\t\t[onDeselect, onSelect, passage]\n\t);\n\tconst handleEdit = React.useCallback(\n\t\t() => onEdit(passage),\n\t\t[onEdit, passage]\n\t);\n\tconst handleSelect = React.useCallback(\n\t\t(value: boolean, exclusive: boolean) => {\n\t\t\tonSelect(passage, exclusive);\n\t\t},\n\t\t[onSelect, passage]\n\t);\n\n\treturn (\n\t\t<DraggableCore\n\t\t\tnodeRef={container}\n\t\t\tonMouseDown={handleMouseDown}\n\t\t\tonStart={onDragStart}\n\t\t\tonDrag={onDrag}\n\t\t\tonStop={onDragStop}\n\t\t>\n\t\t\t<div className={className} ref={container} style={style}>\n\t\t\t\t<SelectableCard\n\t\t\t\t\thighlighted={passage.highlighted}\n\t\t\t\t\tlabel={passage.name}\n\t\t\t\t\tonDoubleClick={handleEdit}\n\t\t\t\t\tonSelect={handleSelect}\n\t\t\t\t\tselected={passage.selected}\n\t\t\t\t>\n\t\t\t\t\t<TagStripe tagColors={tagColors} tags={passage.tags} />\n\t\t\t\t\t<h2>{passage.name}</h2>\n\t\t\t\t\t<CardContent>{excerpt}</CardContent>\n\t\t\t\t</SelectableCard>\n\t\t\t</div>\n\t\t</DraggableCore>\n\t);\n});\n\nPassageCard.displayName = 'PassageCard';","import * as React from 'react';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {Passage} from '../../store/stories';\nimport {PassageCard, PassageCardProps} from './passage-card';\nimport '../../styles/animations.css';\n\nexport interface PassageCardGroupProps\n\textends Omit<PassageCardProps, 'passage'> {\n\tpassages: Passage[];\n}\n\nexport const PassageCardGroup: React.FC<PassageCardGroupProps> = React.memo(\n\tprops => {\n\t\tconst {passages} = props;\n\n\t\t// Passages must be sorted so that tabbing around follows a logical pattern.\n\n\t\tconst sortedPassages = React.useMemo(\n\t\t\t() =>\n\t\t\t\t[...passages].sort((a, b) => {\n\t\t\t\t\tif (a.top !== b.top) {\n\t\t\t\t\t\treturn a.top - b.top;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn a.left - b.left;\n\t\t\t\t}),\n\t\t\t[passages]\n\t\t);\n\n\t\treturn (\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{sortedPassages.map(passage => (\n\t\t\t\t\t<CSSTransition classNames=\"pop\" key={passage.id} timeout={200}>\n\t\t\t\t\t\t<PassageCard passage={passage} {...props} />\n\t\t\t\t\t</CSSTransition>\n\t\t\t\t))}\n\t\t\t</TransitionGroup>\n\t\t);\n\t}\n);\n\nPassageCardGroup.displayName = 'PassageCardGroup';","import * as React from 'react';\nimport {DraggableData} from 'react-draggable';\nimport {Passage, Story} from '../../../store/stories';\nimport {boundingRect, Point} from '../../../util/geometry';\nimport {PassageConnections} from '../passage-connections';\nimport {PassageCardGroup} from '../passage-card-group';\nimport './passage-map.css';\nimport classnames from 'classnames';\n\nexport interface PassageMapProps {\n\tformatName: string;\n\tformatVersion: string;\n\tonDeselect: (passage: Passage) => void;\n\tonDrag: (change: Point) => void;\n\tonEdit: (passage: Passage) => void;\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassages: Passage[];\n\tstartPassageId: string;\n\ttagColors: Story['tagColors'];\n\tvisibleZoom: number;\n\tzoom: number;\n}\n\ninterface DragState {\n\tdragging: boolean;\n\tdragX: number;\n\tdragY: number;\n\tstartX: number;\n\tstartY: number;\n}\n\ntype DragAction =\n\t| {type: 'start'; x: number; y: number}\n\t| {type: 'move'; x: number; y: number}\n\t| {type: 'stop'; callback: (change: Point) => void};\n\nfunction dragReducer(state: DragState, action: DragAction) {\n\tswitch (action.type) {\n\t\tcase 'start':\n\t\t\treturn {\n\t\t\t\tdragging: true,\n\t\t\t\tdragX: action.x,\n\t\t\t\tdragY: action.y,\n\t\t\t\tstartX: action.x,\n\t\t\t\tstartY: action.y\n\t\t\t};\n\n\t\tcase 'move':\n\t\t\treturn {...state, dragX: action.x, dragY: action.y};\n\n\t\tcase 'stop':\n\t\t\t// This is bad reducer practice, probably—this dispatch causes a side\n\t\t\t// effect. However, it allows us to avoid re-renders as state\n\t\t\t// changes--otherwise state becomes a dependency of the handleDragStop\n\t\t\t// callback below--which have a large performance impact.\n\t\t\t//\n\t\t\t// This also must be deferred to avoid changing state mid-render through\n\t\t\t// the callback.\n\n\t\t\tPromise.resolve().then(() =>\n\t\t\t\taction.callback({\n\t\t\t\t\tleft: state.dragX - state.startX,\n\t\t\t\t\ttop: state.dragY - state.startY\n\t\t\t\t})\n\t\t\t);\n\t\t\treturn {dragging: false, dragX: 0, dragY: 0, startX: 0, startY: 0};\n\t}\n}\n\nconst compactCardZoom = 0.6;\n\nexport const PassageMap: React.FC<PassageMapProps> = props => {\n\tconst {\n\t\tformatName,\n\t\tformatVersion,\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonEdit,\n\t\tonSelect,\n\t\tpassages,\n\t\tstartPassageId,\n\t\ttagColors,\n\t\tvisibleZoom,\n\t\tzoom\n\t} = props;\n\tconst [compactCards, setCompactCards] = React.useState(\n\t\tvisibleZoom <= compactCardZoom\n\t);\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst passageBounds = React.useMemo(() => {\n\t\t// Need to inject a fake rect at the very top-left corner to anchor the\n\t\t// bounds there.\n\n\t\treturn boundingRect([...passages, {top: 0, left: 0, width: 0, height: 0}]);\n\t}, [passages]);\n\n\t// This is a separate memo so that there's less work when visibleZoom changes\n\t// during a zoom transition. The max() expression ensures that dialogs will\n\t// never overlap it--800px is the largest user-selectable dialog width (see\n\t// dialogs/app-prefs.tsx), so we leave 200px padding around that. We hardcode\n\t// it here instead of taking a prop mainly for simplicity's sake.\n\n\tconst style = React.useMemo(() => {\n\t\treturn {\n\t\t\theight: `calc(${passageBounds.height}px + max(50vh, ${\n\t\t\t\t1000 / visibleZoom\n\t\t\t}px))`,\n\t\t\twidth: `calc(${passageBounds.width}px + max(50vw, ${\n\t\t\t\t1000 / visibleZoom\n\t\t\t}px))`,\n\t\t\ttransform: `scale(${visibleZoom})`\n\t\t};\n\t}, [passageBounds.height, passageBounds.width, visibleZoom]);\n\n\tconst [state, dispatch] = React.useReducer(dragReducer, {\n\t\tdragging: false,\n\t\tdragX: 0,\n\t\tdragY: 0,\n\t\tstartX: 0,\n\t\tstartY: 0\n\t});\n\n\t// Only update the compact card state when visibleZoom and zoom are the same.\n\t// This avoids re-rendering the cards in the middle of a zoom transition\n\t// (which causes jank).\n\n\tReact.useEffect(() => {\n\t\tif (zoom === visibleZoom) {\n\t\t\tsetCompactCards(zoom <= compactCardZoom);\n\t\t}\n\t}, [visibleZoom, zoom]);\n\n\t// Set CSS variables on the container for drag offsets.\n\n\tReact.useEffect(() => {\n\t\tif (!container.current) {\n\t\t\treturn;\n\t\t}\n\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-left',\n\t\t\t`${(state.dragX - state.startX) / visibleZoom}px`\n\t\t);\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-top',\n\t\t\t`${(state.dragY - state.startY) / visibleZoom}px`\n\t\t);\n\t}, [state.dragX, state.dragY, state.startX, state.startY, visibleZoom]);\n\n\tconst handleDragStart = React.useCallback((event, data: DraggableData) => {\n\t\tdocument.body.classList.add('dragging-passages');\n\t\tdispatch({type: 'start', x: data.x, y: data.y});\n\t}, []);\n\tconst handleDrag = React.useCallback(\n\t\t(event, data: DraggableData) =>\n\t\t\tdispatch({type: 'move', x: data.x, y: data.y}),\n\t\t[]\n\t);\n\tconst handleDragStop = React.useCallback(() => {\n\t\t// We use a timeout to delay this execution until after the click handler on\n\t\t// <SelectableCard> runs and triggers handleSelect below, so that function\n\t\t// can see that a drag has just finished (and should be ignored as part of\n\t\t// the drag interaction).\n\t\t//\n\t\t// Promise.resolve() doesn't appear to give us the timing we need.\n\n\t\twindow.setTimeout(() => {\n\t\t\tdocument.body.classList.remove('dragging-passages');\n\t\t\tdispatch({type: 'stop', callback: onDrag});\n\t\t}, 0);\n\t}, [onDrag]);\n\tconst handleSelect = React.useCallback(\n\t\t(passage: Passage, exclusive: boolean) => {\n\t\t\t// See comments in handleDragStop above.\n\n\t\t\tif (!state.dragging) {\n\t\t\t\tonSelect(passage, exclusive);\n\t\t\t}\n\t\t},\n\t\t[onSelect, state.dragging]\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classnames('passage-map', {\n\t\t\t\t'compact-passage-cards': compactCards\n\t\t\t})}\n\t\t\tref={container}\n\t\t\tstyle={style}\n\t\t>\n\t\t\t<PassageConnections\n\t\t\t\tformatName={formatName}\n\t\t\t\tformatVersion={formatVersion}\n\t\t\t\toffset={{\n\t\t\t\t\tleft: (state.dragX - state.startX) / zoom,\n\t\t\t\t\ttop: (state.dragY - state.startY) / zoom\n\t\t\t\t}}\n\t\t\t\tpassages={passages}\n\t\t\t\tstartPassageId={startPassageId}\n\t\t\t/>\n\t\t\t<PassageCardGroup\n\t\t\t\tonDeselect={onDeselect}\n\t\t\t\tonDragStart={handleDragStart}\n\t\t\t\tonDrag={handleDrag}\n\t\t\t\tonDragStop={handleDragStop}\n\t\t\t\tonEdit={onEdit}\n\t\t\t\tonSelect={handleSelect}\n\t\t\t\tpassages={passages}\n\t\t\t\ttagColors={tagColors}\n\t\t\t/>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {\n\tMarqueeSelection,\n\tMarqueeSelectionProps\n} from '../../components/marquee-selection';\nimport {\n\tPassageMap,\n\tPassageMapProps\n} from '../../components/passage/passage-map';\nimport {Rect, rectsIntersect} from '../../util/geometry';\n\nexport interface MarqueeablePassageMapProps\n\textends PassageMapProps,\n\t\tOmit<\n\t\t\tMarqueeSelectionProps,\n\t\t\t'ignoreEventsOnSelector' | 'onTemporarySelectRect'\n\t\t> {}\n\n/**\n * Marries a MarqueeSelection with a PassageMap. This handles displaying a\n * temporary selection while the user drags around the marquee selection\n * *without* persisting the change, for performance.\n */\nexport const MarqueeablePassageMap: React.FC<\n\tMarqueeablePassageMapProps\n> = props => {\n\tconst {container, onSelectRect, ...other} = props;\n\tconst [temporaryRect, setTemporaryRect] = React.useState<Rect>();\n\tconst [temporaryAdditive, setTemporaryAdditive] = React.useState<boolean>();\n\tconst innerPassages = React.useMemo(() => {\n\t\tif (!temporaryRect) {\n\t\t\treturn props.passages;\n\t\t}\n\n\t\treturn props.passages.map(passage => {\n\t\t\tif (temporaryAdditive && passage.selected) {\n\t\t\t\treturn passage;\n\t\t\t}\n\n\t\t\tconst selected = rectsIntersect(temporaryRect, passage);\n\n\t\t\tif (selected === passage.selected) {\n\t\t\t\treturn passage;\n\t\t\t}\n\n\t\t\treturn {...passage, selected};\n\t\t});\n\t}, [props.passages, temporaryAdditive, temporaryRect]);\n\n\tconst handleTemporarySelectRect = React.useCallback(\n\t\t(rect: Rect, additive: boolean) => {\n\t\t\tsetTemporaryRect({\n\t\t\t\theight: rect.height / props.zoom,\n\t\t\t\tleft: rect.left / props.zoom,\n\t\t\t\ttop: rect.top / props.zoom,\n\t\t\t\twidth: rect.width / props.zoom\n\t\t\t});\n\t\t\tsetTemporaryAdditive(additive);\n\t\t},\n\t\t[props.zoom]\n\t);\n\n\tconst handleSelectRect = React.useCallback(\n\t\t(rect: Rect, additive: boolean) => {\n\t\t\tsetTemporaryRect(undefined);\n\t\t\tsetTemporaryAdditive(undefined);\n\t\t\tonSelectRect(rect, additive);\n\t\t},\n\t\t[onSelectRect]\n\t);\n\n\treturn (\n\t\t<>\n\t\t\t<MarqueeSelection\n\t\t\t\tcontainer={container}\n\t\t\t\tignoreEventsOnSelector=\".passage-card, .zoom-buttons\"\n\t\t\t\tonSelectRect={handleSelectRect}\n\t\t\t\tonTemporarySelectRect={handleTemporarySelectRect}\n\t\t\t/>\n\t\t\t<PassageMap {...other} passages={innerPassages} />\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {MainContent} from '../../components/container/main-content';\nimport {\n\tDialogsContextProvider,\n\tPassageEditDialog,\n\tuseDialogsContext\n} from '../../dialogs';\nimport {\n\tcreateUntitledPassage,\n\tdeselectPassage,\n\tmovePassages,\n\tPassage,\n\tselectPassage,\n\tselectPassagesInRect,\n\tstoryWithId\n} from '../../store/stories';\nimport {\n\tUndoableStoriesContextProvider,\n\tuseUndoableStoriesContext\n} from '../../store/undoable-stories';\nimport {Point, Rect} from '../../util/geometry';\nimport {StoryEditToolbar} from './toolbar';\nimport './story-edit-route.css';\nimport {ZoomButtons} from './zoom-buttons';\nimport {DocumentTitle} from '../../components/document-title/document-title';\nimport {useZoomTransition} from './use-zoom-transition';\nimport {useZoomShortcuts} from './use-zoom-shortcuts';\nimport {MarqueeablePassageMap} from './marqueeable-passage-map';\n\nexport const InnerStoryEditRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\tconst mainContent = React.useRef<HTMLDivElement>(null);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {dispatch: undoableStoriesDispatch, stories} =\n\t\tuseUndoableStoriesContext();\n\tconst story = storyWithId(stories, storyId);\n\tuseZoomShortcuts(story);\n\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\n\tconst getCenter = React.useCallback(() => {\n\t\tif (!mainContent.current) {\n\t\t\tthrow new Error(\n\t\t\t\t'Asked for the center of the main content, but it does not exist in the DOM yet'\n\t\t\t);\n\t\t}\n\n\t\treturn {\n\t\t\tleft:\n\t\t\t\t(mainContent.current.scrollLeft + mainContent.current.clientWidth / 2) /\n\t\t\t\tstory.zoom,\n\t\t\ttop:\n\t\t\t\t(mainContent.current.scrollTop + mainContent.current.clientHeight / 2) /\n\t\t\t\tstory.zoom\n\t\t};\n\t}, [story.zoom]);\n\n\tconst handleDeselectPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tundoableStoriesDispatch(deselectPassage(story, passage)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleDragPassages = React.useCallback(\n\t\t(change: Point) => {\n\t\t\t// Ignore tiny drags--they're probably caused by the user moving their\n\t\t\t// mouse slightly during double-clicking.\n\n\t\t\tif (Math.abs(change.left) < 1 && Math.abs(change.top) < 1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tmovePassages(\n\t\t\t\t\tstory,\n\t\t\t\t\tstory.passages.reduce<string[]>(\n\t\t\t\t\t\t(result, current) =>\n\t\t\t\t\t\t\tcurrent.selected ? [...result, current.id] : result,\n\t\t\t\t\t\t[]\n\t\t\t\t\t),\n\t\t\t\t\tchange.left / story.zoom,\n\t\t\t\t\tchange.top / story.zoom\n\t\t\t\t),\n\t\t\t\tselectedPassages.length > 1\n\t\t\t\t\t? 'undoChange.movePassages'\n\t\t\t\t\t: 'undoChange.movePassages'\n\t\t\t);\n\t\t},\n\t\t[selectedPassages.length, story, undoableStoriesDispatch]\n\t);\n\n\tconst handleEditPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tdialogsDispatch({\n\t\t\t\ttype: 'addDialog',\n\t\t\t\tcomponent: PassageEditDialog,\n\t\t\t\tprops: {passageId: passage.id, storyId: story.id}\n\t\t\t}),\n\t\t[dialogsDispatch, story.id]\n\t);\n\n\tconst handleSelectPassage = React.useCallback(\n\t\t(passage: Passage, exclusive: boolean) =>\n\t\t\tundoableStoriesDispatch(selectPassage(story, passage, exclusive)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleSelectRect = React.useCallback(\n\t\t(rect: Rect, exclusive: boolean) => {\n\t\t\t// The rect we receive is in screen coordinates--we need to convert to\n\t\t\t// logical ones.\n\t\t\tconst logicalRect: Rect = {\n\t\t\t\theight: rect.height / story.zoom,\n\t\t\t\tleft: rect.left / story.zoom,\n\t\t\t\ttop: rect.top / story.zoom,\n\t\t\t\twidth: rect.width / story.zoom\n\t\t\t};\n\t\t\t// This should not be undoable.\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tselectPassagesInRect(\n\t\t\t\t\tstory,\n\t\t\t\t\tlogicalRect,\n\t\t\t\t\texclusive ? selectedPassages.map(passage => passage.id) : []\n\t\t\t\t)\n\t\t\t);\n\t\t},\n\t\t[selectedPassages, story, undoableStoriesDispatch]\n\t);\n\n\t// If we have just mounted and the story has no passages, create one for the\n\t// user (and skip undo history, since it was an automatic action).\n\n\tReact.useEffect(() => {\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\n\t\t\tif (story.passages.length === 0) {\n\t\t\t\tconst center = getCenter();\n\n\t\t\t\tundoableStoriesDispatch(\n\t\t\t\t\tcreateUntitledPassage(story, center.left, center.top)\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}, [getCenter, inited, story, undoableStoriesDispatch]);\n\n\tconst visibleZoom = useZoomTransition(story.zoom, mainContent.current);\n\n\treturn (\n\t\t<div className=\"story-edit-route\">\n\t\t\t<DocumentTitle title={story.name} />\n\t\t\t<StoryEditToolbar getCenter={getCenter} story={story} />\n\t\t\t<MainContent grabbable padded={false} ref={mainContent}>\n\t\t\t\t<MarqueeablePassageMap\n\t\t\t\t\tcontainer={mainContent}\n\t\t\t\t\tformatName={story.storyFormat}\n\t\t\t\t\tformatVersion={story.storyFormatVersion}\n\t\t\t\t\tonDeselect={handleDeselectPassage}\n\t\t\t\t\tonDrag={handleDragPassages}\n\t\t\t\t\tonEdit={handleEditPassage}\n\t\t\t\t\tonSelect={handleSelectPassage}\n\t\t\t\t\tonSelectRect={handleSelectRect}\n\t\t\t\t\tpassages={story.passages}\n\t\t\t\t\tstartPassageId={story.startPassage}\n\t\t\t\t\ttagColors={story.tagColors}\n\t\t\t\t\tvisibleZoom={visibleZoom}\n\t\t\t\t\tzoom={story.zoom}\n\t\t\t\t/>\n\t\t\t\t<ZoomButtons story={story} />\n\t\t\t</MainContent>\n\t\t</div>\n\t);\n};;\n\n// This is a separate component so that the inner one can use\n// `useEditorsContext()` and `useUndoableStoriesContext()` inside it.\n\nexport const StoryEditRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryEditRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import {useHotkeys} from 'react-hotkeys-hook';\nimport {Story, updateStory, useStoriesContext} from '../../store/stories';\n\nexport function useZoomShortcuts(story: Story) {\n\tconst {dispatch, stories} = useStoriesContext();\n\n\tuseHotkeys(\n\t\t'-',\n\t\t() => {\n\t\t\tswitch (story.zoom) {\n\t\t\t\tcase 1:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.6}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase 0.6:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.3}));\n\t\t\t\t\tbreak;\n\t\t\t\t// Do nothing if zoom is 0.3\n\t\t\t}\n\t\t},\n\t\t{keydown: false, keyup: true},\n\t\t[dispatch, stories, story]\n\t);\n\tuseHotkeys(\n\t\t'=',\n\t\t() => {\n\t\t\tswitch (story.zoom) {\n\t\t\t\tcase 0.3:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.6}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase 0.6:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 1}));\n\t\t\t\t\tbreak;\n\t\t\t\t// Do nothing if zoom is 1\n\t\t\t}\n\t\t},\n\t\t{keydown: false, keyup: true},\n\t\t[dispatch, stories, story]\n\t);\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport './storage-quota.css';\n\nexport interface StorageQuotaProps {\n\twatch: any;\n}\n\nexport const StorageQuota: React.FC<StorageQuotaProps> = props => {\n\tconst {watch} = props;\n\tconst [lastWatch, setLastWatch] = React.useState<any>();\n\tconst [working, setWorking] = React.useState(false);\n\tconst [percentFree, setPercentFree] = React.useState<string>();\n\n\t// This is set to -1 so that we can hide the percentage while doing the\n\t// initial calculation. Later ones will show the same percentage but with a\n\t// loading icon beside it until finishes.\n\n\tconst {t} = useTranslation();\n\n\tconst hide = isElectronRenderer() || !navigator.storage?.estimate;\n\n\t// When the watch prop changes, start calculating space.\n\n\tReact.useEffect(() => {\n\t\tasync function run() {\n\t\t\tsetWorking(true);\n\n\t\t\tconst {quota, usage} = await navigator.storage.estimate();\n\n\t\t\tif (quota !== undefined && usage !== undefined) {\n\t\t\t\tsetPercentFree(((1 - usage / quota) * 100).toFixed(0));\n\t\t\t}\n\n\t\t\tsetLastWatch(watch);\n\t\t\tsetWorking(false);\n\t\t}\n\n\t\tif (!hide && !working && lastWatch !== watch) {\n\t\t\trun();\n\t\t}\n\t}, [hide, lastWatch, watch, working]);\n\n\tif (hide) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<span className=\"storage-quota\">\n\t\t\t{percentFree &&\n\t\t\t\tt('components.storageQuota.freeSpace', {\n\t\t\t\t\tpercent: percentFree\n\t\t\t\t})}\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPackage} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {useStoriesContext} from '../../../../store/stories';\nimport {archiveFilename, publishArchive} from '../../../../util/publish';\nimport {saveHtml} from '../../../../util/save-html';\nimport {getAppInfo} from '../../../../util/app-info';\n\nexport const ArchiveButton: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPackage />}\n\t\t\tlabel={t('routes.storyList.toolbar.archive')}\n\t\t\tonClick={() =>\n\t\t\t\tsaveHtml(publishArchive(stories, getAppInfo()), archiveFilename())\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryImportDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const ImportStoryButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconFileImport />}\n\t\t\tlabel={t('common.import')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({type: 'addDialog', component: StoryImportDialog})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryTagsDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const StoryTagsButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyList.toolbar.storyTags')}\n\t\t\tonClick={() => {\n\t\t\t\tdispatch({type: 'addDialog', component: StoryTagsDialog});\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {ArchiveButton} from './archive-button';\nimport {ImportStoryButton} from './import-story-button';\nimport {StoryTagsButton} from './story-tags-button';\n\nexport const LibraryActions: React.FC = () => (\n\t<ButtonBar>\n\t\t<StoryTagsButton />\n\t\t<ImportStoryButton />\n\t\t<ArchiveButton />\n\t</ButtonBar>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconPlus} from '@tabler/icons';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tcreateStory,\n\tstoryDefaults,\n\tuseStoriesContext\n} from '../../../../store/stories';\nimport {PromptButton} from '../../../../components/control/prompt-button';\nimport {unusedName} from '../../../../util/unused-name';\n\nexport const CreateStoryButton: React.FC = () => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst [newName, setNewName] = React.useState(\n\t\tunusedName(\n\t\t\tstoryDefaults().name,\n\t\t\tstories.map(story => story.name)\n\t\t)\n\t);\n\tconst history = useHistory();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction validateName(value: string) {\n\t\tif (value.trim() === '') {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\tmessage: t('routes.storyList.toolbar.createStoryButton.emptyName')\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\tstories.some(story => story.name.toLowerCase() === value.toLowerCase())\n\t\t) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\tmessage: t('routes.storyList.toolbar.createStoryButton.nameConflict')\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\tfunction handleSubmit() {\n\t\tconst id = createStory(stories, prefs, {name: newName})(\n\t\t\tdispatch,\n\t\t\t() => stories\n\t\t);\n\n\t\thistory.push(`/stories/${id}`);\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tsubmitLabel={t('common.create')}\n\t\t\tsubmitVariant=\"create\"\n\t\t\tonChange={e => setNewName(e.target.value)}\n\t\t\tonSubmit={handleSubmit}\n\t\t\tprompt={t('routes.storyList.toolbar.createStoryButton.prompt')}\n\t\t\tvalidate={validateName}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n","import {IconCheck, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './confirm-button.css';\n\nexport interface ConfirmButtonProps\n\textends Omit<CardButtonProps, 'ariaLabel' | 'open' | 'onChangeOpen'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tconfirmIcon?: React.ReactNode;\n\tconfirmLabel?: string;\n\tconfirmVariant?: IconButtonProps['variant'];\n\tonConfirm: () => void;\n\tprompt: string;\n}\n\nexport const ConfirmButton: React.FC<ConfirmButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tconfirmIcon,\n\t\tconfirmLabel,\n\t\tconfirmVariant,\n\t\tonConfirm,\n\t\tprompt,\n\t\t...other\n\t} = props;\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tfunction handleConfirm() {\n\t\tsetOpen(false);\n\t\tonConfirm();\n\t}\n\n\treturn (\n\t\t<span className=\"confirm-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={prompt}\n\t\t\t\tfocusSelector=\"button:nth-child(2)\"\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t\t{...other}\n\t\t\t>\n\t\t\t\t<div>\n\t\t\t\t\t<CardContent>{prompt}</CardContent>\n\t\t\t\t\t<ButtonBar>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={confirmIcon ?? <IconCheck />}\n\t\t\t\t\t\t\tlabel={confirmLabel ?? t('common.ok')}\n\t\t\t\t\t\t\tonClick={handleConfirm}\n\t\t\t\t\t\t\tvariant={confirmVariant ?? 'primary'}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ButtonBar>\n\t\t\t\t</div>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ConfirmButton} from '../../../../components/control/confirm-button';\nimport {deleteStory, Story, useStoriesContext} from '../../../../store/stories';\nimport {isElectronRenderer} from '../../../../util/is-electron';\n\nexport interface DeleteStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DeleteStoryButton: React.FC<DeleteStoryButtonProps> = ({\n\tstory\n}) => {\n\t// We need to store a local copy of the story name so that after it's deleted,\n\t// the prompt doesn't change as it transitions out.\n\tconst [storyName, setStoryName] = React.useState(story?.name);\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (story?.name) {\n\t\t\tsetStoryName(story.name);\n\t\t}\n\t}, [story?.name]);\n\n\treturn (\n\t\t<ConfirmButton\n\t\t\tconfirmIcon={<IconTrash />}\n\t\t\tconfirmLabel={t('common.delete')}\n\t\t\tconfirmVariant=\"danger\"\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.delete')}\n\t\t\tonConfirm={story ? () => dispatch(deleteStory(story)) : () => {}}\n\t\t\tprompt={t(\n\t\t\t\t`routes.storyList.toolbar.deleteStoryButton.warning.${\n\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t}`,\n\t\t\t\t{storyName}\n\t\t\t)}\n\t\t/>\n\t);\n};\n","import {IconCopy} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tduplicateStory,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface DuplicateStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DuplicateStoryButton: React.FC<DuplicateStoryButtonProps> = ({\n\tstory\n}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story set');\n\t\t}\n\n\t\tdispatch(duplicateStory(story, stories));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconCopy />}\n\t\t\tlabel={t('common.duplicate')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Story} from '../../../../store/stories';\n\nexport interface EditStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const EditStoryButton: React.FC<EditStoryButtonProps> = ({story}) => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={t('common.edit')}\n\t\t\tonClick={() => history.push(`/stories/${story?.id}`)}\n\t\t/>\n\t);\n};\n","import {IconTag} from '@tabler/icons';\nimport * as React from 'react';\nimport {AddTagButton} from '../../../../components/tag';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {\n\tStory,\n\tstoryTags,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface TagStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const TagStoryButton: React.FC<TagStoryButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\n\tfunction handleAddTag(tagName: string, tagColor?: string) {\n\t\tif (!story) {\n\t\t\tthrow new Error('Story is unset');\n\t\t}\n\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags ? [...story.tags, tagName] : [tagName]\n\t\t\t})\n\t\t);\n\n\t\tif (tagColor) {\n\t\t\tprefsDispatch(\n\t\t\t\tsetPref('storyTagColors', {\n\t\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t\t[tagName]: tagColor\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<AddTagButton\n\t\t\tassignedTags={story?.tags ?? []}\n\t\t\tdisabled={!story}\n\t\t\texistingTags={storyTags(stories)}\n\t\t\ticon={<IconTag />}\n\t\t\tonAdd={handleAddTag}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {CreateStoryButton} from './create-story-button';\nimport {DeleteStoryButton} from './delete-story-button';\nimport {DuplicateStoryButton} from './duplicate-story-button';\nimport {EditStoryButton} from './edit-story-button';\nimport {TagStoryButton} from './tag-story-button';\n\nexport interface StoryActionsProps {\n\tselectedStory?: Story;\n}\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {selectedStory} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreateStoryButton />\n\t\t\t<EditStoryButton story={selectedStory} />\n\t\t\t<TagStoryButton story={selectedStory} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name =>\n\t\t\t\t\tdispatch(updateStory(stories, selectedStory!, {name}))\n\t\t\t\t}\n\t\t\t\tstory={selectedStory}\n\t\t\t/>\n\t\t\t<DuplicateStoryButton story={selectedStory} />\n\t\t\t<DeleteStoryButton story={selectedStory} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowsSort} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\n\nexport const SortByButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\tconst {dispatch, prefs} = usePrefsContext();\n\n\treturn (\n\t\t<MenuButton\n\t\t\ticon={<IconArrowsSort />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'date',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByDate'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'date'))\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'name',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByName'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'name'))\n\t\t\t\t}\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.sort')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconTag} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {usePrefsContext} from '../../../../store/prefs';\n\nexport interface TagFilterButtonProps {\n\ttags: string[];\n}\n\nexport const TagFilterButton: React.FC<TagFilterButtonProps> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<MenuButton\n\t\t\tdisabled={props.tags.length === 0}\n\t\t\ticon={<IconTag />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.length === 0,\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.showAllStories'),\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({type: 'update', name: 'storyListTagFilter', value: []})\n\t\t\t\t},\n\t\t\t\t{separator: true},\n\t\t\t\t...props.tags.map(tag => ({\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.includes(tag),\n\t\t\t\t\tlabel: tag,\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\t\tname: 'storyListTagFilter',\n\t\t\t\t\t\t\tvalue: prefs.storyListTagFilter.includes(tag)\n\t\t\t\t\t\t\t\t? prefs.storyListTagFilter.filter(t => t !== tag)\n\t\t\t\t\t\t\t\t: [...prefs.storyListTagFilter, tag]\n\t\t\t\t\t\t})\n\t\t\t\t}))\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.showTags')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {storyTags, useStoriesContext} from '../../../../store/stories';\nimport {SortByButton} from './sort-by-button';\nimport {TagFilterButton} from './tag-filter-button';\n\nexport const ViewActions: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<SortByButton />\n\t\t\t<TagFilterButton tags={storyTags(stories)} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {StorageQuota} from '../../../components/storage-quota/storage-quota';\nimport {BuildActions, AppActions} from '../../../route-actions';\nimport {Story, useStoriesContext} from '../../../store/stories';\nimport {LibraryActions} from './library/library-actions';\nimport {StoryActions} from './story/story-actions';\nimport {ViewActions} from './view/view-actions';\n\nexport interface StoryListToolbarProps {\n\tselectedStories: Story[];\n}\n\nexport const StoryListToolbar: React.FC<StoryListToolbarProps> = props => {\n\tconst {selectedStories} = props;\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst selectedStory =\n\t\tselectedStories.length === 1 ? selectedStories[0] : undefined;\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<StorageQuota watch={stories} />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.story')]: <StoryActions selectedStory={selectedStory} />,\n\t\t\t\t[t('routes.storyList.library')]: <LibraryActions />,\n\t\t\t\t[t('common.build')]: <BuildActions story={selectedStory} />,\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","/**\n * Generates a hue (as in the HSL colorspace) for a string.\n */\nexport function hueString(value: string): number {\n\tlet result = 0;\n\n\tfor (let i = 0; i < value.length; i++) {\n\t\tresult += value.charCodeAt(i);\n\t}\n\n\treturn result % 360;\n}\n","import * as React from 'react';\nimport {Story} from '../../store/stories';\nimport {hueString} from '../../util/hue-string';\nimport './story-preview.css';\n\nexport interface StoryPreviewProps {\n\tstory: Story;\n}\n\nexport const StoryPreview: React.FC<StoryPreviewProps> = React.memo(props => {\n\tconst {story} = props;\n\tconst hues = [hueString(story.name)];\n\n\thues.push((hues[0] + 15) % 360);\n\thues.push((hues[0] - 15) % 360);\n\thues.push((hues[0] + 30) % 360);\n\thues.push((hues[0] - 30) % 360);\n\thues.push((hues[0] + 60) % 360);\n\n\tlet minX = Number.POSITIVE_INFINITY;\n\tlet minY = Number.POSITIVE_INFINITY;\n\tlet maxX = Number.NEGATIVE_INFINITY;\n\tlet maxY = Number.NEGATIVE_INFINITY;\n\n\tconst circles = story.passages.map(passage => ({\n\t\tkey: passage.name,\n\t\tx: passage.left + passage.width / 2,\n\t\ty: passage.top + passage.height / 2,\n\t\tradius: Math.max(passage.width, passage.height)\n\t}));\n\n\tconst svg = circles\n\t\t.reduce<[React.ReactNode[], React.ReactNode[]]>(\n\t\t\t(result, circle, index) => {\n\t\t\t\t// We reduce the circles to an array with two elements so that the\n\t\t\t\t// larger, faded circles appear below the smaller, more solid ones.\n\n\t\t\t\tconst bgRadius = circle.radius + 200;\n\n\t\t\t\t// Kind of gross to do side effects in a reduce(), but it saves an O(n).\n\n\t\t\t\tminX = Math.min(minX, circle.x - bgRadius);\n\t\t\t\tminY = Math.min(minY, circle.y - bgRadius);\n\t\t\t\tmaxX = Math.max(maxX, circle.x + bgRadius);\n\t\t\t\tmaxY = Math.max(maxY, circle.y + bgRadius);\n\n\t\t\t\tresult[0].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-bg`}\n\t\t\t\t\t\tr={bgRadius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 80%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\tresult[1].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-fg`}\n\t\t\t\t\t\tr={circle.radius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 60%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\t[[], []]\n\t\t)\n\t\t.map((nodes, index) => (\n\t\t\t<g className={`story-preview-${index === 0 ? 'bg' : 'fg'}`} key={index}>\n\t\t\t\t{nodes}\n\t\t\t</g>\n\t\t));\n\n\tconst viewBox = `${minX} ${minY} ${maxX - minX} ${maxY - minY}`;\n\n\treturn (\n\t\t<svg\n\t\t\tclassName=\"story-preview\"\n\t\t\tviewBox={viewBox}\n\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t>\n\t\t\t{svg}\n\t\t</svg>\n\t);\n});\n\nStoryPreview.displayName = 'StoryPreview';","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Story} from '../../store/stories';\nimport {Color} from '../../util/color';\nimport {CardContent, CardProps} from '../container/card';\nimport {SelectableCard} from '../container/card/selectable-card';\nimport {TagButton} from '../tag';\nimport './story-card.css';\nimport {StoryPreview} from './story-preview';\n\nconst dateFormatter = new Intl.DateTimeFormat([]);\n\nexport interface StoryCardProps extends CardProps {\n\tonChangeTagColor: (name: string, color: Color) => void;\n\tonRemoveTag: (name: string) => void;\n\tonEdit: () => void;\n\tonSelect: () => void;\n\tstory: Story;\n\tstoryTagColors: Record<string, Color>;\n}\n\nexport const StoryCard: React.FC<StoryCardProps> = props => {\n\tconst {\n\t\tonChangeTagColor,\n\t\tonEdit,\n\t\tonRemoveTag,\n\t\tonSelect,\n\t\tstory,\n\t\tstoryTagColors,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-card\">\n\t\t\t<SelectableCard\n\t\t\t\t{...otherProps}\n\t\t\t\tlabel={story.name}\n\t\t\t\tonDoubleClick={onEdit}\n\t\t\t\tonSelect={onSelect}\n\t\t\t\tselected={story.selected}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-card-summary\">\n\t\t\t\t\t\t<div className=\"story-card-summary-preview\">\n\t\t\t\t\t\t\t<StoryPreview story={story} />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"story-card-summary-text\">\n\t\t\t\t\t\t\t<h2>{story.name}</h2>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t{t('components.storyCard.lastUpdated', {\n\t\t\t\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\t{t('components.storyCard.passageCount', {\n\t\t\t\t\t\t\t\t\tcount: story.passages.length\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{story.tags && (\n\t\t\t\t\t\t<div className=\"tags\">\n\t\t\t\t\t\t\t{story.tags.map(tag => (\n\t\t\t\t\t\t\t\t<TagButton\n\t\t\t\t\t\t\t\t\tcolor={storyTagColors[tag]}\n\t\t\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\t\t\tonChangeColor={color => onChangeTagColor(tag, color)}\n\t\t\t\t\t\t\t\t\tonRemove={() => onRemoveTag(tag)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</CardContent>\n\t\t\t</SelectableCard>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useHistory} from 'react-router-dom';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {CardGroup} from '../../components/container/card-group';\nimport {StoryCard} from '../../components/story/story-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {Story, updateStory} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\n/**\n * How wide a story card should render onscreen as.\n */\nconst cardWidth = '360px';\n\nexport interface StoryCardsProps {\n\tonSelectStory: (story: Story) => void;\n\tstories: Story[];\n}\n\nexport const StoryCards: React.FC<StoryCardsProps> = props => {\n\tconst {onSelectStory, stories} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useUndoableStoriesContext();\n\tconst history = useHistory();\n\n\tfunction handleChangeTagColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {\n\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t[tagName]: color\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(story: Story, tagName: string) {\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags.filter(tag => tag !== tagName)\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CardGroup columnWidth={cardWidth}>\n\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t{stories.map(story => (\n\t\t\t\t\t\t<CSSTransition classNames=\"pop\" key={story.id} timeout={200}>\n\t\t\t\t\t\t\t<StoryCard\n\t\t\t\t\t\t\t\tonChangeTagColor={handleChangeTagColor}\n\t\t\t\t\t\t\t\tonEdit={() => history.push(`/stories/${story.id}`)}\n\t\t\t\t\t\t\t\tonRemoveTag={name => handleRemoveTag(story, name)}\n\t\t\t\t\t\t\t\tonSelect={() => onSelectStory(story)}\n\t\t\t\t\t\t\t\tstory={story}\n\t\t\t\t\t\t\t\tstoryTagColors={prefs.storyTagColors}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t))}\n\t\t\t\t</TransitionGroup>\n\t\t\t</CardGroup>\n\t\t</>\n\t);\n};\n","import sortBy from 'lodash/sortBy';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {MainContent} from '../../components/container/main-content';\nimport {SafariWarningCard} from '../../components/error';\nimport {\n\tAppDonationDialog,\n\tDialogsContextProvider,\n\tuseDialogsContext\n} from '../../dialogs';\nimport {usePrefsContext} from '../../store/prefs';\nimport {useDonationCheck} from '../../store/prefs/use-donation-check';\nimport {\n\tdeselectAllStories,\n\tdeselectStory,\n\tselectStory,\n\tuseStoriesContext\n} from '../../store/stories';\nimport {UndoableStoriesContextProvider} from '../../store/undoable-stories';\nimport {StoryListToolbar} from './toolbar/story-list-toolbar';\nimport {StoryCards} from './story-cards';\nimport {ClickAwayListener} from '../../components/click-away-listener';\n\nexport const InnerStoryListRoute: React.FC = () => {\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {shouldShowDonationPrompt} = useDonationCheck();\n\tconst {t} = useTranslation();\n\n\tconst selectedStories = React.useMemo(\n\t\t() => stories.filter(story => story.selected),\n\t\t[stories]\n\t);\n\n\tconst visibleStories = React.useMemo(() => {\n\t\tconst filteredStories =\n\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t? stories.filter(story =>\n\t\t\t\t\t\tstory.tags.some(tag => prefs.storyListTagFilter.includes(tag))\n\t\t\t\t  )\n\t\t\t\t: stories;\n\n\t\tswitch (prefs.storyListSort) {\n\t\t\tcase 'date':\n\t\t\t\treturn sortBy(filteredStories, 'lastUpdated');\n\t\t\tcase 'name':\n\t\t\t\treturn sortBy(filteredStories, 'name');\n\t\t}\n\t}, [prefs.storyListSort, prefs.storyListTagFilter, stories]);\n\n\t// Any stories no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const story of selectedStories) {\n\t\t\tif (story.selected && !visibleStories.includes(story)) {\n\t\t\t\tstoriesDispatch(deselectStory(story));\n\t\t\t}\n\t\t}\n\t}, [selectedStories, stories, storiesDispatch, visibleStories]);\n\n\tReact.useEffect(() => {\n\t\tif (shouldShowDonationPrompt()) {\n\t\t\tdialogsDispatch({type: 'addDialog', component: AppDonationDialog});\n\t\t}\n\t}, [dialogsDispatch, shouldShowDonationPrompt]);\n\n\treturn (\n\t\t<div className=\"story-list-route\">\n\t\t\t<StoryListToolbar selectedStories={selectedStories} />\n\t\t\t<ClickAwayListener\n\t\t\t\tignoreSelector=\".story-card\"\n\t\t\t\tonClickAway={() => storiesDispatch(deselectAllStories())}\n\t\t\t>\n\t\t\t\t<MainContent\n\t\t\t\t\ttitle={t(\n\t\t\t\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t\t\t\t? 'routes.storyList.taggedTitleCount'\n\t\t\t\t\t\t\t: 'routes.storyList.titleCount',\n\t\t\t\t\t\t{count: visibleStories.length}\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t<SafariWarningCard />\n\t\t\t\t\t<div className=\"stories\">\n\t\t\t\t\t\t{stories.length === 0 ? (\n\t\t\t\t\t\t\t<p>{t('routes.storyList.noStories')}</p>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<StoryCards\n\t\t\t\t\t\t\t\tonSelectStory={story =>\n\t\t\t\t\t\t\t\t\tstoriesDispatch(selectStory(story, true))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tstories={visibleStories}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</MainContent>\n\t\t\t</ClickAwayListener>\n\t\t</div>\n\t);\n};\n\nexport const StoryListRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryListRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\n/**\n * How long since the user began using Twine to show a donation prompt. It's set\n * to 14 days.\n */\nexport const donationDelay = 1000 * 60 * 60 * 24 * 14;\n\nexport function useDonationCheck() {\n\tconst {prefs} = usePrefsContext();\n\n\tconst shouldShowDonationPrompt = React.useCallback(() => {\n\t\tif (prefs.donateShown) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn Date.now() > prefs.firstRunTime + donationDelay;\n\t}, [prefs.donateShown, prefs.firstRunTime]);\n\n\treturn {shouldShowDonationPrompt};\n}\n","export function replaceDom(html: string) {\n\t// Blast JS globals.\n\n\tdelete (window as any).CodeMirror;\n\tdelete (window as any).SVG;\n\tdelete (window as any).Store;\n\tdelete (window as any).StoryFormat;\n\tdelete (window as any).amdDefine;\n\tdelete (window as any).app;\n\tdelete (window as any).jQuery;\n\n\t// Rewrite the document.\n\n\tdocument.open();\n\tdocument.write(html);\n\tdocument.close();\n}\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\nimport {ErrorMessage} from '../../components/error';\n\nexport const StoryPlayRoute: React.FC = () => {\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\ttry {\n\t\t\t\treplaceDom(await publishStory(storyId));\n\t\t\t} catch (error) {\n\t\t\t\tsetPublishError(error as Error);\n\t\t\t}\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, publishStory, storyId]);\n\n\tif (publishError) {\n\t\treturn <ErrorMessage>{publishError.message}</ErrorMessage>;\n\t}\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\nimport {ErrorMessage} from '../../components/error';\n\nexport const StoryProofRoute: React.FC = () => {\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {proofStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\ttry {\n\t\t\t\treplaceDom(await proofStory(storyId));\n\t\t\t} catch (error) {\n\t\t\t\tsetPublishError(error as Error);\n\t\t\t}\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, proofStory, storyId]);\n\n\tif (publishError) {\n\t\treturn <ErrorMessage>{publishError.message}</ErrorMessage>;\n\t}\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\nimport {ErrorMessage} from '../../components/error';\n\nexport const StoryTestRoute: React.FC = () => {\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [inited, setInited] = React.useState(false);\n\tconst {passageId, storyId} = useParams<{\n\t\tpassageId: string;\n\t\tstoryId: string;\n\t}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\ttry {\n\t\t\t\treplaceDom(\n\t\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\t\tstartId: passageId\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tsetPublishError(error as Error);\n\t\t\t}\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, passageId, publishStory, storyId]);\n\n\tif (publishError) {\n\t\treturn <ErrorMessage>{publishError.message}</ErrorMessage>;\n\t}\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowRight, IconArrowBarToRight} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {Card, CardContent, CardProps} from '../container/card';\nimport {IconButton} from '../control/icon-button';\nimport './welcome-card.css';\n\nexport interface WelcomeCardProps extends CardProps {\n\timage?: React.ReactNode;\n\tnextLabel: string;\n\tonNext: () => void;\n\tonSkip: () => void;\n\tshowSkip: boolean;\n\ttitle: string;\n}\n\nexport const WelcomeCard: React.FC<WelcomeCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\timage,\n\t\tnextLabel,\n\t\tonNext,\n\t\tonSkip,\n\t\tshowSkip,\n\t\ttitle,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"welcome-card\">\n\t\t\t<Card {...otherProps}>\n\t\t\t\t<div className=\"welcome-card-image\">{image}</div>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<h2>{title}</h2>\n\t\t\t\t\t{children}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconArrowRight />}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tonClick={onNext}\n\t\t\t\t\t\tlabel={nextLabel}\n\t\t\t\t\t/>\n\t\t\t\t\t{showSkip && (\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconArrowBarToRight />}\n\t\t\t\t\t\t\tlabel={t('common.skip')}\n\t\t\t\t\t\t\tonClick={onSkip}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import {IconDeviceFloppy, IconHelp, IconMoodSmile} from '@tabler/icons';\nimport {IconTwine} from '../../components/image/icon';\nimport {isElectronRenderer} from '../../util/is-electron';\n\nexport const content = () => [\n\t{\n\t\thtml: 'routes.welcome.greeting',\n\t\timage: <IconTwine />,\n\t\tnextLabel: 'routes.welcome.tellMeMore',\n\t\ttitle: 'routes.welcome.greetingTitle'\n\t},\n\t{\n\t\thtml: 'routes.welcome.help',\n\t\timage: <IconHelp />,\n\t\ttitle: 'routes.welcome.helpTitle'\n\t},\n\tisElectronRenderer()\n\t\t? {\n\t\t\t\thtml: 'routes.welcome.autosave',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.autosaveTitle'\n\t\t  }\n\t\t: {\n\t\t\t\thtml: 'routes.welcome.browserStorage',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.browserStorageTitle'\n\t\t  },\n\t{\n\t\thtml: 'routes.welcome.done',\n\t\timage: <IconMoodSmile />,\n\t\tnextLabel: 'routes.welcome.gotoStoryList',\n\t\ttitle: 'routes.welcome.doneTitle'\n\t}\n];\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport scroll from 'scroll';\nimport {WelcomeCard} from '../../components/welcome/welcome-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {content} from './content';\nimport './welcome-route.css';\n\nexport const WelcomeRoute: React.FC = () => {\n\tconst containerEl = React.useRef<HTMLDivElement>(null);\n\tconst {dispatch} = usePrefsContext();\n\tconst history = useHistory();\n\tconst [shown, setShown] = React.useState(1);\n\tconst allCards = React.useMemo(content, []);\n\tconst visibleCards = React.useMemo(() => allCards.slice(0, shown), [\n\t\tallCards,\n\t\tshown\n\t]);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (containerEl.current) {\n\t\t\tconst lastCard = containerEl.current.querySelector(\n\t\t\t\t'.welcome-card:last-of-type'\n\t\t\t);\n\n\t\t\tif (lastCard) {\n\t\t\t\tscroll.top(\n\t\t\t\t\tdocument.documentElement ?? document.body,\n\t\t\t\t\t(lastCard as HTMLElement).offsetTop,\n\t\t\t\t\t{duration: 400}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}, [shown]);\n\n\tconst finish = () => {\n\t\tdispatch(setPref('welcomeSeen', true));\n\t\thistory.push('/');\n\t};\n\n\tconst showNext = () => setShown(shown => shown + 1);\n\n\treturn (\n\t\t<div className=\"welcome-route\" ref={containerEl}>\n\t\t\t<Helmet>\n\t\t\t\t<title>{t('routes.welcome.greetingTitle')}</title>\n\t\t\t</Helmet>\n\t\t\t<div className=\"cards\">\n\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t{visibleCards.map((card, index) => (\n\t\t\t\t\t\t<CSSTransition classNames=\"pop\" key={card.title} timeout={200}>\n\t\t\t\t\t\t\t<WelcomeCard\n\t\t\t\t\t\t\t\timage={card.image}\n\t\t\t\t\t\t\t\tnextLabel={\n\t\t\t\t\t\t\t\t\tcard.nextLabel ? t(card.nextLabel) : t('common.next')\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tonNext={index === allCards.length - 1 ? finish : showNext}\n\t\t\t\t\t\t\t\tonSkip={finish}\n\t\t\t\t\t\t\t\tshowSkip={index === 0}\n\t\t\t\t\t\t\t\ttitle={t(card.title)}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div dangerouslySetInnerHTML={{__html: t(card.html)}} />\n\t\t\t\t\t\t\t</WelcomeCard>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t))}\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {HashRouter, Route, Switch} from 'react-router-dom';\nimport {usePrefsContext} from '../store/prefs';\nimport {StoryFormatListRoute} from './story-format-list';\nimport {StoryEditRoute} from './story-edit';\nimport {StoryListRoute} from './story-list';\nimport {StoryPlayRoute} from './story-play';\nimport {StoryProofRoute} from './story-proof';\nimport {StoryTestRoute} from './story-test';\nimport {WelcomeRoute} from './welcome';\n\nexport const Routes: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\t// A <HashRouter> is used to make our lives easier--to load local story\n\t// formats, we need the document HREF to reflect where the HTML file is.\n\t// Otherwise we'd have to store the actual location somewhere, which will\n\t// differ between web and Electron contexts.\n\n\treturn (\n\t\t<HashRouter>\n\t\t\t{prefs.welcomeSeen ? (\n\t\t\t\t<Switch>\n\t\t\t\t\t<Route exact path=\"/\">\n\t\t\t\t\t\t<StoryListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/story-formats\">\n\t\t\t\t\t\t<StoryFormatListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/welcome\">\n\t\t\t\t\t\t<WelcomeRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/play\">\n\t\t\t\t\t\t<StoryPlayRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/proof\">\n\t\t\t\t\t\t<StoryProofRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test/:passageId\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId\">\n\t\t\t\t\t\t<StoryEditRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route\n\t\t\t\t\t\tpath=\"*\"\n\t\t\t\t\t\trender={path => {\n\t\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t\t`No route for path \"${path.location.pathname}\", rendering story list`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn <StoryListRoute />;\n\t\t\t\t\t\t}}\n\t\t\t\t\t></Route>\n\t\t\t\t</Switch>\n\t\t\t) : (\n\t\t\t\t<WelcomeRoute />\n\t\t\t)}\n\t\t</HashRouter>\n\t);\n};\n","import * as React from 'react';\nimport {defaults, usePrefsContext} from './prefs';\nimport {useStoriesContext} from './stories';\nimport {\n\tformatWithNameAndVersion,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {usePersistence} from './persistence/use-persistence';\nimport {LoadingCurtain} from '../components/loading-curtain';\n\nexport const StateLoader: React.FC = ({children}) => {\n\tconst [initing, setIniting] = React.useState(false);\n\tconst [inited, setInited] = React.useState(false);\n\tconst [prefsRepaired, setPrefsRepaired] = React.useState(false);\n\tconst [formatsRepaired, setFormatsRepaired] = React.useState(false);\n\tconst [storiesRepaired, setStoriesRepaired] = React.useState(false);\n\tconst {dispatch: prefsDispatch, prefs: prefsState} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useStoriesContext();\n\tconst {dispatch: formatsDispatch, formats: formatsState} =\n\t\tuseStoryFormatsContext();\n\tconst {prefs, stories, storyFormats} = usePersistence();\n\n\t// Done in steps so that the repair action can see the inited state, and then\n\t// each repair action can see the results of the preceding ones.\n\t//\n\t// Repairs must go:\n\t// formats -> prefs (so it can repair bad format preferences) -> stories\n\n\tReact.useEffect(() => {\n\t\tasync function run() {\n\t\t\tif (!initing) {\n\t\t\t\tconst formatsState = await storyFormats.load();\n\t\t\t\tconst prefsState = await prefs.load();\n\t\t\t\tconst storiesState = await stories.load();\n\n\t\t\t\tformatsDispatch({type: 'init', state: formatsState});\n\t\t\t\tprefsDispatch({type: 'init', state: prefsState});\n\t\t\t\tstoriesDispatch({type: 'init', state: storiesState});\n\t\t\t\tsetInited(true);\n\t\t\t}\n\t\t}\n\n\t\trun();\n\t\tsetIniting(true);\n\t}, [\n\t\tformatsDispatch,\n\t\tinited,\n\t\tiniting,\n\t\tprefs,\n\t\tprefsDispatch,\n\t\tstories,\n\t\tstoriesDispatch,\n\t\tstoryFormats\n\t]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && !formatsRepaired) {\n\t\t\tformatsDispatch({type: 'repair'});\n\t\t\tsetFormatsRepaired(true);\n\t\t}\n\t}, [formatsDispatch, formatsRepaired, inited]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && formatsRepaired && !prefsRepaired) {\n\t\t\tprefsDispatch({type: 'repair', allFormats: formatsState});\n\t\t\tsetPrefsRepaired(true);\n\t\t}\n\t}, [formatsRepaired, formatsState, inited, prefsDispatch, prefsRepaired]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && formatsRepaired && prefsRepaired && !storiesRepaired) {\n\t\t\t// We try to repair stories to the user's preferred format, but perhaps\n\t\t\t// their prefs are out of date/corrupted. In that case, we use the default\n\t\t\t// one.\n\n\t\t\tlet safeFormat: StoryFormat | undefined;\n\n\t\t\ttry {\n\t\t\t\tsafeFormat = formatWithNameAndVersion(\n\t\t\t\t\tformatsState,\n\t\t\t\t\tprefsState.storyFormat.name,\n\t\t\t\t\tprefsState.storyFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\ttry {\n\t\t\t\t\tsafeFormat = formatWithNameAndVersion(\n\t\t\t\t\t\tformatsState,\n\t\t\t\t\t\tdefaults().storyFormat.name,\n\t\t\t\t\t\tdefaults().storyFormat.version\n\t\t\t\t\t);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t`Could not locate a safe story format, skipping story repair: ${\n\t\t\t\t\t\t\t(error as Error).message\n\t\t\t\t\t\t}`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (safeFormat) {\n\t\t\t\tstoriesDispatch({\n\t\t\t\t\ttype: 'repair',\n\t\t\t\t\tallFormats: formatsState,\n\t\t\t\t\tdefaultFormat: safeFormat\n\t\t\t\t});\n\t\t\t}\n\t\t\tsetStoriesRepaired(true);\n\t\t}\n\t}, [\n\t\tformatsDispatch,\n\t\tformatsRepaired,\n\t\tformatsState,\n\t\tinited,\n\t\tprefsDispatch,\n\t\tprefsRepaired,\n\t\tprefsState.storyFormat.name,\n\t\tprefsState.storyFormat.version,\n\t\tstories,\n\t\tstoriesDispatch,\n\t\tstoriesRepaired\n\t]);\n\n\treturn inited && formatsRepaired && prefsRepaired && storiesRepaired ? (\n\t\t<>{children}</>\n\t) : (\n\t\t<LoadingCurtain />\n\t);\n};\n","import * as React from 'react';\nimport {useComputedTheme} from './prefs/use-computed-theme';\n\nexport function ThemeSetter() {\n\tconst computedTheme = useComputedTheme();\n\n\tReact.useEffect(() => {\n\t\tdocument.body.dataset.appTheme = computedTheme;\n\t}, [computedTheme]);\n\n\treturn null;\n}\n","import * as React from 'react';\nimport {GlobalErrorBoundary} from './components/error';\nimport {LoadingCurtain} from './components/loading-curtain/loading-curtain';\nimport {LocaleSwitcher} from './store/locale-switcher';\nimport {PrefsContextProvider} from './store/prefs';\nimport {Routes} from './routes';\nimport {StoriesContextProvider} from './store/stories';\nimport {StoryFormatsContextProvider} from './store/story-formats';\nimport {StateLoader} from './store/state-loader';\nimport {ThemeSetter} from './store/theme-setter';\nimport 'focus-visible';\nimport './styles/typography.css';\nimport './styles/focus-visible-shim.css';\n\nexport const App: React.FC = () => {\n\treturn (\n\t\t<GlobalErrorBoundary>\n\t\t\t<PrefsContextProvider>\n\t\t\t\t<LocaleSwitcher />\n\t\t\t\t<ThemeSetter />\n\t\t\t\t<StoryFormatsContextProvider>\n\t\t\t\t\t<StoriesContextProvider>\n\t\t\t\t\t\t<StateLoader>\n\t\t\t\t\t\t\t<React.Suspense fallback={<LoadingCurtain />}>\n\t\t\t\t\t\t\t\t<Routes />\n\t\t\t\t\t\t\t</React.Suspense>\n\t\t\t\t\t\t</StateLoader>\n\t\t\t\t\t</StoriesContextProvider>\n\t\t\t\t</StoryFormatsContextProvider>\n\t\t\t</PrefsContextProvider>\n\t\t</GlobalErrorBoundary>\n\t);\n};\n","import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport {App} from './app';\nimport './util/i18n';\n\nReactDOM.render(\n\t<React.StrictMode>\n\t\t<App />\n\t</React.StrictMode>,\n\tdocument.getElementById('root')\n);\n"],"sourceRoot":""}
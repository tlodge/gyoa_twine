(this.webpackJsonpTwine=this.webpackJsonpTwine||[]).push([[0],[,,,function(e,t,n){"use strict";var r=n(213);n.d(t,"addPassageTag",(function(){return r.a})),n.d(t,"createStory",(function(){return r.b})),n.d(t,"createUntitledPassage",(function(){return r.c})),n.d(t,"deletePassages",(function(){return r.d})),n.d(t,"deleteStory",(function(){return r.e})),n.d(t,"deselectAllStories",(function(){return r.f})),n.d(t,"deselectPassage",(function(){return r.g})),n.d(t,"deselectStory",(function(){return r.h})),n.d(t,"duplicateStory",(function(){return r.i})),n.d(t,"highlightPassagesMatchingSearch",(function(){return r.j})),n.d(t,"importStories",(function(){return r.k})),n.d(t,"movePassages",(function(){return r.l})),n.d(t,"removePassageTag",(function(){return r.m})),n.d(t,"renamePassageTag",(function(){return r.n})),n.d(t,"renameStoryTag",(function(){return r.o})),n.d(t,"replaceInStory",(function(){return r.p})),n.d(t,"selectAllPassages",(function(){return r.q})),n.d(t,"selectPassage",(function(){return r.r})),n.d(t,"selectPassagesInRect",(function(){return r.s})),n.d(t,"selectStory",(function(){return r.t})),n.d(t,"setTagColor",(function(){return r.u})),n.d(t,"updatePassage",(function(){return r.v})),n.d(t,"updateStory",(function(){return r.w}));var a=n(27);n.d(t,"passageDefaults",(function(){return a.a})),n.d(t,"storyDefaults",(function(){return a.b}));var o=n(72);n.d(t,"passageConnections",(function(){return o.a})),n.d(t,"passageWithId",(function(){return o.b})),n.d(t,"passageWithName",(function(){return o.c})),n.d(t,"passagesMatchingSearch",(function(){return o.d})),n.d(t,"storyPassageTags",(function(){return o.e})),n.d(t,"storyStats",(function(){return o.f})),n.d(t,"storyTags",(function(){return o.g})),n.d(t,"storyWithId",(function(){return o.h})),n.d(t,"storyWithName",(function(){return o.i}));var s=n(214);n.d(t,"StoriesContextProvider",(function(){return s.a})),n.d(t,"useStoriesContext",(function(){return s.b}));n(192),n(193)},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(5),a=n(0),o=n(20),s=n.n(o),c=(n(167),n(2)),i=n(165),u=n(243),l=(n(364),n(1)),d=function(e){var t=e.anchor,n=e.label,o=e.position,s=void 0===o?"top":o,d=a.useState(null),f=Object(r.a)(d,2),b=f[0],j=f[1],p=a.useState(null),m=Object(r.a)(p,2),h=m[0],g=m[1],O=a.useState(!1),v=Object(r.a)(O,2),y=v[0],x=v[1],w=a.useState(),S=Object(r.a)(w,2),C=S[0],k=S[1],F=Object(u.a)(t,b,{modifiers:[{name:"arrow",options:{element:h}},{name:"flip"}],placement:s,strategy:"fixed"}),E=F.styles,I=F.attributes;return a.useEffect((function(){var e=function(){return k(window.setTimeout((function(){return x(!0)}),500))},n=function(){C&&window.clearTimeout(C),x(!1)};if(t)return t.addEventListener("pointerenter",e),t.addEventListener("pointerleave",n),function(){t.removeEventListener("pointerenter",e),t.removeEventListener("pointerleave",n)}}),[t,C]),Object(l.jsx)(i.a,{classNames:"fade-in-out",in:y,mountOnEnter:!0,timeout:200,unmountOnExit:!0,children:Object(l.jsxs)("div",Object(c.a)(Object(c.a)({"aria-hidden":!0,className:"tooltip",ref:j,role:"tooltip",style:E.popper},I.popper),{},{children:[Object(l.jsx)("div",{className:"tooltip-arrow",ref:g,style:E.arrow}),Object(l.jsx)("div",{className:"tooltip-label",children:n})]}))})},f=a.forwardRef((function(e,t){var n=e.disabled,o=e.icon,c=e.iconOnly,i=e.iconPosition,u=void 0===i?"start":i,f=e.onClick,b=e.preventDefault,j=e.selectable,p=void 0!==j&&j,m=e.selected,h=void 0!==m&&m,g=e.tooltipPosition,O=e.variant,v=void 0===O?"secondary":O,y=s()("icon-button","icon-position-".concat(u),{selected:h},"variant-".concat(v),{"icon-only":c}),x=a.useState(null),w=Object(r.a)(x,2),S=w[0],C=w[1];a.useImperativeHandle(t,(function(){return S}));return Object(l.jsxs)(l.Fragment,{children:[Object(l.jsxs)("button",{"aria-label":c?e.label:void 0,"aria-pressed":p?h:void 0,disabled:n,className:y,onClick:function(e){f&&f(e),b&&e.preventDefault()},ref:C,children:[Object(l.jsx)("span",{className:"icon",children:o}),!c&&e.label]}),c&&Object(l.jsx)(d,{anchor:S,label:e.label,position:g})]})}))},function(e,t,n){"use strict";var r=n(168);n.d(t,"setPref",(function(){return r.a}));var a=n(56);n.d(t,"defaults",(function(){return a.a}));var o=n(169);n.d(t,"formatEditorExtensionsDisabled",(function(){return o.a}));var s=n(220);n.d(t,"PrefsContextProvider",(function(){return s.a})),n.d(t,"usePrefsContext",(function(){return s.b}));n(194)},,,function(e,t,n){"use strict";var r=n(189);n.d(t,"createFromProperties",(function(){return r.a})),n.d(t,"deleteFormat",(function(){return r.b})),n.d(t,"deselectAllFormats",(function(){return r.c})),n.d(t,"deselectFormat",(function(){return r.d})),n.d(t,"loadAllFormatProperties",(function(){return r.e})),n.d(t,"loadFormatProperties",(function(){return r.f})),n.d(t,"selectFormat",(function(){return r.g}));n(75);var a=n(190);n.d(t,"filteredFormats",(function(){return a.a})),n.d(t,"formatImageUrl",(function(){return a.b})),n.d(t,"formatWithId",(function(){return a.c})),n.d(t,"formatWithNameAndVersion",(function(){return a.d})),n.d(t,"newestFormatNamed",(function(){return a.e})),n.d(t,"sortFormats",(function(){return a.f}));var o=n(221);n.d(t,"StoryFormatsContextProvider",(function(){return o.a})),n.d(t,"useStoryFormatsContext",(function(){return o.b}));n(191)},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return c}));n(0);var r=n(20),a=n.n(r),o=(n(254),n(1)),s=function(e){var t;return Object(o.jsx)("div",{className:a()("button-bar","orientation-".concat(null!==(t=e.orientation)&&void 0!==t?t:"horizontal")),children:e.children})},c=(n(255),function(){return Object(o.jsx)("div",{className:"button-bar-separator"})})},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r.a})),n.d(t,"b",(function(){return o}));var r=n(71),a=(n(0),n(257),n(1)),o=function(e){var t=e.children;return Object(a.jsx)("div",{className:"card-content",children:t})};n(258)},function(e,t,n){"use strict";var r=n(222);n.d(t,"AboutTwineDialog",(function(){return r.a}));var a=n(195);n.d(t,"AppDonationDialog",(function(){return a.a}));var o=n(219);n.d(t,"AppPrefsDialog",(function(){return o.a}));var s=n(118);n.d(t,"DialogsContextProvider",(function(){return s.a})),n.d(t,"useDialogsContext",(function(){return s.b}));n(116);var c=n(200);n.o(c,"PassageEditDialog")&&n.d(t,"PassageEditDialog",(function(){return c.PassageEditDialog})),n.o(c,"PassageTagsDialog")&&n.d(t,"PassageTagsDialog",(function(){return c.PassageTagsDialog})),n.o(c,"StoryDetailsDialog")&&n.d(t,"StoryDetailsDialog",(function(){return c.StoryDetailsDialog})),n.o(c,"StoryImportDialog")&&n.d(t,"StoryImportDialog",(function(){return c.StoryImportDialog})),n.o(c,"StoryJavaScriptDialog")&&n.d(t,"StoryJavaScriptDialog",(function(){return c.StoryJavaScriptDialog})),n.o(c,"StorySearchDialog")&&n.d(t,"StorySearchDialog",(function(){return c.StorySearchDialog})),n.o(c,"StoryStylesheetDialog")&&n.d(t,"StoryStylesheetDialog",(function(){return c.StoryStylesheetDialog})),n.o(c,"StoryTagsDialog")&&n.d(t,"StoryTagsDialog",(function(){return c.StoryTagsDialog}));var i=n(215);n.d(t,"PassageEditDialog",(function(){return i.a}));var u=n(202);n.d(t,"PassageTagsDialog",(function(){return u.a}));var l=n(216);n.d(t,"StoryImportDialog",(function(){return l.a}));var d=n(203);n.d(t,"StoryJavaScriptDialog",(function(){return d.a}));var f=n(218);n.d(t,"StoryDetailsDialog",(function(){return f.a}));var b=n(204);n.d(t,"StorySearchDialog",(function(){return b.a}));var j=n(205);n.d(t,"StoryStylesheetDialog",(function(){return j.a}));var p=n(206);n.d(t,"StoryTagsDialog",(function(){return p.a}))},,,,,function(e,t,n){"use strict";var r=n(217);n.d(t,"UndoableStoriesContextProvider",(function(){return r.a})),n.d(t,"useUndoableStoriesContext",(function(){return r.b}));n(201)},function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return j}));var r=n(0),a=n(20),o=n.n(a),s=n(49),c=n(4),i=n(16),u=n(6),l=(n(365),n(76)),d=n(37),f=n(1),b=function(e){var t=e.children,n=e.className,a=e.collapsed,b=e.fixedSize,j=e.headerLabel,p=e.maximizable,m=e.maximized,h=e.onChangeCollapsed,g=e.onChangeMaximized,O=e.onClose,v=Object(l.a)(),y=v.didCatch,x=v.ErrorBoundary,w=v.error,S=Object(s.a)().t;r.useEffect((function(){w&&console.error(w)}),[w]);var C=o()("dialog-card",n,{collapsed:a,"fixed-size":b,maximized:m});return Object(f.jsx)("div",{"aria-label":j,role:"dialog",className:C,onKeyDown:function(e){"Escape"===e.key&&O()},children:Object(f.jsxs)(i.a,{floating:!0,children:[Object(f.jsxs)("h2",{children:[Object(f.jsx)("div",{className:"dialog-card-header",children:Object(f.jsx)(u.a,{icon:a?Object(f.jsx)(c.p,{}):Object(f.jsx)(c.o,{}),label:j,onClick:function(){return h(!a)}})}),Object(f.jsxs)("div",{className:"dialog-card-header-controls",children:[p&&Object(f.jsx)(u.a,{icon:m?Object(f.jsx)(c.i,{}):Object(f.jsx)(c.h,{}),iconOnly:!0,label:S(m?"common.unmaximize":"common.maximize"),onClick:function(){return g(!m)},tooltipPosition:"bottom"}),Object(f.jsx)(u.a,{icon:Object(f.jsx)(c.ab,{}),iconOnly:!0,label:S("common.close"),onClick:O,tooltipPosition:"bottom"})]})]}),y?Object(f.jsx)(d.a,{children:S("components.dialogCard.contentsCrashed")}):Object(f.jsx)(x,{children:!a&&t})]})})},j=(n(366),function(e){return Object(f.jsx)("div",{className:"dialog-editor",children:e.children})})},,function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return s})),n.d(t,"e",(function(){return c})),n.d(t,"g",(function(){return i})),n.d(t,"f",(function(){return u})),n.d(t,"a",(function(){return l}));var r=n(96);function a(e,t){return 180*Math.atan2(t.top-e.top,t.left-e.left)/Math.PI}function o(e,t){return Math.hypot(e.left-t.left,e.top-t.top)}function s(e){return{left:e.left+e.width/2,top:e.top+e.height/2}}function c(e,t){var n={height:0,left:0,top:0,width:0};return e.left<t.left?(n.left=e.left,n.width=t.left-e.left):(n.left=t.left,n.width=e.left-t.left),e.top<t.top?(n.top=e.top,n.height=t.top-e.top):(n.top=t.top,n.height=e.top-t.top),n}function i(e,t){return!(t.left>e.left+e.width||t.left+t.width<e.left||t.top>e.top+e.height||t.top+t.height<e.top)}function u(e,t,n){var a=[NaN,NaN];return Object(r.a)(a,[e.left,e.top],[e.left,e.top+e.height],[t.left,t.top],[n.left,n.top])||Object(r.a)(a,[e.left+e.width,e.top],[e.left+e.width,e.top+e.height],[t.left,t.top],[n.left,n.top])||Object(r.a)(a,[e.left,e.top],[e.left+e.width,e.top],[t.left,t.top],[n.left,n.top])||Object(r.a)(a,[e.left,e.top+e.height],[e.left+e.width,e.top+e.height],[t.left,t.top],[n.left,n.top])?{left:a[0],top:a[1]}:null}function l(e){if(0===e.length)throw new Error("Can't calculate bounding rect for 0 rects");for(var t=e[0].left,n=e[0].left+e[0].width,r=e[0].top,a=e[0].top+e[0].height,o=1;o<e.length;o++){var s=e[o].left+e[o].width,c=e[o].top+e[o].height;e[o].left<t&&(t=e[o].left),e[o].top<r&&(r=e[o].top),s>n&&(n=s),c>a&&(a=c)}return{left:t,top:r,height:a-r,width:n-t}}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return o}));var r=n(59),a=function(){return{height:100,highlighted:!1,left:0,name:r.a.t("store.passageDefaults.name"),selected:!1,tags:[],text:"",top:0,width:100}},o=function(){return{ifid:"",lastUpdate:new Date,passages:[],name:r.a.t("store.storyDefaults.name"),script:"",selected:!1,snapToGrid:!0,startPassage:"",storyFormat:"",storyFormatVersion:"",stylesheet:"",tags:[],tagColors:{},zoom:1}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(2),a=n(18),o=(n(0),n(4)),s=n(6),c=n(1),i=function(e){var t=e.checkedIcon,n=e.icon,i=e.onChange,u=e.uncheckedIcon,l=e.value,d=Object(a.a)(e,["checkedIcon","icon","onChange","uncheckedIcon","value"]),f=l?null!==t&&void 0!==t?t:Object(c.jsx)(o.T,{}):null!==u&&void 0!==u?u:Object(c.jsx)(o.S,{});return Object(c.jsx)("span",{"aria-disabled":d.disabled,className:"checkbox-button",role:"checkbox","aria-checked":l,children:Object(c.jsx)(s.a,Object(r.a)({icon:null!==n&&void 0!==n?n:f,onClick:function(){return i(!l)}},d))})}},,function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return r}));var r=function(){return-1!==window.navigator.userAgent.indexOf("Electron")}}).call(this,n(144))},,function(e,t,n){"use strict";var r=n(184);n.o(r,"storyFileName")&&n.d(t,"storyFileName",(function(){return r.storyFileName}));var a=n(185);n.d(t,"storyFileName",(function(){return a.a}))},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return i}));var r=["highlighted","selected"],a=["lastUpdate","selected"],o=["loadError","loadState","properties","selected"];function s(e){return Object.keys(e).some((function(e){return!r.includes(e)}))}function c(e){return Object.keys(e).some((function(e){return!a.includes(e)}))}function i(e){return Object.keys(e).some((function(e){return!o.includes(e)}))}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return j}));var r=n(4),a=(n(0),n(251),n(1)),o=function(e){var t=e.children;return Object(a.jsxs)("div",{className:"error-message",children:[Object(a.jsx)(r.a,{}),Object(a.jsx)("div",{className:"message",children:t})]})},s=n(76),c=(n(253),function(e){var t=e.children,n=Object(s.a)(),r=n.ErrorBoundary,c=n.didCatch,i=n.error;return c?Object(a.jsx)("div",{className:"global-error-boundary",children:Object(a.jsxs)("div",{children:[Object(a.jsxs)(o,{children:[Object(a.jsx)("p",{children:"Something went wrong and Twine can't continue."}),Object(a.jsx)("p",{children:"Please try restarting Twine or reloading the page."}),Object(a.jsxs)("p",{children:["If you see this message repeatedly, please"," ",Object(a.jsx)("a",{href:"https://twinery.org/2bugs",rel:"noreferrer",target:"_blank",children:"report a bug"}),"."]})]}),Object(a.jsx)("p",{children:"Details:"}),Object(a.jsx)("pre",{children:i.stack})]})}):Object(a.jsx)(r,{children:t})}),i=n(49),u=n(223),l=n.n(u),d=n(13),f=n(16),b=n(62),j=(n(259),function(e){var t=Object(i.a)().t,n=(new l.a).getBrowser();if("Safari"!==n.name)return null;if(n.version){var s=parseInt(n.version.replace(/\..*/,""));if(Number.isFinite(s)&&s<13)return null}var c=window.navigator;if(c.standalone)return null;var u=void 0!==c.standalone;return Object(a.jsx)("div",{className:"safari-warning-card",children:Object(a.jsxs)(f.a,{children:[Object(a.jsxs)(o,{children:[Object(a.jsx)("p",{children:t("components.safariWarningCard.message")}),u&&Object(a.jsx)("p",{children:t("components.safariWarningCard.addToHomeScreen")}),Object(a.jsx)("p",{children:t("components.safariWarningCard.archiveAndUseAnotherBrowser")})]}),Object(a.jsxs)(d.a,{children:[Object(a.jsx)(b.a,{href:"https://twinery.org/2ioslocalstorage",icon:Object(a.jsx)(r.F,{}),label:t("components.safariWarningCard.learnMore"),variant:"primary"}),u&&Object(a.jsx)(b.a,{href:"https://twinery.org/2ioshomescreen",icon:Object(a.jsx)(r.F,{}),label:t("components.safariWarningCard.howToAddToHomeScreen")})]})]})})})},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));n(0);var r=n(20),a=n.n(r),o=(n(369),n(1)),s=function(e){var t=e.children,n=e.onChange,r=e.options,s=e.orientation,c=e.value,i=a()("text-select","orientation-".concat(null!==s&&void 0!==s?s:"horizontal"));return Object(o.jsx)("span",{className:i,children:Object(o.jsxs)("label",{children:[Object(o.jsx)("span",{className:"text-select-label",children:t}),Object(o.jsx)("span",{className:"text-select-control",children:Object(o.jsx)("select",{onChange:n,value:c,children:r.map((function(e){return Object(o.jsx)("option",{disabled:e.disabled,value:e.value,children:e.label},e.value)}))})})]})})}},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return o.a})),n.d(t,"c",(function(){return s}));var r=n(80);function a(e,t){var n;if("loaded"===e.loadState&&(null===(n=e.properties.editorExtensions)||void 0===n?void 0:n.twine)){var a=Object.keys(e.properties.editorExtensions.twine).filter((function(e){return Object(r.satisfies)(t,e)}));if(0!==a.length)return a.length>1&&console.warn("More than one set of editor extensions for ".concat(e.name," ").concat(e.version," is satisfied by ").concat(t,". Using the first.")),e.properties.editorExtensions.twine[a[0]];console.info("".concat(e.name," ").concat(e.version," has editor extensions, but none that ").concat(t," satisfies"))}}var o=n(74);function s(e){return e.name.toLowerCase().replace(/\s/g,"-")+"-"+e.version}},,function(e,t,n){"use strict";function r(){return{name:"Twine",version:"2.5.1"}}n.d(t,"a",(function(){return r}))},,function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return c})),n.d(t,"c",(function(){return u})),n.d(t,"d",(function(){return l}));var r=n(29),a=n.n(r),o=n(59);function s(){var e=(new Date).toLocaleString().replace(/[/:\\]/g,".");return o.a.t("store.archiveFilename",{timestamp:e})}function c(e,t){return e.reduce((function(e,n){return e+u(n,t,{startOptional:!0})+"\n\n"}),"")}function i(e,t){return'<tw-passagedata pid="'.concat(a()(t.toString()),'" ')+'name="'.concat(a()(e.name),'" ')+'tags="'.concat(a()(e.tags.join(" ")),'" ')+'position="'.concat(e.left,",").concat(e.top,'" ')+'size="'.concat(e.width,",").concat(e.height,'">')+"".concat(a()(e.text),"</tw-passagedata>")}function u(e,t){var n,r,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=o.formatOptions,c=o.startId,u=o.startOptional;if(c=null!==(n=c)&&void 0!==n?n:e.startPassage,!u){if(!c)throw new Error("There is no starting point set for this story and none was set manually.");if(!e.passages.find((function(e){return e.id===c})))throw new Error("The passage set as starting point for this story does not exist.")}var l="";e.passages.forEach((function(e,t){l+=i(e,t+1),e.id===c&&(r=t+1)}));var d=Object.keys(e.tagColors).reduce((function(t,n){return t+'<tw-tag name="'.concat(a()(n),'" color="').concat(a()(e.tagColors[n]),'"></tw-tag>')}),"");return'<tw-storydata name="'.concat(a()(e.name),'" ')+'startnode="'.concat(r||"",'" ')+'creator="'.concat(a()(t.name),'" ')+'creator-version="'.concat(a()(t.version),'" ')+'format="'.concat(a()(e.storyFormat),'" ')+'format-version="'.concat(a()(e.storyFormatVersion),'" ')+'ifid="'.concat(a()(e.ifid),'" ')+'options="'.concat(a()(s),'" ')+'tags="'.concat(a()(e.tags.join(" ")),'" ')+'zoom="'.concat(a()(e.zoom.toString()),'" hidden>')+'<style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">'+e.stylesheet+'</style><script role="script" id="twine-user-script" type="text/twine-javascript">'+e.script+"<\/script>"+d+l+"</tw-storydata>"}function l(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=r.formatOptions,s=r.startId;if(!t)throw new Error("Story format source cannot be empty.");var c=t;return c=(c=c.replace(/{{STORY_NAME}}/g,(function(){return a()(e.name)}))).replace(/{{STORY_DATA}}/g,(function(){return u(e,n,{formatOptions:o,startId:s})}))}},,,function(e,t,n){"use strict";function r(e){return e.length>0&&!/\s/.test(e)}n.d(t,"a",(function(){return r}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var r=n(2),a=n(5),o=n(18),s=n(0),c=n(243),i=n(165),u=n(16),l=n(6),d=(n(410),n(235)),f=n.n(d),b=n(1),j=function(e){var t=e.ariaLabel,n=e.children,d=(e.focusSelector,e.onChangeOpen),j=e.open,p=Object(o.a)(e,["ariaLabel","children","focusSelector","onChangeOpen","open"]),m=s.useState(null),h=Object(a.a)(m,2),g=h[0],O=h[1],v=s.useState(null),y=Object(a.a)(v,2),x=y[0],w=y[1],S=Object(c.a)(g,x,{strategy:"fixed"}),C=S.styles,k=S.attributes;return Object(b.jsxs)("span",{className:"card-button",children:[Object(b.jsx)(l.a,Object(r.a)(Object(r.a)({onClick:function(){return d(!j)}},p),{},{ref:O})),Object(b.jsx)(i.a,{classNames:"fade-out",in:j,mountOnEnter:!0,timeout:200,unmountOnExit:!0,children:Object(b.jsx)(f.a,{focusTrapOptions:{clickOutsideDeactivates:!0,onDeactivate:function(){return d(!1)}},children:Object(b.jsx)("div",Object(r.a)(Object(r.a)({"aria-label":t,className:"card-button-card",ref:w,role:"dialog",style:C.popper},k.popper),{},{children:Object(b.jsx)(u.a,{floating:!0,children:n})}))})})]})}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var r=n(2),a=n(5),o=n(18),s=n(0),c=n(243),i=n(165),u=n(13),l=n(128),d=n(57),f=n(6),b=(n(409),n(28)),j=n(4),p=n(1),m=function(e){var t=e.items,n=Object(o.a)(e,["items"]),m=s.useState(null),h=Object(a.a)(m,2),g=h[0],O=h[1],v=s.useState(null),y=Object(a.a)(v,2),x=y[0],w=y[1],S=s.useState(!1),C=Object(a.a)(S,2),k=C[0],F=C[1],E=Object(c.a)(g,x,{strategy:"fixed"}),I=E.styles,N=E.attributes;return s.useEffect((function(){var e=function(){return F(!1)};return k&&document.addEventListener("click",e),function(){return document.removeEventListener("click",e)}}),[x,k,F]),Object(p.jsxs)("span",{className:"menu-button",children:[Object(p.jsx)(f.a,Object(r.a)(Object(r.a)({},n),{},{onClick:function(){return F((function(e){return!e}))},ref:O})),Object(p.jsx)(i.a,{classNames:"fade-out",in:k,mountOnEnter:!0,timeout:200,unmountOnExit:!0,children:Object(p.jsx)("div",Object(r.a)(Object(r.a)({className:"menu-button-menu",ref:w,style:I.popper},N.popper),{},{children:Object(p.jsx)(l.a,{floating:!0,children:Object(p.jsx)(u.a,{orientation:"vertical",children:t.map((function(e,t){return e.separator?Object(p.jsx)(u.b,{},t):"checkable"in e?Object(p.jsx)(b.a,{checkedIcon:Object(p.jsx)(j.n,{}),disabled:e.disabled,label:e.label,onChange:e.onClick,uncheckedIcon:Object(p.jsx)(d.a,{}),value:e.checked},t):Object(p.jsx)(f.a,{disabled:e.disabled,icon:Object(p.jsx)(d.a,{}),label:e.label,onClick:e.onClick,variant:e.variant},t)}))})})}))})]})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var r=n(2),a=n(8),o=n.n(a),s=n(12),c=n(5),i=n(18),u=n(0),l=n(49),d=n(4),f=n(13),b=n(16),j=n(47),p=n(6),m=n(67),h=n(1),g=function(e){var t=e.cancelIcon,n=e.cancelLabel,a=e.onChange,g=e.onSubmit,O=e.prompt,v=e.submitIcon,y=e.submitLabel,x=e.submitVariant,w=e.validate,S=e.value,C=Object(i.a)(e,["cancelIcon","cancelLabel","onChange","onSubmit","prompt","submitIcon","submitLabel","submitVariant","validate","value"]),k=u.useRef(!0),F=u.useState(!1),E=Object(c.a)(F,2),I=E[0],N=E[1],P=u.useState(),T=Object(c.a)(P,2),D=T[0],L=T[1],A=Object(l.a)().t;return u.useEffect((function(){function e(){return(e=Object(s.a)(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!w){e.next=7;break}return e.next=3,w(S);case 3:t=e.sent,k.current&&L(t),e.next=8;break;case 7:k.current&&L({valid:!0});case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(){e.apply(this,arguments)}()}),[w,S]),u.useEffect((function(){return function(){k.current=!1}}),[]),Object(h.jsx)("span",{className:"prompt-button",children:Object(h.jsx)(j.a,Object(r.a)(Object(r.a)({ariaLabel:O,onChangeOpen:N,open:I},C),{},{children:Object(h.jsxs)("form",{onSubmit:function(e){e.preventDefault(),(null===D||void 0===D?void 0:D.valid)&&(g(S),N(!1))},children:[Object(h.jsxs)(b.b,{children:[Object(h.jsx)(m.a,{onChange:a,orientation:"vertical",value:S,children:O}),(null===D||void 0===D?void 0:D.message)&&Object(h.jsx)("p",{children:D.message})]}),Object(h.jsxs)(f.a,{children:[Object(h.jsx)(p.a,{buttonType:"submit",disabled:!(null===D||void 0===D?void 0:D.valid),icon:null!==v&&void 0!==v?v:Object(h.jsx)(d.n,{}),label:null!==y&&void 0!==y?y:A("common.ok"),variant:null!==x&&void 0!==x?x:"primary"}),Object(h.jsx)(p.a,{buttonType:"button",icon:null!==t&&void 0!==t?t:Object(h.jsx)(d.ab,{}),label:null!==n&&void 0!==n?n:A("common.cancel"),onClick:function(e){e.preventDefault(),N(!1)}})]})]})}))})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var r=n(122),a=n.n(r),o=function(e){return!/^\w+:\/\/\/?\w/i.test(e)},s=function(e){return""!==e},c=function(e){var t=u(e,"][",0);return null!==t&&void 0!==t?t:e},i=function(e){return e.substr(2,e.length-4)},u=function(e,t,n){var r=e.split(t);if(1!==r.length)return n<0?r[r.length+n]:r[n]},l=function(e){return u(e,"->",-1)||u(e,"<-",0)||u(e,"|",-1)||e};function d(e,t){var n=a()(function(e){return e.match(/\[\[.*?\]\]/g)||[]}(e).map(i).map(c).map(l).filter(s));return t&&(n=n.filter(o)),n}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(){return{appTheme:"system",codeEditorFontFamily:"var(--font-monospaced)",codeEditorFontScale:1,dialogWidth:600,disabledStoryFormatEditorExtensions:[],donateShown:!1,editorCursorBlinks:!0,firstRunTime:(new Date).getTime(),lastUpdateSeen:"",lastUpdateCheckTime:(new Date).getTime(),locale:window.navigator.userLanguage||window.navigator.language||window.navigator.browserLanguage||window.navigator.systemLanguage||"en-us",passageEditorFontFamily:"var(--font-system)",passageEditorFontScale:1,proofingFormat:{name:"Paperthin",version:"1.0.0"},storyFormat:{name:"GrowYourOwn",version:"1.0.0"},storyFormatListFilter:"current",storyListSort:"name",storyListTagFilter:[],storyTagColors:{},welcomeSeen:!1}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return s})),n.d(t,"c",(function(){return c}));n(0);var r=n(1),a=function(){return Object(r.jsx)("svg",{viewBox:"0 0 24 24",width:"24",height:"24",stroke:"currentColor",strokeWidth:"2",fill:"none",strokeLinecap:"round",strokeLinejoin:"round"})},o=n(4),s=(n(265),function(){return Object(r.jsx)("span",{className:"icon-loading",children:Object(r.jsx)(o.q,{})})}),c=function(){return Object(r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink",viewBox:"0 0 1200 1200",width:"1200",height:"1200",children:[Object(r.jsxs)("defs",{children:[Object(r.jsxs)("linearGradient",{id:"b",children:[Object(r.jsx)("stop",{offset:"0",stopColor:"#127aee"}),Object(r.jsx)("stop",{offset:"1",stopColor:"#117aef",stopOpacity:".251"})]}),Object(r.jsxs)("linearGradient",{id:"a",children:[Object(r.jsx)("stop",{offset:"0",stopColor:"#10f05e",stopOpacity:".251"}),Object(r.jsx)("stop",{offset:"1",stopColor:"#10f05e"})]}),Object(r.jsx)("linearGradient",{xlinkHref:"#a",id:"d",x1:"52",y1:"604.362",x2:"972",y2:"604.362",gradientUnits:"userSpaceOnUse"}),Object(r.jsx)("linearGradient",{xlinkHref:"#b",id:"c",x1:"256",y1:"0",x2:"231.987",y2:"725.548",gradientUnits:"userSpaceOnUse",gradientTransform:"translate(0 28.362)"})]}),Object(r.jsx)("path",{fill:"url(#c)",d:"M64 28.362h384v1024H64z",transform:"translate(88 59.638)"}),Object(r.jsx)("path",{d:"M64 860.362c0-704 896-704 896-704v384s-512 0-512 320v192H64z",fill:"url(#d)",transform:"translate(88 59.638)"})]})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var r=n(2),a=n(18),o=(n(0),n(234)),s=(n(400),n(401),n(402),n(403),n(404),n(405),n(406),n(407),n(20)),c=n.n(s),i=n(31),u=n(36),l=n.n(u),d=[];function f(e,t){var n=t.prefixes,r=t.callback;function a(e){if(!e.state.completionActive&&n&&r){var t=e.findWordAt(e.getDoc().getCursor());t.anchor.ch--;var a,o=e.findWordAt(t.anchor),s=e.getRange(o.anchor,o.head),c=Object(i.a)(n);try{for(c.s();!(a=c.n()).done;){if(s===a.value)return void r(e)}}catch(u){c.e(u)}finally{c.f()}}}r&&n&&!d.includes(e)?(d.push(e),e.on("inputRead",a)):d.includes(e)&&(e.off("inputRead",a),d=d.filter((function(t){return t!==e})))}var b=!1;var j=n(1);b||(l.a.defineOption("prefixTrigger",[],f),b=!0);var p=function(e){var t=e.fontFamily,n=e.fontScale,s=e.label,i=Object(a.a)(e,["fontFamily","fontScale","label"]),u={};return t&&(u.fontFamily=t.includes(" ")?'"'.concat(t,'"'):t),n&&(u.fontSize="".concat(100*n,"%")),Object(j.jsx)("div",{className:"code-area",style:u,children:Object(j.jsxs)("label",{children:[Object(j.jsx)("span",{className:c()("label",{"screen-reader-only":e.labelHidden}),children:s}),Object(j.jsx)(o.Controlled,Object(r.a)({},i))]})})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(242),a=n(228),o=n(86),s=r.a.createInstance();s.use(a.a).use(o.e).init({debug:!1,backend:{loadPath:"".concat(".","/locales/{{lng}}.json")},fallbackLng:"en-us",interpolation:{escapeValue:!1},load:"currentOnly"})},function(e,t,n){"use strict";n.d(t,"a",(function(){return q}));var r=n(0),a=n(8),o=n.n(a),s=n(12),c=n(56);function i(){return u.apply(this,arguments)}function u(){return(u=Object(s.a)(o.a.mark((function e(){var t,n,r,a,s,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=window,n=t.twineElectron,r={},a=Object.keys(Object(c.a)()),n){e.next=5;break}throw new Error("Electron bridge is not present on window.");case 5:return e.next=7,null===n||void 0===n?void 0:n.ipcRenderer.invoke("load-prefs");case 7:if((s=e.sent)&&"object"===typeof s)for(i in s)a.includes(i)&&(r[i]=s[i]);return e.abrupt("return",r);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function l(e,t){var n=window.twineElectron;if(!n)throw new Error("Electron bridge is not present on window.");n.ipcRenderer.send("save-json",e,t)}function d(e,t){"repair"!==t.type&&"update"!==t.type||l("prefs.json",e)}var f=n(11),b=n(120);function j(){return p.apply(this,arguments)}function p(){return(p=Object(s.a)(o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=window,n=t.twineElectron){e.next=3;break}throw new Error("Electron bridge is not present on window.");case 3:return e.next=5,null===n||void 0===n?void 0:n.ipcRenderer.invoke("load-stories");case 5:if(!(r=e.sent)||!Array.isArray(r)){e.next=10;break}return e.abrupt("return",r.reduce((function(e,t){var n=Object(b.a)(t.htmlSource,t.mtime);return n[0]?[].concat(Object(f.a)(e),[n[0]]):(console.warn("Could not hydrate story: ",t.htmlSource),e)}),[]));case 10:console.warn("No stories to hydrate in Electron bridge");case 11:return e.abrupt("return",[]);case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var m,h=n(3),g=n(35),O=n(43),v=n(10),y=n(41),x=n(74);function w(e,t){return S.apply(this,arguments)}function S(){return(S=Object(s.a)(o.a.mark((function e(t,n){var r,a,s,c,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=window,a=r.twineElectron){e.next=3;break}throw new Error("Electron bridge is not present on window.");case 3:if(e.prev=3,"loaded"!==(s=Object(v.formatWithNameAndVersion)(n,t.storyFormat,t.storyFormatVersion)).loadState){e.next=9;break}a.ipcRenderer.send("save-story-html",t,Object(O.d)(t,s.properties.source,Object(y.a)(),{startOptional:!0})),e.next=14;break;case 9:return e.next=11,Object(x.a)(s.url);case 11:c=e.sent,i=c.source,a.ipcRenderer.send("save-story-html",t,Object(O.d)(t,i,Object(y.a)(),{startOptional:!0}));case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(3),console.warn("Could not save full story (".concat(e.t0.message,"). Trying to save story data only.")),a.ipcRenderer.send("save-story-html",t,Object(O.c)(t,Object(y.a)(),{startOptional:!0}));case 20:case"end":return e.stop()}}),e,null,[[3,16]])})))).apply(this,arguments)}function C(e,t,n){var r=window.twineElectron;if(!r)throw new Error("Electron bridge is not present on window.");switch(t.type){case"init":case"repair":break;case"createStory":if(!t.props.name)throw new Error("Passage was created but with no name specified");w(Object(h.storyWithName)(e,t.props.name),n);break;case"deleteStory":r.ipcRenderer.send("delete-story",Object(h.storyWithId)(m,t.storyId));break;case"updateStory":if(Object(g.b)(t.props))if(t.props.name){var a=Object(h.storyWithId)(m,t.storyId),o=Object(h.storyWithId)(e,t.storyId);r.ipcRenderer.once("story-renamed",(function(){return w(o,n)})),r.ipcRenderer.send("rename-story",a,o)}else w(Object(h.storyWithId)(e,t.storyId),n);break;case"createPassage":case"createPassages":case"deletePassage":case"deletePassages":w(Object(h.storyWithId)(e,t.storyId),n);break;case"updatePassage":Object(g.a)(t.props)&&w(Object(h.storyWithId)(e,t.storyId),n);break;case"updatePassages":Object.keys(t.passageUpdates).some((function(e){return Object(g.a)(t.passageUpdates[e])}))&&w(Object(h.storyWithId)(e,t.storyId),n);break;default:console.warn("Story action ".concat(t.type," has no Electron persistence handler"))}m=Object(f.a)(e)}var k=n(19),F=n.n(k);function E(){return I.apply(this,arguments)}function I(){return(I=Object(s.a)(o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=window,n=t.twineElectron){e.next=3;break}throw new Error("Electron bridge is not present on window.");case 3:return e.next=5,null===n||void 0===n?void 0:n.ipcRenderer.invoke("load-story-formats");case 5:if((r=e.sent)&&Array.isArray(r)){e.next=8;break}return e.abrupt("return",[]);case 8:return e.abrupt("return",r.map((function(e){return{id:F()(),loadState:"unloaded",name:e.name,selected:!1,version:e.version,url:e.url,userAdded:e.userAdded}})));case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function N(e,t){("create"===t.type||"delete"===t.type||"repair"===t.type||"update"===t.type&&Object(g.c)(t.props))&&l("story-formats.json",e.map((function(e){return{id:e.id,name:e.name,selected:void 0,version:e.version,url:e.url,userAdded:e.userAdded}})))}function P(){return T.apply(this,arguments)}function T(){return(T=Object(s.a)(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=window.localStorage.getItem("twine-prefs"),n={},t){e.next=4;break}return e.abrupt("return",{});case 4:return t.split(",").forEach((function(e){try{var t=window.localStorage.getItem("twine-prefs-".concat(e));if(!t)return void console.warn("No preference stored at twine-prefs-".concat(e));var r=JSON.parse(t);n[r.name]=r.value}catch(a){console.warn("Preference ".concat(e," had corrupt serialized value, skipping"),window.localStorage.getItem("twine-prefs-".concat(e)),a)}})),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function D(e,t){"repair"!==t.type&&"update"!==t.type||function(e){var t=window.localStorage.getItem("twine-prefs");t&&t.split(",").forEach((function(e){window.localStorage.removeItem("twine-prefs-".concat(e))}));var n=[];for(var r in e){var a=F()();n.push(a),window.localStorage.setItem("twine-prefs-".concat(a),JSON.stringify({id:a,name:r,value:e[r]}))}window.localStorage.setItem("twine-prefs",n.join(","))}(e)}var L,A=n(2),M=n(27);function z(){return R.apply(this,arguments)}function R(){return(R=Object(s.a)(o.a.mark((function e(){var t,n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t={},n=window.localStorage.getItem("twine-stories")){e.next=4;break}return e.abrupt("return",[]);case 4:return n.split(",").forEach((function(e){var n=window.localStorage.getItem("twine-stories-".concat(e));if(n)try{var r=JSON.parse(n);if(!r.id)return void console.warn("Story in local storage had no ID, skipping",r);t[r.id]=Object(A.a)(Object(A.a)(Object(A.a)({},Object(M.b)()),r),{},{lastUpdate:r.lastUpdate?new Date(Date.parse(r.lastUpdate)):new Date,passages:[]})}catch(a){console.warn("Could not parse story as JSON, skipping: ".concat(n))}else console.warn("Story list contained ID ".concat(e,", but twine-stories-").concat(e," does not exist, skipping"))})),(r=window.localStorage.getItem("twine-passages"))&&r.split(",").forEach((function(e){var n=window.localStorage.getItem("twine-passages-".concat(e));if(n)try{var r=JSON.parse(n);if(!r||!r.story)return void console.warn("Passage ".concat(e," did not have parent story ID, skipping"),r);if(!t[r.story])return void console.warn("Passage ".concat(e," is orphaned (looking for story ID ").concat(r.story,"), skipping"));t[r.story].passages.push(Object(A.a)(Object(A.a)(Object(A.a)({},M.a),r),{},{tags:r.tags?r.tags.filter((function(e){return""!==e.trim()})):[]}))}catch(a){console.warn("Could not parse passage as JSON, skipping: ".concat(n))}else console.warn("Passage list contained ID ".concat(e,", but twine-passages-").concat(e," does not exist, skipping"))})),e.abrupt("return",Object.values(t));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function W(e,t){return""===e?t:function(e,t){return new RegExp("\\b"+t+"\\b").test(e)}(e,t)?e:e+","+t}function U(e,t){return","===(e=e.replace(new RegExp(",?"+t),""))[0]?e.substring(1):e}function B(e){var t,n,r={passageIds:null!==(t=window.localStorage.getItem("twine-passages"))&&void 0!==t?t:"",storyIds:null!==(n=window.localStorage.getItem("twine-stories"))&&void 0!==n?n:""};e(r),window.localStorage.setItem("twine-stories",r.storyIds),window.localStorage.setItem("twine-passages",r.passageIds)}function V(e,t){if(!t.id)throw new Error("Story has no ID");e.storyIds=W(e.storyIds,t.id),window.localStorage.setItem("twine-stories-".concat(t.id),JSON.stringify(Object(A.a)(Object(A.a)({},t),{},{passages:void 0})))}function H(e,t){if(!t.id)throw new Error("Passage has no ID");e.passageIds=W(e.passageIds,t.id),window.localStorage.setItem("twine-passages-".concat(t.id),JSON.stringify(t))}function Y(e,t){e.passageIds=U(e.passageIds,t),window.localStorage.removeItem("twine-passages-".concat(t))}function J(e,t){switch(t.type){case"init":case"repair":break;case"createPassage":if(!t.props.name)throw new Error("Passage was created but with no name specified");var n=Object(h.storyWithId)(e,t.storyId),r=Object(h.passageWithName)(e,n.id,t.props.name);B((function(e){V(e,n),H(e,r)}));break;case"createPassages":var a=Object(h.storyWithId)(e,t.storyId);B((function(n){V(n,a),t.props.forEach((function(t){if(!t.name)throw new Error("Passage was created but with no name specified");H(n,Object(h.passageWithName)(e,a.id,t.name))}))}));break;case"createStory":if(!t.props.name)throw new Error("Story was created but with no name specified");var o=Object(h.storyWithName)(e,t.props.name);B((function(e){V(e,o),o.passages.forEach((function(t){return H(e,t)}))}));break;case"deletePassage":var s=Object(h.storyWithId)(e,t.storyId);B((function(e){V(e,s),Y(e,t.passageId)}));break;case"deletePassages":var c=Object(h.storyWithId)(e,t.storyId);B((function(e){V(e,c),t.passageIds.forEach((function(t){return Y(e,t)}))}));break;case"deleteStory":var i=Object(h.storyWithId)(L,t.storyId);B((function(e){i.passages.forEach((function(t){return Y(e,t.id)})),function(e,t){if(!t.id)throw new Error("Story has no ID");e.storyIds=U(e.storyIds,t.id),window.localStorage.removeItem("twine-stories-".concat(t.id))}(e,i)}));break;case"updatePassage":if(Object(g.a)(t.props)){var u=Object(h.storyWithId)(e,t.storyId),l=Object(h.passageWithId)(e,t.storyId,t.passageId);B((function(e){V(e,u),H(e,l)}));break}break;case"updatePassages":var d=Object(h.storyWithId)(e,t.storyId);B((function(n){V(n,d),Object.keys(t.passageUpdates).filter((function(e){return Object(g.a)(t.passageUpdates[e])})).forEach((function(r){return H(n,Object(h.passageWithId)(e,t.storyId,r))}))}));break;case"updateStory":var f=Object(h.storyWithId)(e,t.storyId);B((function(e){V(e,f),f.passages.forEach((function(t){return H(e,t)}))}));break;default:console.warn("Story action ".concat(t.type," has no local storage persistence handler"))}L=e}function X(){return _.apply(this,arguments)}function _(){return(_=Object(s.a)(o.a.mark((function e(){var t,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=[],n=window.localStorage.getItem("twine-storyformats")){e.next=4;break}return e.abrupt("return",[]);case 4:return n.split(",").forEach((function(e){try{var n=window.localStorage.getItem("twine-storyformats-".concat(e));if(!n)return void console.warn("No story format stored at twine-storyformats-".concat(e,", skipping"));t.push(Object(A.a)(Object(A.a)({},JSON.parse(n)),{},{loadState:"unloaded"}))}catch(r){console.warn("Story format ".concat(e," had corrupt serialized value, skipping"),window.localStorage.getItem("twine-storyformats-".concat(e)))}})),e.abrupt("return",t);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(e){var t=window.localStorage.getItem("twine-storyformats");t&&t.split(",").forEach((function(e){window.localStorage.removeItem("twine-storyformats-".concat(e))}));var n=[];e.forEach((function(e){var t=F()();n.push(t),window.localStorage.setItem("twine-storyformats-".concat(t),JSON.stringify(Object(A.a)(Object(A.a)({},e),{},{loadError:void 0,loadState:void 0,properties:void 0,selected:void 0})))})),window.localStorage.setItem("twine-storyformats",n.join(","))}function K(e,t){switch(t.type){case"create":case"delete":case"repair":G(e);break;case"update":Object(g.c)(t.props)&&G(e)}}var $=n(30);function q(){var e=r.useMemo((function(){return{prefs:{load:i,saveMiddleware:d},stories:{load:j,saveMiddleware:C},storyFormats:{load:E,saveMiddleware:N}}}),[]),t=r.useMemo((function(){return{prefs:{load:P,saveMiddleware:D},stories:{load:z,saveMiddleware:J},storyFormats:{load:X,saveMiddleware:K}}}),[]);return r.useMemo((function(){return Object($.a)()?e:t}),[e,t])}},function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return y}));var r=n(11),a=n(5),o=n(0),s=n(49),c=n(84),i=n(4),u=n(13),l=n(16),d=n(47),f=n(6),b=n(67),j=n(38),p=n(46),m=(n(411),n(1)),h=function(e){var t=e.assignedTags,n=e.disabled,h=e.existingTags,g=e.icon,O=e.label,v=e.onAdd,y=o.useState(!0),x=Object(a.a)(y,2),w=x[0],S=x[1],C=o.useState("none"),k=Object(a.a)(C,2),F=k[0],E=k[1],I=o.useState(""),N=Object(a.a)(I,2),P=N[0],T=N[1],D=o.useState(!1),L=Object(a.a)(D,2),A=L[0],M=L[1],z=Object(s.a)().t,R=void 0,W=Object(p.a)(P);return W||""===P||(R=z("components.addTagButton.invalidName")),W&&w&&((W=!h.includes(P))||(R=z("components.addTagButton.alreadyAdded"))),Object(m.jsx)("span",{className:"add-tag-button",children:Object(m.jsxs)(d.a,{ariaLabel:z("components.addTagButton.addLabel"),disabled:n,icon:null!==g&&void 0!==g?g:Object(m.jsx)(i.L,{}),label:null!==O&&void 0!==O?O:z("common.tag"),onChangeOpen:M,open:A,children:[Object(m.jsxs)(l.b,{children:[Object(m.jsx)(j.a,{onChange:function(e){var t=e.target.value;T(t),S(""===t)},options:[{label:z("components.addTagButton.newTag"),value:""}].concat(Object(r.a)(h.map((function(e){return{disabled:t.includes(e),label:e,value:e}})))),value:w?"":P,children:z("components.addTagButton.addLabel")}),w&&Object(m.jsxs)(m.Fragment,{children:[Object(m.jsx)(b.a,{onChange:function(e){return T(e.target.value.replace(/\s/g,"-"))},value:P,children:z("components.addTagButton.tagNameLabel")}),Object(m.jsx)(j.a,{onChange:function(e){return E(e.target.value)},options:c.a.map((function(e){return{label:z("colors.".concat(e)),value:e}})),value:F,children:z("components.addTagButton.tagColorLabel")})]}),w&&!!R&&Object(m.jsx)("p",{children:R})]}),Object(m.jsxs)(u.a,{children:[Object(m.jsx)(f.a,{disabled:!W,icon:Object(m.jsx)(i.L,{}),label:z("common.add"),onClick:function(){w?v(P,F):v(P),M(!1)},variant:"create"}),Object(m.jsx)(f.a,{icon:Object(m.jsx)(i.ab,{}),label:z("common.cancel"),onClick:function(){return M(!1)}})]})]})})},g=n(20),O=n.n(g),v=n(51),y=(n(412),function(e){var t=Object(s.a)().t;return Object(m.jsx)("span",{className:O()("tag-button","color-".concat(e.color)),children:Object(m.jsx)(v.a,{icon:Object(m.jsx)(i.o,{}),iconPosition:"end",items:[].concat(Object(r.a)(c.a.map((function(n){return{checkable:!0,checked:"none"===n?!e.color:n===e.color,label:t("colors.".concat(n)),onClick:function(){return e.onChangeColor(n)}}}))),[{separator:!0},{label:t("common.remove"),onClick:e.onRemove}]),label:e.name})})});n(117)},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));n(0);var r=n(20),a=n.n(r),o=(n(167),n(1)),s=function(e){var t=e.href,n=e.icon,r=e.label,s=e.target,c=e.variant,i=a()("icon-link","variant-".concat(c));return Object(o.jsxs)("a",{href:t,className:i,target:null!==s&&void 0!==s?s:"_blank",children:[Object(o.jsx)("span",{className:"icon",children:n}),r]})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return l}));var r=n(0),a=n(49),o=n(4),s=n(6),c=n(1),i=function(e){var t=e.editor,n=Object(a.a)().t;function r(e){null===t||void 0===t||t.execCommand(e),null===t||void 0===t||t.focus()}return Object(c.jsxs)(c.Fragment,{children:[Object(c.jsx)(s.a,{disabled:!t,icon:Object(c.jsx)(o.E,{}),label:n("components.indentButtons.indent"),onClick:function(){return r("indentMore")}}),Object(c.jsx)(s.a,{disabled:!t,icon:Object(c.jsx)(o.D,{}),label:n("components.indentButtons.unindent"),onClick:function(){return r("indentLess")}})]})},u=n(5),l=function(e){var t=e.editor,n=e.watch,i=Object(a.a)().t,l=r.useState(!1),d=Object(u.a)(l,2),f=d[0],b=d[1],j=r.useState(!1),p=Object(u.a)(j,2),m=p[0],h=p[1];function g(e){null===t||void 0===t||t.execCommand(e),null===t||void 0===t||t.focus()}return r.useEffect((function(){if(t){var e=t.historySize();b(e.redo>0),h(e.undo>0)}else b(!1),h(!1)}),[t,n]),Object(c.jsxs)(c.Fragment,{children:[Object(c.jsx)(s.a,{disabled:!m,icon:Object(c.jsx)(o.c,{}),label:i("common.undo"),onClick:function(){return g("undo")}}),Object(c.jsx)(s.a,{disabled:!f,icon:Object(c.jsx)(o.e,{}),label:i("common.redo"),onClick:function(){return g("redo")}})]})}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(20),a=n.n(r),o=(n(0),n(368),n(1)),s=function(e){var t,n=a()("text-input","orientation-".concat(e.orientation),"type-".concat(e.type));return Object(o.jsx)("span",{className:n,children:Object(o.jsxs)("label",{children:[Object(o.jsx)("span",{className:"text-input-label",children:e.children}),Object(o.jsx)("input",{onChange:e.onChange,onInput:e.onInput,placeholder:e.placeholder,type:null!==(t=e.type)&&void 0!==t?t:"text",value:e.value})]})})}},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));n(0);var r=n(20),a=n.n(r),o=(n(256),n(1)),s=function(e){var t=e.children,n=e.floating,r=e.highlighted,s=a()("card",{floating:n,highlighted:r});return Object(o.jsx)("div",{className:s,children:t})}},function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return u})),n.d(t,"a",(function(){return l})),n.d(t,"d",(function(){return d})),n.d(t,"e",(function(){return f})),n.d(t,"f",(function(){return b})),n.d(t,"g",(function(){return j})),n.d(t,"h",(function(){return p})),n.d(t,"i",(function(){return m}));var r=n(11),a=n(122),o=n.n(a),s=n(93),c=n(53);function i(e,t,n){var r=p(e,t).passages.find((function(e){return e.id===n}));if(r)return r;throw new Error('There is no passage with ID "'.concat(n,'" in a story with ID "').concat(t,'".'))}function u(e,t,n){var r=p(e,t).passages.find((function(e){return e.name===n}));if(r)return r;throw new Error('There is no passage with name "'.concat(n,'" in a story with ID "').concat(t,'".'))}function l(e,t){var n=null!==t&&void 0!==t?t:function(e){return Object(c.a)(e,!0)},r=new Map(e.map((function(e){return[e.name,e]}))),a={draggable:{broken:new Set,connections:new Map,self:new Set},fixed:{broken:new Set,connections:new Map,self:new Set}};return e.forEach((function(e){return n(e.text).forEach((function(t){if(t===e.name)(e.selected?a.draggable:a.fixed).self.add(e);else{var n=r.get(t);if(n){var o=e.selected||n.selected?a.draggable:a.fixed;o.connections.has(e)?o.connections.get(e).add(n):o.connections.set(e,new Set([n]))}else(e.selected?a.draggable:a.fixed).broken.add(e)}}))})),a}function d(e,t,n){if(""===t)return[];var a,o=n.includePassageNames,c=n.matchCase,i=n.useRegexes;try{a=Object(s.a)(t,{matchCase:c,useRegexes:i})}catch(u){return[]}return e.reduce((function(e,t){return a.test(t.text)||o&&a.test(t.name)?[].concat(Object(r.a)(e),[t]):e}),[])}function f(e){return Array.from(e.passages.reduce((function(e,t){return t.tags&&t.tags.forEach((function(t){return e.add(t)})),e}),new Set)).sort()}function b(e){var t=e.passages.reduce((function(e,t){return[].concat(Object(r.a)(e),Object(r.a)(Object(c.a)(t.text).filter((function(t){return-1===e.indexOf(t)}))))}),[]);return{brokenLinks:o()(t).filter((function(t){return!e.passages.some((function(e){return e.name===t}))})),links:t,characters:e.passages.reduce((function(e,t){return e+t.text.length}),0),passages:e.passages.length,words:e.passages.reduce((function(e,t){return e+t.text.split(/\s+/).length}),0)}}function j(e){return Array.from(e.reduce((function(e,t){return t.tags&&t.tags.forEach((function(t){return e.add(t)})),e}),new Set)).sort()}function p(e,t){var n=e.find((function(e){return e.id===t}));if(n)return n;throw new Error('There is no story with ID "'.concat(t,'".'))}function m(e,t){var n=e.find((function(e){return e.name===t}));if(n)return n;throw new Error('There is no story with name "'.concat(t,'".'))}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var r=n(8),a=n.n(r),o=n(12),s=n(230),c=n.n(s),i=n(30),u=Promise.resolve();function l(e){return d.apply(this,arguments)}function d(){return d=Object(o.a)(a.a.mark((function e(t){var n,r,o,s,l=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=l.length>1&&void 0!==l[1]?l[1]:2e3,r=window,o=r.twineElectron,s=Object(i.a)()&&(null===o||void 0===o?void 0:o.jsonp)?o.jsonp:c.a,e.abrupt("return",new Promise((function(e,r){return u=u.then((function(){return new Promise((function(a){s(t,{timeout:n,name:"storyFormat"},(function(t,n){t?r(t):e(n),a()}))}))}))})));case 4:case"end":return e.stop()}}),e)}))),d.apply(this,arguments)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(){return[{name:"GrowYourOwn",url:"story-formats/growyourown-1.0.0/format.js",version:"1.0.0"},{name:"Chapbook",url:"story-formats/chapbook-1.2.2/format.js",version:"1.2.2"},{name:"Harlowe",url:"story-formats/harlowe-1.2.4/format.js",version:"1.2.4"},{name:"Harlowe",url:"story-formats/harlowe-2.1.0/format.js",version:"2.1.0"},{name:"Harlowe",url:"story-formats/harlowe-3.3.3/format.js",version:"3.3.3"},{name:"Paperthin",url:"story-formats/paperthin-1.0.0/format.js",version:"1.0.0"},{name:"Snowman",url:"story-formats/snowman-1.4.0/format.js",version:"1.4.0"},{name:"Snowman",url:"story-formats/snowman-2.0.2/format.js",version:"2.0.2",userAdded:!1},{name:"SugarCube",url:"story-formats/sugarcube-1.0.35/format.js",version:"1.0.35"},{name:"SugarCube",url:"story-formats/sugarcube-2.36.1/format.js",version:"2.36.1"}]}},,,function(e,t,n){"use strict";function r(e,t){if(t.includes(e)){for(var n=1;t.includes("".concat(e," ").concat(n));)n++;return"".concat(e," ").concat(n)}return e}n.d(t,"a",(function(){return r}))},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(49),a=n(30);function o(){var e=Object(r.a)("",{useSuspense:!1}),t=e.t,n=e.ready;return{reportError:function(e,r){console.error("Twine store error",e),n?window.alert(t(r,{error:e.message})+" "+t("store.errors.".concat(Object(a.a)()?"electron":"web","Remediation"))):window.alert("An error occurred while saving (".concat(e.message,"). Reloading or restarting the application may help."))}}}},function(e){e.exports=JSON.parse('{"a":"2.5.1"}')},function(e,t,n){"use strict";function r(e){var t={extraKeys:{Insert:function(){}}};return e.editorCursorBlinks||(t.cursorBlinkRate=0),t}n.d(t,"a",(function(){return r}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=["none","red","orange","yellow","green","blue","purple"]},,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return s}));var r=n(123),a=n.n(r);function o(e,t){return new RegExp(t.useRegexes?e:a()(e),t.matchCase?"g":"gi")}function s(e){return e.replace(/\$/g,"$$$$")}},,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var r=n(2),a=(n(0),n(126)),o=n(165),s=n(510),c=n(118),i=n(7),u=(n(398),n(1)),l=function(e){return Object(u.jsx)(o.a,Object(r.a)(Object(r.a)({classNames:"pop",timeout:200},e),{},{children:e.children}))},d=function(){var e=Object(a.useScrollbarSize)(),t=e.height,n=e.width,o=Object(i.usePrefsContext)().prefs,d=Object(c.b)(),f=d.dispatch,b=d.dialogs,j=b.some((function(e){return!e.maximized})),p={paddingLeft:"calc(100% - (".concat(o.dialogWidth,"px + 2 * (var(--grid-size))))"),marginBottom:t,marginRight:n},m={marginRight:j?"calc(".concat(o.dialogWidth,"px + var(--grid-size))"):0};return Object(u.jsx)("div",{className:"dialogs",style:p,children:Object(u.jsx)(s.a,{component:null,children:b.map((function(e,t){var n={collapsed:e.collapsed,maximized:e.maximized,onChangeCollapsed:function(e){return f({type:"setDialogCollapsed",collapsed:e,index:t})},onChangeMaximized:function(e){return f({type:"setDialogMaximized",maximized:e,index:t})},onClose:function(){return f({type:"removeDialog",index:t})}};return Object(u.jsx)(l,{children:e.maximized?Object(u.jsx)("div",{className:"maximized",style:m,children:Object(u.jsx)(e.component,Object(r.a)(Object(r.a)({},e.props),n))}):Object(u.jsx)(e.component,Object(r.a)(Object(r.a)({},e.props),n))},t)}))})})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(0),a=(n(413),n(1)),o=r.memo((function(e){return Object(a.jsx)("div",{className:"tag-stripe",children:e.tags.map((function(t){return Object(a.jsx)("span",{className:"color-".concat(e.tagColors[t]),title:t},t)}))})}));o.displayName="TagStripe"},function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"a",(function(){return m}));var r=n(5),a=n(0),o=n(79),s=n.n(o),c=n(11),i=n(2),u=n(233),l=n.n(u),d=function(e,t){switch(t.type){case"addDialog":var n=!1,r=e.map((function(e){return l()(e,{collapsed:e.collapsed,component:t.component,maximized:e.maximized,props:t.props})?(n=!0,Object(i.a)(Object(i.a)({},e),{},{collapsed:!1})):e}));return n?r:[].concat(Object(c.a)(e),[{collapsed:!1,component:t.component,maximized:!1,props:t.props}]);case"removeDialog":return e.filter((function(e,n){return n!==t.index}));case"setDialogCollapsed":return e.map((function(e,n){return n===t.index?Object(i.a)(Object(i.a)({},e),{},{collapsed:t.collapsed}):e}));case"setDialogMaximized":return e.map((function(e,n){return Object(i.a)(Object(i.a)({},e),{},{maximized:n===t.index&&t.maximized})}))}},f=n(116),b=n(1),j=a.createContext({dispatch:function(){},dialogs:[]});j.displayName="Dialogs";var p=function(){return a.useContext(j)},m=function(e){var t=s()(d,[]),n=Object(r.a)(t,2),a=n[0],o=n[1];return Object(b.jsxs)(j.Provider,{value:{dispatch:o,dialogs:a},children:[e.children,Object(b.jsx)(f.a,{})]})}},,function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var r=n(14),a=n(2),o=n(160),s=n.n(o),c=n(19),i=n.n(c),u=n(3),l="[role=script]",d="[role=stylesheet]",f="tw-storydata",b="tw-tag",j="tw-passagedata";function p(e){return parseFloat(e)}function m(e,t){return Array.from(e.querySelectorAll(t))}function h(e){if("string"===typeof e){var t=e.split(",");return 2===t.length?[t[0],t[1]]:void 0}}function g(e,t){var n=document.createElement("div");return n.innerHTML=e,m(n,f).map((function(e){var n=function(e){var t,n,o,s,c,u=e.getAttribute("startnode"),f=void 0,g={ifid:null!==(t=e.getAttribute("ifid"))&&void 0!==t?t:i()(),id:i()(),lastUpdate:void 0,name:null!==(n=e.getAttribute("name"))&&void 0!==n?n:void 0,storyFormat:null!==(o=e.getAttribute("format"))&&void 0!==o?o:void 0,storyFormatVersion:null!==(s=e.getAttribute("format-version"))&&void 0!==s?s:void 0,script:m(e,l).map((function(e){return e.textContent})).join("\n"),stylesheet:m(e,d).map((function(e){return e.textContent})).join("\n"),tags:e.getAttribute("tags")?e.getAttribute("tags").split(/\s+/):[],zoom:parseFloat(null!==(c=e.getAttribute("zoom"))&&void 0!==c?c:"1"),tagColors:m(e,b).reduce((function(e,t){var n=t.getAttribute("name");return"string"!==typeof n?e:Object(a.a)(Object(a.a)({},e),{},Object(r.a)({},n,t.getAttribute("color")))}),{}),passages:m(e,j).map((function(e){var t,n,r=i()(),a=h(e.getAttribute("position")),o=h(e.getAttribute("size"));return e.getAttribute("pid")===u&&(f=r),{id:r,left:a?p(a[0]):void 0,top:a?p(a[1]):void 0,width:o?p(o[0]):void 0,height:o?p(o[1]):void 0,tags:e.getAttribute("tags")?e.getAttribute("tags").split(/\s+/):[],name:null!==(t=e.getAttribute("name"))&&void 0!==t?t:void 0,text:null!==(n=e.textContent)&&void 0!==n?n:void 0}}))};return g.startPassage=f,g}(e),o=s()(n,{id:i()()},Object(u.storyDefaults)());return t&&(o.lastUpdate=t),o.passages=o.passages.map((function(e){return s()(e,Object(u.passageDefaults)(),{story:o.id})})),o}))}},,,,,,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(2),a=(n(0),n(71)),o=(n(408),n(1)),s=function(e){return Object(o.jsx)("div",{className:"button-card",children:Object(o.jsx)(a.a,Object(r.a)({},e))})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var r=n(2),a=n(5),o=n(0),s=n(49),c=n(4),i=n(52),u=n(6),l=n(1),d=function(){var e=Object(s.a)().t;return Object(l.jsx)(u.a,{disabled:!0,icon:Object(l.jsx)(c.Z,{}),label:e("common.rename")})},f=function(e){var t=e.onRename,n=e.passage,r=e.story,u=o.useState(n.name),d=Object(a.a)(u,2),f=d[0],b=d[1],j=Object(s.a)().t;return Object(l.jsx)(i.a,{icon:Object(l.jsx)(c.Z,{}),label:j("common.rename"),onChange:function(e){return b(e.target.value)},onSubmit:t,prompt:j("common.renamePrompt",{name:n.name}),validate:function(e){return""===e.trim()?{message:j("components.renamePassageButton.emptyName"),valid:!1}:r.passages.some((function(t){return t.id!==n.id&&t.name===e}))?{message:j("components.renamePassageButton.nameAlreadyUsed"),valid:!1}:{valid:!0}},value:f})},b=function(e){return e.passage?Object(l.jsx)(f,Object(r.a)({},e)):Object(l.jsx)(d,{})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(5),a=n(0),o=n(7);function s(){var e=Object(o.usePrefsContext)().prefs,t=a.useState(window.matchMedia("(prefers-color-scheme: dark)")),n=Object(r.a)(t,1)[0],s=a.useState(n.matches?"dark":"light"),c=Object(r.a)(s,2),i=c[0],u=c[1];return a.useEffect((function(){var e=function(e){return u(e.matches?"dark":"light")};return n.addEventListener("change",e),function(){return n.removeEventListener("change",e)}}),[n]),"system"===e.appTheme?i:e.appTheme}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var r=n(5),a=n(0),o=n(49),s=n(20),c=n.n(s),i=n(4),u=n(84),l=n(52),d=n(38),f=(n(415),n(1)),b=function(e){var t=e.allTags,n=e.color,s=e.name,b=e.onChangeColor,j=e.onChangeName,p=a.useState(s),m=Object(r.a)(p,2),h=m[0],g=m[1],O=Object(o.a)().t;return Object(f.jsxs)("div",{className:"tag-editor",children:[Object(f.jsx)("span",{className:c()("tag-name","color-".concat(e.color)),children:e.name}),Object(f.jsx)(l.a,{icon:Object(f.jsx)(i.Z,{}),label:O("common.rename"),onChange:function(e){return g(e.target.value.replace(/\s/g,"-"))},onSubmit:function(){return j(h)},prompt:O("common.renamePrompt",{name:s}),value:h,validate:function(e){return e!==s&&t.includes(e)?{message:O("components.tagEditor.alreadyExists"),valid:!1}:{valid:!0}}}),Object(f.jsx)(d.a,{onChange:function(e){return b(e.target.value)},options:u.a.map((function(e){return{label:O("colors.".concat(e)),value:e}})),value:null!==n&&void 0!==n?n:"",children:O("common.color")})]})}},,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u}));var r=n(11),a=n(5),o=n(0),s=(n(420),n(1)),c=function(e){var t=e.children,n=e.domId,r=e.percent;return Object(s.jsxs)("div",{className:"meter",id:n,role:"meter","aria-labelledby":"".concat(n,"-label"),"aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":100*r,children:[Object(s.jsx)("div",{className:"meter-bar",children:Object(s.jsx)("span",{className:"filled",style:{width:100*r+"%"}})}),Object(s.jsx)("div",{className:"meter-label",id:"".concat(n,"-label"),children:t})]})},i=n(10),u=function(e){var t=e.block,n=e.children,u=o.useState([]),l=Object(a.a)(u,2),d=l[0],f=l[1],b=Object(i.useStoryFormatsContext)(),j=b.dispatch,p=b.formats;o.useEffect((function(){var e=p.filter((function(e){return!d.find((function(t){return t.name===e.name&&t.version===e.version}))}));e.length>0&&(j(Object(i.loadAllFormatProperties)(e)),f([].concat(Object(r.a)(d),Object(r.a)(e))))}),[j,p,d]);var m=p.find((function(e){return"loading"===e.loadState})),h=p.filter((function(e){return"loaded"===e.loadState})).length/p.length;return t&&h<1?Object(s.jsx)(c,{domId:"story-format-loader",percent:h,children:m&&Object(s.jsxs)(s.Fragment,{children:["Loading ",m.name," ",m.version]})}):Object(s.jsx)(s.Fragment,{children:n})}},,,,,,,,,,,,,,,,,,,,,,,,,,,function(e){e.exports=JSON.parse('{"code":["Chris Klimas","Leon Arnott","Ingrid Cheung","Daithi O Crualaoich","Thomas Michael Edwards","Micah Fitch","Juhana Leinonen","Michael Savich","Ross Smith"],"localizations":["David Marchand (Castellano)","Jordi Mallach (catal\xe0)","Svatopluk V\xedt (\u010ce\u0161tina)","Kristian Torgard (Dansk)","Julian Brehmer, Moritz Rebbert (Deutsch)","Valentin Rocher (Fran\xe7ais)","Marco Secchi (Italiano)","Stefan Peeters (Nederlands)","Jos\xe9 Carlos Dias (Portugu\xeas)","Alliah (Portugu\xeas Brasileiro)","Anton Zhuchkov (\u0420\u0443\u0441\u0441\u043a\u0438\u0439)","Mika Letonsaari (Suomi)","D\xe9sir\xe9e Nordlund (Svenska)","H. Utku Maden (T\xfcrk\xe7e)","Shitake & SEN1 (Chinese)"]}')},,,,,,function(e,t,n){},function(e,t,n){"use strict";function r(e,t){return{type:"update",name:e,value:t}}n.d(t,"a",(function(){return r}))},function(e,t,n){"use strict";function r(e,t,n){return e.disabledStoryFormatEditorExtensions.some((function(e){return e.name===t&&e.version===n}))}n.d(t,"a",(function(){return r}))},,,,,,,,,,,,,,,function(e,t){},function(e,t,n){"use strict";function r(e){return e.name.replace(/[^\w. -]/g,"_")+".html"}n.d(t,"a",(function(){return r}))},,,,function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return f})),n.d(t,"e",(function(){return p})),n.d(t,"f",(function(){return m})),n.d(t,"g",(function(){return h}));var r=n(2),a=n(8),o=n.n(a),s=n(12),c=n(31),i=n(74);function u(e,t){if(!t.name||!t.version)throw new Error("Missing required properties for a new story format");return{type:"create",props:{url:e,name:t.name,selected:!1,userAdded:!0,version:t.version}}}function l(e){return{type:"delete",id:e.id}}function d(){return function(e,t){var n,r=Object(c.a)(t());try{for(r.s();!(n=r.n()).done;){var a=n.value;a.selected&&e({type:"update",id:a.id,props:{selected:!1}})}}catch(o){r.e(o)}finally{r.f()}}}function f(e){return{type:"update",id:e.id,props:{selected:!1}}}function b(e,t){return j.apply(this,arguments)}function j(){return(j=Object(s.a)(o.a.mark((function e(t,n){var a,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n({type:"update",id:t.id,props:{loadState:"loading"}}),e.prev=1,e.next=4,Object(i.a)(t.url);case 4:if((a=e.sent).hydrate)try{s={},new Function(a.hydrate).call(s),a=Object(r.a)(Object(r.a)({},s),a)}catch(o){console.error("Format ".concat(t.id," has a hydrate property but it threw an error when called"),o)}return n({type:"update",id:t.id,props:{properties:a,loadState:"loaded"}}),e.abrupt("return",a);case 10:e.prev=10,e.t0=e.catch(1),n({type:"update",id:t.id,props:{loadError:e.t0,loadState:"error"}});case 13:case"end":return e.stop()}}),e,null,[[1,10]])})))).apply(this,arguments)}function p(e){var t=e.filter((function(e){return"loaded"!==e.loadState&&"loading"!==e.loadState}));return t?function(){var e=Object(s.a)(o.a.mark((function e(n){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.allSettled(t.map((function(e){return b(e,n)})));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}():function(){}}function m(e){return"loaded"===e.loadState?function(){return e.properties}:function(){var t=Object(s.a)(o.a.mark((function t(n){return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,b(e,n);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}function h(e,t){return function(n,r){if(e.selected||n({type:"update",id:e.id,props:{selected:!0}}),t){var a,o=Object(c.a)(r());try{for(o.s();!(a=o.n()).done;){var s=a.value;s.id!==e.id&&s.selected&&n({type:"update",id:s.id,props:{selected:!1}})}}catch(i){o.e(i)}finally{o.f()}}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return d})),n.d(t,"c",(function(){return f})),n.d(t,"d",(function(){return b})),n.d(t,"e",(function(){return j})),n.d(t,"f",(function(){return p}));var r=n(14),a=n(2),o=n(231),s=n.n(o),c=n(73),i=n.n(c),u=n(80);function l(e,t){switch(t){case"all":return e;case"current":return Object.values(e.reduce((function(e,t){return!e[t.name]||i()(e[t.name].version,t.version)?Object(a.a)(Object(a.a)({},e),{},Object(r.a)({},t.name,t)):e}),{}));case"user":return e.filter((function(e){return e.userAdded}))}}function d(e){if("loaded"!==e.loadState||!e.properties.image)throw new Error("Format has no image property");return s()(e.properties.image)?e.properties.image:e.url.replace(/\/[^/]*?$/,"/")+e.properties.image}function f(e,t){var n=e.find((function(e){return e.id===t}));if(n)return n;throw new Error('There is no story format with ID "'.concat(t,'".'))}function b(e,t,n){var r=e.find((function(e){return e.name===t&&e.version===n}));if(r)return r;throw new Error('There is no story format with name "'.concat(t,'" and version "').concat(n,'".'))}function j(e,t){return e.reduce((function(e,n){return n.name!==t?e:!e||Object(u.gt)(n.version,e.version)?n:e}),void 0)}function p(e){return e.sort((function(e,t){return e.name<t.name?-1:e.name>t.name?1:e.version===t.version?0:i()(t.version,e.version)?-1:1}))}},function(e,t){},function(e,t){},function(e,t,n){"use strict"},function(e,t){},function(e,t,n){"use strict";n.d(t,"a",(function(){return j}));var r=n(2),a=n(4),o=n(0),s=n(49),c=n(13),i=n(16),u=n(23),l=n(6),d=n(62),f=n(7),b=n(1),j=function(e){var t=Object(f.usePrefsContext)().dispatch,n=Object(s.a)().t;return o.useEffect((function(){return t(Object(f.setPref)("donateShown",!0))}),[t]),Object(b.jsxs)(u.a,Object(r.a)(Object(r.a)({},e),{},{className:"app-donation-dialog",fixedSize:!0,headerLabel:n("dialogs.appDonation.title"),children:[Object(b.jsx)(i.b,{children:Object(b.jsxs)("div",{className:"text",children:[Object(b.jsx)("p",{children:n("dialogs.appDonation.supportMessage")}),Object(b.jsx)("p",{children:n("dialogs.appDonation.onlyOnce")})]})}),Object(b.jsxs)(c.a,{children:[Object(b.jsx)(d.a,{href:"https://twinery.org/donate",icon:Object(b.jsx)(a.B,{}),label:n("dialogs.appDonation.donate"),variant:"primary"}),Object(b.jsx)(l.a,{icon:Object(b.jsx)(a.ab,{}),label:n("dialogs.appDonation.noThanks"),onClick:e.onClose})]})]}))}},,,,,function(e,t){},function(e,t){},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(2),a=n(18),o=(n(0),n(49)),s=n(23),c=n(16),i=n(3),u=n(22),l=n(131),d=n(1),f=function(e){var t=e.storyId,n=Object(a.a)(e,["storyId"]),f=Object(u.useUndoableStoriesContext)(),b=f.dispatch,j=f.stories,p=Object(o.a)().t,m=Object(i.storyWithId)(j,t),h=Object(i.storyPassageTags)(m);return Object(d.jsx)(s.a,Object(r.a)(Object(r.a)({className:"passage-tags-dialog",fixedSize:!0,headerLabel:p("dialogs.passageTags.title")},n),{},{children:Object(d.jsx)(c.b,{children:h.length>0?h.map((function(e){return Object(d.jsx)(l.a,{allTags:h,color:m.tagColors[e],name:e,onChangeColor:function(t){return function(e,t){b(Object(i.setTagColor)(m,e,t),p("undoChange.changeTagColor"))}(e,t)},onChangeName:function(t){return function(e,t){b(Object(i.renamePassageTag)(m,e,t),p("undoChange.renameTag"))}(e,t)}},e)})):Object(d.jsx)("p",{children:p("dialogs.passageTags.noTags")})})}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var r=n(2),a=n(5),o=n(18),s=n(0),c=n(49),i=n(63),u=n(13),l=n(23),d=n(58),f=n(7),b=n(3),j=n(83),p=(n(419),n(1)),m=function(e){var t=e.storyId,n=Object(o.a)(e,["storyId"]),m=s.useState(),h=Object(a.a)(m,2),g=h[0],O=h[1],v=Object(b.useStoriesContext)(),y=v.dispatch,x=v.stories,w=Object(f.usePrefsContext)().prefs,S=Object(b.storyWithId)(x,t),C=Object(c.a)().t;return Object(p.jsxs)(l.a,Object(r.a)(Object(r.a)({},n),{},{className:"story-javascript-dialog",headerLabel:C("dialogs.storyJavaScript.title"),maximizable:!0,children:[Object(p.jsxs)(u.a,{children:[Object(p.jsx)(i.b,{editor:g,watch:S.script}),Object(p.jsx)(i.a,{editor:g})]}),Object(p.jsx)(l.b,{children:Object(p.jsx)(d.a,{editorDidMount:O,fontFamily:w.codeEditorFontFamily,fontScale:w.codeEditorFontScale,label:C("dialogs.storyJavaScript.editorLabel"),labelHidden:!0,onBeforeChange:function(e,t,n){O(e),y(Object(b.updateStory)(x,S,{script:n}))},options:Object(r.a)(Object(r.a)({},Object(j.a)(w)),{},{autofocus:!0,lineWrapping:!0,mode:"javascript",placeholder:C("dialogs.storyJavaScript.explanation")}),value:S.script})})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return O}));var r=n(14),a=n(2),o=n(5),s=n(18),c=n(127),i=n(0),u=n(49),l=n(4),d=n(23),f=n(28),b=n(58),j=n(6),p=n(3),m=n(22),h=(n(422),n(1)),g={Tab:!1,"Shift-Tab":!1},O=function(e){var t,n,O,v=e.storyId,y=Object(s.a)(e,["storyId"]),x=i.useState({includePassageNames:!0,matchCase:!1,useRegexes:!1}),w=Object(o.a)(x,2),S=w[0],C=w[1],k=i.useState(""),F=Object(o.a)(k,2),E=F[0],I=F[1],N=i.useState(""),P=Object(o.a)(N,2),T=P[0],D=P[1],L=Object(m.useUndoableStoriesContext)(),A=L.dispatch,M=L.stories,z=i.useMemo((function(){return Object(c.debounce)(A,250)}),[A]),R=Object(u.a)().t,W=Object(p.storyWithId)(M,v),U=Object(p.passagesMatchingSearch)(W.passages,T,S);function B(e){C((function(t){return Object(a.a)(Object(a.a)({},t),{},Object(r.a)({},e,!t[e]))}))}return i.useEffect((function(){return z(Object(p.highlightPassagesMatchingSearch)(W,T,S)),function(){return z(Object(p.highlightPassagesMatchingSearch)(W,"",{}))}}),[z,T,S,W]),Object(h.jsxs)(d.a,Object(a.a)(Object(a.a)({},y),{},{className:"story-search-dialog",fixedSize:!0,headerLabel:R("dialogs.storySearch.title"),children:[Object(h.jsxs)("div",{className:"search-fields",children:[Object(h.jsx)(b.a,{label:R("dialogs.storySearch.find"),onBeforeChange:function(e,t,n){D(n)},options:{extraKeys:g,mode:"text"},value:T}),Object(h.jsx)(b.a,{label:R("dialogs.storySearch.replaceWith"),onBeforeChange:function(e,t,n){I(n)},options:{extraKeys:g,mode:"text"},value:E})]}),Object(h.jsxs)("div",{className:"search-flags",children:[Object(h.jsx)(f.a,{label:R("dialogs.storySearch.includePassageNames"),onChange:function(){return B("includePassageNames")},value:null!==(t=S.includePassageNames)&&void 0!==t&&t}),Object(h.jsx)(f.a,{label:R("dialogs.storySearch.matchCase"),onChange:function(){return B("matchCase")},value:null!==(n=S.matchCase)&&void 0!==n&&n}),Object(h.jsx)(f.a,{label:R("dialogs.storySearch.useRegexes"),onChange:function(){return B("useRegexes")},value:null!==(O=S.useRegexes)&&void 0!==O&&O})]}),Object(h.jsxs)("div",{className:"search-results",children:[Object(h.jsx)(j.a,{disabled:0===U.length,icon:Object(h.jsx)(l.N,{}),label:R("dialogs.storySearch.replaceAll"),onClick:function(){A(Object(p.replaceInStory)(W,T,E,S),"undoChange.replaceAllText")},variant:"danger"}),Object(h.jsx)("span",{children:T&&(U.length>0?R("dialogs.storySearch.matchCount",{count:U.length}):R("dialogs.storySearch.noMatches"))})]})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return m}));var r=n(2),a=n(5),o=n(18),s=n(0),c=n(49),i=n(63),u=n(13),l=n(23),d=n(58),f=n(7),b=n(3),j=n(83),p=(n(423),n(1)),m=function(e){var t=e.storyId,n=Object(o.a)(e,["storyId"]),m=s.useState(),h=Object(a.a)(m,2),g=h[0],O=h[1],v=Object(b.useStoriesContext)(),y=v.dispatch,x=v.stories,w=Object(f.usePrefsContext)().prefs,S=Object(b.storyWithId)(x,t),C=Object(c.a)().t;return Object(p.jsxs)(l.a,Object(r.a)(Object(r.a)({},n),{},{className:"story-stylesheet-dialog",headerLabel:C("dialogs.storyStylesheet.title"),maximizable:!0,children:[Object(p.jsxs)(u.a,{children:[Object(p.jsx)(i.b,{editor:g,watch:S.script}),Object(p.jsx)(i.a,{editor:g})]}),Object(p.jsx)(l.b,{children:Object(p.jsx)(d.a,{editorDidMount:O,fontFamily:w.codeEditorFontFamily,fontScale:w.codeEditorFontScale,label:C("dialogs.storyStylesheet.editorLabel"),labelHidden:!0,onBeforeChange:function(e,t,n){O(e),y(Object(b.updateStory)(x,S,{stylesheet:n}))},options:Object(r.a)(Object(r.a)({},Object(j.a)(w)),{},{autofocus:!0,lineWrapping:!0,mode:"css",placeholder:C("dialogs.storyStylesheet.explanation")}),value:S.stylesheet})})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return b}));var r=n(14),a=n(2),o=(n(0),n(49)),s=n(23),c=n(16),i=n(3),u=n(7),l=n(22),d=n(131),f=n(1),b=function(e){var t=Object(l.useUndoableStoriesContext)(),n=t.dispatch,b=t.stories,j=Object(u.usePrefsContext)(),p=j.dispatch,m=j.prefs,h=Object(o.a)().t,g=Object(i.storyTags)(b);return Object(f.jsx)(s.a,Object(a.a)(Object(a.a)({className:"story-tags-dialog",fixedSize:!0,headerLabel:h("dialogs.storyTags.title")},e),{},{children:Object(f.jsx)(c.b,{children:g.length>0?g.map((function(e){return Object(f.jsx)(d.a,{allTags:g,color:m.storyTagColors[e],name:e,onChangeColor:function(t){return function(e,t){p(Object(u.setPref)("storyTagColors",Object(a.a)(Object(a.a)({},m.storyTagColors),{},Object(r.a)({},e,t))))}(e,t)},onChangeName:function(t){return function(e,t){n(Object(i.renameStoryTag)(b,e,t))}(e,t)}},e)})):Object(f.jsx)("p",{children:h("dialogs.storyTags.noTags")})})}))}},,,,,,,function(e,t,n){"use strict";n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return f})),n.d(t,"d",(function(){return b})),n.d(t,"e",(function(){return j})),n.d(t,"i",(function(){return p})),n.d(t,"p",(function(){return k})),n.d(t,"j",(function(){return E})),n.d(t,"k",(function(){return N})),n.d(t,"l",(function(){return P})),n.d(t,"n",(function(){return D})),n.d(t,"o",(function(){return L})),n.d(t,"g",(function(){return A})),n.d(t,"q",(function(){return M})),n.d(t,"r",(function(){return z})),n.d(t,"s",(function(){return R})),n.d(t,"h",(function(){return W})),n.d(t,"f",(function(){return U})),n.d(t,"t",(function(){return B})),n.d(t,"u",(function(){return V})),n.d(t,"a",(function(){return H})),n.d(t,"m",(function(){return Y})),n.d(t,"v",(function(){return w})),n.d(t,"w",(function(){return J}));var r=n(27),a=n(25),o=n(53);function s(e,t,n,s){if(!e.passages.some((function(e){return e.id===t.id})))throw new Error("This passage does not belong to this story.");return function(c){var i=Object(o.a)(s),u=Object(o.a)(n).filter((function(t){return!i.includes(t)&&!e.passages.some((function(e){return e.name===t}))}));if(0!==u.length){for(var l=Object(r.a)(),d=25,f=t.top+t.height+d,b=u.length*l.width+(u.length-1)*d,j=t.left+(t.width-b)/2,p=function(){return e.passages.some((function(e){return Object(a.g)(e,{left:j,top:f,height:l.height,width:b})}))};p()&&(j+=l.width+d,p())&&(j-=2*(l.width+d),p());)j+=l.width+d,f+=l.height+d;c({type:"createPassages",storyId:e.id,props:u.map((function(e){var t={left:j,name:e,top:f};return j+=l.width+d,t}))})}}}var c=n(2),i=n(19),u=n.n(i);function l(e,t,n){var r=u()();if(""===n.name.trim())throw new Error("Story name cannot be empty");if(e.some((function(e){return e.name.toLowerCase()===n.name.toLowerCase()})))throw new Error('There is already a story named "'.concat(n.name,'"'));return function(e){return e({type:"createStory",props:Object(c.a)({id:r,storyFormat:t.storyFormat.name,storyFormatVersion:t.storyFormat.version},n)}),r}}var d=n(78);function f(e,t,n){if(!Number.isFinite(t)||!Number.isFinite(n))throw new Error("Center must be a finite coordinate pair");var o=Object(r.a)(),s=Object(d.a)(o.name,e.passages.map((function(e){return e.name}))),i=25,u={height:o.height,left:Math.max(t-o.width/2,0),top:Math.max(n-o.height/2,0),width:o.width};e.snapToGrid&&(u.left=Math.round(u.left/i)*i,u.top=Math.round(u.top/i)*i);for(var l=function(){return e.passages.some((function(e){return Object(a.g)(e,u)}))};l()&&(u.left+=u.width+i,l())&&(u.left-=u.width+i,u.top+=u.height+i,l());){if(u.left>=u.width+i){if(u.left-=u.width+i,!l())break;u.left+=u.width+i}u.top+=u.height+i}return{type:"createPassage",storyId:e.id,props:Object(c.a)(Object(c.a)({},u),{},{story:e.id,name:s})}}function b(e,t){return{type:"deletePassages",storyId:e.id,passageIds:t.map((function(e){return e.id}))}}function j(e){return{type:"deleteStory",storyId:e.id}}function p(e,t){return{type:"createStory",props:Object(c.a)(Object(c.a)({},e),{},{id:u()(),ifid:u()(),name:Object(d.a)(e.name,t.map((function(e){return e.name})))})}}var m=n(31),h=n(93),g=n(123),O=n.n(g),v=n(72),y=n(11);function x(e,t,n,r){if(!e.passages.some((function(e){return e.id===t.id})))throw new Error("This passage does not belong to this story.");return function(a){var s=Object(o.a)(r),c=Object(o.a)(n),i=s.filter((function(e){return!c.includes(e)})).reduce((function(n,r){var a=e.passages.find((function(e){return e.name===r}));return a&&function(e){return""===e.text&&0===e.tags.length&&100===e.width&&100===e.height}(a)&&e.startPassage!==a.id?e.passages.some((function(e){return e.id!==t.id&&Object(o.a)(e.text).includes(r)}))?n:[].concat(Object(y.a)(n),[a.id]):n}),[]);i.length>0&&a({type:"deletePassages",passageIds:i,storyId:e.id})}}function w(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(!e.passages.some((function(e){return e.id===t.id})))throw new Error("This passage does not belong to this story.");if("name"in n&&e.passages.filter((function(e){return e.name===n.name})).some((function(e){return e.id!==t.id})))throw new Error('There is already a passage named "'.concat(n.name,'".'));return function(a,o){var c=t.name,i=t.text;if(a({props:n,type:"updatePassage",passageId:t.id,storyId:e.id}),!r.dontUpdateOthers&&n.text){a(x(e,t,n.text,i));var u=Object(v.h)(o(),e.id);a(s(u,t,n.text,i))}if(n.name){var l=O()(c),d=n.name.replace(/\$/g,"$$$$"),f=new RegExp("\\[\\["+l+"(\\]\\[.*?)?\\]\\]","g"),b=new RegExp("\\[\\[(.*?)(\\||->)"+l+"(\\]\\[.*?)?\\]\\]","g"),j=new RegExp("\\[\\["+l+"(<-.*?)(\\]\\[.*?)?\\]\\]","g");e.passages.forEach((function(t){if(f.test(t.text)||b.test(t.text)||j.test(t.text)){var n=t.text;n=(n=(n=n.replace(f,"[["+d+"$1]]")).replace(b,"[[$1$2"+d+"$3]]")).replace(j,"[["+d+"$1$2]]"),w(e,t,{text:n},r)(a,o)}}))}}}function S(e,t,n,r){var a=r.matchCase,o=r.useRegexes,s=Object(h.a)(t,{matchCase:a,useRegexes:o}),c=o?n:Object(h.b)(n);return e.replace(s,c)}function C(e,t,n,r,a){return function(o,s){if(""===n)throw new Error("Can't replace an empty string");if(t.story!==e.id)throw new Error("Passage does not belong to story");var c=a.includePassageNames,i={},u=S(t.text,n,r,a);if(u!==t.text&&(i.text=u),c){var l=S(t.name,n,r,a);l!==t.name&&(i.name=l)}Object.keys(i).length>0&&w(e,t,i)(o,s)}}function k(e,t,n,r){return function(a,o){if(""===t)throw new Error("Can't replace an empty string");if(r.includePassageNames){var s,c=Object(m.a)(e.passages);try{for(c.s();!(s=c.n()).done;){var i=s.value,u=S(i.name,t,n,r);u!==i.name&&w(e,i,{name:u})(a,o)}}catch(g){c.e(g)}finally{c.f()}var l,d=Object(m.a)(e.passages);try{for(d.s();!(l=d.n()).done;){var f=l.value,b=S(f.text,t,n,r);b!==f.text&&w(e,f,{text:b})(a,o)}}catch(g){d.e(g)}finally{d.f()}}else{var j,p=Object(m.a)(e.passages);try{for(p.s();!(j=p.n()).done;){var h=j.value;C(e,h,t,n,r)(a,o)}}catch(g){p.e(g)}finally{p.f()}}}}var F=n(14);function E(e,t,n){return function(r){var a={};if(""===t)a=e.passages.reduce((function(e,t){return t.highlighted?Object(c.a)(Object(c.a)({},e),{},Object(F.a)({},t.id,{highlighted:!1})):e}),{});else{var o=Object(v.d)(e.passages,t,n).map((function(e){return e.id}));e.passages.forEach((function(e){var t=e.highlighted,n=o.includes(e.id);n!==t&&(a[e.id]={highlighted:n})}))}Object.keys(a).length>0&&r({passageUpdates:a,type:"updatePassages",storyId:e.id})}}var I=n(32);function N(e,t){return e.forEach((function(t){if(e.some((function(e){return e!==t&&Object(I.storyFileName)(e)===Object(I.storyFileName)(t)})))throw new Error('Stories to import cannot have the same name: "'.concat(t.name,'"'))})),function(n){e.forEach((function(e){var r=Object(c.a)({},e);delete r.id;var a=t.find((function(t){return Object(I.storyFileName)(t)===Object(I.storyFileName)(e)}));a?(r.passages&&(r.passages=r.passages.map((function(e){return Object(c.a)(Object(c.a)({},e),{},{story:a.id})}))),n({props:r,type:"updateStory",storyId:a.id})):n({props:r,type:"createStory"})}))}}function P(e,t,n,r){var a={};if(!Number.isFinite(n)||!Number.isFinite(r))throw new Error("Offset must be a finite number.");return t.forEach((function(t){var o=e.passages.find((function(e){return e.id===t}));if(!o)throw new Error('There is no passage in this story with ID "'.concat(t,'".'));var s=Math.max(o.left+n,0),c=Math.max(o.top+r,0);e.snapToGrid&&(s=25*Math.round(s/25),c=25*Math.round(c/25)),a[o.id]={left:s,top:c}})),{type:"updatePassages",passageUpdates:a,storyId:e.id}}var T=n(46);function D(e,t,n){if(!Object(T.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));return function(r){var a={};if(e.passages.forEach((function(e){e.tags.includes(t)&&(a[e.id]={tags:e.tags.map((function(e){return e===t?n:e}))})})),Object.keys(a).length>0){r({type:"updatePassages",passageUpdates:a,storyId:e.id});var o=Object(c.a)({},e.tagColors);delete o[t],o[n]=e.tagColors[t],r({type:"updateStory",props:{tagColors:o},storyId:e.id})}}}function L(e,t,n){if(!Object(T.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));return function(r){e.forEach((function(e){e.tags.includes(t)&&r({type:"updateStory",storyId:e.id,props:{tags:e.tags.map((function(e){return e===t?n:e}))}})}))}}function A(e,t){if(t.story!==e.id)throw new Error("This passage does not belong to this story");return function(n){t.selected&&n({type:"updatePassage",passageId:t.id,props:{selected:!1},storyId:e.id})}}function M(e){return function(t){var n={};e.passages.forEach((function(e){e.selected||(n[e.id]={selected:!0})})),Object.keys(n).length>0&&t({passageUpdates:n,type:"updatePassages",storyId:e.id})}}function z(e,t,n){if(t.story!==e.id)throw new Error("This passage does not belong to this story");return function(r){var a={};t.selected||(a[t.id]={selected:!0}),n&&e.passages.forEach((function(e){e.id!==t.id&&e.selected&&(a[e.id]={selected:!1})})),Object.keys(a).length>0&&r({type:"updatePassages",passageUpdates:a,storyId:e.id})}}function R(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return function(r){var o={};e.passages.forEach((function(e){if(!n.find((function(t){return t===e.id}))){var r=Object(a.g)(t,e);e.selected!==r&&(o[e.id]={selected:r})}})),Object.keys(o).length>0&&r({type:"updatePassages",passageUpdates:o,storyId:e.id})}}function W(e){return function(t,n){e.selected||t({type:"updateStory",storyId:e.id,props:{selected:!1}})}}function U(){return function(e,t){var n,r=Object(m.a)(t());try{for(r.s();!(n=r.n()).done;){var a=n.value;a.selected&&e({type:"updateStory",storyId:a.id,props:{selected:!1}})}}catch(o){r.e(o)}finally{r.f()}}}function B(e,t){return function(n,r){if(e.selected||n({type:"updateStory",storyId:e.id,props:{selected:!0}}),t){var a,o=Object(m.a)(r());try{for(o.s();!(a=o.n()).done;){var s=a.value;s.id!==e.id&&s.selected&&n({type:"updateStory",storyId:s.id,props:{selected:!1}})}}catch(c){o.e(c)}finally{o.f()}}}}function V(e,t,n){if(!Object(T.a)(t))throw new Error('"'.concat(t,'" is not a valid tag name.'));return function(r){if("none"===n){if(t in e.tagColors){var a=Object(c.a)({},e.tagColors);delete a[t],r({type:"updateStory",props:{tagColors:a},storyId:e.id})}}else r({type:"updateStory",props:{tagColors:Object(c.a)(Object(c.a)({},e.tagColors),{},Object(F.a)({},t,n))},storyId:e.id})}}function H(e,t,n){if(t.story!==e.id)throw new Error("This passage does not belong to this story.");if(!Object(T.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));if(t.tags.includes(n))throw new Error('This passage already has the tag "'.concat(n,'".'));return{type:"updatePassage",passageId:t.id,storyId:e.id,props:{tags:[].concat(Object(y.a)(t.tags),[n])}}}function Y(e,t,n){if(t.story!==e.id)throw new Error("This passage does not belong to this story.");if(!Object(T.a)(n))throw new Error('"'.concat(n,'" is not a valid tag name.'));if(!t.tags.includes(n))throw new Error('This passage does not have the tag "'.concat(n,'".'));return{type:"updatePassage",passageId:t.id,storyId:e.id,props:{tags:t.tags.filter((function(e){return e!==n}))}}}function J(e,t,n){if(n.name&&e.filter((function(e){return Object(I.storyFileName)(e)===Object(I.storyFileName)(Object(c.a)(Object(c.a)({},e),n))})).some((function(e){return e.id!==t.id})))throw new Error('There is already a story named "'.concat(n.name,'".'));return{props:n,storyId:t.id,type:"updateStory"}}},function(e,t,n){"use strict";n.d(t,"b",(function(){return k})),n.d(t,"a",(function(){return F}));var r=n(5),a=n(0),o=n(79),s=n.n(o),c=n(60),i=n(11),u=n(2),l=n(19),d=n.n(l),f=n(27);function b(e,t,n){var r=!1,a=!1,o=e.map((function(e){if(e.id!==t)return e;if(r=!0,e.passages.some((function(e){return e.id===n.id})))return console.warn('There is already a passage in this story with ID "'.concat(n.id,'", taking no action')),e;if("name"in n&&e.passages.some((function(e){return e.name===n.name})))return console.warn('There is already a passage in this story with name "'.concat(n.name,'", taking no action')),e;var o=Object(u.a)(Object(u.a)(Object(u.a)({},Object(f.a)()),{},{id:d()()},n),{},{story:e.id}),s=Object(u.a)(Object(u.a)({},e),{},{lastUpdate:new Date,passages:[].concat(Object(i.a)(e.passages),[o])});return 1===s.passages.length&&(s.startPassage=o.id),a=!0,s}));return r?a?o:e:(console.warn('No story in state with ID "'.concat(t,'", taking no action')),e)}function j(e,t,n){var r=!1,a=!1,o=e.map((function(e){if(e.id!==t)return e;r=!0;var o=Object(u.a)(Object(u.a)({},e),{},{passages:e.passages.filter((function(e){return e.id!==n||(a=!0,!1)}))});return a?(o.lastUpdate=new Date,o):e}));return r?a?o:(console.warn('Asked to delete a passage with ID "'.concat(n,'", but it does not exist in story ID ').concat(t,", taking no action")),e):(console.warn('No story in state with ID "'.concat(t,'", taking no action')),e)}var p=n(80);function m(e,t,n,r){var a='Repairing passage (name: "'.concat(e.name,'", id: ').concat(e.id,"): ")+"setting ".concat(t," to ").concat(n,", was ").concat(e[t]);r&&(a+=" (".concat(r,")")),console.info(a)}function h(e,t,n,r){var a='Repairing story (name: "'.concat(e.name,'", id: ').concat(e.id,") by ")+"setting ".concat(t," to ").concat(n,", was ").concat(e[t]);r&&(a+=" (".concat(r,")")),console.info(a)}function g(e,t,n,a){var o=Object(f.b)(),s={};if("string"!==typeof e.id||""===e.id){var c=d()();h(e,"id",c,"was bad type or empty string"),s.id=c}if("string"!==typeof e.ifid||""===e.id){var i=d()();h(e,"ifid",i,"was bad type or empty string"),s.ifid=i}if(Object.entries(o).forEach((function(t){var n=Object(r.a)(t,2),a=n[0],c=n[1],i=a;("number"===typeof c&&!Number.isFinite(e[i])||typeof c!==typeof e[i])&&(h(e,i,o[i]),s[i]=o[i])})),"string"!==typeof e.storyFormat||""===e.storyFormat||"string"!==typeof e.storyFormatVersion||""===e.storyFormatVersion)h(e,"storyFormat",a.name,"was bad type or unset"),h(e,"storyFormatVersion",a.version,"was bad type or unset"),s.storyFormat=a.name,s.storyFormatVersion=a.version;else if(!n.some((function(t){return t.name===e.storyFormat&&t.version===e.storyFormatVersion}))){var l=n.find((function(t){return t.name===e.storyFormat&&Object(p.satisfies)(t.version,"^"+e.storyFormatVersion)}));l?(h(e,"storyFormat",l.name,"no match in existing formats but found one that satisfies semver"),h(e,"storyFormatVersion",l.version,"no match in existing formats but found one that satisfies semver"),s.storyFormat=l.name,s.storyFormatVersion=l.version):(h(e,"storyFormat",a.name,"no match in existing formats and could not find one that satisfies semver"),h(e,"storyFormatVersion",a.version,"no match in existing formats and could not find one that satisfies semver"),s.storyFormat=a.name,s.storyFormatVersion=a.version)}if(t.some((function(t){return t!==e&&t.id===e.id}))){var b=d()();h(e,"id",b,"conflicted with another story's ID"),s.id=b}var j=!1,g=e.passages.map((function(t){var n=function(e,t){var n=Object(f.a)(),a={};if("string"!==typeof e.id||""===e.id){var o=d()();m(e,"id",o,"was undefined or empty string"),a.id=d()()}if(Object.entries(n).forEach((function(t){var o=Object(r.a)(t,2),s=o[0],c=o[1],i=s;("number"===typeof c&&!Number.isFinite(e[i])||typeof c!==typeof e[i])&&(m(e,i,n[i]),a[i]=n[i])})),["left","top"].forEach((function(t){var n=t;e[n]<0&&(m(e,n,0,"was negative"),a[n]=0)})),["height","width"].forEach((function(t){var n=t;e[n]<5&&(m(e,n,0,"was less than 5"),a[n]=5)})),e.story!==t.id&&(m(e,"story",t.id,"didn't match parent story"),a.story=t.id),t.passages.some((function(t){return t!==e&&t.id===e.id}))){var s=d()();m(e,"id",s,"conflicted with another passage in the story"),a.id=s}return Object.keys(a).length>0?Object(u.a)(Object(u.a)({},e),a):e}(t,Object(u.a)(Object(u.a)({},e),s));return n!==t?(j=!0,n):t}));return j&&(s.passages=g),Object.keys(s).length>0?Object(u.a)(Object(u.a)({},e),s):e}var O=n(35);function v(e,t,n,r){var a=!1,o=!1,s=e.map((function(e){if(e.id!==t)return e;if(a=!0,"name"in r&&e.passages.some((function(e){return e.name===r.name&&e.id!==n})))return console.warn('There is already a passage in this story with name "'.concat(r.name,'", taking no action')),e;var s=Object(u.a)(Object(u.a)({},e),{},{passages:e.passages.map((function(e){return e.id!==n?e:(o=!0,Object(u.a)(Object(u.a)({},e),r))}))});return o?(Object(O.a)(r)&&(s.lastUpdate=new Date),s):(console.warn('Asked to update a passage with ID "'.concat(n,'", but it does not exist in story ID ').concat(t,", taking no action")),e)}));return a?o?s:e:(console.warn('No story in state with ID "'.concat(t,'", taking no action')),e)}var y=function(e,t){switch(t.type){case"createPassage":return b(e,t.storyId,t.props);case"createPassages":return function(e,t,n){return n.reduce((function(e,n){return b(e,t,n)}),e)}(e,t.storyId,t.props);case"createStory":return function(e,t){if("id"in t&&e.some((function(e){return e.id===t.id})))return console.warn('There is already a story in state with ID "'.concat(t.id,'", taking no action')),e;if("name"in t&&e.some((function(e){return e.name===t.name})))return console.warn('There is already a story in state with name "'.concat(t.name,'", taking no action')),e;var n=Object(u.a)(Object(u.a)({id:d()()},Object(f.b)()),{},{ifid:d()().toUpperCase(),lastUpdate:new Date,passages:[],tags:[],tagColors:{}},t);return n.passages=n.passages.map((function(e){return Object(u.a)(Object(u.a)(Object(u.a)({},f.a),e),{},{story:n.id})})),[].concat(Object(i.a)(e),[n])}(e,t.props);case"deletePassage":return j(e,t.storyId,t.passageId);case"deletePassages":return function(e,t,n){return n.reduce((function(e,n){return j(e,t,n)}),e)}(e,t.storyId,t.passageIds);case"deleteStory":return function(e,t){var n=!1,r=e.filter((function(e){return e.id!==t||(n=!0,!1)}));return n?r:(console.warn('Asked to delete a story with ID "'.concat(t,'", but it does not exist in state')),e)}(e,t.storyId);case"init":return n=t.state,Object(i.a)(n);case"repair":return function(e,t,n){return e.map((function(r){return g(r,e,t,n)}))}(e,t.allFormats,t.defaultFormat);case"updatePassage":return v(e,t.storyId,t.passageId,t.props);case"updatePassages":return function(e,t,n){return Object.keys(n).reduce((function(e,r){return v(e,t,r,n[r])}),e)}(e,t.storyId,t.passageUpdates);case"updateStory":return function(e,t,n){if("name"in n&&e.some((function(e){return e.name===n.name&&e.id!==t})))return console.warn('There is another story in state with name "'.concat(n.name,'", taking no action')),e;var r=!1,a=e.map((function(e){if(e.id!==t)return e;r=!0;var a=Object(u.a)(Object(u.a)({},e),n);return Object(O.b)(n)&&(a.lastUpdate=new Date),a}));return r?a:(console.warn('Asked to update a story with ID "'.concat(t,'", but it does not exist in state')),e)}(e,t.storyId,t.props);default:console.warn("".concat(t.type," not implemented yet"))}var n;return e},x=n(10),w=n(81),S=n(1),C=a.createContext({dispatch:function(){},stories:[]});C.displayName="Stories";var k=function(){return a.useContext(C)},F=function(e){var t=Object(c.a)().stories,n=Object(x.useStoryFormatsContext)().formats,o=Object(w.a)().reportError,i=a.useMemo((function(){return function(e,r){var a=y(e,r);try{t.saveMiddleware(a,r,n)}catch(s){o(s,"store.errors.cantPersistStories")}return a}}),[n,o,t]),u=s()(i,[]),l=Object(r.a)(u,2),d=l[0],f=l[1];return Object(S.jsx)(C.Provider,{value:{dispatch:f,stories:d},children:e.children})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return W}));var r=n(2),a=n(5),o=n(18),s=n(0),c=n(49),i=n(76),u=n(23),l=n(37),d=n(3),f=n(10),b=n(22),j=(n(399),n(127)),p=n(58),m=n(7),h=n(11),g=n(36),O=n.n(g);var v=n(82),y=n(39);var x=n(83),w=n(1),S=function(e){var t,n=e.onChange,o=e.onEditorChange,i=e.passage,l=e.story,d=e.storyFormat,b=e.storyFormatExtensionsDisabled,g=s.useState(!1),S=Object(a.a)(g,2),C=S[0],k=S[1],F=s.useState(i.text),E=Object(a.a)(F,2),I=E[0],N=E[1],P=Object(m.usePrefsContext)().prefs,T=function(e){return s.useCallback((function(t){t.showHint({completeSingle:!1,extraKeys:["]","-","|"].reduce((function(e,t){return e[t]=function(e,n){var r=e.getDoc();r.replaceRange(t,r.getCursor()),n.close()},e}),{}),hint:function(){var n=t.findWordAt(t.getCursor()),r=t.getRange(n.anchor,n.head).toLowerCase(),a={list:e.passages.reduce((function(e,t){return t.name.toLowerCase().includes(r)?[].concat(Object(h.a)(e),[t.name]):e}),[]),from:n.anchor,to:n.head};return O.a.on(a,"pick",(function(){var e=t.getDoc();e.replaceRange("]] ",e.getCursor())})),a}})}),[e.passages])}(l),D=null!==(t=function(e,t){var n=Object(f.useStoryFormatsContext)(),r=n.dispatch,o=n.formats,c=Object(f.formatWithNameAndVersion)(o,e,t),i=Object(m.usePrefsContext)().prefs,u=s.useState(),l=Object(a.a)(u,2),d=l[0],b=l[1],j=Object(m.formatEditorExtensionsDisabled)(i,e,t);return s.useEffect((function(){if(!j)if("unloaded"===c.loadState)r(Object(f.loadFormatProperties)(c));else if("loaded"===c.loadState){var e,t=Object(y.b)(c,v.a);(null===t||void 0===t||null===(e=t.codeMirror)||void 0===e?void 0:e.mode)&&(O.a.defineMode(Object(y.c)(c),t.codeMirror.mode),b(Object(y.c)(c)))}}),[r,j,c]),d}(d.name,d.version))&&void 0!==t?t:"text",L=Object(c.a)().t;s.useEffect((function(){C||I===i.text||N(i.text)}),[C,I,i.text]);var A=s.useMemo((function(){return Object(j.debounce)((function(e){n(e),k(!1)}),1e3)}),[n]),M=s.useCallback((function(e){o(e),window.setTimeout((function(){e.focus(),e.refresh()}),400)}),[o]),z=s.useCallback((function(e,t,n){o(e),k(!0),A(n),N(n)}),[A,o]),R=s.useMemo((function(){return Object(r.a)(Object(r.a)({},Object(x.a)(P)),{},{mode:b?"text":D,lineWrapping:!0,placeholder:L("dialogs.passageEdit.passageTextPlaceholder"),prefixTrigger:{callback:T,prefixes:["[[","->"]}})}),[T,D,P,b,L]);return Object(w.jsx)(u.b,{children:Object(w.jsx)(p.a,{editorDidMount:M,fontFamily:P.passageEditorFontFamily,fontScale:P.passageEditorFontScale,label:L("dialogs.passageEdit.passageTextEditorLabel"),labelHidden:!0,onBeforeChange:z,onChange:o,options:R,value:I})})},C=n(4),k=n(63),F=n(13),E=n(28),I=n(51),N=n(129),P=n(61),T=function(e){var t=e.editor,n=e.passage,r=e.story,a=Object(b.useUndoableStoriesContext)(),o=a.dispatch,s=a.stories,i=Object(c.a)().t,u=r.startPassage===n.id;function l(e){var t=e.height,a=e.width;o(Object(d.updatePassage)(r,n,{height:t,width:a}))}return Object(w.jsxs)(F.a,{children:[Object(w.jsx)(k.b,{editor:t,watch:n.text}),Object(w.jsx)(P.a,{assignedTags:n.tags,existingTags:Object(d.storyPassageTags)(r),onAdd:function(e,t){o(Object(d.addPassageTag)(r,n,e),i("undoChange.addTag")),t&&o(Object(d.setTagColor)(r,e,t))}}),Object(w.jsx)(I.a,{icon:Object(w.jsx)(C.O,{}),items:[{checkable:!0,checked:100===n.height&&100===n.width,label:i("dialogs.passageEdit.sizeSmall"),onClick:function(){return l({height:100,width:100})}},{checkable:!0,checked:200===n.height&&200===n.width,label:i("dialogs.passageEdit.sizeLarge"),onClick:function(){return l({height:200,width:200})}},{checkable:!0,checked:200===n.height&&100===n.width,label:i("dialogs.passageEdit.sizeTall"),onClick:function(){return l({height:200,width:100})}},{checkable:!0,checked:100===n.height&&200===n.width,label:i("dialogs.passageEdit.sizeWide"),onClick:function(){return l({height:100,width:200})}}],label:i("dialogs.passageEdit.size")}),Object(w.jsx)(N.a,{onRename:function(e){o(Object(d.updatePassage)(r,n,{name:e},{dontUpdateOthers:!0}))},passage:n,story:r}),Object(w.jsx)(E.a,{disabled:u,label:i("dialogs.passageEdit.setAsStart"),onChange:function(){o(Object(d.updateStory)(s,r,{startPassage:n.id}))},value:u})]})},D=n(130),L=n(14);var A=n(6),M=(n(414),function(e){var t=e.editor,n=e.onExecCommand,o=e.storyFormat,c=s.useRef(null),i=Object(D.a)(),u=Object(m.usePrefsContext)().prefs,l=function(e,t){var n=Object(f.useStoryFormatsContext)(),o=n.dispatch,c=n.formats,i=s.useState({}),u=Object(a.a)(i,2),l=u[0],d=u[1],b=s.useState(),j=Object(a.a)(b,2),p=j[0],g=j[1],x=Object(f.formatWithNameAndVersion)(c,e,t),w=Object(m.usePrefsContext)().prefs,S=Object(m.formatEditorExtensionsDisabled)(w,e,t);return s.useEffect((function(){if(!S)if("unloaded"===x.loadState)o(Object(f.loadFormatProperties)(x));else if("loaded"===x.loadState&&!l[Object(y.c)(x)]){var e,t,n=Object(y.c)(x),a=Object(y.b)(x,v.a);if(null===a||void 0===a||null===(e=a.codeMirror)||void 0===e?void 0:e.commands)for(var s in a.codeMirror.commands){var c=n+s;c in O.a.commands?console.warn('CodeMirror already has a "'.concat(c,'" command defined, skipping')):O.a.commands[c]=a.codeMirror.commands[s]}(null===a||void 0===a||null===(t=a.codeMirror)||void 0===t?void 0:t.toolbar)&&g((function(){return function(e,t){var o;if(!(null===a||void 0===a||null===(o=a.codeMirror)||void 0===o?void 0:o.toolbar))return[];var s=a.codeMirror.toolbar(e,t);return Array.isArray(s)?s.reduce((function(e,t){switch(t.type){case"button":return[].concat(Object(h.a)(e),[Object(r.a)(Object(r.a)({},t),{},{command:n+t.command})]);case"menu":if(Array.isArray(t.items))return[].concat(Object(h.a)(e),[Object(r.a)(Object(r.a)({},t),{},{items:t.items.filter((function(e){return["button","separator"].includes(e.type)})).map((function(e){return"separator"===e.type?e:Object(r.a)(Object(r.a)({},e),{},{command:n+e.command})}))})])}return e}),[]):[]}})),d((function(e){return Object(r.a)(Object(r.a)({},e),{},Object(L.a)({},Object(y.c)(x),!0))}))}}),[o,S,x,l]),p}(o.name,o.version),d=s.useState([]),b=Object(a.a)(d,2),j=b[0],p=b[1],g=s.useCallback((function(){if(l&&c.current&&t)try{var e=window.getComputedStyle(c.current);p(l(t,{appTheme:i,foregroundColor:e.color,locale:u.locale}))}catch(n){console.error("Toolbar function for ".concat(o.name," ").concat(o.version," threw an error, skipping update"),n)}else p([])}),[i,t,u.locale,o.name,o.version,l]);function x(e){n(e),Promise.resolve().then(g)}return s.useEffect((function(){if(t)return g(),t.on("cursorActivity",g),function(){return t.off("cursorActivity",g)}}),[t,g]),Object(w.jsx)("div",{className:"story-format-toolbar",ref:c,children:Object(w.jsx)(F.a,{children:j.map((function(e,t){switch(e.type){case"button":return Object(w.jsx)(A.a,{disabled:e.disabled,icon:Object(w.jsx)("img",{src:e.icon,alt:""}),iconOnly:e.iconOnly,label:e.label,onClick:function(){return x(e.command)}},t);case"menu":return Object(w.jsx)(I.a,{disabled:e.disabled,icon:Object(w.jsx)("img",{src:e.icon,alt:""}),iconOnly:e.iconOnly,items:e.items.filter((function(e){return["button","separator"].includes(e.type)})).map((function(e){return"button"===e.type?{type:"button",disabled:e.disabled,label:e.label,onClick:function(){return x(e.command)}}:{separator:!0}})),label:e.label},t)}return null}))})})}),z=function(e){var t=e.passage,n=e.story,a=Object(b.useUndoableStoriesContext)(),o=a.dispatch,s=a.stories,i=Object(c.a)().t;return 0===t.tags.length?null:Object(w.jsx)("div",{className:"tags",children:Object(w.jsx)(F.a,{children:t.tags.map((function(e){return Object(w.jsx)(P.b,{color:n.tagColors[e],name:e,onChangeColor:function(t){return function(e,t){o(Object(d.updateStory)(s,n,{tagColors:Object(r.a)(Object(r.a)({},n.tagColors),{},Object(L.a)({},e,t))}))}(e,t)},onRemove:function(){return r=e,void o(Object(d.removePassageTag)(n,t,r),i("undoChange.removeTag"));var r}},e)}))})})},R=function(e){var t=e.passageId,n=e.storyId,j=Object(o.a)(e,["passageId","storyId"]),p=s.useState(!0),m=Object(a.a)(p,2),h=m[0],g=m[1],O=s.useState(!1),v=Object(a.a)(O,2),y=v[0],x=v[1],C=s.useState(),k=Object(a.a)(C,2),F=k[0],E=k[1],I=Object(i.a)(),N=I.ErrorBoundary,P=I.error,D=I.reset,L=Object(b.useUndoableStoriesContext)(),A=L.dispatch,R=L.stories,W=Object(f.useStoryFormatsContext)().formats,U=Object(d.passageWithId)(R,n,t),B=Object(d.storyWithId)(R,n),V=Object(f.formatWithNameAndVersion)(W,B.storyFormat,B.storyFormatVersion),H=Object(c.a)().t;s.useEffect((function(){P&&(h?(console.error("Passage editor crashed, trying without format extensions",P),g(!1)):x(!0),D())}),[P,D,h]);var Y=s.useCallback((function(e){A(Object(d.updatePassage)(B,U,{text:e}))}),[A,U,B]);return Object(w.jsx)(u.a,Object(r.a)(Object(r.a)({},j),{},{className:"passage-edit-dialog",headerLabel:U.name,maximizable:!0,children:y?Object(w.jsx)(l.a,{children:H("dialogs.passageEdit.editorCrashed")}):Object(w.jsxs)(w.Fragment,{children:[Object(w.jsx)(T,{editor:F,passage:U,story:B}),h&&Object(w.jsx)(M,{editor:F,onExecCommand:function(e){if(!F)throw new Error("No editor set");F.execCommand(e);var t=F.listSelections();Promise.resolve().then((function(){return F.setSelections(t)}))},storyFormat:V}),Object(w.jsx)(z,{passage:U,story:B}),Object(w.jsx)(N,{children:Object(w.jsx)(S,{onChange:Y,onEditorChange:E,passage:U,story:B,storyFormat:V,storyFormatExtensionsDisabled:!h})})]})}))},W=function(e){var t=Object(b.useUndoableStoriesContext)().stories;try{Object(d.passageWithId)(t,e.storyId,e.passageId)}catch(n){return e.onClose(),null}return Object(w.jsx)(R,Object(r.a)({},e))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var r=n(2),a=n(5),o=n(0),s=n(49),c=n(16),i=n(23),u=n(3),l=n(18),d=n(20),f=n.n(d),b=(n(416),n(1)),j=function(e){var t=e.children,n=e.onChange,a=e.onError,o=e.orientation,s=Object(l.a)(e,["children","onChange","onError","orientation"]),c=f()("file-input","orientation-".concat(null!==o&&void 0!==o?o:"horizontal"));return Object(b.jsx)("span",{className:c,children:Object(b.jsxs)("label",{children:[Object(b.jsx)("span",{className:"file-input-label",children:t}),Object(b.jsx)("span",{className:"file-input-control",children:Object(b.jsx)("input",Object(r.a)(Object(r.a)({},s),{},{onChange:function(e){if(!e.target.files)throw new Error("Change event occurred but no files present");var t=e.target.files[0],r=new FileReader;r.addEventListener("loadend",(function(e){r.error?(console.warn(r.error),a&&a(r.error)):n(t,r.result)})),r.readAsText(t)},type:"file"}))})]})})},p=n(120),m=function(e){var t=e.onChange,n=Object(s.a)().t;return Object(b.jsx)("div",{className:"file-chooser",children:Object(b.jsx)("p",{children:Object(b.jsx)(j,{accept:".html",onChange:function(e,n){t(e,Object(p.a)(n))},orientation:"vertical",children:n("dialogs.storyImport.filePrompt")})})})},h=n(11),g=n(4),O=n(28),v=n(6),y=n(32),x=(n(417),function(e){var t=e.existingStories,n=e.onImport,r=e.stories,c=o.useState([]),i=Object(a.a)(c,2),u=i[0],l=i[1],d=Object(s.a)().t;function f(e){return t.some((function(t){return Object(y.storyFileName)(t)===Object(y.storyFileName)(e)}))}return Object(b.jsxs)("div",{className:"story-chooser",children:[Object(b.jsx)("p",{children:d("dialogs.storyImport.storiesPrompt")}),Object(b.jsx)("ul",{children:r.map((function(e){return Object(b.jsxs)("li",{children:[Object(b.jsx)(O.a,{label:e.name,onChange:function(t){return function(e,t){l(t?function(t){return[].concat(Object(h.a)(t),[e])}:function(t){return t.filter((function(t){return t.id!==e.id}))})}(e,t)},value:u.includes(e)},e.id),u.includes(e)&&f(e)&&Object(b.jsx)("span",{className:"replace-warning",children:d("dialogs.storyImport.willReplaceExisting")})]})}))}),Object(b.jsx)("div",{className:"actions",children:Object(b.jsx)(v.a,{disabled:0===u.length,icon:Object(b.jsx)(g.x,{}),label:d("dialogs.storyImport.importSelected"),onClick:function(){return n(u)},variant:"primary"})})]})}),w=(n(418),function(e){var t=e.onClose,n=Object(s.a)().t,l=Object(u.useStoriesContext)(),d=l.dispatch,f=l.stories,j=o.useState(),p=Object(a.a)(j,2),h=p[0],g=p[1],O=o.useState([]),v=Object(a.a)(O,2),y=v[0],w=v[1];return Object(b.jsx)(i.a,Object(r.a)(Object(r.a)({},e),{},{className:"story-import-dialog",fixedSize:!0,headerLabel:n("dialogs.storyImport.title"),children:Object(b.jsxs)(c.b,{children:[Object(b.jsx)(m,{onChange:function(e,t){g(e),w(t)}}),h&&y.length>0&&Object(b.jsx)(x,{existingStories:f,onImport:function(e){d(Object(u.importStories)(e,f)),t()},stories:y}),h&&0===y.length&&Object(b.jsx)("p",{children:n("dialogs.storyImport.noStoriesInFile")})]})}))})},function(e,t,n){"use strict";n.d(t,"b",(function(){return p})),n.d(t,"a",(function(){return m}));var r=n(5),a=n(0),o=n(49),s=n(2),c=n(11),i=n(14),u=n(3);function l(e,t){switch(e.type){case"createPassage":if(e.props.id)return{type:"deletePassage",passageId:e.props.id,storyId:e.storyId};if(e.props.name){return function(t,n){t({type:"deletePassage",passageId:Object(u.passageWithName)(n(),e.storyId,e.props.name).id,storyId:e.storyId})}}throw new Error("Can't reverse a createPassage action without either name or ID");case"createPassages":if(e.props.some((function(e){return!e.id&&!e.name})))throw new Error("Can't reverse a createPassages action where a prop set doesn't have either name or ID");return function(t,n){e.props.forEach((function(r){r.id?t({type:"deletePassage",passageId:r.id,storyId:e.storyId}):r.name&&t({type:"deletePassage",passageId:Object(u.passageWithName)(n(),e.storyId,r.name).id,storyId:e.storyId})}))};case"deletePassage":return{type:"createPassage",props:Object(u.passageWithId)(t,e.storyId,e.passageId),storyId:e.storyId};case"deletePassages":return{type:"createPassages",props:e.passageIds.map((function(n){return Object(u.passageWithId)(t,e.storyId,n)})),storyId:e.storyId};case"updatePassage":var n=Object(u.passageWithId)(t,e.storyId,e.passageId);return{type:"updatePassage",props:Object.keys(e.props).reduce((function(e,t){return Object(s.a)(Object(s.a)({},e),{},Object(i.a)({},t,n[t]))}),{}),passageId:e.passageId,storyId:e.storyId};case"updatePassages":return{type:"updatePassages",passageUpdates:Object.keys(e.passageUpdates).reduce((function(n,r){var a=Object(u.passageWithId)(t,e.storyId,r);return Object(s.a)(Object(s.a)({},n),{},Object(i.a)({},r,Object.keys(e.passageUpdates[r]).reduce((function(e,t){return Object(s.a)(Object(s.a)({},e),{},Object(i.a)({},t,a[t]))}),{})))}),{}),storyId:e.storyId};case"updateStory":var r=Object(u.storyWithId)(t,e.storyId);return{type:"updateStory",props:Object.keys(e.props).reduce((function(e,t){return Object(s.a)(Object(s.a)({},e),{},Object(i.a)({},t,r[t]))}),{}),storyId:e.storyId}}throw new Error("Don't know how to reverse action type \"".concat(e.type,'"'))}function d(e,t){var n=[];return e((function(e){"function"===typeof e?n.push(d(e,t)):n.push(l(e,t))}),(function(){return t})),function(e){return n.forEach(e)}}var f=function(e,t){switch(t.type){case"addChange":var n={description:t.description,redo:t.action,undo:"function"===typeof t.action?d(t.action,t.storiesState):l(t.action,t.storiesState)},r=[].concat(Object(c.a)(e.changes.slice(0,e.currentChange+1)),[n]);return{changes:r,currentChange:r.length-1};case"updateCurrent":return Object(s.a)(Object(s.a)({},e),{},{currentChange:Math.min(Math.max(e.currentChange+t.change,-1),e.changes.length-1)})}},b=n(1),j=a.createContext({dispatch:function(){},stories:[]});j.displayName="UndoableStories";var p=function(){return a.useContext(j)},m=function(e){var t=Object(u.useStoriesContext)(),n=t.dispatch,s=t.stories,c=a.useReducer(f,{changes:[],currentChange:-1}),i=Object(r.a)(c,2),l=i[0],d=i[1],p=a.useCallback((function(e,t){return t&&d({type:"addChange",action:e,description:t,storiesState:s}),n(e)}),[s,n]),m=Object(o.a)().t,h=void 0,g=void 0,O=void 0,v=void 0;return l.changes.length>0&&(l.currentChange>=0&&(O=function(){n(l.changes[l.currentChange].undo),d({type:"updateCurrent",change:-1})},v=m("common.undoChange",{change:m(l.changes[l.currentChange].description)})),l.currentChange<l.changes.length-1&&(h=function(){n(l.changes[l.currentChange+1].redo),d({type:"updateCurrent",change:1})},g=m("common.redoChange",{change:m(l.changes[l.currentChange+1].description)}))),Object(b.jsx)(j.Provider,{value:{dispatch:p,redo:h,redoLabel:g,stories:s,undo:O,undoLabel:v},children:e.children})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return g}));var r=n(2),a=n(18),o=(n(0),n(49)),s=n(28),c=n(13),i=n(16),u=n(23),l=n(10),d=n(38),f=n(1),b=function(e){var t=e.formats,n=e.selectedFormat,s=Object(a.a)(e,["formats","selectedFormat"]),c=Object(o.a)().t,i=t.filter((function(e){return"loading"===e.loadState})),u=Object(l.sortFormats)(t.filter((function(e){return"loaded"===e.loadState||e.id===n.id}))).map((function(e){return{disabled:!1,label:"".concat(e.name," ").concat(e.version),value:e.id}}));return 0!==i.length&&u.push({disabled:!0,label:c("components.storyFormatSelect.loadingCount",{loadingCount:i.length}),value:""}),Object(f.jsx)(d.a,Object(r.a)(Object(r.a)({},s),{},{options:u,value:n.id}))},j=n(3),p=n(134),m=(n(421),new Intl.DateTimeFormat([],{dateStyle:"full",timeStyle:"long"})),h=function(e){var t=e.story,n=Object(j.storyStats)(t),r=Object(o.a)().t;return Object(f.jsxs)("div",{className:"story-stats",children:[Object(f.jsx)("table",{className:"counts",children:Object(f.jsxs)("tbody",{children:[Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.characters}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.characters")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.words}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.words")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.passages}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.passages")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.links.length}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.links")})]}),Object(f.jsxs)("tr",{children:[Object(f.jsx)("td",{children:n.brokenLinks.length}),Object(f.jsx)("td",{children:r("dialogs.storyDetails.stats.brokenLinks")})]})]})}),Object(f.jsxs)("div",{className:"update-and-ifid",children:[Object(f.jsx)("p",{children:r("dialogs.storyDetails.stats.lastUpdate",{date:m.format(t.lastUpdate)})}),Object(f.jsxs)("p",{children:[r("dialogs.storyDetails.stats.ifid",{ifid:t.ifid}),"\xa0",Object(f.jsx)("a",{href:"https://ifdb.org/help-ifid",target:"_blank",rel:"noreferrer",children:r("dialogs.storyDetails.stats.ifidExplanation")})]})]})]})},g=function(e){var t=e.storyId,n=Object(a.a)(e,["storyId"]),d=Object(j.useStoriesContext)(),m=d.dispatch,g=d.stories,O=Object(l.useStoryFormatsContext)().formats,v=Object(j.storyWithId)(g,t),y=Object(o.a)().t;return Object(f.jsxs)(u.a,Object(r.a)(Object(r.a)({},n),{},{className:"story-details-dialog",fixedSize:!0,headerLabel:v.name,children:[Object(f.jsxs)("div",{className:"story-format",children:[Object(f.jsx)(p.a,{block:!1}),Object(f.jsx)(b,{formats:O,onChange:function(e){var t=Object(l.formatWithId)(O,e.target.value);m(Object(j.updateStory)(g,v,{storyFormat:t.name,storyFormatVersion:t.version}))},selectedFormat:Object(l.formatWithNameAndVersion)(O,v.storyFormat,v.storyFormatVersion),children:y("common.storyFormat")}),Object(f.jsx)("a",{href:"https://twinery.org/2storyformats",target:"_blank",rel:"noreferrer",children:y("dialogs.storyDetails.storyFormatExplanation")})]}),Object(f.jsx)(c.a,{children:Object(f.jsx)(s.a,{label:y("dialogs.storyDetails.snapToGrid"),onChange:function(e){return m(Object(j.updateStory)(g,v,{snapToGrid:e}))},value:v.snapToGrid})}),Object(f.jsx)(i.b,{children:!n.collapsed&&Object(f.jsx)(h,{story:v})})]}))}},function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var r=n(2),a=n(0),o=n(49),s=n(16),c=n(23),i=n(28),u=n(11),l=n(5),d=n(67),f=n(38),b=(n(370),n(1)),j=["var(--font-monospaced)","var(--font-system)"],p=[.8,.9,1,1.25,1.5,2],m=function(e){var t=e.familyLabel,n=e.fontFamily,r=e.fontScale,s=e.onChangeFamily,c=e.onChangeScale,i=e.scaleLabel,m=a.useState(!p.includes(r)),h=Object(l.a)(m,2),g=h[0],O=h[1],v=a.useState(!j.includes(n)),y=Object(l.a)(v,2),x=y[0],w=y[1],S=a.useState(n),C=Object(l.a)(S,2),k=C[0],F=C[1],E=a.useState((100*r).toString()),I=Object(l.a)(E,2),N=I[0],P=I[1],T=Object(o.a)().t;return Object(b.jsxs)("div",{className:"font-select",children:[Object(b.jsx)(f.a,{onChange:function(e){"custom"===e.target.value?(w(!0),j.includes(k)&&F("")):(w(!1),s(e.target.value))},options:[{label:T("components.fontSelect.fonts.system"),value:"var(--font-system)"},{label:T("components.fontSelect.fonts.monospaced"),value:"var(--font-monospaced)"},{label:T("common.custom"),value:"custom"}],value:x?"custom":n,children:t}),x&&Object(b.jsx)(d.a,{onChange:function(e){F(e.target.value),""!==e.target.value.trim()&&s(e.target.value)},orientation:"vertical",value:k,children:T("components.fontSelect.customFamilyDetail")}),Object(b.jsx)(f.a,{onChange:function(e){"custom"===e.target.value?O(!0):(O(!1),c(parseFloat(e.target.value)))},options:[].concat(Object(u.a)(p.map((function(e){return{label:T("components.fontSelect.percentage",{percent:100*e}),value:e.toString()}}))),[{label:T("common.custom"),value:"custom"}]),value:g?"custom":r.toString(),children:i}),g&&Object(b.jsx)(d.a,{onChange:function(e){P(e.target.value);var t=parseInt(e.target.value);Number.isFinite(t)&&c(t/100)},orientation:"vertical",value:N,children:T("components.fontSelect.customScaleDetail")})]})},h=n(7),g=[{code:"ca",name:"Catal\xe0"},{code:"cs",name:"\u010ce\u0161tina"},{code:"da",name:"Dansk"},{code:"de",name:"Deutsch"},{code:"en",name:"English"},{code:"es",name:"Castellano"},{code:"fi",name:"Suomi"},{code:"fr",name:"Fran\xe7ais"},{code:"it",name:"Italiano"},{code:"ms",name:"Bahasa Melayu"},{code:"nb",name:"Norsk bokm\xe5l"},{code:"nl",name:"Nederlands"},{code:"pt-br",name:"Portugu\xeas Brasileiro"},{code:"pt-pt",name:"Portugu\xeas"},{code:"ru",name:"\u0440\u0443\u0441\u0441\u043a\u0438\u0439"},{code:"sv",name:"Svenska"},{code:"tr",name:"T\xfcrk\xe7e"},{code:"zh-cn",name:"\u4e2d\u6587(\u7b80\u4f53)"}];function O(e){if(g.some((function(t){return t.code===e})))return e;if(e.includes("-")){var t=e.replace(/-.+/,""),n=g.find((function(e){return e.code===t||e.code.replace(/-.+/,"")===t}));if(n)return n.code}return"en"}n(371);var v=function(e){var t=Object(h.usePrefsContext)(),n=t.dispatch,a=t.prefs,u=Object(o.a)().t;return Object(b.jsx)(c.a,Object(r.a)(Object(r.a)({},e),{},{className:"app-prefs-dialog",fixedSize:!0,headerLabel:u("dialogs.appPrefs.title"),children:Object(b.jsxs)(s.b,{children:[Object(b.jsx)(f.a,{onChange:function(e){return n(Object(h.setPref)("locale",e.target.value))},options:g.map((function(e){return{label:e.name,value:e.code}})),value:O(a.locale),children:u("dialogs.appPrefs.language")}),Object(b.jsx)(f.a,{onChange:function(e){return n(Object(h.setPref)("appTheme",e.target.value))},options:[{label:u("dialogs.appPrefs.themeSystem"),value:"system"},{label:u("dialogs.appPrefs.themeLight"),value:"light"},{label:u("dialogs.appPrefs.themeDark"),value:"dark"}],value:a.appTheme,children:u("dialogs.appPrefs.theme")}),Object(b.jsx)(f.a,{onChange:function(e){return n(Object(h.setPref)("dialogWidth",parseInt(e.target.value)))},options:[{label:u("dialogs.appPrefs.dialogWidths.default"),value:"600"},{label:u("dialogs.appPrefs.dialogWidths.wider"),value:"700"},{label:u("dialogs.appPrefs.dialogWidths.widest"),value:"800"}],value:a.dialogWidth.toString(),children:u("dialogs.appPrefs.dialogWidth")}),Object(b.jsx)(i.a,{label:u("dialogs.appPrefs.editorCursorBlinks"),onChange:function(e){return n(Object(h.setPref)("editorCursorBlinks",e))},value:a.editorCursorBlinks}),Object(b.jsx)("p",{className:"font-explanation",children:u("dialogs.appPrefs.fontExplanation")}),Object(b.jsx)(m,{familyLabel:u("dialogs.appPrefs.passageEditorFont"),fontFamily:a.passageEditorFontFamily,fontScale:a.passageEditorFontScale,onChangeFamily:function(e){return n(Object(h.setPref)("passageEditorFontFamily",e))},onChangeScale:function(e){return n(Object(h.setPref)("passageEditorFontScale",e))},scaleLabel:u("dialogs.appPrefs.passageEditorFontScale")}),Object(b.jsx)(m,{familyLabel:u("dialogs.appPrefs.codeEditorFont"),fontFamily:a.codeEditorFontFamily,fontScale:a.codeEditorFontScale,onChangeFamily:function(e){return n(Object(h.setPref)("codeEditorFontFamily",e))},onChangeScale:function(e){return n(Object(h.setPref)("codeEditorFontScale",e))},scaleLabel:u("dialogs.appPrefs.codeEditorFontScale")})]})}))}},function(e,t,n){"use strict";n.d(t,"b",(function(){return b})),n.d(t,"a",(function(){return j}));var r=n(5),a=n(0),o=n(60),s=n(81),c=n(56),i=n(14),u=n(2),l=n(10),d=n(1),f=a.createContext({dispatch:function(){},prefs:Object(c.a)()});f.displayName="Prefs";var b=function(){return a.useContext(f)},j=function(e){var t=Object(o.a)().prefs,n=Object(s.a)().reportError,b=a.useCallback((function(e,a){var o=function(e,t){switch(t.type){case"init":return Object(u.a)(Object(u.a)({},e),t.state);case"repair":var n=Object(c.a)(),a=Object.entries(n).reduce((function(t,n){var a=Object(r.a)(n,2),o=a[0],s=a[1],c=o;return"number"===typeof s&&!Number.isFinite(e[c])||typeof s!==typeof e[c]?(console.info('Repairing preference "'.concat(o,'" by setting it to ').concat(s,", ")+"was ".concat(e[c]," (bad type)")),Object(u.a)(Object(u.a)({},t),{},Object(i.a)({},c,s))):t}),{}),o=e.proofingFormat,s=e.storyFormat,d=t.allFormats;try{Object(l.formatWithNameAndVersion)(d,o.name,o.version)}catch(j){var f=Object(l.newestFormatNamed)(d,o.name);f?(console.info("Repairing proofing format preference (version doesn't exist) by setting to ".concat(f.name," ").concat(f.version,", was ").concat(o.name," ").concat(o.version)),a.proofingFormat={name:f.name,version:f.version}):(console.info("Repairing proofing format preference (format doesn't exist at all) by setting to default ".concat(n.proofingFormat.name," ").concat(n.proofingFormat.version,", was ").concat(o.name," ").concat(o.version)),a.proofingFormat={name:n.proofingFormat.name,version:n.proofingFormat.version})}try{Object(l.formatWithNameAndVersion)(d,s.name,s.version)}catch(p){var b=Object(l.newestFormatNamed)(d,s.name);b?(console.info("Repairing story format preference (version doesn't exist) by setting to ".concat(b.name," ").concat(b.version,", was ").concat(s.name," ").concat(s.version)),a.storyFormat={name:b.name,version:b.version}):(console.info("Repairing story format preference (format doesn't exist at all) by setting to default ".concat(n.storyFormat.name," ").concat(n.storyFormat.version,", was ").concat(s.name," ").concat(o.version)),a.storyFormat={name:n.storyFormat.name,version:n.storyFormat.version})}return Object(u.a)(Object(u.a)({},e),a);case"update":return Object(u.a)(Object(u.a)({},e),{},Object(i.a)({},t.name,t.value))}}(e,a);try{t.saveMiddleware(o,a)}catch(s){n(s,"store.errors.cantPersistPrefs")}return o}),[t,n]),j=a.useReducer(b,Object(c.a)()),p=Object(r.a)(j,2),m=p[0],h=p[1];return Object(d.jsx)(f.Provider,{value:{dispatch:h,prefs:m},children:e.children})}},function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"a",(function(){return g}));var r=n(5),a=n(2),o=n(19),s=n.n(o),c=n(0),i=n(79),u=n.n(i),l=n(60),d=n(75),f=n(81),b=n(11),j=n(1),p=Object(d.a)().map((function(e){return Object(a.a)(Object(a.a)({},e),{},{id:s()(),loadState:"unloaded",selected:!1,userAdded:!1})})),m=c.createContext({dispatch:function(){},formats:[]});m.displayName="StoryFormats";var h=function(){return c.useContext(m)},g=function(e){var t=Object(l.a)().storyFormats,n=Object(f.a)().reportError,o=c.useCallback((function(e,r){var o=function(e,t){switch(t.type){case"init":return Object(b.a)(t.state);case"repair":var n=Object(d.a)(),r=e.filter((function(e){var t=e.userAdded||n.some((function(t){return t.name===e.name&&t.version===e.version}));return t||console.info("Repairing story formats by removing ".concat(e.name," ").concat(e.version," ")+"(outdated version of built-in format)"),t}));return n.forEach((function(e){r.some((function(t){return t.name===e.name&&t.version===e.version}))||(console.info("Repairing story formats by adding built-in ".concat(e.name," ").concat(e.version)),r.push(Object(a.a)(Object(a.a)({},e),{},{id:s()(),loadState:"unloaded",selected:!1,userAdded:!1})))})),r;case"create":return e.some((function(e){return e.name===t.props.name&&e.version===t.props.version}))?e:[].concat(Object(b.a)(e),[Object(a.a)(Object(a.a)({},t.props),{},{id:s()(),loadState:"unloaded"})]);case"delete":return e.filter((function(e){return e.id!==t.id}));case"update":return e.some((function(e){return e.id!==t.id&&e.name===t.props.name&&e.version===t.props.version}))?e:e.map((function(e){return e.id!==t.id?e:Object(a.a)(Object(a.a)({},e),t.props)}))}return e}(e,r);try{t.saveMiddleware(o,r)}catch(c){n(c,"store.errors.cantPersistStoryFormats")}return o}),[n,t]),i=u()(o,p),h=Object(r.a)(i,2),g=h[0],O=h[1];return Object(j.jsx)(m.Provider,{value:{dispatch:O,formats:g},children:e.children})}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var r=n(2),a=(n(0),n(49)),o=n(4),s=n(13),c=n(23),i=n(62),u=n(41),l=n(161),d=(n(367),n(1)),f=function(e){var t=Object(a.a)().t,n=Object(u.a)();return Object(d.jsx)(c.a,Object(r.a)(Object(r.a)({},e),{},{className:"about-twine-dialog",fixedSize:!0,headerLabel:t("dialogs.aboutTwine.title",{version:n.version}),children:Object(d.jsxs)("div",{className:"content",children:[Object(d.jsx)("p",{children:t("dialogs.aboutTwine.twineDescription")}),Object(d.jsx)("p",{dangerouslySetInnerHTML:{__html:t("dialogs.aboutTwine.license")}}),Object(d.jsxs)("div",{className:"credits",children:[Object(d.jsxs)("div",{className:"code",children:[Object(d.jsx)("h3",{children:t("dialogs.aboutTwine.codeHeader")}),Object(d.jsx)("ul",{children:l.code.map((function(e){return Object(d.jsx)("li",{children:e},e)}))})]}),Object(d.jsxs)("div",{className:"localizations",children:[Object(d.jsx)("h3",{children:t("dialogs.aboutTwine.localizationHeader")}),Object(d.jsx)("ul",{children:l.localizations.map((function(e){return Object(d.jsx)("li",{children:e},e)}))})]})]}),Object(d.jsxs)(s.a,{children:[Object(d.jsx)(i.a,{href:"https://twinery.org/donate",icon:Object(d.jsx)(o.B,{}),label:t("dialogs.aboutTwine.donateToTwine"),variant:"primary"}),Object(d.jsx)(i.a,{href:"https://github.com/klembot/twinejs",icon:Object(d.jsx)(o.r,{}),label:t("dialogs.aboutTwine.codeRepo")})]})]})}))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,,,function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},function(e,t,n){},,,,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},function(e,t,n){},,function(e,t,n){},function(e,t,n){},function(e,t,n){"use strict";n.r(t);var r=n(0),a=n(55),o=n(37),s=n(57),c=(n(266),n(1)),i=function(){return Object(c.jsx)("div",{className:"loading-curtain",children:Object(c.jsx)(s.b,{})})},u=n(7),l=n(59),d=function(){var e=Object(u.usePrefsContext)().prefs;return r.useEffect((function(){l.a.changeLanguage(e.locale)}),[e.locale]),null},f=n(42),b=n(24),j=n(31),p=n(49),m=n(510),h=n(165),g=(n(153),function(e){var t=e.children,n=e.ignoreSelector,r=e.onClickAway;return Object(c.jsx)("div",{onClick:function(e){var t;n?(null===(t=e.target)||void 0===t?void 0:t.closest(n))||r():r()},children:t})}),O=(n(357),function(e){var t,n={gridTemplateColumns:"columnWidth"in e?"repeat(auto-fit, ".concat("number"===typeof e.columnWidth?e.columnWidth+"px":e.columnWidth,")"):"repeat(".concat(e.columns,", 1fr)"),maxWidth:null!==(t=e.maxWidth)&&void 0!==t?t:"auto"};return Object(c.jsx)("div",{className:"card-group",style:n,children:e.children})}),v=n(20),y=n.n(v),x=n(124),w=n(30),S=function(e){var t=e.title;return r.useEffect((function(){if(Object(w.a)()){var e=window.setTimeout((function(){document.querySelector("title").innerHTML=t}),0);return function(){return window.clearTimeout(e)}}}),[t]),Object(c.jsx)(x.a,{children:Object(c.jsx)("title",{children:t})})},C=(n(360),r.forwardRef((function(e,t){var n,a=e.children,o=e.grabbable,s=e.title,i=r.useRef(null),u=y()("main-content",{padded:null===(n=e.padded)||void 0===n||n});return r.useImperativeHandle(t,(function(){return i.current})),r.useEffect((function(){i.current&&i.current.focus()}),[]),r.useEffect((function(){var e,t,n=i.current;function r(r){n&&(n.scrollLeft=e.left+(t.left-r.clientX),n.scrollTop=e.top+(t.top-r.clientY))}function a(e){2===e.button&&n&&(n.releasePointerCapture(e.pointerId),n.removeEventListener("pointermove",r),n.style.cursor="",e.preventDefault())}function s(o){2===o.button&&n&&(n.setPointerCapture(o.pointerId),n.addEventListener("pointermove",r),n.addEventListener("pointerup",a),n.style.cursor="grabbing",e={left:n.scrollLeft,top:n.scrollTop},t={left:o.clientX,top:o.clientY},o.preventDefault())}function c(e){e.preventDefault()}if(o&&n)return n.addEventListener("pointerdown",s),n.addEventListener("contextmenu",c),function(){n.removeEventListener("pointerdown",s),n.removeEventListener("contextmenu",c)}}),[o]),Object(c.jsxs)("div",{className:u,ref:i,children:[s&&Object(c.jsxs)(c.Fragment,{children:[Object(c.jsx)(S,{title:s}),Object(c.jsx)("h1",{children:s})]}),a]})}))),k=n(4),F=n(10),E=(n(361),function(e){var t=e.label;return Object(c.jsx)("span",{className:"badge",children:t})}),I=n(16),N=n(2),P=n(18),T=n(71),D=(n(362),function(e){var t=e.label,n=e.onDoubleClick,a=e.onSelect,o=e.selected,s=Object(P.a)(e,["label","onDoubleClick","onSelect","selected"]),i=r.useCallback((function(e){e.ctrlKey||e.shiftKey?a(!o,!1):a(!0,!0)}),[a,o]),u=r.useCallback((function(e){" "!==e.key&&"Enter"!==e.key||(e.preventDefault(),e.ctrlKey||e.shiftKey?a(!o,!1):a(!0,!0))}),[a,o]);return Object(c.jsx)("div",{className:y()("selectable-card",{selected:o}),role:"button","aria-label":t,"aria-pressed":o,onClick:i,onDoubleClick:n,onKeyDown:u,tabIndex:0,children:Object(c.jsx)(T.a,Object(N.a)({},s))})}),L=function(e){var t=e.format,n=Object(p.a)().t;return"unloaded"===t.loadState||"loading"===t.loadState?Object(c.jsx)("div",{className:"story-format-card-details",children:Object(c.jsx)("p",{children:n("components.storyFormatCard.loadingFormat")})}):"error"===t.loadState?Object(c.jsx)("div",{className:"story-format-card-details",children:Object(c.jsx)("p",{children:n("components.storyFormatCard.loadError",{errorMessage:t.loadError.message})})}):Object(c.jsxs)("div",{className:"story-format-card-details",children:[t.properties.author&&Object(c.jsx)("p",{className:"story-format-card-author",dangerouslySetInnerHTML:{__html:n("components.storyFormatCard.author",{author:t.properties.author})}}),t.properties.description&&Object(c.jsx)("div",{className:"story-format-card-description",dangerouslySetInnerHTML:{__html:t.properties.description}}),t.properties.license&&Object(c.jsx)("p",{className:"story-format-card-license",children:n("components.storyFormatCard.license",{license:t.properties.license})})]})},A=(n(363),function(e){var t=e.defaultFormat,n=e.editorExtensionsDisabled,r=e.format,a=e.onSelect,o=e.proofingFormat,i=Object(p.a)().t,u=Object(c.jsx)(c.Fragment,{});return"error"===r.loadState?u=Object(c.jsx)(k.b,{}):"unloaded"===r.loadState||"loading"===r.loadState?u=Object(c.jsx)(s.b,{}):"loaded"===r.loadState&&r.properties.image&&(u=Object(c.jsx)("img",{src:Object(F.formatImageUrl)(r),alt:""})),Object(c.jsx)("div",{className:"story-format-card",children:Object(c.jsx)(D,{label:i("components.storyFormatCard.name",{name:r.name,version:r.version}),onSelect:a,selected:r.selected,children:Object(c.jsxs)(I.b,{children:[Object(c.jsx)("div",{className:"story-format-image",children:u}),Object(c.jsxs)("div",{className:"story-format-description",children:[Object(c.jsx)("h2",{children:i("components.storyFormatCard.name",{name:r.name,version:r.version})}),Object(c.jsx)(L,{format:r})]}),Object(c.jsxs)("div",{className:"story-format-badges",children:[!r.userAdded&&Object(c.jsx)(E,{label:i("components.storyFormatCard.builtIn")}),t&&Object(c.jsx)(E,{label:i("components.storyFormatCard.defaultFormat")}),n&&Object(c.jsx)(E,{label:i("components.storyFormatCard.editorExtensionsDisabled")}),"loaded"===r.loadState&&r.properties.proofing&&Object(c.jsx)(E,{label:i("components.storyFormatCard.proofing")}),o&&Object(c.jsx)(E,{label:i("components.storyFormatCard.proofingFormat")})]})]})})})}),M=n(17),z=n(134),R=n(14),W=n(5),U=n(95),B=n(6),V=function(){var e=Object(b.f)(),t=Object(p.a)().t;return["/","/stories"].includes(e.location.pathname)?null:Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.f,{}),variant:"primary",label:e.length>1?t("common.back"):t("routes.storyList.titleGeneric"),onClick:function(){return e.length>1?e.goBack():e.push("/")}})},H=(n(426),function(e){var t=e.helpUrl,n=void 0===t?"https://twinery.org/2guide":t,r=e.pinnedControls,a=e.tabs,o=Object(p.a)().t;return Object(c.jsx)("div",{className:"route-toolbar",children:Object(c.jsxs)(U.d,{selectedTabClassName:"selected",children:[Object(c.jsxs)("div",{className:"route-toolbar-top",children:[Object(c.jsx)(V,{}),Object(c.jsx)(U.b,{className:"route-toolbar-tablist",children:Object.keys(a).map((function(e){return Object(c.jsx)(U.a,{className:"route-toolbar-tab",children:e},e)}))}),Object(c.jsxs)("div",{className:"route-toolbar-pinned-controls",children:[r,Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.C,{}),label:o("common.help"),onClick:function(){return window.open(n,"_blank")}})]})]}),Object(c.jsx)("div",{children:Object.entries(a).map((function(e){var t=Object(W.a)(e,2),n=t[0],r=t[1];return Object(c.jsx)(U.c,{children:r},n)}))})]})})}),Y=n(8),J=n.n(Y),X=n(12),_=n(13),G=n(47),K=n(32),$=n(43),q=n(3),Z=n(41);function Q(){var e=Object(u.usePrefsContext)().prefs,t=Object(F.useStoryFormatsContext)(),n=t.dispatch,a=t.formats,o=Object(q.useStoriesContext)().stories;return{publishArchive:r.useCallback(Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object($.b)(o,Object(Z.a)()));case 1:case"end":return e.stop()}}),e)}))),[o]),proofStory:r.useCallback(function(){var t=Object(X.a)(J.a.mark((function t(r){var s,c,i;return J.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return s=Object(q.storyWithId)(o,r),c=Object(F.formatWithNameAndVersion)(a,e.proofingFormat.name,e.proofingFormat.version),t.next=4,Object(F.loadFormatProperties)(c)(n);case 4:if(i=t.sent){t.next=7;break}throw new Error("Couldn't load story format properties");case 7:return t.abrupt("return",Object($.d)(s,i.source,Object(Z.a)()));case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),[a,e.proofingFormat.name,e.proofingFormat.version,o,n]),publishStory:r.useCallback(function(){var e=Object(X.a)(J.a.mark((function e(t,r){var s,c,i;return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=Object(q.storyWithId)(o,t),c=Object(F.formatWithNameAndVersion)(a,s.storyFormat,s.storyFormatVersion),e.next=4,Object(F.loadFormatProperties)(c)(n);case 4:if(i=e.sent){e.next=7;break}throw new Error("Couldn't load story format properties");case 7:return e.abrupt("return",Object($.d)(s,i.source,Object(Z.a)(),r));case 8:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),[a,o,n]),publishStoryData:r.useCallback((function(e){var t=Object(q.storyWithId)(o,e);return Object($.c)(t,Object(Z.a)(),{startOptional:!0})}),[o])}}function ee(){var e=Q(),t=e.proofStory,n=e.publishStory;if(Object(w.a)()){var r=window.twineElectron;if(!r)throw new Error("Electron bridge is not present on window.");return{playStory:function(){var e=Object(X.a)(J.a.mark((function e(t){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r.ipcRenderer,e.next=3,n(t);case 3:e.t1=e.sent,e.t0.send.call(e.t0,"open-with-temp-file",e.t1,".html");case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),proofStory:function(){var e=Object(X.a)(J.a.mark((function e(n){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r.ipcRenderer,e.next=3,t(n);case 3:e.t1=e.sent,e.t0.send.call(e.t0,"open-with-temp-file",e.t1,".html");case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),testStory:function(){var e=Object(X.a)(J.a.mark((function e(t,a){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r.ipcRenderer,e.next=3,n(t,{formatOptions:"debug",startId:a});case 3:e.t1=e.sent,e.t0.send.call(e.t0,"open-with-temp-file",e.t1,".html");case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}}return{playStory:function(){var e=Object(X.a)(J.a.mark((function e(t){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:window.open("#/stories/".concat(t,"/play"),"_blank");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),proofStory:function(){var e=Object(X.a)(J.a.mark((function e(t){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:window.open("#/stories/".concat(t,"/proof"),"_blank");case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),testStory:function(){var e=Object(X.a)(J.a.mark((function e(t,n){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:window.open(n?"#/stories/".concat(t,"/test/").concat(n):"#/stories/".concat(t,"/test"),"_blank");case 1:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}}var te=n(237);function ne(e,t){var n=new Blob([e],{type:"text/html;charset=utf-8"});Object(te.saveAs)(n,t)}var re=function(e){var t,n,a,o,s=e.story,i=Q().publishStory,u=r.useState(),l=Object(W.a)(u,2),d=l[0],f=l[1],b=r.useState(),j=Object(W.a)(b,2),m=j[0],h=j[1],g=r.useState(),O=Object(W.a)(g,2),v=O[0],y=O[1],x=r.useState(),w=Object(W.a)(x,2),S=w[0],C=w[1],F=ee(),E=F.playStory,N=F.proofStory,P=F.testStory,T=Object(p.a)().t;function D(){f(void 0),h(void 0),y(void 0),C(void 0)}function L(){return(L=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=2;break}throw new Error("No story provided to publish");case 2:return D(),e.prev=3,e.next=6,E(s.id);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),f(e.t0);case 11:case"end":return e.stop()}}),e,null,[[3,8]])})))).apply(this,arguments)}function A(){return(A=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=2;break}throw new Error("No story provided to publish");case 2:return D(),e.prev=3,e.next=6,N(s.id);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),h(e.t0);case 11:case"end":return e.stop()}}),e,null,[[3,8]])})))).apply(this,arguments)}function M(){return(M=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=2;break}throw new Error("No story provided to publish");case 2:return D(),e.prev=3,e.t0=ne,e.next=7,i(s.id);case 7:e.t1=e.sent,e.t2=Object(K.storyFileName)(s),(0,e.t0)(e.t1,e.t2),e.next=15;break;case 12:e.prev=12,e.t3=e.catch(3),y(e.t3);case 15:case"end":return e.stop()}}),e,null,[[3,12]])})))).apply(this,arguments)}function z(){return(z=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=2;break}throw new Error("No story provided to publish");case 2:return D(),e.prev=3,e.next=6,P(s.id);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),C(e.t0);case 11:case"end":return e.stop()}}),e,null,[[3,8]])})))).apply(this,arguments)}return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(G.a,{ariaLabel:null!==(t=null===S||void 0===S?void 0:S.message)&&void 0!==t?t:"",disabled:!s,icon:Object(c.jsx)(k.X,{}),label:T("routeActions.build.test"),onChangeOpen:function(){return C(void 0)},onClick:function(){return z.apply(this,arguments)},open:!!S,children:Object(c.jsxs)(I.b,{children:[Object(c.jsx)("p",{children:null===S||void 0===S?void 0:S.message}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.ab,{}),label:T("common.close"),onClick:function(){return C(void 0)},variant:"primary"})]})}),Object(c.jsx)(G.a,{ariaLabel:null!==(n=null===d||void 0===d?void 0:d.message)&&void 0!==n?n:"",disabled:!s,icon:Object(c.jsx)(k.K,{}),label:T("routeActions.build.play"),onChangeOpen:function(){return f(void 0)},onClick:function(){return L.apply(this,arguments)},open:!!d,children:Object(c.jsxs)(I.b,{children:[Object(c.jsx)("p",{children:null===d||void 0===d?void 0:d.message}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.ab,{}),label:T("common.close"),onClick:function(){return f(void 0)},variant:"primary"})]})}),Object(c.jsx)(G.a,{ariaLabel:null!==(a=null===m||void 0===m?void 0:m.message)&&void 0!==a?a:"",disabled:!s,icon:Object(c.jsx)(k.v,{}),label:T("routeActions.build.proof"),onChangeOpen:function(){return h(void 0)},onClick:function(){return A.apply(this,arguments)},open:!!m,children:Object(c.jsxs)(I.b,{children:[Object(c.jsx)("p",{children:null===m||void 0===m?void 0:m.message}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.ab,{}),label:T("common.close"),onClick:function(){return h(void 0)},variant:"primary"})]})}),Object(c.jsx)(G.a,{ariaLabel:null!==(o=null===v||void 0===v?void 0:v.message)&&void 0!==o?o:"",disabled:!s,icon:Object(c.jsx)(k.y,{}),label:T("routeActions.build.publishToFile"),onChangeOpen:function(){return y(void 0)},onClick:function(){return M.apply(this,arguments)},open:!!v,children:Object(c.jsxs)(I.b,{children:[Object(c.jsx)("p",{children:null===v||void 0===v?void 0:v.message}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.ab,{}),label:T("common.close"),onClick:function(){return y(void 0)},variant:"primary"})]})})]})},ae=function(){var e=Object(M.useDialogsContext)().dispatch,t=Object(b.f)(),n=Object(p.a)().t;return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.R,{}),label:n("routeActions.app.preferences"),onClick:function(){return e({type:"addDialog",component:M.AppPrefsDialog})}}),Object(c.jsx)(B.a,{disabled:"/story-formats"===t.location.pathname,icon:Object(c.jsx)(k.w,{}),label:n("routeActions.app.storyFormats"),onClick:function(){return t.push("/story-formats")}}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.k,{}),label:n("routeActions.app.aboutApp"),onClick:function(){return e({type:"addDialog",component:M.AboutTwineDialog})}}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.m,{}),label:n("routeActions.app.reportBug"),onClick:function(){return window.open("https://twinery.org/2bugs","_blank")}})]})},oe=n(52),se=n(39);n(427);function ce(e){try{return new URL(e),!0}catch(t){}return!1}var ie=function(){var e=Object(F.useStoryFormatsContext)(),t=e.dispatch,n=e.formats,a=r.useState(""),o=Object(W.a)(a,2),s=o[0],i=o[1],u=Object(p.a)().t;function l(){return(l=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.t1=F.createFromProperties,e.t2=s,e.next=5,Object(se.a)(s);case 5:e.t3=e.sent,e.t4=(0,e.t1)(e.t2,e.t3),(0,e.t0)(e.t4);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var d=function(){var e=Object(X.a)(J.a.mark((function e(t){var r;return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""!==s.trim()){e.next=2;break}return e.abrupt("return",{valid:!1});case 2:if(ce(s)){e.next=4;break}return e.abrupt("return",{message:u("routes.storyFormatList.toolbar.addStoryFormatButton.invalidUrl"),valid:!1});case 4:return e.prev=4,e.next=7,Object(se.a)(s);case 7:if(r=e.sent,!n.some((function(e){return e.name===r.name&&e.version===r.version}))){e.next=10;break}return e.abrupt("return",{message:u("routes.storyFormatList.toolbar.addStoryFormatButton.alreadyAdded",{storyFormatName:r.name,storyFormatVersion:r.version}),valid:!1});case 10:return e.abrupt("return",{message:u("routes.storyFormatList.toolbar.addStoryFormatButton.addPreview",{storyFormatName:r.name,storyFormatVersion:r.version}),valid:!0});case 13:return e.prev=13,e.t0=e.catch(4),e.abrupt("return",{message:u("routes.storyFormatList.toolbar.addStoryFormatButton.fetchError",{errorMessage:e.t0.message}),valid:!1});case 16:case"end":return e.stop()}}),e,null,[[4,13]])})));return function(t){return e.apply(this,arguments)}}();return Object(c.jsx)("span",{className:"add-format-button",children:Object(c.jsx)(oe.a,{icon:Object(c.jsx)(k.L,{}),label:u("common.add"),onChange:function(e){return i(e.target.value)},onSubmit:function(){return l.apply(this,arguments)},prompt:u("routes.storyFormatList.toolbar.addStoryFormatButton.prompt"),submitIcon:Object(c.jsx)(k.L,{}),submitLabel:u("common.add"),submitVariant:"create",validate:d,value:s})})},ue=function(e){var t=e.format,n=Object(u.usePrefsContext)(),r=n.dispatch,a=n.prefs,o=Object(p.a)().t,s="loaded"!==(null===t||void 0===t?void 0:t.loadState)||t.properties.proofing||a.storyFormat.name===t.name&&a.storyFormat.version===t.version;return Object(c.jsx)(B.a,{disabled:s,icon:Object(c.jsx)(k.U,{}),label:o("routes.storyFormatList.toolbar.useAsDefaultFormat"),onClick:function(){if(!t)throw new Error("Can't set undefined format as default");r({type:"update",name:"storyFormat",value:{name:t.name,version:t.version}})}})},le=function(e){var t=e.format,n=Object(u.usePrefsContext)(),r=n.dispatch,a=n.prefs,o=Object(p.a)().t,s="loaded"!==(null===t||void 0===t?void 0:t.loadState)||!t.properties.proofing||a.proofingFormat.name===t.name&&a.proofingFormat.version===t.version;return Object(c.jsx)(B.a,{disabled:s,icon:Object(c.jsx)(k.v,{}),label:o("routes.storyFormatList.toolbar.useAsProofingFormat"),onClick:function(){if(!t)throw new Error("Can't set undefined format as proofing");r({type:"update",name:"proofingFormat",value:{name:t.name,version:t.version}})}})},de=function(e){var t=e.format,n=Object(F.useStoryFormatsContext)().dispatch,r=Object(u.usePrefsContext)().prefs,a=Object(p.a)().t,o=(null===t||void 0===t?void 0:t.name)===r.storyFormat.name&&(null===t||void 0===t?void 0:t.version)===r.storyFormat.version,s=(null===t||void 0===t?void 0:t.name)===r.proofingFormat.name&&(null===t||void 0===t?void 0:t.version)===r.proofingFormat.version;return Object(c.jsx)(B.a,{disabled:!t||!t.userAdded||o||s,icon:Object(c.jsx)(k.Y,{}),label:a("common.remove"),onClick:function(){return t&&n(Object(F.deleteFormat)(t))}})},fe=n(11),be=function(e){var t=e.format,n=Object(u.usePrefsContext)(),r=n.dispatch,a=n.prefs,o=Object(p.a)().t,s=a.disabledStoryFormatEditorExtensions.some((function(e){return e.name===(null===t||void 0===t?void 0:t.name)&&e.version===(null===t||void 0===t?void 0:t.version)}));return Object(c.jsx)(B.a,{disabled:!t,icon:Object(c.jsx)(k.M,{}),label:o("routes.storyFormatList.toolbar.".concat(s?"enable":"disable","FormatExtensions")),onClick:function(){if(!t)throw new Error("Format is not set");r(s?Object(u.setPref)("disabledStoryFormatEditorExtensions",a.disabledStoryFormatEditorExtensions.filter((function(e){return e.name!==t.name||e.version!==t.version}))):Object(u.setPref)("disabledStoryFormatEditorExtensions",[].concat(Object(fe.a)(a.disabledStoryFormatEditorExtensions),[{name:t.name,version:t.version}])))}})},je=function(e){var t=e.selectedFormats,n=1===t.length?t[0]:void 0;return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(ie,{}),Object(c.jsx)(de,{format:n}),Object(c.jsx)(be,{format:n}),Object(c.jsx)(ue,{format:n}),Object(c.jsx)(le,{format:n})]})},pe=n(28),me=function(){var e=Object(u.usePrefsContext)(),t=e.dispatch,n=e.prefs,r=Object(p.a)().t;function a(e){t(Object(u.setPref)("storyFormatListFilter",e))}return Object(c.jsxs)(c.Fragment,{children:[Object(c.jsx)(pe.a,{disabled:"current"===n.storyFormatListFilter,label:r("routes.storyFormatList.title.current"),onChange:function(){return a("current")},value:"current"===n.storyFormatListFilter}),Object(c.jsx)(pe.a,{disabled:"user"===n.storyFormatListFilter,label:r("routes.storyFormatList.title.user"),onChange:function(){return a("user")},value:"user"===n.storyFormatListFilter}),Object(c.jsx)(pe.a,{disabled:"all"===n.storyFormatListFilter,label:r("routes.storyFormatList.title.all"),onChange:function(){return a("all")},value:"all"===n.storyFormatListFilter})]})},he=function(e){var t,n=e.selectedFormats,r=Object(p.a)().t;return Object(c.jsx)(H,{tabs:(t={},Object(R.a)(t,r("common.storyFormat"),Object(c.jsx)(je,{selectedFormats:n})),Object(R.a)(t,r("common.view"),Object(c.jsx)(me,{})),Object(R.a)(t,r("common.appName"),Object(c.jsx)(ae,{})),t)})},ge=function(){var e=Object(F.useStoryFormatsContext)(),t=e.dispatch,n=e.formats,a=Object(u.usePrefsContext)(),o=a.dispatch,s=a.prefs,i=Object(p.a)().t,l=n.filter((function(e){return e.selected})),d=Object(F.sortFormats)(Object(F.filteredFormats)(n,s.storyFormatListFilter));return r.useEffect((function(){var e,n=Object(j.a)(l);try{for(n.s();!(e=n.n()).done;){var r=e.value;r.selected&&!d.includes(r)&&t(Object(F.deselectFormat)(r))}}catch(a){n.e(a)}finally{n.f()}}),[o,l,d,t]),Object(c.jsx)("div",{className:"story-format-list-route",children:Object(c.jsxs)(M.DialogsContextProvider,{children:[Object(c.jsx)(he,{selectedFormats:l}),Object(c.jsx)(g,{ignoreSelector:".story-format-card",onClickAway:function(){return t(Object(F.deselectAllFormats)())},children:Object(c.jsxs)(C,{title:i("routes.storyFormatList.title.".concat(s.storyFormatListFilter)),children:[Object(c.jsx)("p",{children:i(d.length>0?"routes.storyFormatList.storyFormatExplanation":"routes.storyFormatList.noneVisible")}),Object(c.jsx)(z.a,{children:Object(c.jsx)(O,{columnWidth:"450px",children:Object(c.jsx)(m.a,{component:null,children:d.map((function(e){return Object(c.jsx)(h.a,{classNames:"pop",timeout:200,children:Object(c.jsx)(A,{defaultFormat:e.name===s.storyFormat.name&&e.version===s.storyFormat.version,editorExtensionsDisabled:s.disabledStoryFormatEditorExtensions.some((function(t){return e.name===t.name&&e.version===t.version})),format:e,onSelect:function(){return function(e){t(Object(F.selectFormat)(e,!0))}(e)},proofingFormat:e.name===s.proofingFormat.name&&e.version===s.proofingFormat.version})},e.id)}))})})})]})})]})})},Oe=n(22),ve=n(129),ye=function(e){var t=e.getCenter,n=e.story,a=Object(Oe.useUndoableStoriesContext)().dispatch,o=r.useCallback((function(){var e=t(),r=e.left,o=e.top;a(Object(q.createUntitledPassage)(n,r,o),"undoChange.newPassage")}),[a,t,n]),s=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.L,{}),label:s("common.new"),onClick:o})},xe=n(94),we=function(e){var t=e.passages,n=e.story,a=Object(Oe.useUndoableStoriesContext)().dispatch,o=Object(p.a)().t,s=r.useMemo((function(){return 0===t.length||t.some((function(e){return n.startPassage===e.id}))}),[t,n.startPassage]),i=r.useCallback((function(){0!==t.length&&a(Object(q.deletePassages)(n,t),t.length>1?"undoChange.deletePassages":"undoChange.deletePassage")}),[a,t,n]);return Object(xe.a)("Backspace,Delete",i,[i]),Object(c.jsx)(B.a,{disabled:s,icon:Object(c.jsx)(k.Y,{}),label:!s&&t.length>1?o("common.deleteCount",{count:t.length}):o("common.delete"),onClick:i})},Se=function(e){var t=e.passages,n=e.story,r=Object(M.useDialogsContext)().dispatch,a=Object(p.a)().t;return Object(c.jsx)(B.a,{disabled:0===t.length,icon:Object(c.jsx)(k.u,{}),label:t.length>1?a("common.editCount",{count:t.length}):a("common.edit"),onClick:function(){r((function(e){return t.forEach((function(t){return e({type:"addDialog",component:M.PassageEditDialog,props:{passageId:t.id,storyId:n.id}})}))}))}})},Ce=function(e){var t=e.story,n=Object(q.useStoriesContext)().dispatch,r=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.H,{}),label:r("common.selectAll"),onClick:function(){return n(Object(q.selectAllPassages)(t))}})},ke=function(e){var t=e.passage,n=e.story,r=Object(q.useStoriesContext)(),a=r.dispatch,o=r.stories,s=Object(p.a)().t;return Object(c.jsx)(B.a,{disabled:!t||t.id===n.startPassage,icon:Object(c.jsx)(k.P,{}),label:s("routes.storyEdit.toolbar.startStoryHere"),onClick:function(){if(!t)throw new Error("No passage set");a(Object(q.updateStory)(o,n,{startPassage:t.id}))}})},Fe=function(e){var t=e.passage,n=e.story,r=ee().testStory,a=Object(p.a)().t;return Object(c.jsx)(B.a,{disabled:!t,icon:Object(c.jsx)(k.X,{}),label:a("routes.storyEdit.toolbar.testFromHere"),onClick:function(){return r(n.id,null===t||void 0===t?void 0:t.id)}})},Ee=function(e){var t=e.getCenter,n=e.story,a=Object(q.useStoriesContext)().dispatch,o=r.useMemo((function(){return n.passages.filter((function(e){return e.selected}))}),[n.passages]),s=r.useMemo((function(){return 1===o.length?o[0]:void 0}),[o]);return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(ye,{getCenter:t,story:n}),Object(c.jsx)(Se,{passages:o,story:n}),Object(c.jsx)(ve.a,{onRename:function(e){return function(e,t){if(!t)throw new Error("Passage is unset");a(Object(q.updatePassage)(n,t,{name:e},{dontUpdateOthers:!0}))}(e,s)},passage:s,story:n}),Object(c.jsx)(we,{passages:o,story:n}),Object(c.jsx)(Fe,{passage:s,story:n}),Object(c.jsx)(ke,{passage:s,story:n}),Object(c.jsx)(Ce,{story:n})]})},Ie=function(){var e=Object(p.a)().t;return Object(c.jsx)(B.a,{disabled:!0,icon:Object(c.jsx)(k.Z,{}),label:e("common.rename")})},Ne=function(e){var t=e.existingStories,n=e.onRename,a=e.story,o=r.useState(a.name),s=Object(W.a)(o,2),i=s[0],u=s[1],l=Object(p.a)().t;return r.useEffect((function(){return u(a.name)}),[a]),Object(c.jsx)(oe.a,{icon:Object(c.jsx)(k.Z,{}),label:l("common.rename"),onChange:function(e){return u(e.target.value)},onSubmit:n,prompt:l("common.renamePrompt",{name:a.name}),validate:function(e){return""===e.trim()?{message:l("components.renameStoryButton.emptyName"),valid:!1}:t.some((function(t){return t.id!==a.id&&Object(K.storyFileName)(t)===Object(K.storyFileName)(Object(N.a)(Object(N.a)({},a),{},{name:e}))}))?{message:l("components.renameStoryButton.nameAlreadyUsed"),valid:!1}:{valid:!0}},value:i})},Pe=function(e){return e.story?Object(c.jsx)(Ne,Object(N.a)({},e)):Object(c.jsx)(Ie,{})},Te=function(e){var t=e.story,n=Object(M.useDialogsContext)().dispatch,r=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.F,{}),label:r("common.details"),onClick:function(){return n({type:"addDialog",component:M.StoryDetailsDialog,props:{storyId:t.id}})}})},De=function(e){var t=e.story,n=Object(M.useDialogsContext)().dispatch,r=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.Q,{}),label:r("routes.storyEdit.toolbar.findAndReplace"),onClick:function(){return n({type:"addDialog",component:M.StorySearchDialog,props:{storyId:t.id}})}})},Le=function(e){var t=e.story,n=Object(M.useDialogsContext)().dispatch,r=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.l,{}),label:r("routes.storyEdit.toolbar.javaScript"),onClick:function(){return n({type:"addDialog",component:M.StoryJavaScriptDialog,props:{storyId:t.id}})}})},Ae=function(e){var t=e.story,n=Object(M.useDialogsContext)().dispatch,r=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.W,{}),label:r("routes.storyEdit.toolbar.passageTags"),onClick:function(){return n({type:"addDialog",component:M.PassageTagsDialog,props:{storyId:t.id}})}})},Me=function(e){var t=e.story,n=Object(M.useDialogsContext)().dispatch,r=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.A,{}),label:r("routes.storyEdit.toolbar.stylesheet"),onClick:function(){return n({type:"addDialog",component:M.StoryStylesheetDialog,props:{storyId:t.id}})}})},ze=function(e){var t=Object(q.useStoriesContext)(),n=t.dispatch,r=t.stories,a=e.story;return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(De,{story:a}),Object(c.jsx)(Pe,{existingStories:r,onRename:function(e){return n(Object(q.updateStory)(r,a,{name:e}))},story:a}),Object(c.jsx)(Te,{story:a}),Object(c.jsx)(Ae,{story:a}),Object(c.jsx)(Le,{story:a}),Object(c.jsx)(Me,{story:a})]})},Re=function(){var e=Object(Oe.useUndoableStoriesContext)(),t=e.redo,n=e.redoLabel,r=e.undo,a=e.undoLabel,o=Object(p.a)().t;return Object(c.jsxs)(c.Fragment,{children:[Object(c.jsx)(B.a,{disabled:!r,icon:Object(c.jsx)(k.c,{}),label:null!==a&&void 0!==a?a:o("common.undo"),onClick:r}),Object(c.jsx)(B.a,{disabled:!t,icon:Object(c.jsx)(k.e,{}),label:null!==n&&void 0!==n?n:o("common.redo"),onClick:t})]})},We=function(e){var t,n=e.getCenter,r=e.story,a=Object(p.a)().t;return Object(c.jsx)(H,{pinnedControls:Object(c.jsx)(Re,{}),tabs:(t={},Object(R.a)(t,a("common.passage"),Object(c.jsx)(Ee,{getCenter:n,story:r})),Object(R.a)(t,a("common.story"),Object(c.jsx)(ze,{story:r})),Object(R.a)(t,a("common.build"),Object(c.jsx)(re,{story:r})),Object(R.a)(t,a("common.appName"),Object(c.jsx)(ae,{})),t)})},Ue=(n(428),n(128)),Be=(n(429),n(126)),Ve=r.memo((function(e){var t=e.story,n=Object(q.useStoriesContext)(),a=n.dispatch,o=n.stories,s=Object(p.a)().t,i=Object(Be.useScrollbarSize)().height,u=r.useCallback((function(e){a(Object(q.updateStory)(o,t,{zoom:e}))}),[a,o,t]),l={marginBottom:i};return Object(c.jsx)("div",{className:"zoom-buttons",style:l,children:Object(c.jsxs)(Ue.a,{children:[Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.S,{}),iconOnly:!0,label:s("routes.storyEdit.zoomButtons.passageNamesAndExcerpts"),onClick:function(){return u(1)},selectable:!0,selected:1===t.zoom,tooltipPosition:"right"}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.G,{}),iconOnly:!0,label:s("routes.storyEdit.zoomButtons.passageNames"),onClick:function(){return u(.6)},selectable:!0,selected:.6===t.zoom,tooltipPosition:"right"}),Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.z,{}),iconOnly:!0,label:s("routes.storyEdit.zoomButtons.storyStructure"),onClick:function(){return u(.3)},selectable:!0,selected:.3===t.zoom,tooltipPosition:"right"})]})})}));Ve.displayName="ZoomButtons";var He=n(238);function Ye(e,t){var n=r.useState(e),a=Object(W.a)(n,2),o=a[0],s=a[1],c=r.useRef(),i=r.useCallback((function(){c.current&&window.requestAnimationFrame((function(e){var t=c.current;if(t.lastTimestamp){t.elapsed+=(e-t.lastTimestamp)/500,t.lastTimestamp=e;var n=function(e,t,n,r){var a;if(r<1)return e(a=t+n*Object(He.quadOut)(r)),a;e(t+n)}(s,t.zoom.start,t.zoom.change,t.elapsed);if(n){var r=t.scrollNormalizedCenter.left*n-t.scrollCenter.width,a=t.scrollNormalizedCenter.top*n-t.scrollCenter.height;r>=0&&a>=0&&(t.scrollTarget.scrollLeft=r,t.scrollTarget.scrollTop=a),i()}else c.current=void 0}else t.lastTimestamp=e,i()}))}),[]);return r.useEffect((function(){!c.current&&o!==e&&t&&(c.current={scrollTarget:t,elapsed:0,scrollNormalizedCenter:{left:(t.scrollLeft+t.clientWidth/2)/o,top:(t.scrollTop+t.clientHeight/2)/o},scrollCenter:{height:t.clientHeight/2,width:t.clientWidth/2},zoom:{start:o,change:e-o}},window.requestAnimationFrame(i))}),[o,t,i,e]),o}var Je=n(25),Xe=(n(460),function(e){var t=e.container,n=e.ignoreEventsOnSelector,a=e.onSelectRect,o=e.onTemporarySelectRect,s=r.useState(!1),i=Object(W.a)(s,2),u=i[0],l=i[1],d=r.useState(!1),f=Object(W.a)(d,2),b=f[0],j=f[1],p=r.useState(),m=Object(W.a)(p,2),h=m[0],g=m[1],O=r.useState(),v=Object(W.a)(O,2),y=v[0],x=v[1];r.useEffect((function(){var e,r=t.current;function a(t){return{left:t.clientX-e.left+r.scrollLeft,top:t.clientY-e.top+r.scrollTop}}function o(e){r&&(r.releasePointerCapture(e.pointerId),r.removeEventListener("pointermove",s),r.removeEventListener("pointerup",o),j(!1))}function s(e){x(a(e))}function c(t){"touch"!==t.pointerType&&0===t.button&&r&&(n&&t.target.closest(n)||(e=r.getBoundingClientRect(),r.setPointerCapture(t.pointerId),r.addEventListener("pointermove",s),r.addEventListener("pointerup",o),l(!(!t.shiftKey&&!t.ctrlKey)),j(!0),g(a(t)),x(a(t))))}if(r)return r.addEventListener("pointerdown",c),function(){return r.removeEventListener("pointerdown",c)}}),[t,n]),r.useEffect((function(){h&&y&&(b?o(Object(Je.e)(h,y),u):(a(Object(Je.e)(h,y),u),g(void 0),x(void 0)))}),[u,y,b,a,o,h]);var w=r.useMemo((function(){if(!h||!y)return{};var e=Object(Je.e)(h,y);return{transform:"translate(".concat(e.left,"px, ").concat(e.top,"px) scale(").concat(e.width/100,", ").concat(e.height/100,")")}}),[y,h]);return h&&y?Object(c.jsx)("div",{className:"marquee-selection",style:w}):null}),_e=(n(461),25*Math.sqrt(2)),Ge=function(e){var t=e.offset,n=e.passage,r={left:n.left,top:n.top};return n.selected&&(r.left+=t.left,r.top+=t.top),Object(c.jsx)("line",{className:"broken-connection",x1:r.left+n.width,y1:r.top+n.height,x2:r.left+n.width+_e,y2:r.top+n.height+_e,style:{markerEnd:"url(#link-broken)"}})};function Ke(e){var t=e.start,n=e.end,r=e.radius,a=e.largeArc,o=e.sweep,s=e.rotation;return"M"+t.left+","+t.top+" A"+r.left+","+r.top+" "+(null!==s&&void 0!==s?s:"0")+(a?" 1":" 0")+(o?" 1 ":" 0 ")+n.left+","+n.top}n(462);var $e=function(e){var t=e.end,n=e.offset,a=e.start,o=e.variant,s=r.useMemo((function(){var e=a,r=t;a.selected&&(e=Object(N.a)(Object(N.a)({},a),{},{left:a.left+n.left,top:a.top+n.top})),t.selected&&(r=Object(N.a)(Object(N.a)({},t),{},{left:t.left+n.left,top:t.top+n.top}));var o=Object(Je.d)(e),s=Object(Je.d)(r);if(!(o=Object(Je.f)(e,o,s)))return"";if(!(s=Object(Je.f)(r,o,s)))return"";var c=Object(Je.c)(o,s),i=o.left<s.left;return o.left===s.left&&o.top<s.top&&(i=!0),Ke({start:o,end:s,radius:{left:c,top:.75*c},rotation:Object(Je.b)(o,s),sweep:i})}),[t,n.left,n.top,a]);return Object(c.jsx)("path",{d:s,className:"passage-connection variant-".concat(o),style:{markerEnd:"url(#link-arrowhead)"}})},qe=(n(463),function(e){var t=e.offset,n=e.passage,a=e.variant,o={left:n.left,top:n.top};n.selected&&(o.left+=t.left,o.top+=t.top);var s=r.useMemo((function(){return.4*Math.min(n.width,n.height)}),[n.height,n.width]),i=r.useMemo((function(){return Ke({start:{left:o.left,top:o.top+n.height/2},end:{left:o.left,top:o.top},radius:{left:s,top:s},sweep:!0,largeArc:!0})}),[n.height,s,o.left,o.top]);return Object(c.jsx)("path",{className:"self-connection variant-".concat(a),d:i,style:{markerEnd:"url(#link-arrowhead)"}})}),Ze=r.memo((function(e){var t=e.broken,n=e.connections,r=e.offset,a=e.self,o=e.variant,s=void 0===o?"link":o;return Object(c.jsxs)(c.Fragment,{children:[Array.from(n).map((function(e){return Array.from(e[1]).map((function(t){return Object(c.jsx)($e,{end:t,offset:r,start:e[0],variant:s},e[0].name+t.name)}))})),Array.from(a).map((function(e){return Object(c.jsx)(qe,{offset:r,passage:e,variant:s},e.name)})),Array.from(t).map((function(e){return Object(c.jsx)(Ge,{offset:r,passage:e},e.name)}))]})}));Ze.displayName="PassageConnectionGroup";n(464);var Qe=function(){return Object(c.jsxs)("defs",{children:[Object(c.jsx)("marker",{id:"link-arrowhead",refX:"6",refY:"4",markerWidth:"8",markerHeight:"8",orient:"auto",children:Object(c.jsx)("path",{d:"M 1,1 7,4 1,7 Z"})}),Object(c.jsxs)("marker",{id:"link-broken",refX:"7.5",refY:"7.5",markerWidth:"15",markerHeight:"15",children:[Object(c.jsx)("circle",{cx:"7.5",cy:"7.5",r:"7.5"}),Object(c.jsx)("path",{d:"M4.5 7.5h 6z"})]}),Object(c.jsxs)("marker",{id:"link-start",markerWidth:"15",markerHeight:"15",refX:"16",refY:"16",viewBox:"0 0 32 32",children:[Object(c.jsx)("circle",{cx:"16",cy:"16",r:"16"}),Object(c.jsx)("path",{d:"M8 17a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3"}),Object(c.jsx)("path",{d:"M11 18a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3"}),Object(c.jsx)("circle",{className:"fill-white",cx:"19",cy:"13",r:"1"})]})]})},et=(n(465),r.memo((function(e){var t=e.offset,n=e.passage,r={left:n.left,top:n.top};return n.selected&&(r.left+=t.left,r.top+=t.top),Object(c.jsx)("line",{className:"start-connection",x1:r.left-50,y1:r.top+n.height/2,x2:r.left,y2:r.top+n.height/2,style:{markerStart:"url(#link-start)"}})})));et.displayName="StartConnection";var tt=n(82),nt=function(){return[]};var rt=new Set,at={left:0,top:0},ot=function(e){var t=e.formatName,n=e.formatVersion,a=e.offset,o=e.passages,s=e.startPassageId,i=function(e,t){var n,a,o=Object(u.usePrefsContext)().prefs,s=Object(F.useStoryFormatsContext)(),c=s.dispatch,i=s.formats,l=Object(F.formatWithNameAndVersion)(i,e,t),d=r.useState(),f=Object(W.a)(d,2),b=f[0],j=f[1],p=Object(u.formatEditorExtensionsDisabled)(o,e,t);return r.useEffect((function(){p||("unloaded"===l.loadState?c(Object(F.loadFormatProperties)(l)):"loaded"===l.loadState&&j(Object(se.b)(l,tt.a)))}),[c,p,l]),p?nt:null!==(n=null===b||void 0===b||null===(a=b.references)||void 0===a?void 0:a.parsePassageText)&&void 0!==n?n:nt}(t,n),l=r.useMemo((function(){return Object(q.passageConnections)(o)}),[o]),d=l.draggable,f=l.fixed,b=r.useMemo((function(){return Object(q.passageConnections)(o,i)}),[o,i]),j=b.draggable,p=b.fixed,m=r.useMemo((function(){return o.find((function(e){return e.id===s}))}),[o,s]);return Object(c.jsxs)("svg",{className:"link-connectors",children:[Object(c.jsx)(Qe,{}),m&&Object(c.jsx)(et,{offset:a,passage:m}),Object(c.jsx)(Ze,Object(N.a)(Object(N.a)({},d),{},{offset:a})),Object(c.jsx)(Ze,Object(N.a)(Object(N.a)({},f),{},{offset:at})),Object(c.jsx)(Ze,{broken:rt,connections:j.connections,offset:a,self:rt,variant:"reference"}),Object(c.jsx)(Ze,{broken:rt,connections:p.connections,offset:at,self:rt,variant:"reference"})]})},st=n(240),ct=n(239),it=n(117),ut=(n(469),r.memo((function(e){var t=e.onDeselect,n=e.onDrag,a=e.onDragStart,o=e.onDragStop,s=e.onEdit,i=e.onSelect,u=e.passage,l=e.tagColors,d=Object(p.a)().t,f=r.useMemo((function(){return y()("passage-card",{empty:""===u.text&&0===u.tags.length,selected:u.selected})}),[u.selected,u.tags.length,u.text]),b=r.useRef(null),j=r.useMemo((function(){return u.text.length>0?u.text.substring(0,400):Object(c.jsx)("span",{className:"placeholder",children:d("touchOnly"===st.a?"components.passageCard.placeholderTouch":"components.passageCard.placeholderClick")})}),[u.text,d]),m=r.useMemo((function(){return{height:u.height,left:u.left,top:u.top,width:u.width}}),[u.height,u.left,u.top,u.width]),h=r.useCallback((function(e){e.shiftKey||e.ctrlKey?u.selected?t(u):i(u,!1):u.selected||i(u,!0)}),[t,i,u]),g=r.useCallback((function(){return s(u)}),[s,u]),O=r.useCallback((function(e,t){i(u,t)}),[i,u]);return Object(c.jsx)(ct.DraggableCore,{nodeRef:b,onMouseDown:h,onStart:a,onDrag:n,onStop:o,children:Object(c.jsx)("div",{className:f,ref:b,style:m,children:Object(c.jsxs)(D,{highlighted:u.highlighted,label:u.name,onDoubleClick:g,onSelect:O,selected:u.selected,children:[Object(c.jsx)(it.a,{tagColors:l,tags:u.tags}),Object(c.jsx)("h2",{children:u.name}),Object(c.jsx)(I.b,{children:j})]})})})})));ut.displayName="PassageCard";n(470);var lt=r.memo((function(e){var t=e.passages,n=r.useMemo((function(){return Object(fe.a)(t).sort((function(e,t){return e.top!==t.top?e.top-t.top:e.left-t.left}))}),[t]);return Object(c.jsx)(m.a,{component:null,children:n.map((function(t){return Object(c.jsx)(h.a,{classNames:"pop",timeout:200,children:Object(c.jsx)(ut,Object(N.a)({passage:t},e))},t.id)}))})}));lt.displayName="PassageCardGroup";n(471);function dt(e,t){switch(t.type){case"start":return{dragging:!0,dragX:t.x,dragY:t.y,startX:t.x,startY:t.y};case"move":return Object(N.a)(Object(N.a)({},e),{},{dragX:t.x,dragY:t.y});case"stop":return Promise.resolve().then((function(){return t.callback({left:e.dragX-e.startX,top:e.dragY-e.startY})})),{dragging:!1,dragX:0,dragY:0,startX:0,startY:0}}}var ft=function(e){var t=e.formatName,n=e.formatVersion,a=e.onDeselect,o=e.onDrag,s=e.onEdit,i=e.onSelect,u=e.passages,l=e.startPassageId,d=e.tagColors,f=e.visibleZoom,b=e.zoom,j=r.useState(f<=.6),p=Object(W.a)(j,2),m=p[0],h=p[1],g=r.useRef(null),O=r.useMemo((function(){return Object(Je.a)([].concat(Object(fe.a)(u),[{top:0,left:0,width:0,height:0}]))}),[u]),v=r.useMemo((function(){return{height:"calc(".concat(O.height,"px + max(50vh, ").concat(1e3/f,"px))"),width:"calc(".concat(O.width,"px + max(50vw, ").concat(1e3/f,"px))"),transform:"scale(".concat(f,")")}}),[O.height,O.width,f]),x=r.useReducer(dt,{dragging:!1,dragX:0,dragY:0,startX:0,startY:0}),w=Object(W.a)(x,2),S=w[0],C=w[1];r.useEffect((function(){b===f&&h(b<=.6)}),[f,b]),r.useEffect((function(){g.current&&(g.current.style.setProperty("--drag-offset-left","".concat((S.dragX-S.startX)/f,"px")),g.current.style.setProperty("--drag-offset-top","".concat((S.dragY-S.startY)/f,"px")))}),[S.dragX,S.dragY,S.startX,S.startY,f]);var k=r.useCallback((function(e,t){document.body.classList.add("dragging-passages"),C({type:"start",x:t.x,y:t.y})}),[]),F=r.useCallback((function(e,t){return C({type:"move",x:t.x,y:t.y})}),[]),E=r.useCallback((function(){window.setTimeout((function(){document.body.classList.remove("dragging-passages"),C({type:"stop",callback:o})}),0)}),[o]),I=r.useCallback((function(e,t){S.dragging||i(e,t)}),[i,S.dragging]);return Object(c.jsxs)("div",{className:y()("passage-map",{"compact-passage-cards":m}),ref:g,style:v,children:[Object(c.jsx)(ot,{formatName:t,formatVersion:n,offset:{left:(S.dragX-S.startX)/b,top:(S.dragY-S.startY)/b},passages:u,startPassageId:l}),Object(c.jsx)(lt,{onDeselect:a,onDragStart:k,onDrag:F,onDragStop:E,onEdit:s,onSelect:I,passages:u,tagColors:d})]})},bt=function(e){var t=e.container,n=e.onSelectRect,a=Object(P.a)(e,["container","onSelectRect"]),o=r.useState(),s=Object(W.a)(o,2),i=s[0],u=s[1],l=r.useState(),d=Object(W.a)(l,2),f=d[0],b=d[1],j=r.useMemo((function(){return i?e.passages.map((function(e){if(f&&e.selected)return e;var t=Object(Je.g)(i,e);return t===e.selected?e:Object(N.a)(Object(N.a)({},e),{},{selected:t})})):e.passages}),[e.passages,f,i]),p=r.useCallback((function(t,n){u({height:t.height/e.zoom,left:t.left/e.zoom,top:t.top/e.zoom,width:t.width/e.zoom}),b(n)}),[e.zoom]),m=r.useCallback((function(e,t){u(void 0),b(void 0),n(e,t)}),[n]);return Object(c.jsxs)(c.Fragment,{children:[Object(c.jsx)(Xe,{container:t,ignoreEventsOnSelector:".passage-card, .zoom-buttons",onSelectRect:m,onTemporarySelectRect:p}),Object(c.jsx)(ft,Object(N.a)(Object(N.a)({},a),{},{passages:j}))]})},jt=function(){var e=r.useState(!1),t=Object(W.a)(e,2),n=t[0],a=t[1],o=Object(M.useDialogsContext)().dispatch,s=r.useRef(null),i=Object(b.g)().storyId,u=Object(Oe.useUndoableStoriesContext)(),l=u.dispatch,d=u.stories,f=Object(q.storyWithId)(d,i);!function(e){var t=Object(q.useStoriesContext)(),n=t.dispatch,r=t.stories;Object(xe.a)("-",(function(){switch(e.zoom){case 1:n(Object(q.updateStory)(r,e,{zoom:.6}));break;case.6:n(Object(q.updateStory)(r,e,{zoom:.3}))}}),{keydown:!1,keyup:!0},[n,r,e]),Object(xe.a)("=",(function(){switch(e.zoom){case.3:n(Object(q.updateStory)(r,e,{zoom:.6}));break;case.6:n(Object(q.updateStory)(r,e,{zoom:1}))}}),{keydown:!1,keyup:!0},[n,r,e])}(f);var j=r.useMemo((function(){return f.passages.filter((function(e){return e.selected}))}),[f.passages]),p=r.useCallback((function(){if(!s.current)throw new Error("Asked for the center of the main content, but it does not exist in the DOM yet");return{left:(s.current.scrollLeft+s.current.clientWidth/2)/f.zoom,top:(s.current.scrollTop+s.current.clientHeight/2)/f.zoom}}),[f.zoom]),m=r.useCallback((function(e){return l(Object(q.deselectPassage)(f,e))}),[f,l]),h=r.useCallback((function(e){Math.abs(e.left)<1&&Math.abs(e.top)<1||l(Object(q.movePassages)(f,f.passages.reduce((function(e,t){return t.selected?[].concat(Object(fe.a)(e),[t.id]):e}),[]),e.left/f.zoom,e.top/f.zoom),(j.length,"undoChange.movePassages"))}),[j.length,f,l]),g=r.useCallback((function(e){return o({type:"addDialog",component:M.PassageEditDialog,props:{passageId:e.id,storyId:f.id}})}),[o,f.id]),O=r.useCallback((function(e,t){return l(Object(q.selectPassage)(f,e,t))}),[f,l]),v=r.useCallback((function(e,t){var n={height:e.height/f.zoom,left:e.left/f.zoom,top:e.top/f.zoom,width:e.width/f.zoom};l(Object(q.selectPassagesInRect)(f,n,t?j.map((function(e){return e.id})):[]))}),[j,f,l]);r.useEffect((function(){if(!n&&(a(!0),0===f.passages.length)){var e=p();l(Object(q.createUntitledPassage)(f,e.left,e.top))}}),[p,n,f,l]);var y=Ye(f.zoom,s.current);return Object(c.jsxs)("div",{className:"story-edit-route",children:[Object(c.jsx)(S,{title:f.name}),Object(c.jsx)(We,{getCenter:p,story:f}),Object(c.jsxs)(C,{grabbable:!0,padded:!1,ref:s,children:[Object(c.jsx)(bt,{container:s,formatName:f.storyFormat,formatVersion:f.storyFormatVersion,onDeselect:m,onDrag:h,onEdit:g,onSelect:O,onSelectRect:v,passages:f.passages,startPassageId:f.startPassage,tagColors:f.tagColors,visibleZoom:y,zoom:f.zoom}),Object(c.jsx)(Ve,{story:f})]})]})},pt=function(){return Object(c.jsx)(Oe.UndoableStoriesContextProvider,{children:Object(c.jsx)(M.DialogsContextProvider,{children:Object(c.jsx)(jt,{})})})},mt=n(164),ht=n.n(mt);n(499);var gt=function(e){var t,n=e.watch,a=r.useState(),o=Object(W.a)(a,2),s=o[0],i=o[1],u=r.useState(!1),l=Object(W.a)(u,2),d=l[0],f=l[1],b=r.useState(),j=Object(W.a)(b,2),m=j[0],h=j[1],g=Object(p.a)().t,O=Object(w.a)()||!(null===(t=navigator.storage)||void 0===t?void 0:t.estimate);return r.useEffect((function(){function e(){return(e=Object(X.a)(J.a.mark((function e(){var t,r,a;return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return f(!0),e.next=3,navigator.storage.estimate();case 3:t=e.sent,r=t.quota,a=t.usage,void 0!==r&&void 0!==a&&h((100*(1-a/r)).toFixed(0)),i(n),f(!1);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}O||d||s===n||function(){e.apply(this,arguments)}()}),[O,s,n,d]),O?null:Object(c.jsx)("span",{className:"storage-quota",children:m&&g("components.storageQuota.freeSpace",{percent:m})})},Ot=function(){var e=Object(q.useStoriesContext)().stories,t=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.J,{}),label:t("routes.storyList.toolbar.archive"),onClick:function(){return ne(Object($.b)(e,Object(Z.a)()),Object($.a)())}})},vt=function(){var e=Object(M.useDialogsContext)().dispatch,t=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.x,{}),label:t("common.import"),onClick:function(){return e({type:"addDialog",component:M.StoryImportDialog})}})},yt=function(){var e=Object(M.useDialogsContext)().dispatch,t=Object(p.a)().t;return Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.W,{}),label:t("routes.storyList.toolbar.storyTags"),onClick:function(){e({type:"addDialog",component:M.StoryTagsDialog})}})},xt=function(){return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(yt,{}),Object(c.jsx)(vt,{}),Object(c.jsx)(Ot,{})]})},wt=n(78),St=function(){var e=Object(q.useStoriesContext)(),t=e.dispatch,n=e.stories,a=r.useState(Object(wt.a)(Object(q.storyDefaults)().name,n.map((function(e){return e.name})))),o=Object(W.a)(a,2),s=o[0],i=o[1],l=Object(b.f)(),d=Object(u.usePrefsContext)().prefs,f=Object(p.a)().t;return Object(c.jsx)(oe.a,{icon:Object(c.jsx)(k.L,{}),label:f("common.new"),submitLabel:f("common.create"),submitVariant:"create",onChange:function(e){return i(e.target.value)},onSubmit:function(){var e=Object(q.createStory)(n,d,{name:s})(t,(function(){return n}));l.push("/stories/".concat(e))},prompt:f("routes.storyList.toolbar.createStoryButton.prompt"),validate:function(e){return""===e.trim()?{valid:!1,message:f("routes.storyList.toolbar.createStoryButton.emptyName")}:n.some((function(t){return t.name.toLowerCase()===e.toLowerCase()}))?{valid:!1,message:f("routes.storyList.toolbar.createStoryButton.nameConflict")}:{valid:!0}},value:s})},Ct=(n(500),function(e){var t=e.cancelIcon,n=e.cancelLabel,a=e.confirmIcon,o=e.confirmLabel,s=e.confirmVariant,i=e.onConfirm,u=e.prompt,l=Object(P.a)(e,["cancelIcon","cancelLabel","confirmIcon","confirmLabel","confirmVariant","onConfirm","prompt"]),d=r.useState(!1),f=Object(W.a)(d,2),b=f[0],j=f[1],m=Object(p.a)().t;return Object(c.jsx)("span",{className:"confirm-button",children:Object(c.jsx)(G.a,Object(N.a)(Object(N.a)({ariaLabel:u,focusSelector:"button:nth-child(2)",onChangeOpen:j,open:b},l),{},{children:Object(c.jsxs)("div",{children:[Object(c.jsx)(I.b,{children:u}),Object(c.jsxs)(_.a,{children:[Object(c.jsx)(B.a,{icon:null!==a&&void 0!==a?a:Object(c.jsx)(k.n,{}),label:null!==o&&void 0!==o?o:m("common.ok"),onClick:function(){j(!1),i()},variant:null!==s&&void 0!==s?s:"primary"}),Object(c.jsx)(B.a,{icon:null!==t&&void 0!==t?t:Object(c.jsx)(k.ab,{}),label:null!==n&&void 0!==n?n:m("common.cancel"),onClick:function(){return j(!1)}})]})]})}))})}),kt=function(e){var t=e.story,n=r.useState(null===t||void 0===t?void 0:t.name),a=Object(W.a)(n,2),o=a[0],s=a[1],i=Object(q.useStoriesContext)().dispatch,u=Object(p.a)().t;return r.useEffect((function(){(null===t||void 0===t?void 0:t.name)&&s(t.name)}),[null===t||void 0===t?void 0:t.name]),Object(c.jsx)(Ct,{confirmIcon:Object(c.jsx)(k.Y,{}),confirmLabel:u("common.delete"),confirmVariant:"danger",disabled:!t,icon:Object(c.jsx)(k.Y,{}),label:u("common.delete"),onConfirm:t?function(){return i(Object(q.deleteStory)(t))}:function(){},prompt:u("routes.storyList.toolbar.deleteStoryButton.warning.".concat(Object(w.a)()?"electron":"web"),{storyName:o})})},Ft=function(e){var t=e.story,n=Object(q.useStoriesContext)(),r=n.dispatch,a=n.stories,o=Object(p.a)().t;return Object(c.jsx)(B.a,{disabled:!t,icon:Object(c.jsx)(k.s,{}),label:o("common.duplicate"),onClick:function(){if(!t)throw new Error("No story set");r(Object(q.duplicateStory)(t,a))}})},Et=function(e){var t=e.story,n=Object(b.f)(),r=Object(p.a)().t;return Object(c.jsx)(B.a,{disabled:!t,icon:Object(c.jsx)(k.u,{}),label:r("common.edit"),onClick:function(){return n.push("/stories/".concat(null===t||void 0===t?void 0:t.id))}})},It=n(61),Nt=function(e){var t,n=e.story,r=Object(u.usePrefsContext)(),a=r.dispatch,o=r.prefs,s=Object(q.useStoriesContext)(),i=s.dispatch,l=s.stories;return Object(c.jsx)(It.a,{assignedTags:null!==(t=null===n||void 0===n?void 0:n.tags)&&void 0!==t?t:[],disabled:!n,existingTags:Object(q.storyTags)(l),icon:Object(c.jsx)(k.V,{}),onAdd:function(e,t){if(!n)throw new Error("Story is unset");i(Object(q.updateStory)(l,n,{tags:n.tags?[].concat(Object(fe.a)(n.tags),[e]):[e]})),t&&a(Object(u.setPref)("storyTagColors",Object(N.a)(Object(N.a)({},o.storyTagColors),{},Object(R.a)({},e,t))))}})},Pt=function(e){var t=e.selectedStory,n=Object(q.useStoriesContext)(),r=n.dispatch,a=n.stories;return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(St,{}),Object(c.jsx)(Et,{story:t}),Object(c.jsx)(Nt,{story:t}),Object(c.jsx)(Pe,{existingStories:a,onRename:function(e){return r(Object(q.updateStory)(a,t,{name:e}))},story:t}),Object(c.jsx)(Ft,{story:t}),Object(c.jsx)(kt,{story:t})]})},Tt=n(51),Dt=function(){var e=Object(p.a)().t,t=Object(u.usePrefsContext)(),n=t.dispatch,r=t.prefs;return Object(c.jsx)(Tt.a,{icon:Object(c.jsx)(k.j,{}),items:[{checkable:!0,checked:"date"===r.storyListSort,label:e("routes.storyList.toolbar.sortByDate"),onClick:function(){return n(Object(u.setPref)("storyListSort","date"))}},{checkable:!0,checked:"name"===r.storyListSort,label:e("routes.storyList.toolbar.sortByName"),onClick:function(){return n(Object(u.setPref)("storyListSort","name"))}}],label:e("routes.storyList.toolbar.sort")})},Lt=function(e){var t=Object(u.usePrefsContext)(),n=t.dispatch,r=t.prefs,a=Object(p.a)().t;return Object(c.jsx)(Tt.a,{disabled:0===e.tags.length,icon:Object(c.jsx)(k.V,{}),items:[{checkable:!0,checked:0===r.storyListTagFilter.length,label:a("routes.storyList.toolbar.showAllStories"),onClick:function(){return n({type:"update",name:"storyListTagFilter",value:[]})}},{separator:!0}].concat(Object(fe.a)(e.tags.map((function(e){return{checkable:!0,checked:r.storyListTagFilter.includes(e),label:e,onClick:function(){return n({type:"update",name:"storyListTagFilter",value:r.storyListTagFilter.includes(e)?r.storyListTagFilter.filter((function(t){return t!==e})):[].concat(Object(fe.a)(r.storyListTagFilter),[e])})}}})))),label:a("routes.storyList.toolbar.showTags")})},At=function(){var e=Object(q.useStoriesContext)().stories;return Object(c.jsxs)(_.a,{children:[Object(c.jsx)(Dt,{}),Object(c.jsx)(Lt,{tags:Object(q.storyTags)(e)})]})},Mt=function(e){var t,n=e.selectedStories,r=Object(q.useStoriesContext)().stories,a=Object(p.a)().t,o=1===n.length?n[0]:void 0;return Object(c.jsx)(H,{pinnedControls:Object(c.jsx)(gt,{watch:r}),tabs:(t={},Object(R.a)(t,a("common.story"),Object(c.jsx)(Pt,{selectedStory:o})),Object(R.a)(t,a("routes.storyList.library"),Object(c.jsx)(xt,{})),Object(R.a)(t,a("common.build"),Object(c.jsx)(re,{story:o})),Object(R.a)(t,a("common.view"),Object(c.jsx)(At,{})),Object(R.a)(t,a("common.appName"),Object(c.jsx)(ae,{})),t)})};n(501);function zt(e){for(var t=0,n=0;n<e.length;n++)t+=e.charCodeAt(n);return t%360}n(502);var Rt=r.memo((function(e){var t=e.story,n=[zt(t.name)];n.push((n[0]+15)%360),n.push((n[0]-15)%360),n.push((n[0]+30)%360),n.push((n[0]-30)%360),n.push((n[0]+60)%360);var r=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY,i=t.passages.map((function(e){return{key:e.name,x:e.left+e.width/2,y:e.top+e.height/2,radius:Math.max(e.width,e.height)}})).reduce((function(e,t,i){var u=t.radius+200;return r=Math.min(r,t.x-u),a=Math.min(a,t.y-u),o=Math.max(o,t.x+u),s=Math.max(s,t.y+u),e[0].push(Object(c.jsx)("circle",{cx:t.x,cy:t.y,r:u,style:{fill:"hsl(".concat(n[i%n.length],", 80%, 80%)")}},"".concat(t.key,"-bg"))),e[1].push(Object(c.jsx)("circle",{cx:t.x,cy:t.y,r:t.radius,style:{fill:"hsl(".concat(n[i%n.length],", 80%, 60%)")}},"".concat(t.key,"-fg"))),e}),[[],[]]).map((function(e,t){return Object(c.jsx)("g",{className:"story-preview-".concat(0===t?"bg":"fg"),children:e},t)})),u="".concat(r," ").concat(a," ").concat(o-r," ").concat(s-a);return Object(c.jsx)("svg",{className:"story-preview",viewBox:u,xmlns:"http://www.w3.org/2000/svg",children:i})}));Rt.displayName="StoryPreview";var Wt=new Intl.DateTimeFormat([]),Ut=function(e){var t=e.onChangeTagColor,n=e.onEdit,r=e.onRemoveTag,a=e.onSelect,o=e.story,s=e.storyTagColors,i=Object(P.a)(e,["onChangeTagColor","onEdit","onRemoveTag","onSelect","story","storyTagColors"]),u=Object(p.a)().t;return Object(c.jsx)("div",{className:"story-card",children:Object(c.jsx)(D,Object(N.a)(Object(N.a)({},i),{},{label:o.name,onDoubleClick:n,onSelect:a,selected:o.selected,children:Object(c.jsxs)(I.b,{children:[Object(c.jsxs)("div",{className:"story-card-summary",children:[Object(c.jsx)("div",{className:"story-card-summary-preview",children:Object(c.jsx)(Rt,{story:o})}),Object(c.jsxs)("div",{className:"story-card-summary-text",children:[Object(c.jsx)("h2",{children:o.name}),Object(c.jsxs)("p",{children:[u("components.storyCard.lastUpdated",{date:Wt.format(o.lastUpdate)}),Object(c.jsx)("br",{}),u("components.storyCard.passageCount",{count:o.passages.length})]})]})]}),o.tags&&Object(c.jsx)("div",{className:"tags",children:o.tags.map((function(e){return Object(c.jsx)(It.b,{color:s[e],name:e,onChangeColor:function(n){return t(e,n)},onRemove:function(){return r(e)}},e)}))})]})}))})},Bt=function(e){var t=e.onSelectStory,n=e.stories,r=Object(u.usePrefsContext)(),a=r.dispatch,o=r.prefs,s=Object(Oe.useUndoableStoriesContext)().dispatch,i=Object(b.f)();function l(e,t){a(Object(u.setPref)("storyTagColors",Object(N.a)(Object(N.a)({},o.storyTagColors),{},Object(R.a)({},e,t))))}return Object(c.jsx)(c.Fragment,{children:Object(c.jsx)(O,{columnWidth:"360px",children:Object(c.jsx)(m.a,{component:null,children:n.map((function(e){return Object(c.jsx)(h.a,{classNames:"pop",timeout:200,children:Object(c.jsx)(Ut,{onChangeTagColor:l,onEdit:function(){return i.push("/stories/".concat(e.id))},onRemoveTag:function(t){return function(e,t){s(Object(q.updateStory)(n,e,{tags:e.tags.filter((function(e){return e!==t}))}))}(e,t)},onSelect:function(){return t(e)},story:e,storyTagColors:o.storyTagColors})},e.id)}))})})})},Vt=function(){var e=Object(M.useDialogsContext)().dispatch,t=Object(q.useStoriesContext)(),n=t.dispatch,a=t.stories,s=Object(u.usePrefsContext)().prefs,i=function(){var e=Object(u.usePrefsContext)().prefs;return{shouldShowDonationPrompt:r.useCallback((function(){return!e.donateShown&&Date.now()>e.firstRunTime+12096e5}),[e.donateShown,e.firstRunTime])}}(),l=i.shouldShowDonationPrompt,d=Object(p.a)().t,f=r.useMemo((function(){return a.filter((function(e){return e.selected}))}),[a]),b=r.useMemo((function(){var e=s.storyListTagFilter.length>0?a.filter((function(e){return e.tags.some((function(e){return s.storyListTagFilter.includes(e)}))})):a;switch(s.storyListSort){case"date":return ht()(e,"lastUpdated");case"name":return ht()(e,"name")}}),[s.storyListSort,s.storyListTagFilter,a]);return r.useEffect((function(){var e,t=Object(j.a)(f);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.selected&&!b.includes(r)&&n(Object(q.deselectStory)(r))}}catch(a){t.e(a)}finally{t.f()}}),[f,a,n,b]),r.useEffect((function(){l()&&e({type:"addDialog",component:M.AppDonationDialog})}),[e,l]),Object(c.jsxs)("div",{className:"story-list-route",children:[Object(c.jsx)(Mt,{selectedStories:f}),Object(c.jsx)(g,{ignoreSelector:".story-card",onClickAway:function(){return n(Object(q.deselectAllStories)())},children:Object(c.jsxs)(C,{title:d(s.storyListTagFilter.length>0?"routes.storyList.taggedTitleCount":"routes.storyList.titleCount",{count:b.length}),children:[Object(c.jsx)(o.c,{}),Object(c.jsx)("div",{className:"stories",children:0===a.length?Object(c.jsx)("p",{children:d("routes.storyList.noStories")}):Object(c.jsx)(Bt,{onSelectStory:function(e){return n(Object(q.selectStory)(e,!0))},stories:b})})]})})]})},Ht=function(){return Object(c.jsx)(Oe.UndoableStoriesContextProvider,{children:Object(c.jsx)(M.DialogsContextProvider,{children:Object(c.jsx)(Vt,{})})})};function Yt(e){delete window.CodeMirror,delete window.SVG,delete window.Store,delete window.StoryFormat,delete window.amdDefine,delete window.app,delete window.jQuery,document.open(),document.write(e),document.close()}var Jt=function(){var e=r.useState(),t=Object(W.a)(e,2),n=t[0],a=t[1],s=r.useState(!1),i=Object(W.a)(s,2),u=i[0],l=i[1],d=Object(b.g)().storyId,f=Q().publishStory;return r.useEffect((function(){function e(){return(e=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=Yt,e.next=4,f(d);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),a(e.t2);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}u||(l(!0),function(){e.apply(this,arguments)}())}),[u,f,d]),n?Object(c.jsx)(o.a,{children:n.message}):null},Xt=function(){var e=r.useState(),t=Object(W.a)(e,2),n=t[0],a=t[1],s=r.useState(!1),i=Object(W.a)(s,2),u=i[0],l=i[1],d=Object(b.g)().storyId,f=Q().proofStory;return r.useEffect((function(){function e(){return(e=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=Yt,e.next=4,f(d);case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),a(e.t2);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}u||(l(!0),function(){e.apply(this,arguments)}())}),[u,f,d]),n?Object(c.jsx)(o.a,{children:n.message}):null},_t=function(){var e=r.useState(),t=Object(W.a)(e,2),n=t[0],a=t[1],s=r.useState(!1),i=Object(W.a)(s,2),u=i[0],l=i[1],d=Object(b.g)(),f=d.passageId,j=d.storyId,p=Q().publishStory;return r.useEffect((function(){function e(){return(e=Object(X.a)(J.a.mark((function e(){return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=Yt,e.next=4,p(j,{formatOptions:"debug",startId:f});case 4:e.t1=e.sent,(0,e.t0)(e.t1),e.next=11;break;case 8:e.prev=8,e.t2=e.catch(0),a(e.t2);case 11:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}u||(l(!0),function(){e.apply(this,arguments)}())}),[u,f,p,j]),n?Object(c.jsx)(o.a,{children:n.message}):null},Gt=n(241),Kt=n.n(Gt),$t=(n(503),function(e){var t=e.children,n=e.image,r=e.nextLabel,a=e.onNext,o=e.onSkip,s=e.showSkip,i=e.title,u=Object(P.a)(e,["children","image","nextLabel","onNext","onSkip","showSkip","title"]),l=Object(p.a)().t;return Object(c.jsx)("div",{className:"welcome-card",children:Object(c.jsxs)(I.a,Object(N.a)(Object(N.a)({},u),{},{children:[Object(c.jsx)("div",{className:"welcome-card-image",children:n}),Object(c.jsxs)(I.b,{children:[Object(c.jsx)("h2",{children:i}),t]}),Object(c.jsxs)(_.a,{children:[Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.g,{}),variant:"primary",onClick:a,label:r}),s&&Object(c.jsx)(B.a,{icon:Object(c.jsx)(k.d,{}),label:l("common.skip"),onClick:o})]})]}))})}),qt=function(){return[{html:"routes.welcome.greeting",image:Object(c.jsx)(s.c,{}),nextLabel:"routes.welcome.tellMeMore",title:"routes.welcome.greetingTitle"},{html:"routes.welcome.help",image:Object(c.jsx)(k.C,{}),title:"routes.welcome.helpTitle"},Object(w.a)()?{html:"routes.welcome.autosave",image:Object(c.jsx)(k.t,{}),title:"routes.welcome.autosaveTitle"}:{html:"routes.welcome.browserStorage",image:Object(c.jsx)(k.t,{}),title:"routes.welcome.browserStorageTitle"},{html:"routes.welcome.done",image:Object(c.jsx)(k.I,{}),nextLabel:"routes.welcome.gotoStoryList",title:"routes.welcome.doneTitle"}]},Zt=(n(504),function(){var e=r.useRef(null),t=Object(u.usePrefsContext)().dispatch,n=Object(b.f)(),a=r.useState(1),o=Object(W.a)(a,2),s=o[0],i=o[1],l=r.useMemo(qt,[]),d=r.useMemo((function(){return l.slice(0,s)}),[l,s]),f=Object(p.a)().t;r.useEffect((function(){if(e.current){var t,n=e.current.querySelector(".welcome-card:last-of-type");if(n)Kt.a.top(null!==(t=document.documentElement)&&void 0!==t?t:document.body,n.offsetTop,{duration:400})}}),[s]);var j=function(){t(Object(u.setPref)("welcomeSeen",!0)),n.push("/")},g=function(){return i((function(e){return e+1}))};return Object(c.jsxs)("div",{className:"welcome-route",ref:e,children:[Object(c.jsx)(x.a,{children:Object(c.jsx)("title",{children:f("routes.welcome.greetingTitle")})}),Object(c.jsx)("div",{className:"cards",children:Object(c.jsx)(m.a,{component:null,children:d.map((function(e,t){return Object(c.jsx)(h.a,{classNames:"pop",timeout:200,children:Object(c.jsx)($t,{image:e.image,nextLabel:e.nextLabel?f(e.nextLabel):f("common.next"),onNext:t===l.length-1?j:g,onSkip:j,showSkip:0===t,title:f(e.title),children:Object(c.jsx)("div",{dangerouslySetInnerHTML:{__html:f(e.html)}})})},e.title)}))})})]})}),Qt=function(){var e=Object(u.usePrefsContext)().prefs;return Object(c.jsx)(f.a,{children:e.welcomeSeen?Object(c.jsxs)(b.c,{children:[Object(c.jsx)(b.a,{exact:!0,path:"/",children:Object(c.jsx)(Ht,{})}),Object(c.jsx)(b.a,{path:"/story-formats",children:Object(c.jsx)(ge,{})}),Object(c.jsx)(b.a,{path:"/welcome",children:Object(c.jsx)(Zt,{})}),Object(c.jsx)(b.a,{path:"/stories/:storyId/play",children:Object(c.jsx)(Jt,{})}),Object(c.jsx)(b.a,{path:"/stories/:storyId/proof",children:Object(c.jsx)(Xt,{})}),Object(c.jsx)(b.a,{path:"/stories/:storyId/test/:passageId",children:Object(c.jsx)(_t,{})}),Object(c.jsx)(b.a,{path:"/stories/:storyId/test",children:Object(c.jsx)(_t,{})}),Object(c.jsx)(b.a,{path:"/stories/:storyId",children:Object(c.jsx)(pt,{})}),Object(c.jsx)(b.a,{path:"*",render:function(e){return console.warn('No route for path "'.concat(e.location.pathname,'", rendering story list')),Object(c.jsx)(Ht,{})}})]}):Object(c.jsx)(Zt,{})})},en=n(60),tn=function(e){var t=e.children,n=r.useState(!1),a=Object(W.a)(n,2),s=a[0],l=a[1],d=r.useState(!1),f=Object(W.a)(d,2),b=f[0],j=f[1],p=r.useState(!1),m=Object(W.a)(p,2),h=m[0],g=m[1],O=r.useState(!1),v=Object(W.a)(O,2),y=v[0],x=v[1],w=r.useState(!1),S=Object(W.a)(w,2),C=S[0],k=S[1],E=Object(u.usePrefsContext)(),I=E.dispatch,N=E.prefs,P=Object(q.useStoriesContext)().dispatch,T=Object(F.useStoryFormatsContext)(),D=T.dispatch,L=T.formats,A=Object(en.a)(),M=A.prefs,z=A.stories,R=A.storyFormats;return r.useEffect((function(){function e(){return(e=Object(X.a)(J.a.mark((function e(){var t,n,r;return J.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s){e.next=14;break}return e.next=3,R.load();case 3:return t=e.sent,e.next=6,M.load();case 6:return n=e.sent,e.next=9,z.load();case 9:r=e.sent,D({type:"init",state:t}),I({type:"init",state:n}),P({type:"init",state:r}),j(!0);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(){e.apply(this,arguments)}(),l(!0)}),[D,b,s,M,I,z,P,R]),r.useEffect((function(){b&&!y&&(D({type:"repair"}),x(!0))}),[D,y,b]),r.useEffect((function(){b&&y&&!h&&(I({type:"repair",allFormats:L}),g(!0))}),[y,L,b,I,h]),r.useEffect((function(){if(b&&y&&h&&!C){var e;try{e=Object(F.formatWithNameAndVersion)(L,N.storyFormat.name,N.storyFormat.version)}catch(t){try{e=Object(F.formatWithNameAndVersion)(L,Object(u.defaults)().storyFormat.name,Object(u.defaults)().storyFormat.version)}catch(o){console.error("Could not locate a safe story format, skipping story repair: ".concat(o.message))}}e&&P({type:"repair",allFormats:L,defaultFormat:e}),k(!0)}}),[D,y,L,b,I,h,N.storyFormat.name,N.storyFormat.version,z,P,C]),b&&y&&h&&C?Object(c.jsx)(c.Fragment,{children:t}):Object(c.jsx)(i,{})},nn=n(130);function rn(){var e=Object(nn.a)();return r.useEffect((function(){document.body.dataset.appTheme=e}),[e]),null}n(505),n(506),n(507);var an=function(){return Object(c.jsx)(o.b,{children:Object(c.jsxs)(u.PrefsContextProvider,{children:[Object(c.jsx)(d,{}),Object(c.jsx)(rn,{}),Object(c.jsx)(F.StoryFormatsContextProvider,{children:Object(c.jsx)(q.StoriesContextProvider,{children:Object(c.jsx)(tn,{children:Object(c.jsx)(r.Suspense,{fallback:Object(c.jsx)(i,{}),children:Object(c.jsx)(Qt,{})})})})})]})})};a.render(Object(c.jsx)(r.StrictMode,{children:Object(c.jsx)(an,{})}),document.getElementById("root"))}],[[508,1,2]]]);
//# sourceMappingURL=main.a321f3ae.chunk.js.map